<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>è®ºæ–‡é˜…è¯»ç¬”è®°</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Paper Notes</a></li><li class="chapter-item expanded "><a href="benchmarks/index.html"><strong aria-hidden="true">1.</strong> benchmarks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="benchmarks/ssb.html"><strong aria-hidden="true">1.1.</strong> ssb</a></li></ol></li><li class="chapter-item expanded "><a href="bigdata/index.html"><strong aria-hidden="true">2.</strong> bigdata</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="bigdata/mapreduce.html"><strong aria-hidden="true">2.1.</strong> mapreduce</a></li><li class="chapter-item expanded "><a href="bigdata/nephele.html"><strong aria-hidden="true">2.2.</strong> nephele</a></li><li class="chapter-item expanded "><a href="bigdata/dataflow-model.html"><strong aria-hidden="true">2.3.</strong> dataflow model</a></li><li class="chapter-item expanded "><a href="bigdata/flink.html"><strong aria-hidden="true">2.4.</strong> flink</a></li><li class="chapter-item expanded "><a href="bigdata/flink-state-management.html"><strong aria-hidden="true">2.5.</strong> flink state management</a></li></ol></li><li class="chapter-item expanded "><a href="compiler/index.html"><strong aria-hidden="true">3.</strong> compiler</a></li><li class="chapter-item expanded "><a href="databases/index.html"><strong aria-hidden="true">4.</strong> databases</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/cloudnative/index.html"><strong aria-hidden="true">4.1.</strong> cloudnative</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/cloudnative/aurora.html"><strong aria-hidden="true">4.1.1.</strong> aurora</a></li><li class="chapter-item expanded "><a href="databases/cloudnative/taurus.html"><strong aria-hidden="true">4.1.2.</strong> taurus</a></li></ol></li><li class="chapter-item expanded "><a href="databases/column-stores-vs-row-stores.html"><strong aria-hidden="true">4.2.</strong> columnstores vs rowstores</a></li><li class="chapter-item expanded "><a href="databases/kv/index.html"><strong aria-hidden="true">4.3.</strong> kv</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/kv/optimizing-space-amplification-in-rocksdb.html"><strong aria-hidden="true">4.3.1.</strong> rocksdb cidr17</a></li><li class="chapter-item expanded "><a href="databases/kv/wisckey.html"><strong aria-hidden="true">4.3.2.</strong> wisckey</a></li></ol></li><li class="chapter-item expanded "><a href="databases/mmdb/index.html"><strong aria-hidden="true">4.4.</strong> mmdb</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/mmdb/overview.html"><strong aria-hidden="true">4.4.1.</strong> mmdb overview</a></li></ol></li><li class="chapter-item expanded "><a href="databases/oltp/index.html"><strong aria-hidden="true">4.5.</strong> oltp</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/oltp/oltp-through-the-looking-glass.html"><strong aria-hidden="true">4.5.1.</strong> through the looking glass</a></li><li class="chapter-item expanded "><a href="databases/oltp/staring-into-the-abyss.html"><strong aria-hidden="true">4.5.2.</strong> staring into the abyss</a></li></ol></li><li class="chapter-item expanded "><a href="databases/olap/index.html"><strong aria-hidden="true">4.6.</strong> olap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/olap/lakehouse.html"><strong aria-hidden="true">4.6.1.</strong> lakehouse</a></li><li class="chapter-item expanded "><a href="databases/olap/delta-lake.html"><strong aria-hidden="true">4.6.2.</strong> delta lake</a></li><li class="chapter-item expanded "><a href="databases/olap/vertica.html"><strong aria-hidden="true">4.6.3.</strong> vertica</a></li><li class="chapter-item expanded "><a href="databases/olap/duckdb.html"><strong aria-hidden="true">4.6.4.</strong> duckdb</a></li></ol></li><li class="chapter-item expanded "><a href="databases/htap/index.html"><strong aria-hidden="true">4.7.</strong> htap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/htap/greenplum-htap.html"><strong aria-hidden="true">4.7.1.</strong> greenplum</a></li></ol></li><li class="chapter-item expanded "><a href="databases/vectordb/index.html"><strong aria-hidden="true">4.8.</strong> vector db</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/vectordb/hnsw.html"><strong aria-hidden="true">4.8.1.</strong> hnsw</a></li><li class="chapter-item expanded "><a href="databases/vectordb/ivf-hnsw.html"><strong aria-hidden="true">4.8.2.</strong> ivf-hnsw</a></li><li class="chapter-item expanded "><a href="databases/vectordb/diskann.html"><strong aria-hidden="true">4.8.3.</strong> diskann</a></li><li class="chapter-item expanded "><a href="databases/vectordb/pq.html"><strong aria-hidden="true">4.8.4.</strong> product quantization</a></li></ol></li><li class="chapter-item expanded "><a href="databases/graphdb/index.html"><strong aria-hidden="true">4.9.</strong> graph db</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/graphdb/kuzu.html"><strong aria-hidden="true">4.9.1.</strong> kuzu</a></li></ol></li><li class="chapter-item expanded "><a href="databases/citus.html"><strong aria-hidden="true">4.10.</strong> citus</a></li><li class="chapter-item expanded "><a href="databases/optimizer/index.html"><strong aria-hidden="true">4.11.</strong> optimizer</a></li><li class="chapter-item expanded "><a href="databases/executor/index.html"><strong aria-hidden="true">4.12.</strong> executor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/executor/volcano.html"><strong aria-hidden="true">4.12.1.</strong> volcano</a></li></ol></li><li class="chapter-item expanded "><a href="databases/concurrencycontrol/index.html"><strong aria-hidden="true">4.13.</strong> concurrency control</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/concurrencycontrol/empirical-evaluation-of-mvcc.html"><strong aria-hidden="true">4.13.1.</strong> evaluation of in-memory mvcc</a></li></ol></li><li class="chapter-item expanded "><a href="databases/cdc/index.html"><strong aria-hidden="true">4.14.</strong> cdc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="databases/cdc/dblog.html"><strong aria-hidden="true">4.14.1.</strong> dblog</a></li></ol></li><li class="chapter-item expanded "><a href="databases/rum.html"><strong aria-hidden="true">4.15.</strong> rum conjecture</a></li></ol></li><li class="chapter-item expanded "><a href="datalayout/index.html"><strong aria-hidden="true">5.</strong> datalayout</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datalayout/c-store.html"><strong aria-hidden="true">5.1.</strong> cstore</a></li><li class="chapter-item expanded "><a href="datalayout/c-store-compression.html"><strong aria-hidden="true">5.2.</strong> cstore compression</a></li><li class="chapter-item expanded "><a href="datalayout/dremel.html"><strong aria-hidden="true">5.3.</strong> dremel</a></li><li class="chapter-item expanded "><a href="datalayout/rcfile.html"><strong aria-hidden="true">5.4.</strong> rcfile</a></li><li class="chapter-item expanded "><a href="datalayout/orc.html"><strong aria-hidden="true">5.5.</strong> orc</a></li><li class="chapter-item expanded "><a href="datalayout/table-placement-methods.html"><strong aria-hidden="true">5.6.</strong> table placement methods</a></li></ol></li><li class="chapter-item expanded "><a href="datastructure/index.html"><strong aria-hidden="true">6.</strong> data structures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datastructure/btreefamily/index.html"><strong aria-hidden="true">6.1.</strong> btree family</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datastructure/btreefamily/bw-tree.html"><strong aria-hidden="true">6.1.1.</strong> bw-tree</a></li></ol></li><li class="chapter-item expanded "><a href="datastructure/hash/index.html"><strong aria-hidden="true">6.2.</strong> hash table</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datastructure/hash/linear-hashing.html"><strong aria-hidden="true">6.2.1.</strong> linear hashing</a></li></ol></li><li class="chapter-item expanded "><a href="datastructure/triefamily/index.html"><strong aria-hidden="true">6.3.</strong> trie family</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datastructure/triefamily/art.html"><strong aria-hidden="true">6.3.1.</strong> art</a></li><li class="chapter-item expanded "><a href="datastructure/triefamily/hot.html"><strong aria-hidden="true">6.3.2.</strong> hot</a></li></ol></li><li class="chapter-item expanded "><a href="datastructure/bitmap/index.html"><strong aria-hidden="true">6.4.</strong> bitmaps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="datastructure/bitmap/roaring.html"><strong aria-hidden="true">6.4.1.</strong> roaring bitmaps</a></li></ol></li><li class="chapter-item expanded "><a href="datastructure/skiplist.html"><strong aria-hidden="true">6.5.</strong> skip list</a></li><li class="chapter-item expanded "><a href="datastructure/bloom-filter.html"><strong aria-hidden="true">6.6.</strong> bloom filter</a></li></ol></li><li class="chapter-item expanded "><a href="distributedsystem/index.html"><strong aria-hidden="true">7.</strong> distributed system</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="distributedsystem/consensus/index.html"><strong aria-hidden="true">7.1.</strong> consensus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="distributedsystem/consensus/flp.html"><strong aria-hidden="true">7.1.1.</strong> flp</a></li><li class="chapter-item expanded "><a href="distributedsystem/consensus/paxos-made-simple.html"><strong aria-hidden="true">7.1.2.</strong> paxos made simple</a></li><li class="chapter-item expanded "><a href="distributedsystem/consensus/paxos-made-live.html"><strong aria-hidden="true">7.1.3.</strong> paxos made live</a></li><li class="chapter-item expanded "><a href="distributedsystem/consensus/vr.html"><strong aria-hidden="true">7.1.4.</strong> viewstamped replication</a></li><li class="chapter-item expanded "><a href="distributedsystem/consensus/zab.html"><strong aria-hidden="true">7.1.5.</strong> zab</a></li><li class="chapter-item expanded "><a href="distributedsystem/consensus/paxos-vs-vr-vs-zab.html"><strong aria-hidden="true">7.1.6.</strong> paxos vs. vr vs. zab</a></li><li class="chapter-item expanded "><a href="distributedsystem/consensus/raft.html"><strong aria-hidden="true">7.1.7.</strong> raft</a></li><li class="chapter-item expanded "><a href="distributedsystem/consensus/paxos-vs-raft.html"><strong aria-hidden="true">7.1.8.</strong> paxos vs raft</a></li></ol></li><li class="chapter-item expanded "><a href="distributedsystem/scheduler/index.html"><strong aria-hidden="true">7.2.</strong> scheduler</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="distributedsystem/scheduler/borg.html"><strong aria-hidden="true">7.2.1.</strong> borg</a></li></ol></li><li class="chapter-item expanded "><a href="distributedsystem/primary-backup.html"><strong aria-hidden="true">7.3.</strong> primary backup</a></li><li class="chapter-item expanded "><a href="distributedsystem/chain-replication.html"><strong aria-hidden="true">7.4.</strong> chain replication</a></li><li class="chapter-item expanded "><a href="distributedsystem/bolosky.html"><strong aria-hidden="true">7.5.</strong> bolosky</a></li><li class="chapter-item expanded "><a href="distributedsystem/holygrail.html"><strong aria-hidden="true">7.6.</strong> holy grail</a></li><li class="chapter-item expanded "><a href="distributedsystem/chandy.html"><strong aria-hidden="true">7.7.</strong> chandy lamport</a></li><li class="chapter-item expanded "><a href="distributedsystem/abs.html"><strong aria-hidden="true">7.8.</strong> asynchronous barrier snapshotting</a></li><li class="chapter-item expanded "><a href="distributedsystem/zookeeper.html"><strong aria-hidden="true">7.9.</strong> zookeeper</a></li></ol></li><li class="chapter-item expanded "><a href="fs/index.html"><strong aria-hidden="true">8.</strong> filesystem</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="fs/gfs.html"><strong aria-hidden="true">8.1.</strong> gfs</a></li><li class="chapter-item expanded "><a href="fs/polarfs.html"><strong aria-hidden="true">8.2.</strong> polarfs</a></li></ol></li><li class="chapter-item expanded "><a href="llm/index.html"><strong aria-hidden="true">9.</strong> llm</a></li><li class="chapter-item expanded "><a href="storage/index.html"><strong aria-hidden="true">10.</strong> storage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="storage/kv/index.html"><strong aria-hidden="true">10.1.</strong> kv store</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="storage/kv/dynamo.html"><strong aria-hidden="true">10.1.1.</strong> dynamo</a></li></ol></li><li class="chapter-item expanded "><a href="storage/kudu.html"><strong aria-hidden="true">10.2.</strong> kudu</a></li><li class="chapter-item expanded "><a href="storage/bluestore.html"><strong aria-hidden="true">10.3.</strong> bluestore</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">è®ºæ–‡é˜…è¯»ç¬”è®°</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/zhjwpku/paper-notes" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="paper-notes"><a class="header" href="#paper-notes">Paper Notes</a></h2>
<p>æœ¬ä»“åº“è®°å½•æˆ‘è¯»è¿‡çš„ paper ä»¥åŠå¯¹æ¯ç¯‡ paper çš„ç†è§£ã€æ”¶è´§å’Œç–‘é—®ã€‚</p>
<p>å¦‚ä½•è¯»è®ºæ–‡æˆ‘å‚è€ƒäº† <a href="./assets/pdfs/how-to-read-a-paper.pdf">How to Read a Paper</a> çš„ three-pass method:</p>
<ol>
<li>ç¬¬ä¸€éå¿«é€Ÿæµè§ˆè®ºæ–‡ï¼ˆ5-10 åˆ†é’Ÿï¼‰
<ul>
<li>ä»”ç»†é˜…è¯»é¢˜ç›®ã€æ‘˜è¦å’Œç®€ä»‹</li>
<li>é˜…è¯»æ¯ä¸ª section åŠ sub-section çš„é¢˜ç›®ï¼Œå¿½ç•¥å…¶å®ƒå†…å®¹</li>
<li>å¦‚æœæœ‰æ•°å­¦å…¬å¼åˆ™å¿«é€Ÿæ‰«ä¸€çœ¼ä»¥ä¾¿äº†è§£å…¶ç†è®ºåŸºç¡€</li>
<li>é˜…è¯»æ€»ç»“éƒ¨åˆ†</li>
<li>ç®€å•æµè§ˆå¼•ç”¨éƒ¨åˆ†ï¼Œçœ‹å“ªäº›æ˜¯ä»¥å‰è¯»è¿‡çš„</li>
</ul>
</li>
<li>ç¬¬äºŒéä»”ç»†é˜…è¯»è®ºæ–‡ä½†æ˜¯å¿½ç•¥ç»†èŠ‚ï¼Œæ¯”å¦‚è¯æ˜éƒ¨åˆ†ã€‚åœ¨é˜…è¯»çš„è¿‡ç¨‹ä¸­è®°å½•ä¸‹ä¸æ‡‚çš„æœ¯è¯­ä»¥åŠæƒ³è¦é—®ä½œè€…çš„é—®é¢˜ï¼ˆå¯¹äºæœ‰ç»éªŒçš„è¯»è€…éœ€è¦ 1 å°æ—¶ï¼‰
<ul>
<li>ä»”ç»†é˜…è¯»è®ºæ–‡ä¸­çš„æ’å›¾ã€å›¾è¡¨æˆ–å…¶å®ƒæ’ç”»ï¼Œå°¤å…¶æ³¨æ„é‚£äº›æ¨ªçºµåæ ‡çš„å«ä¹‰</li>
<li>æ ‡è®°ä¸‹è‡ªå·±æ²¡æœ‰é˜…è¯»è¿‡çš„ç›¸å…³å¼•ç”¨</li>
</ul>
</li>
<li>ä¸ºäº†å®Œå…¨ç†è§£ä¸€ç¯‡è®ºæ–‡ï¼Œå¾€å¾€éœ€è¦é˜…è¯»ç¬¬ä¸‰éã€‚ç¬¬ä¸‰éåˆ™éœ€è¦è¯»è€…ä»ä½œè€…çš„è§’åº¦å‡ºå‘ï¼Œè¯•ç€åœ¨è„‘å­é‡Œé‡æ–°å®ç°ä¸€éè®ºæ–‡çš„å·¥ä½œï¼ˆåˆå­¦è€…éœ€è¦å¤šä¸ªå°æ—¶ï¼Œå¯¹äºæœ‰ç»éªŒçš„è¯»è€…ä¹Ÿéœ€è¦1-2ä¸ªå°æ—¶ï¼‰</li>
</ol>
<p>è®ºæ–‡æ–¹å‘: CS/Database/Distributed System</p>
<p>è®ºæ–‡æ¥æº:</p>
<ul>
<li><a href="http://www.redbook.io/">Readings in Database Systems, 5th Edition</a></li>
<li><a href="https://blog.acolyer.org/">The Morning Paper</a></li>
<li><a href="https://github.com/ept/ddia-references">Literature references for â€œDesigning Data-Intensive Applicationsâ€</a></li>
<li>ä¸€äº› <a href="https://zhjwpku.com/2018/09/16/awesome-cs-courses.html">CS è¯¾ç¨‹</a> ä¸­çš„æ¨èé˜…è¯»</li>
<li><a href="https://github.com/papers-we-love/papers-we-love">papers-we-love</a></li>
<li><a href="https://www.postgresql.org/docs/current/biblio.html">PostgreSQL Documentation Bibliography</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="benchmarks"><a class="header" href="#benchmarks">benchmarks</a></h2>
<ul>
<li><strong><a href="benchmarks/ssb.html">Star Schema Benchmark</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefbenchmarksassetspdfsstarschemabpdfstar-schema-benchmarka"><a class="header" href="#a-hrefbenchmarksassetspdfsstarschemabpdfstar-schema-benchmarka"><a href="benchmarks/../assets/pdfs/StarSchemaB.pdf">Star Schema Benchmark</a></a></h3>
<blockquote>
<p>by P O'Neil 2009</p>
<p>https://www.cs.umb.edu/~poneil/StarSchemaB.PDF</p>
</blockquote>
<p>æ˜Ÿå‹æ¨¡å‹åœ¨æ•°ä»“ä¸­ä½¿ç”¨å¹¿æ³›ï¼Œåœ¨è¯¥æ¨¡å‹ä¸­ï¼Œå¤šä¸ªç»´è¡¨ï¼ˆdimension tablesï¼‰å›´ç»•ä¸€ä¸ªäº‹å®è¡¨ï¼ˆfact tableï¼‰ï¼Œå› æ­¤å¯ä»¥å‡å°‘ä¸å¿…è¦çš„å¤–é”®åŠ joinï¼ŒæŸ¥è¯¢å¤æ‚åº¦è¾ƒä½ï¼Œä½†å´ç”±äºä¸ä¸¥æ ¼éµå¾ªèŒƒå¼ï¼Œå­˜å‚¨åœ¨æ•°æ®å†—ä½™ã€‚</p>
<p>Star Schema Benchmark å°† TPC-H çš„é›ªèŠ±æ¨¡å‹æ”¹é€ æˆäº†æ˜Ÿå‹æ¨¡å¼ï¼Œä»¥æµ‹è¯•æ•°ä»“åœ¨å†³ç­–æ”¯æŒåœºæ™¯ä¸‹æ€§èƒ½è¡¨ç°ã€‚</p>
<blockquote>
<p>We depart from the TPC-H query format for a number of reasons, most commonly to make
an attempt to provide the <code>Functional Coverage</code> and <code>Selectivity Coverage</code> features.</p>
</blockquote>
<p>å¯¹äºæŸ¥è¯¢è¯­å¥çš„é€‰æ‹©ï¼ŒSSB ä¸»è¦è€ƒè™‘:</p>
<ul>
<li>Functional Coverage: å°½å¯èƒ½é€‰æ‹©æ˜Ÿå‹æ¨¡å¼ä¸­å¸¸è§çš„é‡è¦æŸ¥è¯¢ä»¥æ»¡è¶³ç”¨æˆ·çš„é¢„æœŸ</li>
<li>Selectivity Coverage: é€šè¿‡å¯¹ç»´è¡¨æ¡ä»¶çš„é€‰æ‹©å¯ä»¥å†³å®šäº‹å®è¡¨æ£€ç´¢çš„æ•°é‡ï¼ˆtotal Filter Factorï¼‰</li>
</ul>
<h4 id="ssb-çš„è¡¨ç»“æ„"><a class="header" href="#ssb-çš„è¡¨ç»“æ„">SSB çš„è¡¨ç»“æ„</a></h4>
<p><img src="benchmarks/../assets/images/ssb_schema.jpg" alt="SSB Schema" /></p>
<p>äº‹å®è¡¨å°† TPC-H ä¸­çš„ <code>LINEITEM</code> å’Œ <code>ORDERS</code> è¿›è¡Œäº†åˆå¹¶ï¼Œæ›´åŠ ç¬¦åˆæ•°ä»“çš„æ ‡å‡†ï¼Œå¢åŠ äº†å†—ä½™ï¼ŒåŒæ—¶å‡å°‘äº†åœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­ä¸å¿…è¦çš„ join è®¡ç®—ã€‚</p>
<p>å¯¹æ¯” TPC-H çš„è¡¨ç»“æ„ä¸º:</p>
<p><img src="benchmarks/../assets/images/ssb_tpc_h.jpg" alt="TPC-H Schema" /></p>
<h4 id="ssb-queries"><a class="header" href="#ssb-queries">SSB Queries</a></h4>
<p>Q1: é€‰æ‹©ä¸€ä¸ªç»´è¡¨ï¼ˆdateï¼‰ä½œä¸ºæŸ¥è¯¢è¿‡æ»¤æ¡ä»¶ï¼Œè®¡ç®—ç»™å®š<code>æ—¥æœŸèŒƒå›´</code>å†…ï¼ŒæŠ˜æ‰£å’Œé”€å”®æ•°é‡åœ¨æŸä¸ªèŒƒå›´å†…çš„è®¢å•çš„<code>é”€å”®æ”¶å…¥</code>ä¹‹å’Œã€‚</p>
<pre><code class="language-sql">select sum(lo_extendedprice * lo_discount) as revenue
 from lineorder, date
 where lo_orderdate = d_datekey
  and [DATE_FILTER]
  and [LO_DISCOUNT_FILTER]
  and [LO_QUANTITY_FILTER]; 
</code></pre>
<p>Q2: å¯¹ä¸¤ä¸ªç»´è¡¨ï¼ˆpartã€supplierï¼‰è¿›è¡ŒæŸ¥è¯¢è¿‡æ»¤ï¼Œè®¡ç®—æ¯ä¸ªå“ç‰Œæ¯å¹´å¸¦æ¥çš„æ”¶å…¥ä¹‹å’Œã€‚</p>
<pre><code class="language-sql">select sum(lo_revenue), d_year, p_brand1
 from lineorder, date, part, supplier
 where lo_orderdate = d_datekey
  and lo_partkey = p_partkey
  and lo_suppkey = s_suppkey
  and [PART_FILTER]
  and [S_REGION_FILTER]
 group by d_year, p_brand1
 order by d_year, p_brand1; 
</code></pre>
<p>Q3: å¯¹ä¸‰ä¸ªç»´è¡¨ï¼ˆcustomerã€supplier å’Œ dateï¼‰è¿›è¡ŒæŸ¥è¯¢è¿‡æ»¤ï¼Œæ ¹æ®å®¢æˆ·æ‰€åœ¨å›½å®¶ã€ä¾›åº”å•†æ‰€åœ¨å›½å®¶åŠæ—¥æœŸé™åˆ¶è®¡ç®—æ”¶å…¥ä¹‹å’Œã€‚</p>
<pre><code class="language-sql">select c_nation, s_nation, d_year, sum(lo_revenue) as revenue
 from customer, lineorder, supplier, date
 where lo_custkey = c_custkey
  and lo_suppkey = s_suppkey
  and lo_orderdate = d_datekey
  and [CUSTOMOR_FILTER]
  and [SUPPLIER_FILTER]
  and [DATE_FILTER]
 group by c_nation, s_nation, d_year
 order by d_year asc, revenue desc;
</code></pre>
<p>Q4: å¯¹å››ä¸ªç»´è¡¨ï¼ˆå…¨éƒ¨ï¼‰è¿›è¡ŒæŸ¥è¯¢è¿‡æ»¤:</p>
<p>Q4.1</p>
<pre><code class="language-sql">select d_year, c_nation, sum(lo_revenue - lo_supplycost) as profit
 from date, customer, supplier, part, lineorder
 where lo_custkey = c_custkey
  and lo_suppkey = s_suppkey
  and lo_partkey = p_partkey
  and lo_orderdate = d_datekey
  and c_region = 'AMERICA'
  and s_region = 'AMERICA'
  and (p_mfgr = 'MFGR#1' or p_mfgr = 'MFGR#2')
 group by d_year, c_nation
 order by d_year, c_nation;
</code></pre>
<p>Q4.2</p>
<pre><code class="language-sql">select d_year, s_nation, p_category, sum(lo_revenue - lo_supplycost) as profit
 from date, customer, supplier, part, lineorder
 where lo_custkey = c_custkey
  and lo_suppkey = s_suppkey
  and lo_partkey = p_partkey
  and lo_orderdate = d_datekey
  and c_region = 'AMERICA'
  and s_region = 'AMERICA'
  and (d_year = 1997 or d_year = 1998)
  and (p_mfgr = 'MFGR#1' or p_mfgr = 'MFGR#2')
 group by d_year, s_nation, p_category
 order by d_year, s_nation, p_category;
</code></pre>
<p>Q4.3</p>
<pre><code class="language-sql">select d_year, s_city, p_brand1, sum(lo_revenue - lo_supplycost) as profit
 from date, customer, supplier, part, lineorder
 where lo_custkey = c_custkey
  and lo_suppkey = s_suppkey
  and lo_partkey = p_partkey
  and lo_orderdate = d_datekey
  and c_region = 'AMERICA'
  and s_nation = 'UNITED STATES'
  and (d_year = 1997 or d_year = 1998)
  and p_category = 'MFGR#14'
 group by d_year, s_city, p_brand1
 order by d_year, s_city, p_brand1;
</code></pre>
<p>å››ç±»æŸ¥è¯¢å…± 13 ä¸ªæŸ¥è¯¢å¯¹äº‹å®è¡¨çš„ Filter Factor å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<p><img src="benchmarks/../assets/images/ssb_filter_factor.jpg" alt="Filter Factor" /></p>
<h4 id="references"><a class="header" href="#references">References:</a></h4>
<p>[1] <a href="https://github.com/eyalroz/ssb-dbgen">Star Schema Benchmark data set generator (ssb-dbgen)</a><br>
[2] <a href="https://www.geeksforgeeks.org/difference-between-star-schema-and-snowflake-schema/">Difference between Star Schema and Snowflake Schema</a></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="bigdata"><a class="header" href="#bigdata">bigdata</a></h2>
<ul>
<li><strong><a href="bigdata/mapreduce.html">MapReduce: Simplified Data Processing on Large Clusters</a></strong></li>
<li><strong><a href="bigdata/nephele.html">Nephele: Efficient Parallel Data Processing in the Cloud</a></strong></li>
<li><strong><a href="bigdata/dataflow-model.html">The Dataflow Model</a></strong></li>
<li><strong><a href="bigdata/flink.html">Apache Flink: Stream and Batch Processing in a Single Engine</a></strong></li>
<li><strong><a href="bigdata/flink-state-management.html">State Management in Apache Flink</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefbigdataassetspdfsmapreduce-osdi04pdfmapreduce-simplified-data-processing-on-large-clustersa"><a class="header" href="#a-hrefbigdataassetspdfsmapreduce-osdi04pdfmapreduce-simplified-data-processing-on-large-clustersa"><a href="bigdata/../assets/pdfs/mapreduce-osdi04.pdf">MapReduce: Simplified Data Processing on Large Clusters</a></a></h3>
<blockquote>
<p>OSDI'04: Sixth Symposium on Operating System Design and Implementation, San Francisco, CA (2004), pp. 137-150</p>
<p>https://research.google/pubs/pub62/</p>
</blockquote>
<p>åœ¨å¤„ç† <code>Distributed Grep</code>ï¼Œ<code>Inverted Index</code>ã€<code>Distributed Sort</code> ç­‰é—®é¢˜æ—¶ï¼Œè™½ç„¶æ•°æ®æœ¬èº«éœ€è¦æ‰§è¡Œçš„è½¬æ¢éå¸¸ç®€å•ï¼Œä½†åœ¨é«˜åº¦åˆ†å¸ƒå¼ã€å¯æ‰©å±•å’Œå®¹é”™çš„ç¯å¢ƒä¸­æ‰§è¡Œè¿™äº›ä»»åŠ¡å´åˆä¸é‚£ä¹ˆç®€å•ï¼ŒMapReduce é€šè¿‡éšè—æ‰€æœ‰åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œä¸ºç”¨æˆ·æä¾›äº†ä¸€ä¸ªåˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶ï¼Œç”¨æˆ·åªéœ€æä¾›ç”¨äºå°† <code>key/value pair</code> å¤„ç†ç”Ÿæˆä¸€ç»„ <code>intermedia key/value pairs</code> çš„ <code>map</code> å‡½æ•°ï¼Œå’Œä¸€ä¸ªå°†åŒä¸€ä¸ªé”®å¯¹åº”çš„æ‰€æœ‰ <code>intermedia key/value pairs</code> åšåˆå¹¶æ“ä½œçš„ <code>reduce</code> å‡½æ•°ï¼Œå°±å¯ä»¥å°†ç¨‹åºå¹¶è¡Œåœ°è¿è¡Œåœ¨è®¡ç®—æœºé›†ç¾¤ä¸Šã€‚</p>
<p>MapReduce çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹:</p>
<p><img src="bigdata/../assets/images/mapreduce_execution_overview.jpg" alt="MapReduce Execution Overview" /></p>
<ol>
<li>
<p>The MapReduce library in the user program first
splits the input files into M pieces of typically 16
megabytes to 64 megabytes (MB) per piece (controllable
by the user via an optional parameter). It
then starts up many copies of the program on a cluster
of machines.</p>
</li>
<li>
<p>One of the copies of the program is special â€”â€” the
master. The rest are workers that are assigned work
by the master. There are <code>M</code> map tasks and R reduce
tasks to assign. The master picks idle workers and
assigns each one a map task or a reduce task.</p>
</li>
<li>
<p>A worker who is assigned a map task reads the
contents of the corresponding input split. It parses
key/value pairs out of the input data and passes each
pair to the user-defined <code>Map</code> function. The intermediate
key/value pairs produced by the <code>Map</code> function
are buffered in memory.</p>
</li>
<li>
<p>Periodically, the buffered pairs are written to local
disk, partitioned into <code>R</code> regions by the partitioning
function. The locations of these buffered pairs on
the local disk are passed back to the master, who
is responsible for forwarding these locations to the
reduce workers.</p>
</li>
<li>
<p>When a reduce worker is notified by the master
about these locations, it uses remote procedure calls
to read the buffered data from the local disks of the
map workers. When a reduce worker has read all intermediate
data, it sorts it by the intermediate keys
so that all occurrences of the same key are grouped
together. The sorting is needed because typically
many different keys map to the same reduce task. If
the amount of intermediate data is too large to fit in
memory, an external sort is used.</p>
</li>
<li>
<p>The reduce worker iterates over the sorted intermediate
data and for each unique intermediate key encountered,
it passes the key and the corresponding
set of intermediate values to the user's Reduce function.
The output of the Reduce function is appended
to a final output file for this reduce partition.</p>
</li>
<li>
<p>When all map tasks and reduce tasks have been
completed, the master wakes up the user program.
At this point, the MapReduce call in the user program
returns back to the user code.</p>
</li>
</ol>
<p>ä¸€ä¸ª MapReduce ä»»åŠ¡å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ:</p>
<ul>
<li><strong>map phase</strong>: åœ¨ map worker ä¸Šï¼Œå¤„ç†åçš„ä¸­é—´æ•°æ®æ ¹æ®é»˜è®¤æˆ–ç”¨æˆ·æä¾›çš„ partitioning function å°†æ•°æ®ä¿å­˜ä¸º <code>R</code> ä¸ªæœ¬åœ°æ–‡ä»¶ï¼Œå¹¶å°†æ–‡ä»¶ä½ç½®ä¸ŠæŠ¥ç»™ master</li>
<li><strong>shuffle phase</strong>: åœ¨ reduce worker ä¸Šï¼Œæ ¹æ®ä» master ä¸Šè·å–çš„æ–‡ä»¶ä½ç½®ï¼Œä»å„ä¸ª map worker ä¸Šè¯»å–æ‰€éœ€çš„æ–‡ä»¶</li>
<li><strong>reduce phase</strong>: åœ¨ reduce worker ä¸Šå°†è¯»å–æ–‡ä»¶ä¸­ intermedia key/value pairs è¿›è¡Œå¤„ç†çš„è¿‡ç¨‹</li>
</ul>
<h4 id="fault-tolerance"><a class="header" href="#fault-tolerance">Fault Tolerance</a></h4>
<p>å½“ master å¤±è´¥æ—¶ï¼Œæ•´ä¸ªä»»åŠ¡é‡åšï¼›å½“ map worker å¤±è´¥æ—¶ï¼Œå³ä½¿å®ƒå·²ç»å®Œæˆï¼Œä¹Ÿéœ€è¦é‡åšï¼Œå› ä¸ºä¸­é—´æ•°æ®æ–‡ä»¶æ˜¯å†™åœ¨æœ¬åœ°çš„ï¼›å½“ reduce worker å¤±è´¥æ—¶ï¼Œå¦‚æœä»»åŠ¡æœªå®Œæˆï¼Œéœ€è¦æˆé‡æ–°è°ƒåº¦å…¶ä»–èŠ‚ç‚¹å®Œæˆå¯¹åº”çš„ reduce ä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡å·²ç»å®Œæˆï¼Œåˆ™ä¸éœ€è¦é‡åšï¼Œå› ä¸º reduce çš„ç»“æœä¿å­˜åœ¨ GFSã€‚</p>
<h4 id="ä¼˜åŒ–"><a class="header" href="#ä¼˜åŒ–">ä¼˜åŒ–</a></h4>
<ul>
<li>Locality: ç”±äº input file ä¿å­˜åœ¨ GFS ä¸Šï¼ŒMapReduce å¯ä»¥æ ¹æ®æ–‡ä»¶å­˜å‚¨çš„ä½ç½®ï¼Œå°† map worker è°ƒåº¦åˆ°æ•°æ®åˆ†ç‰‡æ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šä»¥å‡å°‘ç½‘ç»œå¼€é”€</li>
<li>Combiner: å½“ reduce å‡½æ•°æ»¡è¶³äº¤æ¢å¾‹å’Œç»“åˆå¾‹ç‰¹æ€§æ—¶ï¼Œå¯ä»¥å°† reduce çš„å·¥ä½œåœ¨ map é˜¶æ®µæå‰æ‰§è¡Œ</li>
<li>Backup Tasks: å°†ä¸€å®šæ¯”ä¾‹çš„é•¿å°¾ä»»åŠ¡é‡æ–°è°ƒåº¦ï¼Œå¯ä»¥å‡å°‘ä»»åŠ¡çš„æ•´ä½“æ‰§è¡Œæ—¶é—´</li>
</ul>
<p>Apache Hadoop æ˜¯ MapReduce çš„å¼€æºå®ç°ï¼Œ2014 å¹´ Google æå‡ºäº† MapReduce çš„æ›¿ä»£æ¨¡å‹ Cloud Dataflowï¼Œè¯¥æ¨¡å‹æ”¯æŒæµæ‰¹ä¸€ä½“ï¼Œå…·æœ‰æ›´å¥½çš„æ€§èƒ½åŠæ‰©å±•æ€§ï¼Œå¯¹æ ‡çš„å¼€æºäº§å“ä¸º Apache Flinkã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefbigdataassetspdfsnephele_09pdfnephele-efficient-parallel-data-processing-in-the-clouda"><a class="header" href="#a-hrefbigdataassetspdfsnephele_09pdfnephele-efficient-parallel-data-processing-in-the-clouda"><a href="bigdata/../assets/pdfs/Nephele_09.pdf">Nephele: Efficient Parallel Data Processing in the Cloud</a></a></h3>
<blockquote>
<p>Proceedings of the 2nd Workshop on Many-Task Computing on Grids and Supercomputers, November 2009</p>
<p>https://dl.acm.org/doi/10.1145/1646468.1646476</p>
</blockquote>
<p>åœ¨äº‘çš„æ—¶ä»£ï¼Œå¯¹äºä¸€ä¸ªå¹¶å‘æ•°æ®å¤„ç†æ¡†æ¶çš„è°ƒåº¦å™¨æ¥è¯´ï¼Œè¦å›ç­”çš„é—®é¢˜ä» <code>Given a set of compute resources, how to distribute the particular tasks of a job among them?</code> è½¬å˜ä¸ºäº† <code>Given a job, what compute resources match the tasks the job consists of best?</code></p>
<p>è¿™ç§æ–°çš„èŒƒå¼å¯¹è°ƒåº¦å™¨æå‡ºäº†ä¸‰ä¸ªè¦æ±‚ï¼š</p>
<ol>
<li>å¿…é¡»äº†è§£ job æ‰§è¡Œæ‰€åœ¨çš„äº‘ç¯å¢ƒï¼Œå¦‚å„ç§ VM çš„ç±»å‹åŠå…¶å®šä»·</li>
<li>å¿…é¡»èƒ½å¤Ÿæè¿°ä¸€ä¸ª job çš„å„ä¸ª task ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œè¿›è€Œåˆ¤æ–­ä½•æ—¶ä¸€ä¸ª VM ä¸å†éœ€è¦å¯ä»¥æå‰é‡Šæ”¾</li>
<li>å¿…é¡»èƒ½å¤Ÿå†³å®šä¸€ä¸ª task åº”è¯¥åœ¨å“ªç§ç±»å‹çš„ VM ä¸Šæ‰§è¡Œ</li>
</ol>
<p>è¿™ç§çµæ´»æ€§åŒæ—¶å¸¦æ¥äº†ä¸€äº›æŒ‘æˆ˜ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„é—®é¢˜åœ¨äºç½‘ç»œæ‹“æ‰‘ï¼Œæ•°æ®å¤„ç†æ¡†æ¶å¾ˆéš¾çŸ¥é“ç½‘ç»œçš„å±‚çº§ï¼Œæ¯”å¦‚ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ä¼ è¾“ç»è¿‡äº†å‡ ä¸ªäº¤æ¢æœºï¼Œå¯¹äºè°ƒåº¦å™¨æ¥è¯´ï¼Œæ‹“æ‰‘æ„ŸçŸ¥çš„è°ƒåº¦éå¸¸å›°éš¾ã€‚å³ä½¿çŸ¥é“äº†åº•å±‚çš„ç½‘ç»œå±‚çº§ï¼Œç”±äº VM çš„è¿ç§»ç‰¹æ€§ï¼Œç½‘ç»œæ‹“æ‰‘å¯èƒ½ä¼šéšæ—¶å˜åŠ¨ã€‚è§£å†³è¿™ç§é—®é¢˜çš„å”¯ä¸€æ–¹æ³•æ˜¯å°†éœ€è¦å¤§é‡æ•°æ®ä¼ è¾“çš„ tasks è°ƒåº¦åœ¨ä¸€ä¸ªæ›´å¼ºçš„ VM ä¸Šä»¥ä¿è¯ Data localityã€‚</p>
<h3 id="nephele"><a class="header" href="#nephele">Nephele</a></h3>
<p>åŸºäºäº‘è®¡ç®—å¸¦æ¥çš„æœºé‡å’ŒæŒ‘æˆ˜ï¼Œè®ºæ–‡æå‡ºäº† Nepheleï¼Œä¸€ç§åŸºäºäº‘ç¯å¢ƒçš„å…¨æ–°æ•°æ®å¤„ç†æ¡†æ¶ã€‚å…¶æ¶æ„éµå¾ª master-worker æ¨¡å¼:</p>
<img src="bigdata/./../../assets/images/nephele_architecture.jpg" alt="nephele architecture" width="450"/>
<p>åœ¨ä¸€ä¸ª job æäº¤ä¹‹å‰ï¼Œç”¨æˆ·éœ€è¦å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿è¡Œ <em>Job Manager(JM)</em>ï¼Œå®ƒè´Ÿè´£æ¥æ”¶ç”¨æˆ·æäº¤çš„ Job åŠè°ƒåº¦ï¼Œå®ƒèƒ½å¤Ÿé€šè¿‡äº‘æä¾›çš„æœåŠ¡æ¥å£åŠ¨æ€ç”³è¯·åŠé‡Šæ”¾ VMã€‚</p>
<p>Nephele æ¡†æ¶çš„å¦ä¸€ç§è§’è‰²ä¸º <em>Task Manager(TM)</em>ï¼Œå®ƒä» JM æ¥æ”¶ä»»åŠ¡ï¼Œæ‰§è¡Œä¹‹åå°†å®ŒæˆçŠ¶æ€æˆ–å¯èƒ½çš„é”™è¯¯ä¿¡æ¯æ±‡æŠ¥ç»™ JMã€‚</p>
<p>ä¸€ä¸ªä»»åŠ¡åœ¨ Nephele ä¸­é€šè¿‡ DAG æ¥æè¿°ï¼ŒåŸå› åœ¨äº:</p>
<ol>
<li>DAG å…è®¸ task æœ‰å¤šä¸ªå…¥åº¦å’Œå‡ºåº¦ï¼Œå¯ä»¥æå¤§ç®€åŒ–ä¼ ç»Ÿæ•°æ®ç»“åˆç®—å­ï¼Œå¦‚ join</li>
<li>DAG çš„è¾¹è¡¨ç¤ºäº†æ‰§è¡Œä¸­çš„ Job çš„æ•°æ®ä¼ è¾“è·¯å¾„ï¼ŒNephele å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯åˆ¤æ–­å“ªäº›å®ä¾‹å¯ä»¥å…³é—­é‡Šæ”¾</li>
</ol>
<p>ä¸€ä¸ª Nephele Job çš„å®šä¹‰ç”±ä¸‰ä¸ªæ‰‹åŠ¨æ­¥éª¤æ„æˆ:</p>
<ol>
<li>the user must write the program code for each task of his processing job or select it from an external library</li>
<li>the task program must be assigned to a vertex</li>
<li>the vertices must be connected by edges to define the communication paths of the job</li>
</ol>
<p>ç”¨æˆ·é€šè¿‡ Job Graph åœ¨ä¸€ä¸ªæŠ½è±¡çš„å±‚çº§æè¿°ä»»åŠ¡å’Œä»»åŠ¡ä¹‹é—´çš„å…³ç³»ï¼Œå°†ä»»åŠ¡å¹¶è¡Œåº¦åŠä»»åŠ¡åœ¨å®ä¾‹ä¸Šçš„è°ƒåº¦ç•™ç»™ Nepheleã€‚ç”¨æˆ·è¿˜å¯ä»¥åœ¨ä»»åŠ¡æè¿°ä¸­å¢åŠ æ³¨è§£ç»™ Job Graph æä¾›æ›´å¤šä¿¡æ¯ï¼Œå¦‚:</p>
<ul>
<li>Number of subtasks</li>
<li>NUmber of subtasks per instance</li>
<li>Sharing instances between tasks</li>
<li>Channel types</li>
<li>Instance type</li>
</ul>
<img src="bigdata/./../../assets/images/nephele_job_graph.jpg" alt="nephele architecture" width="450"/>
<p>åœ¨æ¥æ”¶åˆ°ç”¨æˆ·çš„ Job Graph åï¼ŒJM å°†å…¶è½¬æ¢ä¸º <em>Execution Graph</em>ï¼Œè¿™æ˜¯ Nephele è°ƒåº¦å’Œç›‘æ§çš„ä¸»è¦æ•°æ®ç»“æ„ã€‚ç›¸å¯¹ Job Graph åªåœ¨æŠ½è±¡å±‚æ¬¡æè¿°ä»»åŠ¡ï¼ŒExectution Graph å¤šäº†ç‰©ç†å±‚æ¬¡ä»»åŠ¡è°ƒåº¦åˆ°å…·ä½“å®ä¾‹çš„ä¿¡æ¯åŠ tasks ä¹‹é—´çš„é€šä¿¡é€šé“:</p>
<img src="bigdata/./../../assets/images/nephele_execution_graph.jpg" alt="nephele architecture" width="450"/>
<p>å…¶ä¸­å‡ ä¸ªé‡è¦çš„æ¦‚å¿µ:</p>
<ul>
<li><strong>Execution Stage</strong> ä¸€ä¸ª Exection Stage æ‰§è¡Œä¹‹å‰ï¼Œå¿…é¡»ä¿è¯å…¶å‰åº Execution Stage éƒ½å·²æ‰§è¡Œå®Œæ¯•ï¼Œå®ƒçš„å¦å¤–ä¸‰ä¸ªç‰¹æ€§ä½¿å¾—å®ƒå¯ä»¥ç±»æ¯”ä¸º checkpoint
<ul>
<li>when the processing of a stage begins, all instances required within the stage are allocated</li>
<li>all subtasks included in this stage are set up and ready to receive records</li>
<li>before the processing of a new stage, all intermediate results of its preceding stages are stored in a persistent manner</li>
</ul>
</li>
<li><strong>Group Vertex</strong> å¯¹åº”ä¸€ä¸ª Job çš„ä¸€ä¸ª taskï¼Œå¦‚æœæœ‰å¹¶å‘ï¼Œåˆ™ä¸€ä¸ª Group Vertex å¯ä»¥æœ‰å¤šä¸ª Execution Vertex</li>
<li><strong>Execution Instance</strong> æ‰§è¡Œå®ä¾‹ï¼Œå¤šä¸ª Group Vertex å¯ä»¥è°ƒåº¦åœ¨åŒä¸€ä¸ª Exectuion Instance è¿›è€Œæé«˜ Data Locality</li>
<li><strong>Channels</strong> Nephele è¦æ±‚æ‰€æœ‰çš„è¾¹éƒ½æ›¿æ¢æˆ channelï¼ŒåŒ…æ‹¬å¦‚ä¸‹å‡ ç§:
<ul>
<li>Network channels - è¦æ±‚é€šä¿¡å­ä»»åŠ¡å­˜åœ¨äºåŒä¸€ä¸ª Stage</li>
<li>In-Memory channels - è¦æ±‚é€šä¿¡å­ä»»åŠ¡å­˜åœ¨äºåŒä¸€ä¸ª Stage</li>
<li>File channels - Nephele åªå…è®¸ä¸åŒ Stage çš„å­ä»»åŠ¡ä½¿ç”¨è¿™ç§æ–¹å¼</li>
</ul>
</li>
</ul>
<h3 id="è¯»åæ„Ÿ"><a class="header" href="#è¯»åæ„Ÿ">è¯»åæ„Ÿ</a></h3>
<p>Nephele æ˜¯ Flink çš„å‰èº«ï¼Œè¿™ç§æ ¹æ®ä»»åŠ¡ç”³è¯·èµ„æºã€æŒ‰é‡ä»˜è´¹çš„æ–¹å¼åœ¨äº‘æ—¶ä»£æœ‰ç€å·¨å¤§çš„æœºä¼šï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä½• Snowflakeã€PingCap è¿™æ ·çš„å‚å•†é€æ¸æ’…èµ·çš„ä¸€ä¸ªå› ç´ ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefbigdatapdfsassetspdfsthe_dataflow_modelpdfthe-dataflow-model-a-practical-approach-to-balancing-correctness-latency-and-cost-in-massivescale-unbounded-outoforder-data-processinga"><a class="header" href="#a-hrefbigdatapdfsassetspdfsthe_dataflow_modelpdfthe-dataflow-model-a-practical-approach-to-balancing-correctness-latency-and-cost-in-massivescale-unbounded-outoforder-data-processinga"><a href="bigdata/../pdfs/../../assets/pdfs/the_dataflow_model.pdf">The Dataflow Model: A Practical Approach to Balancing Correctness, Latency, and Cost in MassiveScale, Unbounded, OutofOrder Data Processing</a></a></h3>
<blockquote>
<p>Proceedings of the VLDB EndowmentVolume 8Issue 12August 2015 pp 1792â€“1803</p>
<p>https://doi.org/10.14778/2824032.2824076</p>
</blockquote>
<p><strong>The future of data processing is unbounded data</strong>ï¼Œå°½ç®¡ bounded data ä¾ç„¶æœ‰ç”¨æ­¦ä¹‹åœ°ï¼Œå®ƒåœ¨è¯­ä¹‰ä¸Šå¯ä»¥è¢«å½’ç±»ä¸º ubounded dataã€‚<code>Dataflow Model</code> å°±æ˜¯è¿™æ ·ä¸€ä¸ªæä¾›æ— ç•Œæ•°æ®å’Œæœ‰ç•Œæ•°æ®ç»Ÿä¸€å¤„ç†æ¡†æ¶çš„æ¨¡å‹ã€‚</p>
<p>è®ºæ–‡ä»‹ç»äº† Windowingã€Time Domains ç›¸å…³çš„å„ç§æ¦‚å¿µï¼Œé™„åŠ äº†å¾ˆå¤šå›¾ä¾‹ï¼ŒApache Flink åœ¨ä¸€å®šç¨‹åº¦ä¸Šå€Ÿé‰´äº†è¯¥è®ºæ–‡çš„ç†å¿µã€‚</p>
<p>é˜…è¯»è¯¥è®ºæ–‡æ˜¯å› ä¸ºæœ€è¿‘åœ¨å­¦ä¹  Flinkï¼Œå¹¶æ€»ç»“äº†ä¸€äº›å­¦ä¹ èµ„æº: <a href="https://zhjwpku.com/2021/11/01/awesome-flink.html">Awesome Flink Learning Resources</a>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefbigdataassetspdfsflinkpdfapache-flink-stream-and-batch-processing-in-a-single-enginea"><a class="header" href="#a-hrefbigdataassetspdfsflinkpdfapache-flink-stream-and-batch-processing-in-a-single-enginea"><a href="bigdata/../assets/pdfs/flink.pdf">Apache Flink: Stream and Batch Processing in a Single Engine</a></a></h3>
<blockquote>
<p>Bulletin of the IEEE Computer Society Technical Committee on Data Engineering, 2015</p>
<p>http://asterios.katsifodimos.com/assets/publications/flink-deb.pdf</p>
</blockquote>
<p>Apache Flink æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†æµå’Œæ‰¹å¤„ç†æ•°æ®çš„å¼€æºç³»ç»Ÿã€‚æœ¬è®ºæ–‡ä»‹ç»äº† Flink çš„æ¶æ„åŠå¦‚ä½•åœ¨ä¸€ä¸ªå¼•æ“ä¸Šå®ç°æµå’Œæ‰¹çš„ç»Ÿä¸€ã€‚</p>
<p>è¶Šæ¥è¶Šå¤šçš„åº”ç”¨éœ€è¦å¤§æ•°æ®å¤„ç†å…·æœ‰å®æ—¶æ€§ï¼Œã€Lambda Architectureã€ é€šè¿‡ç»“åˆæµå¤„ç†å’Œæ‰¹å¤„ç†åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ»¡è¶³äº†è¿™æ ·çš„éœ€æ±‚ï¼Œä½†éœ€è¦æŠŠä¸šåŠ¡é€»è¾‘å®ç°ä¸¤æ¬¡ï¼Œå¢åŠ äº†å¤æ‚æ€§ä¸”æµªè´¹èµ„æºã€‚</p>
<p>Flink çš„å‘å±•å— Google çš„ Dataflow model å’Œ MillWheel çš„å½±å“ã€‚å…¶ software stack å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="bigdata/../assets/images/flink-software-stack.jpg" alt="Flink software stack" /></p>
<p><code>Runtime</code> ä½œä¸º Flink çš„æ ¸å¿ƒï¼Œè´Ÿè´£æ‰§è¡Œ <code>dataflow</code> ä»»åŠ¡ï¼Œå…¶ä¸Šçš„ DataSet API æä¾›æ‰¹å¤„ç†æ¥å£ï¼ŒDataStream API æä¾›æµå¤„ç†æ¥å£ã€‚æ‰¹å¤„ç†æ˜¯ä¸€ç§æœ‰ç•Œçš„æµå¤„ç†ï¼ŒäºŒè€…éƒ½ä¼šç”Ÿæˆåœ¨ <code>Runtime</code> ä¸Šè¿è¡Œçš„ <code>dataflow</code>ã€‚</p>
<p><img src="bigdata/../assets/images/flink-process-model.jpg" alt="Flink process model" /></p>
<p>é€šè¿‡åœ¨æ•°æ®æµä¸­æ’å…¥ <code>checkpoint barries</code>ï¼Œä½¿ç”¨ <a href="bigdata/../distributedsystem/abs.html">ABS</a> ç®—æ³•å®ç° <code>exactly once</code> è¯­ä¹‰ã€‚</p>
<p>é€šè¿‡åœ¨æ•°æ®æµä¸­æ’å…¥ <code>watermarks</code> æ¥å®ç° <code>window function</code>ã€‚</p>
<p>æä¾›ä¸‰ç§æ—¶é—´å¤„ç†æ–¹å¼:</p>
<ul>
<li>event-time</li>
<li>process-time</li>
<li>ingest-time</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefbigdataassetspdfsstate-management-in-apache-flinkpdfstate-management-in-apache-flinka"><a class="header" href="#a-hrefbigdataassetspdfsstate-management-in-apache-flinkpdfstate-management-in-apache-flinka"><a href="bigdata/../assets/pdfs/state-management-in-apache-flink.pdf">State Management in Apache Flink</a></a></h3>
<blockquote>
<p>PVLDB, Aug 2017</p>
<p>https://dl.acm.org/doi/10.14778/3137765.3137777</p>
</blockquote>
<p>æµå¤„ç†é™¤äº†éœ€è¦å…·å¤‡å¯æ‰©å±•å’Œä½å»¶è¿Ÿçš„ç‰¹æ€§ï¼Œä¸€ä¸ªæ—¥ç›Šå¢é•¿çš„éœ€æ±‚æ˜¯å¼ºä¸€è‡´æ€§ä¿è¯å’Œå¯¹é›†ç¾¤é…ç½®å˜æ›´ã€patchã€æ•…éšœçš„é€‚åº”æ€§ã€‚Flink æä¾›çš„è½»é‡åˆ†å¸ƒå¼å¿«ç…§æœºåˆ¶ä¿è¯åº”ç”¨çŠ¶æ€çš„ä¸€è‡´æ€§ï¼Œä¸”ä¸å½±å“åº”ç”¨ç¨‹åºçš„æŒç»­æ‰§è¡Œã€‚</p>
<p>Flink çŠ¶æ€ç®¡ç†çš„æ ¸å¿ƒå»ºç«‹åœ¨åˆ†å¸ƒå¼å¿«ç…§ä¹‹ä¸Šï¼Œåˆ†å¸ƒå¼å¿«ç…§èƒ½å¤Ÿå°†åˆ†å¸ƒå¼è¿›ç¨‹å›æ»šåˆ°ä¹‹å‰å…¨å±€ä¸€è‡´çš„æ‰§è¡ŒçŠ¶æ€ï¼Œè¿™ç§å›æ»šæ˜¯ç²—ç²’åº¦çš„ï¼Œå¯ç”¨äºè§£å†³é…ç½®å˜æ›´ã€å®¹é”™å’Œç‰ˆæœ¬ç®¡ç†ç­‰é—®é¢˜ã€‚</p>
<blockquote>
<p>Distributed snapshotting protocols enable rollback recovery by producing a correct,
complete state replica of a distributed execution which can be used to restore the
system to an earlier point in time.</p>
</blockquote>
<p>Flink çš„åˆ†å¸ƒå¼å¿«ç…§åœ¨ <a href="bigdata/../distributedsystem/abs.html">abs</a> ä¸­æœ‰æ‰€ä»‹ç»ï¼Œç±»ä¼¼ <code>chandy-lamport</code> ç®—æ³•ï¼Œä¸è¿‡æ›´é€‚åˆå¼±è¿æ¥çš„æ•°æ®æµå›¾ã€‚</p>
<blockquote>
<p>Weakly connected graphs are inherently relevant to distributed dataflow processing systems.</p>
</blockquote>
<p><img src="bigdata/../../assets/images/flink-state-management-architecture.jpg" alt="Flink System Architecture" /></p>
<p>Flink çš„ç®—å­å¯ä»¥ç»´æŠ¤ä¸€äº›çŠ¶æ€ï¼ŒåŒ…æ‹¬ <code>Keyed-State</code> å’Œ <code>Operator-State</code>ï¼Œ<code>Keyed-State</code> é€šè¿‡ <code>Key-Groups</code> åˆ†é…åˆ°ä¸åŒçš„ physical taskï¼Œè€Œ <code>Operator-State</code> å­˜åœ¨äºæ¯ä¸€ä¸ª physical taskã€‚</p>
<blockquote>
<p>Operator State (or non-keyed state) is state that is is bound to one parallel operator instance.</p>
</blockquote>
<p><code>Keyed-State</code> åœ¨ä»»åŠ¡ä¼¸ç¼©çš„æ—¶å€™èƒ½å¤Ÿé‡æ–°åˆ†é…ï¼Œå› è€Œèƒ½é€‚åº” subtask æ•°ç›®çš„å˜æ›´ï¼ŒFlink æ”¯æŒçš„ <code>Keyed-State</code> åŒ…æ‹¬:</p>
<ul>
<li>ValueState</li>
<li>ListState</li>
<li>ReduceState</li>
<li>MapState</li>
</ul>
<h4 id="pipelined-consistent-snapshots"><a class="header" href="#pipelined-consistent-snapshots">Pipelined Consistent Snapshots</a></h4>
<p>ä¸€ä¸ªåˆ†å¸ƒå¼æµä»»åŠ¡å¯ä»¥è¢«å®šæ—¶ç”Ÿæˆçš„ <code>markers</code> åˆ‡åˆ†ä¸ºä¸åŒçš„ <code>epoch</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="bigdata/../assets/images/flink-state-management-cuts.jpg" alt="flink stream cuts" /></p>
<p>å½“ä¸€ä¸ª task æœ‰å¤šä¸ª input çš„æ—¶å€™ï¼Œéœ€è¦è¿›è¡Œ <code>alignment</code>ï¼Œå¦‚ä¸Šå›¾ä¸­çš„ <code>t3</code> å’Œ <code>t5</code>ï¼Œå¿«ç…§çš„æ‰§è¡Œç”± <code>JobManager</code> åè°ƒï¼Œ<code>JobManager</code> ä¿å­˜å¿«ç…§çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¦‚å¿«ç…§çš„ç›®å½•ä½ç½®ï¼Œ<code>JobManager</code> å¯ä»¥å°†å…³é”®çš„å…ƒæ•°æ®ä¿¡æ¯ä¿å­˜åˆ° <code>Zookeeper</code> æ¥ä¿è¯é«˜å¯ç”¨ï¼Œå…ƒæ•°æ®çš„ä¸Šä¼ å¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œå› ä¸ºæ€»èƒ½ä¿è¯èƒ½å¤Ÿå›æ»šåˆ°ä¸€ä¸ªæ›´å…ˆå‰çš„å¿«ç…§ç‰ˆæœ¬ã€‚</p>
<p>Flink çš„å¿«ç…§ç®—æ³•è¿˜ä¾èµ–ä»¥ä¸‹ä¸‰ä¸ªå‡è®¾:</p>
<ol>
<li>Input data streams are durably logged and indexed externally allowing dataflow sources to re-consume their input, upon recovery, from a specific logical time (offset) by restoring their state.</li>
<li>Directional data channels between tasks are reliable, respect FIFO delivery and can be blocked or unblocked.</li>
<li>Tasks can trigger a block or unblock operation on their input data channels and a send operation (records or control messages) on their output channels.</li>
</ol>
<p>æœ‰å‘æ— ç¯å›¾çš„ <code>alignment</code> ç®—æ³•å¦‚ä¸‹:</p>
<p><img src="bigdata/../assets/images/flink-state-management-snapshot-alignment.jpg" alt="Snapshot Alignment" /></p>
<p>æœ‰ç¯å›¾åˆ™é€šè¿‡ <code>IterationHead</code> å’Œ <code>IterationTail</code> éšå¼ä»»åŠ¡æ”¯æŒã€‚ä»»åŠ¡å¯ä»¥è®¾ç½®å¿½ç•¥ <code>aligment</code> æ¥æ”¯æŒ <code>Relaxing Consistency</code>ã€‚</p>
<p>Flink ä»»åŠ¡çš„é…ç½®ä¿®æ”¹éµå¾ª <code>checkpoint-stop-modify-restore</code> çš„æ¨¡å¼ã€‚</p>
<p>ç®—å­æ”¯æŒ <code>Local state</code> å’Œ <code>External state</code>ï¼ŒçŠ¶æ€å¯ä»¥è¢«å£°æ˜ä¸º <code>Queryable State</code> è¢«å¤–éƒ¨è®¿é—®ã€‚</p>
<p>Flink ä»»åŠ¡ä¾èµ–åˆ†å¸ƒå¼å¿«ç…§ç®—æ³•ï¼Œæ”¯æŒ <code>at least once</code> çš„è¯­ä¹‰ï¼Œå¦‚æœè¦æ”¯æŒ <code>exactly once</code> è¯­ä¹‰ï¼Œåˆ™éœ€è¦ sink ç«¯ä¸º <code>Idemponet Sinks</code> æˆ– <code>Transational Sinks</code>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="compiler"><a class="header" href="#compiler">Compiler</a></h2>
<ul>
<li>C Lattner, et al., CGO 2004 <a href="https://dl.acm.org/doi/pdf/10.5555/977395.977673">LLVM: A Compilation Framework for Lifelong Program Analysis &amp; Transformation</a></li>
<li>C Lattner, et al., CGO 2021 <a href="https://rcs.uwaterloo.ca/%7Eali/cs842-s23/papers/mlir.pdf">MLIR: Scaling Compiler Infrastructure for Domain Specific Computation</a>
<ul>
<li><a href="https://www.youtube.com/watch?v=C_MdJu70z2o">Presentation</a> ğŸ“¹</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="databases"><a class="header" href="#databases">databases</a></h2>
<ul>
<li><strong><a href="databases/cloudnative/index.html">Cloud Native Database Systems</a></strong>
<ul>
<li><strong><a href="databases/cloudnative/aurora.html">Amazon Aurora: Design Considerations for High Throughput Cloud-Native Relational Databases</a></strong></li>
<li><strong><a href="databases/cloudnative/taurus.html">Taurus Database: How to be Fast, Available, and Frugal in the Cloud</a></strong></li>
</ul>
</li>
<li><strong><a href="databases/colum-stores-vs-row-stores.html">Column-stores vs. row-stores: how different are they really?</a></strong></li>
<li><strong><a href="databases/mmdb/index.html">Main Memory Database Systems</a></strong>
<ul>
<li><strong><a href="databases/mmdb/overview.html">Main Memory Database Systems: An Overview</a></strong></li>
</ul>
</li>
<li><strong><a href="databases/kv/index.html">KV databases</a></strong>
<ul>
<li><strong><a href="databases/kv/optimizing-space-amplification-in-rocksdb.html">Optimizing Space Amplification in RocksDB</a></strong></li>
<li><strong><a href="databases/kv/wisckey.html">WiscKey: Separating Keys from Values in SSD-Conscious Storage</a></strong></li>
</ul>
</li>
<li><strong><a href="databases/oltp/index.html">OLTP</a></strong>
<ul>
<li><strong><a href="databases/oltp/oltp-through-the-looking-glass.html">OLTP Through the Looking Glass, and What We Found There</a></strong></li>
<li><strong><a href="databases/oltp/staring-into-the-abyss.html">Staring into the Abyss: An Evaluation of Concurrency Control with One Thousand Cores</a></strong></li>
</ul>
</li>
<li><strong><a href="databases/olap/index.html">OLAP</a></strong>
<ul>
<li><strong><a href="databases/olap/lakehouse.html">Lakehouse: A New Generation of Open Platforms that Unify DataWarehousing and Advanced Analytics</a></strong></li>
<li><strong><a href="databases/olap/delta-lake.html">Delta Lake: HighPerformance ACID Table Storage over Cloud Object Stores</a></strong></li>
<li><strong><a href="databases/olap/vertica.html">The Vertica Analytic Database: C-Store 7 Years Later</a></strong></li>
<li><strong><a href="databases/olap/duckdb.html">Data Management for Data Science Towards Embedded Analytics</a></strong></li>
</ul>
</li>
<li><strong><a href="databases/htap/index.html">HTAP</a></strong>
<ul>
<li><strong><a href="databases/htap/greenplum-htap.html">Greenplum: A Hybrid Database for Transactional and Analytical Workloads</a></strong></li>
</ul>
</li>
<li><strong><a href="databases/vectordb/index.html">Vector DB</a></strong>
<ul>
<li><strong><a href="databases/vectordb/hnsw.html">Hierarchical NSW</a></strong></li>
<li><strong><a href="databases/vectordb/ivf-hnsw.html">IVF-HNSW</a></strong></li>
<li><strong><a href="databases/vectordb/diskann.html">DiskANN</a></strong></li>
<li><strong><a href="databases/vectordb/pq.html">Product Quantization</a></strong></li>
</ul>
</li>
<li><strong><a href="databases/graphdb/index.html">Graph Database</a></strong>
<ul>
<li><strong><a href="https://arxiv.org/pdf/2112.06217">Graph Pattern Matching in GQL and SQL/PGQ</a></strong></li>
<li><strong><a href="databases/graphdb/kuzu.html">KÃ™ZU Graph Database Management System</a></strong></li>
</ul>
</li>
<li><strong><a href="databases/citus.html">Citus: Distributed PostgreSQL for Data-Intensive Applications</a></strong></li>
<li><strong><a href="databases/optimizer/index.html">Optimizer</a></strong></li>
<li><strong><a href="databases/executor/index.html">Executor</a></strong>
<ul>
<li><strong><a href="databases/executor/volcano.html">Volcano â€” An Extensible and Parallel Query Evaluation System</a></strong></li>
</ul>
</li>
<li><strong><a href="databases/concurrencycontrol/index.html">Concurrency Control</a></strong>
<ul>
<li><strong><a href="databases/concurrencycontrol/empirical-evaluation-of-mvcc.html">An Empirical Evaluation of In-Memory Multi-Version Concurrency Control</a></strong></li>
</ul>
</li>
<li><strong><a href="databases/cdc/index.html">Change Data Capture</a></strong>
<ul>
<li><strong><a href="databases/cdc/dblog.html">DBLog: AWatermark Based Change-Data-Capture Framework</a></strong></li>
</ul>
</li>
<li><strong><a href="databases/rum.html">Designing Access Methods: The RUM Conjecture</a></strong></li>
</ul>
<h4 id="optional-readings"><a class="header" href="#optional-readings">Optional readings</a></h4>
<ul>
<li>M. Stonebraker, et al., <a href="databases/./../assets/pdfs/whatgoesaround-stonebraker.pdf">What Goes Around Comes Around</a></li>
<li>A. Pavlo, et al., <a href="databases/../assets/pdfs/pavlo-newsql-sigmodrec2016.pdf">Whatâ€™s Really New with NewSQL?</a></li>
<li>Yihe Huang, et al., <a href="databases/../assets/pdfs/opportunities_for_optimism_in_contented_main-memory_multicore_transactions.pdf">Opportunities for Optimism in Contended MainMemory Multicore Transactions</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="cloud-native-database-systems"><a class="header" href="#cloud-native-database-systems">Cloud Native Database Systems</a></h2>
<ul>
<li><strong><a href="databases/cloudnative/aurora.html">Amazon Aurora: Design Considerations for High Throughput Cloud-Native Relational Databases</a></strong></li>
<li><strong><a href="databases/cloudnative/taurus.html">Taurus Database: How to be Fast, Available, and Frugal in the Cloud</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasescloudnativeassetspdfsaurora-sigmod-17pdfamazon-aurora-design-considerations-for-high-throughput-cloud-native-relational-databasesa"><a class="header" href="#a-hrefdatabasescloudnativeassetspdfsaurora-sigmod-17pdfamazon-aurora-design-considerations-for-high-throughput-cloud-native-relational-databasesa"><a href="databases/cloudnative/../../assets/pdfs/aurora-sigmod-17.pdf">Amazon Aurora: Design Considerations for High Throughput Cloud-Native Relational Databases</a></a></h3>
<blockquote>
<p>SIGMOD 2017</p>
<p>https://www.amazon.science/publications/amazon-aurora-design-considerations-for-high-throughput-cloud-native-relational-databases</p>
</blockquote>
<p>æœ¬æ–‡æè¿°äº† Aurora çš„æ¶æ„ä»¥åŠè®¾è®¡è€ƒè™‘ï¼Œé«˜ååé‡æ•°æ®å¤„ç†çš„ä¸»è¦ç“¶é¢ˆå·²ä»è®¡ç®—å’Œå­˜å‚¨è½¬ç§»åˆ°ç½‘ç»œï¼ŒAurora é€šè¿‡å°† redo log å¤„ç†æ¨é€åˆ°ä¸€ä¸ªä¸“ç”¨çš„å¤šç§Ÿæˆ·å¯æ‰©å±•çš„å­˜å‚¨æœåŠ¡ï¼Œå‡å°‘äº†ç½‘ç»œæµé‡ï¼ŒåŒæ—¶å…è®¸å¿«é€Ÿå´©æºƒæ¢å¤ã€æ— æ•°æ®ä¸¢å¤±çš„å‰¯æœ¬æ•…éšœåˆ‡æ¢ã€‚</p>
<p>åœ¨åˆ†å¸ƒå¼äº‘æœåŠ¡ä¸­ï¼Œé€šè¿‡è®¡ç®—ä¸å­˜å‚¨åˆ†ç¦»ï¼ˆå­˜ç®—åˆ†ç¦»ï¼‰å’Œå¤šèŠ‚ç‚¹å­˜å‚¨å¤åˆ¶ï¼Œå¢åŠ äº†äº‘æœåŠ¡çš„å¼¹æ€§å’Œå¯æ‰©å±•æ€§ã€‚åœ¨è¿™ç§ç¯å¢ƒä¸­ï¼Œä¼ ç»Ÿæ•°æ®åº“ç³»ç»Ÿé¢ä¸´çš„ I/O ç“¶é¢ˆå‘ç”Ÿå˜åŒ–ã€‚ç”±äº I/O å¯ä»¥åˆ†æ•£åˆ°å¤šèŠ‚ç‚¹å’Œå¤šç£ç›˜çš„é›†ç¾¤ä¸­ï¼Œå•ä¸ªç£ç›˜å’ŒèŠ‚ç‚¹ä¸å†æ˜¯çƒ­ç‚¹ã€‚ç“¶é¢ˆè½¬ç§»åˆ°è¯·æ±‚ I/O çš„æ•°æ®åº“å±‚ä¸æ‰§è¡Œ I/O çš„å­˜å‚¨å±‚ä¹‹é—´çš„ç½‘ç»œã€‚æœ€æ…¢çš„å­˜å‚¨èŠ‚ç‚¹ã€ç£ç›˜æˆ–ç½‘ç»œè·¯å¾„çš„æ€§èƒ½ä¼šä¸»å¯¼å“åº”æ—¶é—´ã€‚</p>
<p>æ•°æ®åº“ä¸­çš„å¤§å¤šæ•°æ“ä½œå¯ä»¥é‡å è¿›è¡Œï¼Œä½†æŸäº›æƒ…å†µéœ€è¦åŒæ­¥æ“ä½œï¼Œå¯¼è‡´åœæ»å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ä¾‹å¦‚ï¼Œç¼“å­˜æœªå‘½ä¸­çš„ç£ç›˜è¯»å–ä¼šå¯¼è‡´è¯»çº¿ç¨‹ç­‰å¾…ï¼Œå¯èƒ½è¿˜éœ€è¦ç¼“å­˜æ›¿æ¢å’Œåˆ·è„ç¼“å­˜é¡µã€‚checkpoint å’Œè„é¡µå†™å…¥ç­‰åå°å¤„ç†å¯ä»¥å‡å°‘è¿™ç§é—®é¢˜ï¼Œä½†ä¹Ÿä¼šå¼•èµ·åœæ»ã€ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œèµ„æºäº‰ç”¨ï¼›äº‹åŠ¡æäº¤æ˜¯å¦ä¸€ä¸ªå¹²æ‰°æºï¼Œæäº¤åœæ»ä¼šé˜»ç¢å…¶å®ƒäº‹åŠ¡ã€‚ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰åœ¨äº‘åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤„ç†ä¹Ÿå…·æœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸ºè¿™äº›åè®®ä¸å®¹å¿æ•…éšœä¸”å»¶è¿Ÿé«˜ã€‚</p>
<p>Aurora é€šè¿‡æ›´æ¿€è¿›åœ°ä½¿ç”¨ redo log æ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæ¯ä¸ªå®ä¾‹ä»åŒ…å«ä¼ ç»Ÿæ•°æ®åº“å†…æ ¸çš„å¤§éƒ¨åˆ†ç»„ä»¶ï¼ˆæŸ¥è¯¢å¤„ç†å™¨ã€äº‹åŠ¡ã€é”å®šã€ç¼“å†²ç¼“å­˜ã€è®¿é—®æ–¹æ³•å’Œ undo ç®¡ç†ï¼‰ï¼Œä½†ä¸€äº›åŠŸèƒ½ï¼ˆredo logã€æŒä¹…å­˜å‚¨ã€å´©æºƒæ¢å¤å’Œå¤‡ä»½/æ¢å¤ï¼‰è¢«è½¬ç§»åˆ°å­˜å‚¨æœåŠ¡ä¸­å¤„ç†ã€‚</p>
<p>Aurora çš„æ¶æ„ç›¸æ¯”ä¼ ç»Ÿæ•°æ®åº“çš„ä¸‰å¤§ä¼˜åŠ¿:</p>
<ul>
<li>é€šè¿‡åœ¨å¤šä¸ªæ•°æ®ä¸­å¿ƒæ„å»ºç‹¬ç«‹çš„å®¹é”™å’Œè‡ªæ„ˆå­˜å‚¨æœåŠ¡ï¼Œä¿æŠ¤æ•°æ®åº“å…å—ç½‘ç»œæˆ–å­˜å‚¨å±‚çš„æ€§èƒ½æ³¢åŠ¨å’Œä¸´æ—¶æˆ–æ°¸ä¹…æ•…éšœçš„å½±å“</li>
<li>ä»…å°† redo log è®°å½•å†™å…¥å­˜å‚¨æœåŠ¡ï¼Œå°†ç½‘ç»œ IOPS é™ä½äº†ä¸€ä¸ªæ•°é‡çº§</li>
<li>å°†ä¸€äº›æœ€å¤æ‚å’Œæœ€å…³é”®çš„åŠŸèƒ½ï¼ˆå¤‡ä»½å’Œé‡åšæ¢å¤ï¼‰ä»æ•°æ®åº“å¼•æ“ä¸­çš„ä¸€æ¬¡æ€§æ˜‚è´µæ“ä½œè½¬å˜ä¸ºè·¨å¤§è§„æ¨¡åˆ†å¸ƒå¼é›†ç¾¤çš„è¿ç»­å¼‚æ­¥æ“ä½œï¼Œå®ç°äº†æ— éœ€ checkpoint çš„è¿‘ä¹å³æ—¶å´©æºƒæ¢å¤ä»¥åŠä¸å½±å“å‰å°å¤„ç†çš„ä½æˆæœ¬å¤‡ä»½</li>
</ul>
<h4 id="durability-at-scale"><a class="header" href="#durability-at-scale">DURABILITY AT SCALE</a></h4>
<p>Aurora ä½¿ç”¨äº† 6 å‰¯æœ¬çš„å¤åˆ¶æœºåˆ¶ï¼Œæ¯ä¸ªæ•°æ®åœ¨ä¸‰ä¸ª AZ ä¸­åˆ†åˆ«å¤åˆ¶ä¸¤æ¬¡ï¼Œè¿™æ ·èƒ½å¤Ÿå®¹å¿å•ä¸ª AZ + ä¸€ä¸ªé¢å¤–èŠ‚ç‚¹çš„ä¸¢å¤±ï¼ˆAZ + 1ï¼‰è€Œä¸ä¸¢å¤±æ•°æ®ã€‚</p>
<ul>
<li>write quorum 4/6 (Vw = 4)</li>
<li>read quorum 3/6 (Vr = 3)</li>
</ul>
<p>ä¸‰å‰¯æœ¬åˆ™ä¸èƒ½è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œå› ä¸ºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç£ç›˜æŸåè¢«è®¤ä¸ºæ˜¯æ­£å¸¸çš„ç°è±¡ï¼Œå¦‚æœåŒæ—¶æœ‰ä¸€ä¸ª AZ å› ä¸ºè‡ªç„¶ç¾å®³ä¸¢å¤±ï¼Œé‚£ä¹ˆä¼šå¤±å»ä¸¤ä¸ªå‰¯æœ¬ï¼Œæ— æ³•ç¡®å®šç¬¬ä¸‰ä¸ªå‰¯æœ¬æ˜¯å¦æ˜¯æœ€æ–°çš„ã€‚</p>
<p>Aurora çš„å•ä¸ª AZ æ”¾ç½®ä¸¤ä¸ªå‰¯æœ¬å¯¹äºå¸¸è§çš„ç£ç›˜æ•…éšœæ¢å¤èƒ½å¤Ÿæ›´å¿«ä»æœ¬ AZ æ¢å¤æ•°æ®ã€‚</p>
<p>ä¸ºäº†è¿›ä¸€æ­¥å‡å°‘ MTTR (Mean Time to Repair)ï¼ŒAurora å°†æ•°æ®åº“å·åˆ†å‰²æˆå°çš„å›ºå®šå¤§å°çš„æ®µï¼ˆ10GBï¼Œæ•…éšœå’Œä¿®å¤çš„åŸºæœ¬å•ä½ï¼‰ï¼Œè¿™äº›æ®µä»¥ 6 å‰¯æœ¬çš„æ–¹å¼åˆ†å¸ƒåˆ° Protection Groups (PG) ä¸­ï¼Œæ¯ä¸ª PG ç”±å…­ä¸ª 10GB æ®µç»„æˆï¼Œåˆ†å¸ƒåœ¨ä¸‰ä¸ª AZ ä¸­ï¼Œæ¯ä¸ª AZ ç®¡ç†å•ä¸ª PG çš„ä¸¤ä¸ªæ®µã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒAurora èƒ½å¤Ÿåœ¨ä¸€ä¸ªå‰¯æœ¬å‡ºç°æ•…éšœæ—¶å¿«é€Ÿä¿®å¤ï¼ˆåœ¨ 10Gbps çš„ç½‘ç»œé“¾æ¥ä¸Šï¼Œä¿®å¤ä¸€ä¸ª 10GB çš„æ®µéœ€è¦10ç§’ï¼‰ï¼Œæä¾›é«˜å¯ç”¨æ€§ã€‚</p>
<p>å¦‚æœåœ¨åŒä¸€ä¸ª 10 ç§’çª—å£å†…çœ‹åˆ°ä¸¤ä¸ªè¿™æ ·çš„æ•…éšœï¼Œå†åŠ ä¸Šä¸€ä¸ªä¸åŒ…å«è¿™ä¸¤ä¸ªç‹¬ç«‹æ•…éšœçš„ AZ æ•…éšœï¼Œæ‰ä¼šå¯¼è‡´æ•°æ®åº“çš„ä¸å¯ç”¨ï¼Œä½†æ ¹æ® AWS å¯¹å®¢æˆ·å¤§é‡æ•°æ®åº“çš„è§‚å¯Ÿï¼Œè¿™ç§æƒ…å†µæä¸å¯èƒ½å‘ç”Ÿã€‚</p>
<h4 id="the-log-is-the-database"><a class="header" href="#the-log-is-the-database">THE LOG IS THE DATABASE</a></h4>
<p><img src="databases/cloudnative//assets/images/aurora_network_io_in_mirrored_mysql.png" alt="Network IO in mirrored MySQL" /></p>
<p>åœ¨äº‘ä¸Šï¼Œä¼ ç»Ÿçš„æ•°æ®åº“ä¼šæœ‰ä¸¥é‡çš„å†™æ”¾å¤§é—®é¢˜ï¼Œæ¯”å¦‚ä¸Šå›¾æ˜¯ä¸€ä¸ªåŒæ­¥ä¸»å¤‡çš„ MySQL é…ç½®ï¼ŒAZ1 ä¸­æœ‰ä¸€ä¸ªæ´»è·ƒçš„ MySQL å®ä¾‹ï¼Œæ•°æ®å†™å…¥åˆ° EBS å­˜å‚¨ä¸Šï¼ˆnetworked storageï¼‰ï¼›åŒæ—¶ï¼Œåœ¨ AZ2 ä¸­æœ‰ä¸€ä¸ªå¤‡ç”¨çš„ MySQL å®ä¾‹ï¼Œä¹Ÿä½¿ç”¨ EBS è¿›è¡Œå­˜å‚¨ã€‚é‡åšæ—¥å¿—ã€binary logï¼ˆä¸ºäº†æ”¯æŒæ—¶é—´ç‚¹æ¢å¤ï¼Œå½’æ¡£åˆ°Amazon S3ï¼‰ã€ä¿®æ”¹åçš„æ•°æ®é¡µã€Double writeï¼ˆåŒå†™ï¼Œé˜²æ­¢é¡µé¢æ’•è£‚ï¼‰ä»¥åŠå…ƒæ•°æ®ï¼ˆFRMï¼‰æ–‡ä»¶éƒ½é€šè¿‡ç½‘ç»œè¿›è¡Œå†™å…¥ï¼Œç”±äºå¾ˆå¤šå†™å…¥æ˜¯é¡ºåºçš„ï¼Œå»¶è¿Ÿä¼šç´¯åŠ ã€‚</p>
<p>åœ¨ Aurora ä¸­ï¼Œè·¨ç½‘ç»œä¼ è¾“çš„å”¯ä¸€å†™å…¥æ˜¯ redo logã€‚æ•°æ®åº“å±‚ä¸å†™å…¥é¡µé¢ï¼Œæ— è®ºæ˜¯åå°å†™å…¥ã€æ£€æŸ¥ç‚¹è¿˜æ˜¯ç¼“å­˜é¡µæ¢å‡ºæ—¶åˆ·è„é¡µã€‚ç›¸åï¼Œlog applicator ä¸‹æ²‰åˆ°å­˜å‚¨å±‚ï¼Œåœ¨é‚£é‡Œå®ƒå¯ä»¥ç”¨äºåå°æˆ–æŒ‰éœ€ç”Ÿæˆæ•°æ®åº“é¡µé¢ã€‚</p>
<p>æ˜¾ç„¶ï¼Œä»æ—¶é—´å¼€å§‹çš„æ‰€æœ‰ä¿®æ”¹é“¾ç”Ÿæˆæ¯ä¸ªé¡µé¢æ˜¯æå…¶æ˜‚è´µçš„ã€‚å› æ­¤ï¼Œåå°ä¼šä¸æ–­åœ°ç‰©åŒ–æ•°æ®åº“é¡µé¢ï¼Œä»¥é¿å…æ¯æ¬¡æŒ‰éœ€ç”Ÿæˆå®ƒä»¬ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»æ­£ç¡®æ€§çš„è§’åº¦æ¥çœ‹ï¼Œåå°ç‰©åŒ–æ˜¯å¯é€‰çš„ï¼šå¯¹äºå¼•æ“è€Œè¨€ï¼Œ<strong>æ—¥å¿—å°±æ˜¯æ•°æ®åº“</strong>ï¼Œå­˜å‚¨ç³»ç»Ÿç‰©åŒ–çš„ä»»ä½•é¡µé¢åªæ˜¯æ—¥å¿—åº”ç”¨çš„ç¼“å­˜ã€‚è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œä¸æ£€æŸ¥ç‚¹ä¸åŒï¼Œåªæœ‰å…·æœ‰é•¿ä¿®æ”¹é“¾çš„é¡µé¢éœ€è¦é‡æ–°ç‰©åŒ–ã€‚æ£€æŸ¥ç‚¹ç”±æ•´ä¸ªé‡åšæ—¥å¿—é“¾çš„é•¿åº¦å†³å®šï¼Œè€Œ Aurora é¡µé¢ç‰©åŒ–åˆ™ç”±ç»™å®šé¡µé¢çš„é“¾é•¿åº¦å†³å®šã€‚</p>
<p><img src="databases/cloudnative//assets/images/aurora_network_io_in_aurora.png" alt="Network IO in Amazon Aurora" /></p>
<p>Aurora çš„æ–¹æ³•å°½ç®¡å¢åŠ äº†å¤åˆ¶æ‰€éœ€çš„å†™å…¥é‡ï¼Œä½†æ˜¾è‘—é™ä½äº†ç½‘ç»œè´Ÿè½½ï¼Œä¸Šå›¾å±•ç¤ºäº†ä¸€ä¸ª Aurora é›†ç¾¤ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªä¸»å®ä¾‹å’Œå¤šä¸ªè·¨å¤š AZ éƒ¨ç½²çš„å‰¯æœ¬å®ä¾‹ã€‚ä¸»å®ä¾‹ä»…å°†æ—¥å¿—è®°å½•å†™å…¥å­˜å‚¨æœåŠ¡ï¼Œå¹¶å°†è¿™äº›æ—¥å¿—è®°å½•ä»¥åŠå…ƒæ•°æ®æ›´æ–°æµå¼ä¼ è¾“åˆ°å‰¯æœ¬å®ä¾‹ã€‚I/O æµç¨‹åŸºäºå…±åŒçš„ç›®çš„åœ°ï¼ˆä¸€ä¸ªé€»è¾‘æ®µï¼Œå³ä¸€ä¸ªPGï¼‰å¯¹å®Œå…¨æœ‰åºçš„æ—¥å¿—è®°å½•è¿›è¡Œæ‰¹å¤„ç†ï¼Œå¹¶å°†æ¯ä¸ªæ‰¹æ¬¡äº¤ä»˜ç»™æ‰€æœ‰ 6 ä¸ªå‰¯æœ¬ï¼Œåœ¨é‚£é‡Œæ—¥å¿—è¢«æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œæ•°æ®åº“å¼•æ“ç­‰å¾… 6 ä¸ªå‰¯æœ¬ä¸­çš„ 4 ä¸ªç¡®è®¤ï¼Œä»¥æ»¡è¶³ write quorumï¼Œå¹¶è®¤ä¸ºå‘é€çš„æ—¥å¿—è®°å½•æ˜¯æŒä¹…çš„ã€‚å‰¯æœ¬ä½¿ç”¨é‡åšæ—¥å¿—è®°å½•å¯¹å…¶ç¼“å­˜è¿›è¡Œæ›´æ”¹ã€‚</p>
<p>ä¸Šé¢çš„å¤„ç†ä¸‹ç§»è‡³ storage service è¿˜èƒ½å¤Ÿæœ€å°åŒ–æ•…éšœæ¢å¤çš„æ—¶é—´ï¼ŒåŒæ—¶æ¶ˆé™¤äº† checkpointã€åå°æ•°æ®é¡µå†™å…¥ã€å¤‡ä»½ç­‰æ“ä½œå¼•èµ·çš„æŠ–åŠ¨ã€‚åœ¨ä¼ ç»Ÿæ•°æ®åº“ä¸­ï¼Œå´©æºƒåç³»ç»Ÿå¿…é¡»ä»æœ€è¿‘çš„æ£€æŸ¥ç‚¹å¼€å§‹ï¼Œé‡æ”¾æ—¥å¿—ä»¥ç¡®ä¿æ‰€æœ‰æŒä¹…åŒ–çš„ redo log éƒ½è¢«åº”ç”¨ã€‚åœ¨ Aurora ä¸­ï¼Œredo log çš„å›æ”¾å‘ç”Ÿåœ¨å­˜å‚¨å±‚ï¼Œè¿™æ˜¯è¿ç»­çš„ã€å¼‚æ­¥çš„ï¼Œå¹¶åˆ†æ•£åœ¨æ•´ä¸ªé›†ç¾¤ä¸­ã€‚ä»»ä½•å¯¹æ•°æ®é¡µçš„è¯»å–è¯·æ±‚å¦‚æœé¡µé¢ä¸æ˜¯æœ€æ–°çš„ï¼Œå¯èƒ½éœ€è¦åº”ç”¨ä¸€äº›é‡åšè®°å½•ã€‚å› æ­¤ï¼Œå´©æºƒæ¢å¤çš„è¿‡ç¨‹åˆ†æ•£åœ¨æ‰€æœ‰æ­£å¸¸çš„å‰å°å¤„ç†ä¸­ã€‚åœ¨æ•°æ®åº“å¯åŠ¨æ—¶æ— éœ€è¿›è¡Œä»»ä½•æ“ä½œã€‚</p>
<p>Aurora å­˜å‚¨æœåŠ¡çš„ä¸€ä¸ªæ ¸å¿ƒè®¾è®¡åŸåˆ™æ˜¯æœ€å°åŒ–å‰å°å†™è¯·æ±‚çš„å»¶è¿Ÿã€‚å¤§éƒ¨åˆ†å­˜å‚¨å¤„ç†è¢«ç§»è‡³åå°ã€‚é‰´äºå‰å°è¯·æ±‚ä¸å­˜å‚¨å±‚çš„å¹³å‡è¯·æ±‚ä¹‹é—´è‡ªç„¶å­˜åœ¨çš„å˜åŒ–æ€§ï¼Œå­˜å‚¨å±‚æœ‰å……è¶³çš„æ—¶é—´åœ¨å‰å°è·¯å¾„ä¹‹å¤–æ‰§è¡Œè¿™äº›ä»»åŠ¡ï¼Œå¹¶æœ‰æœºä¼šç”¨ CPU æ¢å–ç£ç›˜æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œåœ¨å­˜å‚¨èŠ‚ç‚¹å¿™äºå¤„ç†å‰å°å†™è¯·æ±‚æ—¶ï¼Œé™¤éç£ç›˜æ¥è¿‘å®¹é‡ï¼Œå¦åˆ™ä¸å¿…è¿è¡Œæ—§é¡µé¢ç‰ˆæœ¬çš„åƒåœ¾æ”¶é›†ï¼ˆGCï¼‰ã€‚åœ¨ Aurora ä¸­ï¼Œåå°å¤„ç†ä¸å‰å°å¤„ç†å‘ˆè´Ÿç›¸å…³ã€‚è¿™ä¸ä¼ ç»Ÿæ•°æ®åº“ä¸åŒï¼Œåœ¨ä¼ ç»Ÿæ•°æ®åº“ä¸­ï¼Œé¡µé¢çš„åå°å†™å…¥å’Œæ£€æŸ¥ç‚¹ä¸ç³»ç»Ÿä¸Šçš„å‰å°è´Ÿè½½å‘ˆæ­£ç›¸å…³ã€‚</p>
<p><img src="databases/cloudnative//assets/images/aurora_traffic_in_storage_node.png" alt="IO Traffic in Aurora Storage Nodes" /></p>
<ul>
<li>(1) receive log record and add to an in-memory queue</li>
<li>(2) persist record on disk and acknowledge</li>
<li>(3) organize records and identify gaps in the log since some batches may be lost</li>
<li>(4) gossip with peers to fill in gaps</li>
<li>(5) coalesce log records into new data pages</li>
<li>(6) periodically stage log and new pages to S3</li>
<li>(7) periodically garbage collect old versions</li>
<li>(8) periodically validate CRC codes on pages.</li>
</ul>
<p>ä¸Šè¿°çš„æ­¥éª¤ä¸­åªæœ‰ï¼ˆ1ï¼‰å’Œï¼ˆ2ï¼‰ä½äºå¯èƒ½å½±å“å»¶è¿Ÿçš„å‰å°è·¯å¾„ä¸­</p>
<h4 id="the-log-marches-forward"><a class="header" href="#the-log-marches-forward">THE LOG MARCHES FORWARD</a></h4>
<p>Aurora é€šè¿‡å°†é‡åšæ—¥å¿—è®°å½•ä¼ è¾“è‡³å­˜å‚¨å±‚ï¼Œç®€åŒ–äº†æ—¥å¿—ç”Ÿæˆã€æŒä¹…çŠ¶æ€ã€è¿è¡Œæ—¶çŠ¶æ€å’Œå‰¯æœ¬çŠ¶æ€çš„ä¸€è‡´æ€§ç»´æŠ¤ï¼Œé¿å…äº†æ˜‚è´µçš„ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰ã€‚å®ƒé€šè¿‡å¼‚æ­¥å¤„ç†æ–¹å¼ï¼Œåœ¨æ”¶åˆ°å­˜å‚¨è¯·æ±‚çš„ç¡®è®¤åï¼Œç»´æŠ¤å¹¶æ¨è¿›ä¸€è‡´æ€§ç‚¹å’ŒæŒä¹…æ€§ç‚¹ã€‚</p>
<p>æ•°æ®åº“äº‹åŠ¡è¢«åˆ†è§£ä¸ºå¤šä¸ªè¿·ä½ äº‹åŠ¡ï¼ˆMTRï¼‰ï¼Œæ¯ä¸ª MTR ç”±å¤šä¸ªè¿ç»­çš„æ—¥å¿—è®°å½•ç»„æˆï¼Œæœ€åä¸€ä¸ªæ—¥å¿—è®°å½•è¢«æ ‡è®°ä¸º CPLï¼ˆConsistency Point LSNï¼‰ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚</p>
<p>åœ¨å´©æºƒæ¢å¤ä¸­ï¼ŒAurora ä¾èµ–å­˜å‚¨æœåŠ¡æ¥æ¢å¤æ—¥å¿—è®°å½•ï¼Œç¡®ä¿æ•°æ®åº“çœ‹åˆ°ä¸€è‡´çš„å­˜å‚¨è§†å›¾ã€‚å­˜å‚¨æœåŠ¡ç¡®å®š VCLï¼ˆVolume Complete LSNï¼‰å’Œ VDLï¼ˆVolume Durable LSNï¼‰ï¼Œå¹¶åœ¨æ¢å¤è¿‡ç¨‹ä¸­æˆªæ–­é«˜äº VDL çš„æ—¥å¿—è®°å½•ã€‚æ•°æ®åº“åœ¨é‡å¯æ—¶ï¼Œé€šè¿‡è¯»å–æ¯ä¸ªä¿æŠ¤ç»„ï¼ˆPGï¼‰çš„ä¸€è‡´æ€§æ®µï¼Œé‡æ–°è®¡ç®— VDL å¹¶ç”Ÿæˆæˆªæ–­èŒƒå›´ã€‚æ­¤å¤–ï¼Œæ•°æ®åº“éœ€è¦æ‰§è¡Œæ’¤é”€æ¢å¤ï¼Œæ¥é€†è½¬å´©æºƒæ—¶æœªå®Œæˆçš„äº‹åŠ¡æ“ä½œã€‚è¿™äº›æ“ä½œåœ¨æ•°æ®åº“ä¸Šçº¿åè¿›è¡Œï¼Œç¡®ä¿ç³»ç»Ÿæ¢å¤è¿‡ç¨‹ä¸­ä¸ä¸­æ–­ç”¨æˆ·æ“ä½œã€‚</p>
<p>åœ¨æ­£å¸¸æ“ä½œä¸­ï¼ŒAurora æŒç»­ä¸å­˜å‚¨æœåŠ¡äº¤äº’ï¼Œä¿æŒçŠ¶æ€ä»¥å»ºç«‹ä»²è£ã€æ¨è¿›æŒä¹…æ€§å¹¶ç™»è®°æäº¤çš„äº‹åŠ¡ã€‚å†™æ“ä½œä¸­ï¼Œéšç€æ¯æ‰¹æ—¥å¿—è®°å½•çš„å†™å…¥ä»²è£ç¡®è®¤ï¼Œå½“å‰ VDL ä¸æ–­æ¨è¿›ã€‚æäº¤æ“ä½œå¼‚æ­¥å®Œæˆï¼Œå¤„ç†æäº¤è¯·æ±‚çš„çº¿ç¨‹ä¼šå°†äº‹åŠ¡è®°å½•åœ¨ç­‰å¾…æäº¤çš„åˆ—è¡¨ä¸­ï¼Œç„¶åç»§ç»­å¤„ç†å…¶å®ƒä»»åŠ¡ã€‚è¯»æ“ä½œä¸­ï¼ŒAurora ä¿è¯ç¼“å­˜ä¸­çš„é¡µé¢æ€»æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œé€šè¿‡ä»å­˜å‚¨èŠ‚ç‚¹è·å–æœ€æ–°çš„é¡µé¢ç‰ˆæœ¬ï¼Œé¿å…äº†ä¼ ç»Ÿæ•°æ®åº“ä¸­é¡µé¢è¢«æ›¿æ¢å‰éœ€è¦å†™å…¥ç£ç›˜çš„é—®é¢˜ã€‚å‰¯æœ¬æ“ä½œä¸­ï¼Œæœ€å¤šå¯æ”¯æŒ15ä¸ªè¯»å‰¯æœ¬ï¼Œå®ƒä»¬é€šè¿‡æ¶ˆè´¹å†™å…¥å™¨ç”Ÿæˆçš„æ—¥å¿—æµä¿æŒåŒæ­¥ã€‚å‰¯æœ¬å¼‚æ­¥å¤„ç†æ—¥å¿—è®°å½•ï¼Œå¹¶ç¡®ä¿åªåº”ç”¨ VDL ä»¥ä¸‹çš„æ—¥å¿—è®°å½•ï¼ŒåŒæ—¶ä¿è¯å•ä¸ªè¿·ä½ äº‹åŠ¡å†…çš„æ—¥å¿—è®°å½•åŸå­æ€§åœ°åº”ç”¨åˆ°ç¼“å­˜ä¸­ã€‚</p>
<h4 id="putting-it-all-together"><a class="header" href="#putting-it-all-together">PUTTING IT ALL TOGETHER</a></h4>
<p><img src="databases/cloudnative//assets/images/aurora_architecture_bird_eye_view.png" alt="Aurora Architecture: A Bird's Eye View" /></p>
<h3 id="further-readings"><a class="header" href="#further-readings">Further readings</a></h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=jJSh54J1s5o">MIT 6.824 Lecture 10: Cloud Replicated DB, Aurora</a></li>
<li><a href="https://www.youtube.com/watch?v=pzZydB78Eyc">AWS re:Invent 2022 - Deep dive into Amazon Aurora and its innovations</a></li>
<li><a href="https://www.youtube.com/watch?v=je6GCOZ22lI">AWS re:Invent 2023 - Deep dive into Amazon Aurora and its innovations</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasescloudnativetaurus-database-how-to-be-fast-available-and-frugal-in-the-clouda"><a class="header" href="#a-hrefdatabasescloudnativetaurus-database-how-to-be-fast-available-and-frugal-in-the-clouda"><a href="databases/cloudnative/">Taurus Database: How to be Fast, Available, and Frugal in the Cloud</a></a></h3>
<blockquote>
<p>SIGMOD 2020</p>
<p>https://dl.acm.org/doi/10.1145/3318464.3386129</p>
</blockquote>
<p>æœ¬æ–‡ä»‹ç»äº†ä¸€ç§åä¸º Taurus çš„æ–°å‹å¤šäº‘ç§Ÿæˆ·æ•°æ®åº“ç³»ç»Ÿçš„è®¾è®¡ã€‚Taurus é€šè¿‡ç±»ä¼¼ Amazon Aurora å’Œ Microsoft Socrates çš„æ–¹å¼åˆ†ç¦»è®¡ç®—å’Œå­˜å‚¨å±‚ï¼Œå¹¶æä¾›ç±»ä¼¼çš„ä¼˜åŠ¿ï¼Œå¦‚è¯»å‰¯æœ¬æ”¯æŒã€ä½ç½‘ç»œåˆ©ç”¨ç‡ã€ç¡¬ä»¶å…±äº«å’Œå¯æ‰©å±•æ€§ã€‚ç„¶è€Œï¼ŒTaurus æ¶æ„å…·æœ‰å‡ ä¸ªç‹¬ç‰¹çš„ä¼˜åŠ¿ï¼š</p>
<ul>
<li>æ”¹è¿›çš„å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§ï¼šä¸ä¼ ç»Ÿçš„æœ¬åœ°éƒ¨ç½²ç›¸æ¯”ï¼Œä½¿ç”¨äº‘æ•°æ®åº“æœåŠ¡ï¼ˆDBaaSï¼‰è¶Šæ¥è¶Šæ™®éï¼Œå…¶ä¸»è¦ä¼˜åŠ¿åŒ…æ‹¬æé«˜å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§ï¼Œå¹¶ä¸”æˆæœ¬æ›´ä½ã€‚</li>
<li>å¼‚æ­¥æ­¥éª¤å¯¹å»¶è¿Ÿçš„å½±å“ï¼šåœ¨ Taurus çš„è®¾è®¡ä¸­ï¼Œæ‰€æœ‰æ­¥éª¤éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œåªæœ‰å‰ä¸¤ä¸ªæ­¥éª¤ä½äºå‰å°è·¯å¾„ä¸­ï¼Œå¯èƒ½ä¼šå¯¹å»¶è¿Ÿäº§ç”Ÿå½±å“ã€‚</li>
<li>ç‹¬ç‰¹çš„å¤åˆ¶å’Œæ¢å¤ç®—æ³•ï¼šTaurus æä¾›äº†æ–°é¢–çš„å¤åˆ¶å’Œæ¢å¤ç®—æ³•ï¼Œä½¿ç”¨ç›¸åŒæ•°é‡æˆ–æ›´å°‘çš„å‰¯æœ¬ï¼Œæä¾›æ›´å¥½çš„å¯ç”¨æ€§ã€‚</li>
</ul>
<h4 id="æ¶æ„"><a class="header" href="#æ¶æ„">æ¶æ„</a></h4>
<p>Taurus åŒ…å« 4 ä¸ªä¸»è¦ç»„ä»¶ï¼š</p>
<ul>
<li>æ•°æ®åº“å‰ç«¯: åŸºäº MySQL çš„ä¿®æ”¹ç‰ˆï¼ŒåŒ…å« Master å®ä¾‹ï¼ˆæä¾›è¯»å†™æœåŠ¡ï¼‰å’Œè‹¥å¹²ä¸ª RO å®ä¾‹ï¼ˆæä¾›åªè¯»æœåŠ¡ï¼‰ã€‚Master å®ä¾‹ç”Ÿæˆ redo logï¼Œè¿™äº›æ—¥å¿—æè¿°äº†äº‹åŠ¡å¯¹æ•°æ®é¡µçš„ä¿®æ”¹ã€‚Master å°† redo log å‘é€ç»™ LogStore å’Œ PageStoreï¼Œå¹¶å‘¨æœŸæ€§åœ°é€šçŸ¥ RO å®ä¾‹æœ€æ–°çš„ LSNï¼Œä»¥ä¾¿ RO å®ä¾‹å¯ä»¥è¯»å–åˆ°æœ€æ–°çš„ log</li>
<li>SAL(Storage Abstraction Layer): åµŒå…¥åˆ°è®¡ç®—å±‚çš„åº“ï¼Œéš”ç¦»äº†è¿œç¨‹å­˜å‚¨ã€æ•°æ®åˆ†ç‰‡ã€æ•…éšœæ¢å¤ã€ä¸»ä»å¤åˆ¶ç­‰å­˜å‚¨å±‚çš„å¤æ‚æ€§ã€‚ä¸»è¦è´Ÿè´£è®¡ç®—å¼•æ“ä¸å­˜å‚¨å±‚çš„ LogStore/PageStore çš„äº¤äº’ï¼Œç®¡ç† PageStore çš„ Slicesï¼Œä»¥åŠé¡µé¢åœ¨ Slices ä¸Šçš„æ˜ å°„å…³ç³»</li>
<li>Log Store: è´Ÿè´£æŒä¹…åŒ–æ—¥å¿—ï¼ˆå†™å…¥ PLogï¼‰ï¼Œäº‹åŠ¡çš„æ‰€æœ‰æ—¥å¿—ä¸€æ—¦æŒä¹…åŒ–ï¼Œè®¡ç®—å±‚å³å¯é€šçŸ¥å®¢æˆ·ç«¯äº‹åŠ¡æäº¤å®Œæˆã€‚åŒæ—¶ï¼Œä¸º RO å®ä¾‹æä¾›æ—¥å¿—å†…å®¹ï¼ŒRO å®ä¾‹é€šè¿‡å›æ”¾ redo log æ¥æ›´æ–°å…¶ç¼“å†²åŒºä¸­çš„é¡µé¢</li>
<li>Page Store: è´Ÿè´£å­˜å‚¨æ•°æ®åº“çš„æ•°æ®é¡µï¼Œä¸»èŠ‚ç‚¹æ›´æ–° Page çš„æ—¶å€™ï¼Œé€šè¿‡ LSN æ¥è¡¨ç¤ºè¿™ä¸ª Page çš„ç‰ˆæœ¬ã€‚PageID+LSN å¯ä»¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ª page versionï¼ŒPage Store æ ¹æ® Master æˆ– RO çš„è¯»è¯·æ±‚å¯ä»¥æ„é€ ä»»æ„ç‰ˆæœ¬çš„ page version</li>
</ul>
<p>Page Store æä¾›äº†å‡ ä¸ªä¸»è¦çš„ API ä¾› SAL è°ƒç”¨:</p>
<pre><code>(1) WriteLogs is used to ship a buffer with log records 
(2) ReadPage is used to read a specific version of a page 
(3) SetRecycleLSN is used to specify the oldest LSN of pages belonging to the same database that the front end might request (recycle LSN)
(4) GetPersistentLSN returns the highest LSN that the Page Store can serve
</code></pre>
<h3 id="further-readings-1"><a class="header" href="#further-readings-1">Further readings</a></h3>
<p><a href="https://www.vldb.org/pvldb/vol16/p3488-depoutovitch.pdf">Taurus MM: bringing multi-master to the cloud</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesassetspdfscolumn-stores20vs20row-stores-20how20different20are20they20reallypdfcolumnstores-vs-rowstores-how-different-are-they-reallya"><a class="header" href="#a-hrefdatabasesassetspdfscolumn-stores20vs20row-stores-20how20different20are20they20reallypdfcolumnstores-vs-rowstores-how-different-are-they-reallya"><a href="databases/../assets/pdfs/Column-Stores%20vs.%20Row-Stores-%20How%20Different%20Are%20They%20Really.pdf">ColumnStores vs. RowStores: How Different Are They Really?</a></a></h3>
<blockquote>
<p>SIGMOD 2008 Daniel J. Abadi, etc.</p>
<p>https://dl.acm.org/doi/10.1145/1376616.1376712</p>
</blockquote>
<p>åˆ—å­˜æ•°æ®åº“åœ¨æ•°ä»“ã€å†³ç­–æ”¯æŒã€BI ç­‰åˆ†æå‹åº”ç”¨ä¸­è¢«è¯æ˜æ¯”ä¼ ç»Ÿè¡Œå­˜æ•°æ®åº“çš„è¡¨ç°è¦å¥½å‡ºä¸€ä¸ªé‡çº§ä»¥ä¸Šï¼Œå…¶åŸå› ä¹Ÿæ˜¾è€Œæ˜“è§ï¼šåˆ—å­˜æ•°æ®åº“å¯¹äºåªè¯»æŸ¥è¯¢æŒ‰éœ€è®¿é—®æ‰€éœ€åˆ—ï¼Œå› è€Œæ›´ <code>IO efficient</code>ã€‚è¿™ç§ç›´è§‚çš„æ„Ÿå—ä¸ç¦è®©äººçŒœæƒ³ï¼šå¦‚æœç”¨è¡Œå­˜æ•°æ®åº“æ¨¡æ‹Ÿåˆ—å­˜æ•°æ®åº“ï¼Œä½¿å¾—æ¯ä¸ªåˆ—å•ç‹¬è®¿é—®ï¼Œæ˜¯å¦å¯ä»¥è·å¾—åˆ—å­˜æ•°æ®åº“çš„æ€§èƒ½æ”¶ç›Šï¼Ÿ</p>
<p>è¿™å¼•å‡ºäº†è®ºæ–‡è¦å›ç­”çš„ç¬¬ä¸€ä¸ªé—®é¢˜:</p>
<ul>
<li>Are these performance gains due
to something fundamental about the way column-oriented DBMSs
are internally architected, or would such gains also be possible in
a conventional system that used a more column-oriented physical
design?</li>
</ul>
<p>ä½œè€…ä½¿ç”¨ä¸‰ç§æŠ€æœ¯åœ¨è¡Œå­˜æ•°æ®åº“ä¸­æ¨¡æ‹Ÿåˆ—å­˜ï¼Œå…¶æŸ¥è¯¢æ€§èƒ½éƒ½éå¸¸å·®ã€‚é‚£ä¹ˆæ˜¯ä»€ä¹ˆé€ å°±äº†åˆ—å­˜æ•°æ®åº“çš„ä¼˜è¶Šæ€§èƒ½å‘¢ï¼Ÿ</p>
<p>è¿™å¼•å‡ºäº†è®ºæ–‡è¦å›ç­”çš„ç¬¬äºŒä¸ªé—®é¢˜:</p>
<ul>
<li>Which of the many column-database specific optimizations proposed
in the literature are most responsible for the significant performance
advantage of column-stores over row-stores on warehouse
workloads?</li>
</ul>
<h3 id="roworiented-execution"><a class="header" href="#roworiented-execution">ROWORIENTED EXECUTION</a></h3>
<p>ä½œè€…åœ¨ System X (ä¸€æ¬¾å•†ä¸šè¡Œå­˜æ•°æ®åº“) ä¸Šä½¿ç”¨äº†ä¸‰ç§æ–¹æ³•æ¥æ¨¡æ‹Ÿåˆ—å­˜æ•°æ®åº“ã€‚é€šè¿‡åœ¨ SSBM ä¸Šçš„å®éªŒå‘ç°è¿™äº›æ–¹æ³•éƒ½ä¸èƒ½å–å¾—è¾ƒå¥½çš„æ€§èƒ½ã€‚</p>
<h4 id="1-vertical-partitioning"><a class="header" href="#1-vertical-partitioning">1. Vertical Partitioning</a></h4>
<p>å°†è¡¨è¿›è¡Œå‚ç›´åˆ‡åˆ†æ˜¯æœ€ç›´è§‚çš„æ–¹å¼ï¼Œä½†è¿™éœ€è¦å°†åˆ‡åˆ†åçš„æ•°æ®è¿›è¡Œå…³è”ã€‚è¡Œå­˜ä¸å…·æœ‰åˆ—å­˜å°†æ¯åˆ—æ•°æ®éƒ½æŒ‰ç…§ç›¸åŒçš„é¡ºåºè¿›è¡Œå­˜å‚¨çš„ç‰¹æ€§ï¼Œå› è€Œä¸€ä¸ªé€»è¾‘è¡¨å‚ç›´åˆ‡åˆ†å‡ºçš„æ¯ä¸€ä¸ªç‰©ç†è¡¨ï¼Œéƒ½ä¿å‡½ä¸¤åˆ—æ•°æ® â€”â€” è¯¥åˆ—çš„åŸå§‹æ•°æ®å’Œ &quot;position&quot; columnï¼ˆé€šå¸¸æ˜¯ primary keyï¼‰ï¼ŒæŸ¥è¯¢éœ€è¦è¢«æ”¹å†™ä¸ºåŸºäº &quot;position&quot; column çš„ joinï¼Œä¸ç®¡æ˜¯ Hash join è¿˜æ˜¯ index joinï¼Œæ€§èƒ½éƒ½è¾ƒå·®ã€‚</p>
<p>è¿™ç§æ–¹å¼ç”±äºåœ¨æ¯ä¸ªåˆ—å¯¹åº”çš„è¡¨ä¸­éƒ½å­˜å‚¨äº† &quot;position&quot; columnï¼Œæµªè´¹äº†å­˜å‚¨ç©ºé—´å’Œç£ç›˜å¸¦å®½ã€‚å¦å¤–è¡Œå­˜æ•°æ®åº“çš„æ¯ä¸€è¡Œæ•°æ®éƒ½ä¼šä¿å­˜ä¸€ä¸ªç›¸å¯¹è¾ƒå¤§çš„ headerï¼Œè¿™è¿›ä¸€æ­¥æµªè´¹äº†å­˜å‚¨ç©ºé—´ã€‚</p>
<h4 id="2-index-only-plans"><a class="header" href="#2-index-only-plans">2. Index-only plans</a></h4>
<p>åœ¨åŸºç¡€è¡Œå­˜è¡¨çš„ä¹‹å¤–å¯¹æ¯ä¸€åˆ—å­˜å‚¨ä¸€ä¸ªï¼ˆvalue, record-idï¼‰çš„éèšç°‡ç´¢å¼•ï¼Œè¿™æ ·å¯ä»¥ä¸å­˜å‚¨é‡å¤æ•°æ®ï¼Œä¸”æ²¡æœ‰ tuple header çš„å­˜å‚¨ç©ºé—´æµªè´¹ã€‚è¿™ç§æ–¹å¼å¯¹æ²¡æœ‰è°“è¯çš„è¿”å›åˆ—éœ€è¦è¿›è¡Œå…¨è¡¨æ‰«æã€‚</p>
<h4 id="3-materialized-views"><a class="header" href="#3-materialized-views">3. Materialized Views</a></h4>
<p>å¯¹æŸ¥è¯¢çš„ä¸­çš„æ¯ä¸ªè¡¨æ‰€éœ€çš„åˆ—ç”Ÿæˆç‰©åŒ–è§†å›¾ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼å‡å°‘æŸ¥è¯¢éœ€è¦è¯»å–çš„æ•°æ®é‡ï¼Œä»¥æœŸæœ›è¯¥ç§æ–¹æ³•å–å¾—ä¼˜äºå¦å¤–ä¸¤ç§æ–¹æ³•çš„æ€§èƒ½ã€‚</p>
<h3 id="columnoriented-execution"><a class="header" href="#columnoriented-execution">COLUMNORIENTED EXECUTION</a></h3>
<p>ä¸Šè¿°è¡Œå­˜æ¨¡æ‹Ÿåˆ—å­˜ä¸èƒ½å–å¾—è¾ƒå¥½çš„æ€§èƒ½æ”¶ç›Šåœ¨äºï¼Œåœ¨ SSBM åœºæ™¯ä¸‹ï¼ŒC-Store ç‰¹æœ‰çš„ <code>Compression</code>ã€<code>Late Materialization</code>ã€<code>Block Iteration</code> å’Œ <code>Invisible Join</code> ç­‰ç‰¹æ€§å¯¹æŸ¥è¯¢æ€§èƒ½å…·æœ‰æå¤§çš„å¸®åŠ©ï¼Œè®ºæ–‡ä¸­å°† C-Store è¿›è¡Œé€ä¸€ç‰¹æ€§é˜‰å‰²ï¼Œå°†å…¶<code>é€€åŒ–</code>ä¸ºä¸€ä¸ªè¡Œå­˜æ•°æ®åº“ï¼Œå¾—å‡ºå„å› ç´ å¯¹äºæ€§èƒ½çš„å½±å“:</p>
<ul>
<li>Compression improves performance by almost a factor of two on average</li>
<li>Late materialization results in almost a factor of three performance improvement</li>
<li>Block-processing can improve performance anywhere from a factor of only 5% to 50% depending on whether compression has already been removed</li>
<li>The invisible join improves performance by 50-75%</li>
</ul>
<p><strong>Compression</strong> é™¤äº†é€šè¿‡èŠ‚çœ I/O æ¥æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œå…¶ <code>operate directly on compressed data</code> çš„ç‰¹æ€§è¿›ä¸€æ­¥æé«˜äº†æ€§èƒ½ã€‚</p>
<p><strong>Late Materialization</strong> å’Œ <strong>Block Iteration</strong> åˆåœ¨ä¸€èµ·è¢«ç§°ä¸º <code>Vectorvectorized query processing</code>ã€‚</p>
<p><strong>Invisible Join</strong> æ˜¯ä¸€ç§ <code>Late materialized join</code> æŠ€æœ¯ï¼Œä½†å‡å°‘äº†éœ€è¦è¯»å–çš„æ•°æ®ï¼Œå…·ä½“ç»†èŠ‚è®ºæ–‡ä¸­çš„ä¾‹å­åšäº†ç®€æ˜çš„è§£é‡Šã€‚</p>
<h3 id="æ€è€ƒ"><a class="header" href="#æ€è€ƒ">æ€è€ƒ</a></h3>
<p>åŸºäº Btree çš„è¡Œå­˜æ•°æ®åº“ä¸­çš„ä¸€äº›ç‰¹æ€§æ˜¯ä¸ºäº†è§£å†³æŸäº›å®é™…é—®é¢˜ï¼ˆå†™ä¼˜åŒ–ï¼‰ï¼Œæ¯”å¦‚è®ºæ–‡ä¸­æåˆ°çš„:</p>
<ul>
<li>æ¯è¡Œæ•°æ®éƒ½æœ‰ header =&gt; ä¸ºäº†å®ç° MVCC è€Œå­˜åœ¨</li>
<li>æ•°æ®å¹¶éç‰©ç†æœ‰åº =&gt; æœ‰äº›å­˜å‚¨å¼•æ“ä½¿ç”¨ directory slots çš„æ–¹å¼å­˜å‚¨æ•°æ®ä»¥é¿å…æ•°æ®æ’å…¥æ—¶è¿‡å¤šçš„æ•°æ®ç§»åŠ¨</li>
</ul>
<p>æ‰€ä»¥èƒ½å¤Ÿç›´è§‚åœ°åˆ¤æ–­å‡ºåœ¨åŸºäº Btree çš„è¡Œå­˜æ•°æ®åº“ä¸­æ¨¡æ‹Ÿåˆ—å­˜ä¸ä¼šæœ‰å¥½çš„æ€§èƒ½æ”¶ç›Šã€‚å¦‚æœæ˜¯ LSM Tree å‘¢ï¼Ÿè™½ç„¶å¯ä»¥å®ç° Late Materializationï¼Œä½† Compression å’Œ Block iteration å¯èƒ½ä¸å¦‚åœ¨ Column Store ä¸­çš„æ”¶ç›Šæ˜æ˜¾ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="kv-databases"><a class="header" href="#kv-databases">kv databases</a></h2>
<ul>
<li><strong><a href="databases/kv/optimizing-space-amplification-in-rocksdb.html">Optimizing Space Amplification in RocksDB</a>, 2017</strong></li>
<li><strong><a href="databases/kv//assets/pdfs/fast21-dong.pdf">Evolution of Development Priorities in Key-value Stores Serving Large-scale Applications: The RocksDB Experience</a>, 2021 <a href="databases/kv//assets/pdfs/rocksdb-evolution-2021.pdf">a slightly more detailed version</a></strong></li>
<li><strong><a href="databases/kv/wisckey.html">WiscKey: Separating Keys from Values in SSD-Conscious Storage</a>, 2016</strong></li>
</ul>
<h3 id="further-readings-2"><a class="header" href="#further-readings-2">Further readings</a></h3>
<ul>
<li><a href="databases/kv//assets/pdfs/pcp_pipelined_compaction_for_lsm_tree.pdf">Pipelined Compaction for the LSM-tree</a>, 2014</li>
<li><a href="databases/kv//assets/pdfs/hashkv-atc18.pdf">HashKV: Enabling Efficient Updates in KV Storage via Hashing</a>, 2018</li>
<li><a href="https://scholar.harvard.edu/files/stratos/files/dostoevskykv.pdf">Dostoevsky: Better Space-Time Trade-Offs for LSM-Tree Based Key-Value Stores via Adaptive Removal of Superfluous Merging</a>, 2018, <a href="https://www.youtube.com/watch?v=fmXgXripmh0">video</a></li>
<li><a href="https://dl.acm.org/doi/abs/10.14778/3229863.3229873">Accordion: better memory organization for LSM key-value stores</a>, 2018, HBase Memory Improvement</li>
<li><a href="databases/kv//assets/pdfs/lower-level-driven-compaction.pdf">LDC: A Lower-Level Driven Compaction Method to Optimize SSD-Oriented Key-Value Stores</a>, 2019</li>
<li><a href="https://www.usenix.org/system/files/fast20-cao_zhichao.pdf">Characterizing, Modeling, and Benchmarking RocksDB Key-Value Workloads at Facebook</a>, 2020</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabaseskvassetspdfsp82-dong-cidr17pdfoptimizing-space-amplification-in-rocksdba"><a class="header" href="#a-hrefdatabaseskvassetspdfsp82-dong-cidr17pdfoptimizing-space-amplification-in-rocksdba"><a href="databases/kv/../../assets/pdfs/p82-dong-cidr17.pdf">Optimizing Space Amplification in RocksDB</a></a></h3>
<blockquote>
<p>CIDR 2017</p>
<p>http://cidrdb.org/cidr2017/papers/p82-dong-cidr17.pdf</p>
</blockquote>
<p>RocksDB æ˜¯ Facebook å¼€å‘çš„ä¸€æ¬¾é«˜æ€§èƒ½åµŒå…¥å¼ kv å­˜å‚¨å¼•æ“ï¼Œå®ƒä½¿ç”¨ LSM-tree æ¥è·å¾—æ˜¾è‘—çš„ç©ºé—´æ•ˆç‡åŠæ›´å¥½çš„å†™å…¥ååé‡ï¼ŒåŒæ—¶å®ç°å¯æ¥å—çš„è¯»å–æ€§èƒ½ã€‚Facebook æ‹¥æœ‰å…¨çƒæœ€å¤§çš„ MySQL å®‰è£…é‡ä¹‹ä¸€ï¼Œå­˜å‚¨äº†æ•°å PB çš„åœ¨çº¿æ•°æ®ï¼Œå…¶å®ä¾‹åº•å±‚çš„å­˜å‚¨å¼•æ“è¶Šæ¥è¶Šå¤šåœ°ä» InnoDB åˆ‡æ¢åˆ°åŸºäº RocksDb çš„ MyRocksã€‚Facebook ä½¿ç”¨ RocksDB çš„ä¸»è¦ç›®æ ‡æ˜¯
æœ€æœ‰æ•ˆåœ°åˆ©ç”¨ç¡¬ä»¶èµ„æºï¼ŒåŒæ—¶ç¡®ä¿å¯ä»¥æ»¡è¶³æ‰€æœ‰é‡è¦çš„æœåŠ¡çº§åˆ«è¦æ±‚ï¼ŒåŒ…æ‹¬äº‹åŠ¡å»¶è¿Ÿã€‚</p>
<p>Facebook çš„ä¸šåŠ¡å¯¹æ•°æ®å­˜å‚¨æœ‰ä»¥ä¸‹å‡ ä¸ªéœ€æ±‚:</p>
<ul>
<li>SSDs are increasingly being used to store persistent data and are the primary target for RocksDB</li>
<li>Facebook relies primarily on shared nothing configuration of commodity hardware in their data centers, where data is distributed across a large number of simple nodes, each with 1-2 SSDs</li>
<li>the amount of data that needs to be stored is huge</li>
<li>the read-write ratio is relatively low at roughly 2:1 in many (but not all) cases, given the fact that large memory-based caches are used extensively</li>
</ul>
<p>åœ¨è¿™æ ·çš„ç¯å¢ƒä¸‹ï¼ŒInnoDB åœ¨å³°å€¼æ—¶å¤„ç†çš„è¯»å†™æ•°æ®é‡è¿œè¿œä½äºç¡¬ä»¶çš„å¤„ç†èƒ½åŠ›ï¼Œä¸»è¦æ˜¯å› ä¸ºæ¯ä¸ªèŠ‚ç‚¹çš„æŸ¥è¯¢ç‡å¾ˆä½ã€‚å¦‚æœ SSD å¯ä»¥å­˜å‚¨ä¸¤å€çš„æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥é¢„è®¡å­˜å‚¨èŠ‚ç‚¹æ•ˆç‡å°†ç¿»å€ï¼Œå› ä¸º SSD å¯ä»¥è½»æ¾å¤„ç†é¢„æœŸçš„åŒå€ IOPSï¼Œå¹¶ä¸”å°†éœ€è¦æ›´å°‘çš„èŠ‚ç‚¹æ¥å¤„ç†å·¥ä½œè´Ÿè½½ã€‚</p>
<p>RocksDB ä¸ºäº†è¿½æ±‚æœ€å°çš„ç©ºé—´æ”¾å¤§ï¼Œéœ€è¦ç‰ºç‰²ä¸€äº›è¯»æ”¾å¤§å’Œå†™æ”¾å¤§ã€‚åœ¨ <code>RUM Tradeoff</code> ç†è®ºä¸­ï¼Œä¸‰è€…æ˜¯ä¸€ä¸ªä¸å¯å…¼å¾—çš„ä¸‰è§’ã€‚RocksDB ä½¿ç”¨ LSM-tree æ¥è·å–è¾ƒä½çš„ç©ºé—´æ”¾å¤§å’Œå†™å…¥æ”¾å¤§ç‰¹æ€§ã€‚æ ¹æ® Facebook çš„ä½¿ç”¨ç»éªŒï¼ŒRocksdb ç›¸æ¯” InnoDB èƒ½å¤Ÿå¹³å‡èŠ‚çœ 50% çš„å­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸”å…·æœ‰æ›´é«˜çš„å†™å…¥äº‹åŠ¡ååï¼Œåœ¨å¯æ¥å—çš„èŒƒå›´å†…å¢åŠ äº†è¯»å–å»¶è¿Ÿã€‚</p>
<h4 id="lsm-tree"><a class="header" href="#lsm-tree">LSM-Tree</a></h4>
<p>å¾ˆå¤šçŸ¥åçš„ç³»ç»Ÿéƒ½ä½¿ç”¨äº† LSM-Treeï¼Œå¦‚ BigTableã€LevelDBã€Apache Cassandraã€HBaseã€‚RocksDB ä¸­ LSM-Tree çš„å®ç°å¯ç”±å¦‚ä¸‹é¢ä¸¤å¼ å›¾ç‰‡æ¦‚æ‹¬:</p>
<p><img src="databases/kv/./../../assets/images/rocksdb-sst-file-organization.jpg" alt="Figure 1: SST file organization" /></p>
<p>æ•°æ®å†™å…¥è¿‡ç¨‹:</p>
<ol>
<li>æ•°æ®å†™å…¥ LSM-Tree æ—¶ï¼Œé¦–å…ˆå†™å…¥å†…å­˜ä¸­çš„ memtable å’Œç”¨äºæ•…éšœæ¢å¤çš„ WAL</li>
<li>å½“ memtable çš„å¤§å°è¾¾åˆ°é¢„è®¢çš„å€¼æ—¶ï¼Œå½“å‰çš„ memtable å’Œ WAL å˜ä¸º immutableï¼Œä¸€ç»„æ–°çš„ WAL å’Œ memtable ç”¨æ¥æ¥æ”¶åç»­çš„æ•°æ®å†™å…¥</li>
<li>å†™æ»¡çš„ memtable è¢«åˆ·å…¥ SST æ–‡ä»¶ï¼ˆL0-SSTï¼‰ï¼Œå®Œæˆä¹‹åå¯¹åº”çš„ memtable å’Œ WAL è¢«åˆ é™¤</li>
<li>å½“ L0-SST æ–‡ä»¶ä¸ªæ•°è¾¾åˆ°é˜ˆå€¼ï¼ˆeg., 4ï¼‰æ—¶ï¼Œè§¦å‘ L0-SST å’Œä¸å…¶ key å€¼èŒƒå›´æœ‰é‡å çš„ L1-SST è¿›è¡Œ compaction</li>
<li>å¯¹äº L &gt; 0 çš„æ–‡ä»¶ï¼Œå½“è¯¥å±‚çº§çš„æ‰€æœ‰æ–‡ä»¶å°ºå¯¸è¾¾åˆ°ä¸€å®šçš„é˜ˆå€¼æ—¶ï¼Œä¸€ä¸ªæˆ–å¤šä¸ª SST æ–‡ä»¶ä¼šè¢«é€‰å–ä¸ L+1 å±‚æœ‰è¦†ç›–çš„æ–‡ä»¶è¿›è¡Œ compaction</li>
</ol>
<p>åªæœ‰ L0 æ–‡ä»¶ä¹‹é—´çš„ key å€¼è¿”å›ä¼šæœ‰è¦†ç›–ï¼Œå…¶å®ƒ Level çš„æ–‡ä»¶ä¹‹é—´çš„ key å€¼è¿”å›ä¸ä¼šæœ‰è¦†ç›–ã€‚</p>
<p><img src="databases/kv/../../assets/images/rocksdb-compaction.jpg" alt="Figure 2: Compaction" /></p>
<h4 id="space-amplification"><a class="header" href="#space-amplification">Space Amplification</a></h4>
<p>B-tree çš„ç©ºé—´åˆ©ç”¨ç‡ç›¸å¯¹è¾ƒä½ï¼Œå…¶é¡µé¢é€šå¸¸åªç”¨äº† 1/2 ~ 2/3ï¼Œè¿™ç§ç¢ç‰‡åŒ–å¯¼è‡´åœ¨åŸºäº B-tree çš„å­˜å‚¨å¼•æ“ä¸­ç©ºé—´æ”¾å¤§è¦å¤§äº 1.5ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒLSM-Tree æ²¡æœ‰ç¢ç‰‡åŒ–çš„é—®é¢˜ï¼Œå…¶ç©ºé—´æ”¾å¤§ä¸»è¦ç”±æœªè¢«åƒåœ¾å›æ”¶çš„é™ˆæ—§æ•°æ®é‡å†³å®šã€‚RocksDB ä½¿ç”¨ä¸¤ç§ç­–ç•¥æ¥å‡å°‘ç©ºé—´æ”¾å¤§:</p>
<ul>
<li>Dynamic level size adaptation
<ul>
<li>é€šè¿‡åŠ¨æ€è°ƒæ•´æ¯ä¸ªçº§åˆ«çš„å¤§å°æ˜¯ä¸‹ä¸€çº§æ•°æ®å¤§å°çš„ 1/10ï¼ˆlevel size multiplier = 10ï¼‰ï¼Œå¯ä»¥ä½¿å¾—ç©ºé—´æ”¾å¤§å‡å°åˆ° 1.111...</li>
<li>level size multiplier çš„å€¼è¶Šå¤§ï¼Œç©ºé—´æ”¾å¤§å’Œè¯»æ”¾å¤§è¶Šå°ï¼Œä½†ä¼šå¢åŠ å†™å…¥æ”¾å¤§</li>
</ul>
</li>
<li>Compression
<ul>
<li>Key prefix encoding: é€šè¿‡é¿å…å†™å…¥é”®çš„é‡å¤å‰ç¼€å¯ä»¥å‡å°‘ 3% - 17% çš„å­˜å‚¨ç©ºé—´</li>
<li>Sequence ID garbage collection: å¤§å¤šæ•° Sequence ID åœ¨ç›¸åº”çš„å¿«ç…§åˆ é™¤ä¹‹åä¸å†éœ€è¦</li>
<li>Data compression: é€šè¿‡å¯¹åŸºäº block çš„æ•°æ®è¿›è¡Œå‹ç¼©å¯ä»¥å°†æ•°æ®å‹ç¼©åˆ°åŸå§‹æ•°æ®çš„ 40% - 25%</li>
<li>Dictionary-Based Compression</li>
</ul>
</li>
</ul>
<h4 id="tradeoffs"><a class="header" href="#tradeoffs">Tradeoffs</a></h4>
<ul>
<li>Tiered compression: å‹ç¼©èƒ½å‡å°‘æ‰€éœ€çš„å­˜å‚¨ç©ºé—´ï¼Œä½†ä¼šå¢åŠ  CPU å¼€é”€
<ul>
<li>åœ¨æœ€åä¸€å±‚ä½¿ç”¨å¼ºå‹ç¼©ç®—æ³•ï¼ˆå¦‚ zlib æˆ– Zstandardï¼‰ï¼Œå³ä½¿å®ƒä¼šå¯¼è‡´æ›´é«˜çš„ CPU å¼€é”€ï¼Œå› ä¸ºå¤§å¤šæ•°ï¼ˆæ¥è¿‘ 90%ï¼‰çš„æ•°æ®éƒ½ä½äºè¯¥çº§åˆ«ï¼Œä½†åªæœ‰ä¸€å°éƒ¨åˆ†è¯»å’Œå†™è¿›å…¥å®ƒ</li>
<li>åœ¨ 0-2 çº§ä¸ä½¿ç”¨ä»»ä½•å‹ç¼©æ¥è·å¾—æ›´ä½çš„è¯»å–å»¶è¿Ÿ</li>
<li>åœ¨ 3è‡³æœ€åä¸€çº§ä½¿ç”¨è½»é‡çº§å‹ç¼©ï¼ˆå¦‚ LZ4 æˆ– Snappyï¼‰å› ä¸ºå®ƒçš„ CPU å¼€é”€æ˜¯å¯ä»¥æ¥å—çš„ï¼ŒåŒæ—¶å‡å°‘äº†ç©ºé—´å¹¶å†™æ”¾å¤§</li>
</ul>
</li>
<li>Bloom filters
<ul>
<li>å¸ƒéš†è¿‡æ»¤å™¨é€šè¿‡ä¸ºæ¯ä¸ª key ç»´æŠ¤ 10 ä¸ª bits æ¥å‡å°‘I/O æ“ä½œï¼Œå¢åŠ äº†å°‘è®¸ CPU å¼€é”€å’Œå†…å­˜å¼€é”€</li>
<li>æœ€åä¸€å±‚ä¸ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨</li>
</ul>
</li>
<li>Prefix Bloom filters
<ul>
<li>å‰ç¼€å¸ƒéš†è¿‡æ»¤å™¨ç”¨äºèŒƒå›´æŸ¥è¯¢</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabaseskvassetspdfswisckeypdfwisckey-separating-keys-from-values-in-ssd-conscious-storagea"><a class="header" href="#a-hrefdatabaseskvassetspdfswisckeypdfwisckey-separating-keys-from-values-in-ssd-conscious-storagea"><a href="databases/kv//assets/pdfs/WiscKey.pdf">WiscKey: Separating Keys from Values in SSD-Conscious Storage</a></a></h3>
<blockquote>
<p>FAST â€™16</p>
<p>https://dl.acm.org/doi/10.1145/3033273</p>
</blockquote>
<p>I/O æ”¾å¤§æ˜¯ LSM-tree å›ºæœ‰çš„ç‰¹æ€§ä¹‹ä¸€ã€‚æ–°å†™å…¥çš„æ•°æ®è¢«è¿½åŠ åˆ° WAL æ—¥å¿—å¹¶å†™å…¥å†…å­˜ memtableï¼Œè¿™ç§æ“ä½œé¿å…äº†å¯¹å·²æœ‰æ•°æ®çš„è¯»å–å’Œä¿®æ”¹ï¼Œå› è€Œéå¸¸é«˜æ•ˆã€‚å½“å†…å­˜ä¸­çš„ç»“æ„è¾¾åˆ°ä¸€å®šå¤§å°æˆ–è¾¾åˆ°ä¸€å®šæ—¶é—´é—´éš”æ—¶ï¼ŒLSM-tree ä¼šå°†è¿™äº›æ•°æ®æ‰¹é‡å†™å…¥åˆ°ç£ç›˜ä¸Šçš„æŒä¹…åŒ–å­˜å‚¨ç»“æ„ä¸­ï¼ˆSSTableï¼‰ï¼Œä½å±‚æ–‡ä»¶é€šè¿‡ compaction ç”Ÿæˆæ›´é«˜å±‚çš„æ–‡ä»¶ã€‚</p>
<blockquote>
<p>To maintain the size limit, once the total size of a level <strong>Li</strong> exceeds its limit, the compaction thread will choose <strong>one</strong> file from <strong>Li</strong>, merge
sort with <strong>all the overlapped files of Li+1</strong>, and generate new <strong>Li+1</strong> SSTable files.</p>
</blockquote>
<p><img src="databases/kv//assets/images/wisckey_lsmtree_leveldb.png" alt="Figure 1: LSM-tree and LevelDB Architecture" /></p>
<p><strong>å†™æ”¾å¤§ï¼ˆWrite Amplificationï¼‰</strong></p>
<p>ç”±äº Li çš„å¤§å°é™åˆ¶æ˜¯ Li-1 çš„ 10 å€ï¼Œå› æ­¤ Li-1 å±‚çš„æ–‡ä»¶åˆå¹¶åˆ° Li æ—¶ï¼Œæœ€åæƒ…å†µä¸‹å¯èƒ½ä¼šè¯»å– Li ä¸­çš„ 10 ä¸ªæ–‡ä»¶ï¼Œå¹¶åœ¨æ’åºåå°†è¿™äº›æ–‡ä»¶å†™å› Liï¼Œå› æ­¤ï¼Œå°†ä¸€ä¸ªæ–‡ä»¶ä»ä¸€ä¸ªå±‚çº§ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå±‚çº§çš„å†™æ”¾å¤§ç³»æ•°æœ€é«˜å¯è¾¾åˆ° 10 å€ã€‚</p>
<blockquote>
<p>For a large dataset, since any newly generated table file can eventually migrate from L0 to L6 through a series of compaction steps, write amplification
can be over 50 (10 for each gap between L1 to L6).</p>
</blockquote>
<p><strong>è¯»æ”¾å¤§ï¼ˆRead Amplificationï¼‰</strong></p>
<p>è¯»æ”¾å¤§çš„æºå¤´æœ‰ä¸¤ç‚¹:</p>
<ul>
<li>é¦–å…ˆï¼Œä¸ºäº†æŸ¥æ‰¾ä¸€ä¸ªé”®å€¼å¯¹ LevelDB å¯èƒ½éœ€è¦æ£€æŸ¥å¤šä¸ªå±‚çº§ï¼ˆL0 8ä¸ª + L1~L6 å„ä¸€ä¸ª = 14ï¼‰</li>
<li>å…¶æ¬¡ï¼Œä¸ºäº†åœ¨ä¸€ä¸ª SSTable æ–‡ä»¶ä¸­æ‰¾åˆ°ä¸€ä¸ªé”®å€¼å¯¹ï¼ŒLevelDB éœ€è¦è¯»å–æ–‡ä»¶ä¸­çš„å¤šä¸ªå…ƒæ•°æ®å—ï¼ˆindex block + bloom-filter blocksï¼‰</li>
</ul>
<p>å‡è®¾æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„ keyï¼Œä¸” bloom-filter è¿‡æ»¤çš„ç»“æœæ˜¯ <code>false positive</code>ï¼Œå¯¹äºæŸ¥è¯¢ 1KB é”®å€¼å¯¹çš„æ“ä½œï¼Œéœ€è¦è¯»å–ä¸€ä¸ª SSTable çš„æ•°æ®é‡ä¸º: 16-KB index block + 4-KB bloom-filter block + 4-KB data block = 24Kã€‚</p>
<blockquote>
<p>Considering the 14 SSTable files in the worst case, the read amplification of LevelDB is 24 Ã— 14 = 336. Smaller key-value pairs will lead to an even higher read amplification.</p>
</blockquote>
<p>å¯¹äº HDD ç›˜ï¼Œå‡è®¾éšæœºå†™å»¶è¿Ÿ/é¡ºåºå†™å»¶è¿Ÿ=1000ï¼Œé‚£ä¹ˆ LSM-tree åœ¨å†™æ”¾å¤§å°äº 1000 çš„æƒ…å†µä¸‹ä»ä¼šæ¯” B-Tree å¿«ã€‚è¿™ä¹Ÿæ˜¯ LSM-tree åœ¨ä¼ ç»Ÿ HDD ç›˜å–å¾—æˆåŠŸçš„é‡è¦åŸå› ã€‚</p>
<p>SSDï¼ˆå›ºæ€ç¡¬ç›˜ï¼‰åˆ™æœ‰æ‰€ä¸åŒï¼Œåœ¨è®¾è®¡é”®å€¼å­˜å‚¨ç³»ç»Ÿæ—¶éœ€è¦è€ƒè™‘ä¸‰ä¸ªé‡è¦çš„å› ç´ :</p>
<ul>
<li>First, the difference between random and sequential performance is not nearly as large as with HDDs</li>
<li>Second, SSDs have a large degree of internal parallelism</li>
<li>Third, SSDs can wear out through repeated writes; the high write amplification in LSM-trees can significantly reduce device lifetime</li>
</ul>
<h3 id="wisckey"><a class="header" href="#wisckey">WiscKey</a></h3>
<blockquote>
<p>The central idea behind WiscKey is the separation of keys and values; only keys are kept sorted in the LSM-tree, while values are stored separately in a log.</p>
</blockquote>
<p>WiscKey åŒ…å«å››ä¸ªå…³é”®çš„è®¾è®¡è¦ç‚¹:</p>
<ul>
<li>First, WiscKey separates keys from values, keeping only keys in the LSM-tree and the values in a separate log file</li>
<li>Second, to deal with unsorted values (which necessitate random access during range queries), WiscKey uses the parallel random-read characteristic of SSD devices</li>
<li>Third, WiscKey utilizes unique crash-consistency and garbage-collection techniques to efficiently manage the value log</li>
<li>Finally, WiscKey optimizes performance by removing the LSM-tree log without sacrificing consistency, thus reducing system-call overhead from small writes</li>
</ul>
<p>ä¸€ä¸ªå¾ˆç›´è§‚çš„æ„Ÿè§‰ï¼ŒLSM-tree åªä¿å­˜ key å’Œ value çš„ä½ç½®ï¼ˆ&lt;vLog-offset, value-size&gt;ï¼‰ï¼Œåœ¨ value å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œèƒ½é¿å…å¯¹ value è¿›è¡Œ compactionï¼Œè¿›è€Œå‡å°‘äº†å†™æ”¾å¤§ï¼ŒèŠ‚çœäº†å¸¦å®½ï¼Œå¢åŠ äº† SSD çš„ä½¿ç”¨å‘¨æœŸã€‚åŒæ—¶ï¼ŒLSM-tree å ç”¨çš„å­˜å‚¨ä¹Ÿæ›´å°‘äº†ï¼Œèƒ½æ›´å……åˆ†åˆ©ç”¨ç¼“å­˜å’Œè¾ƒå°‘çš„å±‚çº§å‡å°‘è¯»æ”¾å¤§ã€‚</p>
<blockquote>
<p>Readers might assume that WiscKey will be slower than LevelDB for lookups, due to its extra I/O to retrieve the value.</p>
</blockquote>
<blockquote>
<p>However, since the LSM-tree of WiscKey is <strong>much smaller</strong> than LevelDB (for the same database size), a lookup may search <strong>fewer levels</strong> of table
files in the LSM-tree and a significant portion of the LSM-tree can be easily <strong>cached in memory</strong>.</p>
</blockquote>
<p>å½“ç„¶ k/v åˆ†ç¦»ä¹Ÿå¸¦æ¥äº†ä¸€äº›æŒ‘æˆ˜ï¼Œæœ€ç›´è§‚çš„æŒ‘æˆ˜æ˜¯å½“å†™å…¥éšæœºçš„é”®å€¼å¯¹ï¼Œç„¶åè¿›è¡Œ Range Queryï¼Œå¯¼è‡´æŸ¥è¯¢åˆ°çš„ value åˆ†å¸ƒåœ¨ log file çš„ä¸åŒä½ç½®ï¼Œæ–‡ç« æå‡ºç”¨å¹¶å‘è¯»æ¥æé«˜å¸¦å®½ã€‚ä½œè€…å¯¹å…¶å®ƒæŒ‘æˆ˜ï¼ˆ Garbage Collection &amp; ï¼‰ä¹Ÿéƒ½æå‡ºäº†ç›¸åº”çš„è§£å†³æ–¹æ¡ˆï¼Œæ„Ÿå…´è¶£çš„è¯»è€…è¯·é˜…è¯»è®ºæ–‡ã€‚</p>
<h4 id="further-readings-3"><a class="header" href="#further-readings-3">Further readings</a></h4>
<ul>
<li><a href="databases/kv//assets/pdfs/hashkv-atc18.pdf">HashKV: Enabling Efficient Updates in KV Storage via Hashing</a>, 2018. Section 2.2 å¯¹ WiscKey çš„ä»‹ç»å€¼å¾—ä¸€è¯»</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="main-memory-database-systems"><a class="header" href="#main-memory-database-systems">Main Memory Database Systems</a></h2>
<ul>
<li><strong><a href="databases/mmdb/overview.html">Main Memory Database Systems: An Overview</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesmmdbassetspdfsmain_memory_database_systems_an_overviewpdfmain-memory-database-systems-an-overviewa"><a class="header" href="#a-hrefdatabasesmmdbassetspdfsmain_memory_database_systems_an_overviewpdfmain-memory-database-systems-an-overviewa"><a href="databases/mmdb/../../assets/pdfs/main_memory_database_systems_an_overview.pdf">Main Memory Database Systems: An Overview</a></a></h3>
<blockquote>
<p>IEEE Transactions on Knowledge and Data Engineering, H. Garcia-Molina, 1992</p>
<p>https://dl.acm.org/doi/10.1109/69.180602</p>
</blockquote>
<p>è¿™æ˜¯ä¸€ç¯‡ 1992 å¹´çš„ paperï¼Œè™½ç„¶é‚£æ—¶çš„å†…å­˜å®¹é‡å¯èƒ½åªæœ‰å‡ åå…†ä¸Šç™¾å…†ï¼Œä½† MMDB å·²ç»å¼€å§‹å´­éœ²å¤´è§’ï¼Œäººä»¬å¸Œæœ›é€šè¿‡å°†æ•°æ®å…¨é‡é©»ç•™åœ¨å†…å­˜æ¥æä¾›æ›´å¿«çš„å“åº”æ—¶é—´åŠæ›´å¤§çš„äº‹åŠ¡ååã€‚ä¼ ç»Ÿæ•°æ®åº“ï¼ˆDRDBï¼‰å¯ä»¥å°†ç£ç›˜æ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­åŠ é€ŸæŸ¥è¯¢ï¼ŒMMDB éœ€è¦å°†æ•°æ®åœ¨ç£ç›˜å¤‡ä»½ä»¥é˜²æ•°æ®ä¸¢å¤±ã€‚</p>
<p><code>MMDB</code> å’Œ <code>DRDB with a very large cache</code> æœ‰ä½•ä¸åŒå‘¢ï¼ŸDRDB åœ¨è®¾è®¡çš„æ—¶å€™å‡è®¾å†…å­˜ä¸è¶³ä»¥ä¿å­˜æ‰€æœ‰æ•°æ®ï¼Œå› æ­¤æ²¡æœ‰å……åˆ†åˆ©ç”¨å†…å­˜çš„ç‰¹æ€§ã€‚è€Œ MMDB åœ¨è®¾è®¡ä¹‹åˆå°±å‡è®¾æ•°æ®å¯ä»¥å…¨é‡å­˜å‚¨åœ¨å†…å­˜ï¼Œå…¶å„æ¨¡å—éƒ½å­˜åœ¨ç€ä¸€äº›ä¸ DRDB ä¸åŒçš„ç‚¹ã€‚</p>
<h4 id="concurrency-control"><a class="header" href="#concurrency-control">Concurrency Control</a></h4>
<ol>
<li>è®¿å­˜è¿œå¿«äºè¯»ç›˜ï¼Œå› è€Œäº‹åŠ¡èƒ½å¤Ÿå¿«é€Ÿç»“æŸï¼ŒåŒæ—¶æ„å‘³ç€é”ä¸ä¼šé•¿æ—¶é—´æŒæœ‰ï¼Œå› æ­¤é”çš„ç²’åº¦å¯ä»¥åŠ å¤§</li>
<li>ç”±äºæ•°æ®å­˜å‚¨åœ¨å†…å­˜ï¼Œå› æ­¤é”æœºåˆ¶å¯ä»¥é€šè¿‡æ•°æ®å¯¹è±¡çš„å°‘é‡æ¯”ç‰¹ä½æ¥å®ç°</li>
</ol>
<h4 id="commit-processing"><a class="header" href="#commit-processing">Commit Processing</a></h4>
<p>æ•°æ®éœ€è¦é€šè¿‡æ—¥å¿—æŒä¹…åŒ–ï¼Œå¯¹äº MMDBï¼Œæ—¥å¿—çš„å¼€é”€å æ¯”æ˜¾å¾—éå¸¸çªå‡ºã€‚è§£å†³è¯¥é—®é¢˜çš„åŠæ³•åŒ…æ‹¬ï¼š</p>
<ol>
<li>Stable main memory å¯ä»¥ç¼“è§£äº‹åŠ¡çš„å“åº”æ—¶é—´ä½†ä¸èƒ½æ¶ˆé™¤æ—¥å¿—ç“¶é¢ˆ</li>
<li>Precommit äº‹åŠ¡å†™å®Œæ—¥å¿—å°±å¯ä»¥å“åº”è¯·æ±‚</li>
<li>Group Commit å°†å¤šä¸ªäº‹åŠ¡çš„æ—¥å¿—æ”’æ‰¹è½ç›˜ï¼Œå¯å‡å°‘ IO</li>
</ol>
<h4 id="access-method"><a class="header" href="#access-method">Access Method</a></h4>
<p>ä¸å†éœ€è¦ B-Treeï¼Œç´¢å¼•å¯ä»¥é€šè¿‡æ’åºçš„é“¾è¡¨æ¥å®ç°ã€‚</p>
<h4 id="data-representation"><a class="header" href="#data-representation">Data Representation</a></h4>
<p>å…³ç³»å…ƒç»„å¯ä»¥é€šè¿‡ä¸€ç»„æŒ‡é’ˆæ¥è¡¨ç¤ºã€‚</p>
<h4 id="query-processing"><a class="header" href="#query-processing">Query Processing</a></h4>
<p>é¡ºåºè®¿é—®ä¸éšæœºè®¿é—®çš„é€Ÿåº¦å¯¹äºå†…å­˜è€Œè¨€å·®åˆ«ä¸å¤§ï¼Œå› æ­¤ä¾èµ–å¿«é€Ÿé¡ºåºè®¿é—®çš„æŸ¥è¯¢ç®—æ³•ä¸å†å…·æœ‰ä¼˜åŠ¿ï¼Œå¦‚ sort-merge joinã€‚ä½† process cost å˜å¾—éš¾ä»¥é¢„æµ‹ã€‚</p>
<h4 id="recovery"><a class="header" href="#recovery">Recovery</a></h4>
<p>åœ¨ MMDB ä¸­ï¼ŒCheckpoint å’Œ Recovery æ˜¯éœ€è¦è®¿é—®ç£ç›˜æ•°æ®çš„ä¸¤ä¸ªå”¯ä¸€åŸå› ã€‚å› æ­¤ç£ç›˜è®¿é—®å¯ä»¥å¯¹ Checkpionter è¿›è¡Œä¼˜åŒ–ï¼Œæ¯”å¦‚ä½¿ç”¨åŠ å¤§çš„ block sizeã€‚åœ¨æ¢å¤çš„æ—¶å€™å¯ä»¥é‡‡ç”¨ <code>on demand</code> çš„æ–¹å¼ä»ç£ç›˜æ¢å¤æ•°æ®æˆ–ä½¿ç”¨ç£ç›˜åˆ†é…æˆ–ç£ç›˜é˜µåˆ—æ¥å¹¶è¡Œè¯»å–æ•°æ®ä»¥åŠ é€Ÿæ¢å¤ã€‚</p>
<h4 id="performance"><a class="header" href="#performance">Performance</a></h4>
<p>ä¼ ç»Ÿæ•°æ®åº“å¤‡ä»½å¯¹æ€§èƒ½çš„å½±å“è¦è¿œå°äº MMDBï¼Œå› æ­¤ checkpoint ç®—æ³•åœ¨ MMDB æ˜¾å¾—è‡³å…³é‡è¦ã€‚</p>
<h4 id="application-programming-interface-and-protection"><a class="header" href="#application-programming-interface-and-protection">Application Programming Interface and Protection</a></h4>
<ol>
<li>Once the transaction can access the database directly, they can read or modify unauthorized parts</li>
<li>and the system has no way of knowing what has been modified, so it can not log the cahnges</li>
</ol>
<p>æœ€ä½³çš„è§£å†³æ–¹æ¡ˆæ˜¯åªè¿è¡Œç”±ç‰¹å®šæ•°æ®åº“ç³»ç»Ÿç¼–è¯‘å™¨ç¼–è¯‘è¿‡çš„äº‹åŠ¡ã€‚</p>
<h4 id="data-clustering-and-migration"><a class="header" href="#data-clustering-and-migration">Data Clustering and Migration</a></h4>
<p>Migration and dynamic clustering are components of a MMDB that have no counterpart in conventional database systems.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="online-transaction-processing"><a class="header" href="#online-transaction-processing">Online Transaction Processing</a></h2>
<ul>
<li><strong><a href="databases/oltp/oltp-through-the-looking-glass.html">OLTP Through the Looking Glass, and What We Found There</a></strong></li>
<li><strong><a href="databases/oltp/staring-into-the-abyss.html">Staring into the Abyss: An Evaluation of Concurrency Control with One Thousand Cores</a></strong></li>
</ul>
<h3 id="misc"><a class="header" href="#misc">Misc</a></h3>
<ul>
<li><a href="databases/oltp//assets/pdfs/the_design_of_postgres.pdf">The design of POSTGRES</a>, 1986</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesoltpassetspdfsoltp-through-the-lookingglasspdfoltp-through-the-looking-glass-and-what-we-found-therea"><a class="header" href="#a-hrefdatabasesoltpassetspdfsoltp-through-the-lookingglasspdfoltp-through-the-looking-glass-and-what-we-found-therea"><a href="databases/oltp/../../assets/pdfs/oltp-through-the-lookingglass.pdf">OLTP Through the Looking Glass, and What We Found There</a></a></h3>
<blockquote>
<p>SIGMOD '08</p>
<p>https://dl.acm.org/doi/10.1145/1376616.1376713</p>
</blockquote>
<p>ä¼ ç»Ÿ OLTP æ•°æ®åº“æœ€åˆè®¾è®¡é¢å‘ç£ç›˜è¿œå¤§äºå†…å­˜çš„è®¡ç®—æœºï¼Œä¸”å†…å­˜ä»·æ ¼é«˜æ˜‚ï¼Œè¿™å¯¼è‡´æ•°æ®åº“å¾€å¾€åŒ…å«å‡ ä¸ªæ ‡å‡†æ¨¡å—:</p>
<ul>
<li>on-disk data structures for table storage, including heap files and B-trees</li>
<li>locking based concurrency control</li>
<li>log-based recovery</li>
<li>an efficient buffer manager</li>
</ul>
<p>ä½†åœ¨ä»Šå¤©ï¼Œå†…å­˜ä¸å†é‚£ä¹ˆæ˜‚è´µï¼Œå°†æ•´ä¸ª OLTP æ•°æ®åº“å¸¸é©»åœ¨å†…å­˜æˆä¸ºå¯èƒ½ã€‚<code>Main Memory Database Systems</code> æˆä¸ºäº†æ•°æ®åº“é¢†åŸŸç‚™æ‰‹å¯çƒ­çš„ç ”ç©¶è¯¾é¢˜ã€‚</p>
<p>ä¼ ç»Ÿæ•°æ®åº“ä¸­å„æ¨¡å—çš„æ¶ˆè€—å æ¯”å¯ä»¥å¯¹å†…å­˜æ•°æ®åº“çš„ç ”ç©¶æä¾›å®è´µçš„æŒ‡å¯¼æ–¹å‘ï¼Œæœ¬æ–‡å°† <a href="https://research.cs.wisc.edu/shore/">Shore</a> é€šè¿‡ä¾æ¬¡å‰¥ç¦» Logglingã€Lockingã€Latchingã€Buffer Manager ç­‰æ¨¡å—ï¼Œå˜ä¸ºäº†ä¸€ä¸ªå•çº¿ç¨‹ã€lock-freeã€ä¸æ”¯æŒå¤±è´¥æ¢å¤çš„å†…å­˜æ•°æ®åº“ã€‚å¾—åˆ°å„æ¨¡å—çš„æŒ‡ä»¤å æ¯”å›¾å¦‚ä¸‹:</p>
<p><img src="databases/oltp/../../assets/images/oltp-through-the-looking-glass-figure1.jpg" alt="Breakdown of instruction count for various DBMS components for the New Order transaction from TPC-C" /></p>
<p>å›¾ä¸­æ˜¾ç¤ºçš„ <code>useful work</code> åªå äº†æ‰€æœ‰æŒ‡ä»¤çš„ 1/60 å·¦å³ï¼Œè¿™è¯æ˜äº†åœ¨ä¼ ç»Ÿæ•°æ®åº“ä¸Šä»…ä»…å°†å…¨éƒ¨æ•°æ®ç¼“å­˜åˆ°å†…å­˜å¹¶ä¸èƒ½è·å¾—ä¼˜å¼‚çš„æ€§èƒ½ï¼Œè¿˜éœ€è¦é’ˆå¯¹å†…å­˜æ•°æ®åº“çš„ç‰¹ç‚¹å¯¹ <code>Logging</code>ã€<code>Locking</code>ã€<code>Lacthing</code>ã€<code>Buffer Manager</code> ç­‰æ¨¡å—è¿›è¡Œæ›´æ·±å…¥çš„ä¼˜åŒ–ã€‚</p>
<p>æ ¹æ®å®éªŒç»“æœï¼Œè®ºæ–‡ç»™å‡ºäº†æœªæ¥ OLTP å¼•æ“çš„å®ç°å»ºè®®:</p>
<ul>
<li>Concurrency Control: å¯¹äºå†…å­˜æ•°æ®åº“ï¼ŒOCC å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©</li>
<li>Multi-core Support: ä½¿ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œä½¿å¾—æ¯ä¸€ä¸ª core éƒ½æ˜¯ä¸€ä¸ª single-threaded machine</li>
<li>Replication Management: ä½¿ç”¨ active-active architecture</li>
<li>Weak Consistency: ä½¿ç”¨ eventual consistency</li>
<li>Cache-conscious B-trees</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesoltpassetspdfsstaring_into_the_abysspdfstaring-into-the-abyss-an-evaluation-of-concurrency-control-with-one-thousand-coresa"><a class="header" href="#a-hrefdatabasesoltpassetspdfsstaring_into_the_abysspdfstaring-into-the-abyss-an-evaluation-of-concurrency-control-with-one-thousand-coresa"><a href="databases/oltp/../../assets/pdfs/staring_into_the_abyss.pdf">Staring into the Abyss: An Evaluation of Concurrency Control with One Thousand Cores</a></a></h3>
<blockquote>
<p>PVLDB, November 2014</p>
<p>https://dl.acm.org/doi/10.14778/2735508.2735511</p>
</blockquote>
<p>è®¡ç®—æœºæ¶æ„ä¸å†è¿½æ±‚å•æ ¸çš„æ—¶é’Ÿé¢‘ç‡ï¼Œè¶Šæ¥è¶Šå¤šçš„ CPU è½¬å‘ multi-core on a sinle Chip çš„æ¶æ„ï¼Œout-of-orderã€super-scalar å¼€å§‹é€æ¸è¢«ç®€å•çš„ in-orderã€single issue æ‰€ä»£æ›¿ã€‚</p>
<blockquote>
<p>We are entering the era of the many-core machines that are powered
by a large number of these smaller, low-power cores on a single chip.</p>
</blockquote>
<p>åœ¨è¿™ç§è¶‹åŠ¿ä¸‹ï¼Œå•èŠ‚ç‚¹ã€å…±äº«å†…å­˜ OLTP DBMS çš„æ‰©å±•æ€§æ˜¾å¾—å°¤ä¸ºé‡è¦ï¼Œå¦‚æœç°æœ‰çš„æŠ€æœ¯ä¸èƒ½é€‚åº”è¿™ç§è¶…å¤šæ ¸æ¶æ„ï¼Œä¼šå‡ºç°å„ç§ç“¶é¢ˆå¹¶é€ æˆè®¡ç®—èµ„æºçš„æµªè´¹ã€‚</p>
<p>æœ¬è®ºæ–‡å¯¹å¹¶å‘æ§åˆ¶çš„å¯æ‰©å±•æ€§è¿›è¡Œäº†ç ”ç©¶ï¼Œé€šè¿‡æ¨¡æ‹Ÿåœ¨ 1000 æ ¸çš„ CPU ä¸Šè¿è¡Œä¸€ä¸ªæ”¯æŒæ’æ‹” <strong>lock manager</strong> è¿›è€Œæ›¿æ¢ä¸åŒå¹¶å‘æ§åˆ¶ç®—æ³•çš„ OLTP å†…å­˜æ•°æ®åº“ï¼Œè¡¨æ˜äº†ç°æœ‰çš„å¹¶å‘æ§åˆ¶åè®®éƒ½ä¸èƒ½éš core æ•°é‡çš„å¢åŠ è€Œæ‰©å±•ã€‚</p>
<blockquote>
<p>Our analysis shows that all algorithms fail to scale as the number
of cores increases. In each case, we identify the primary bottlenecks
that are independent of the DBMS implementation and argue
that even state-of-the-art systems suffer from these limitations.</p>
</blockquote>
<h4 id="concurrency-control-schemas"><a class="header" href="#concurrency-control-schemas">Concurrency Control Schemas</a></h4>
<p>OLTP è´Ÿè½½ä¸­çš„äº‹åŠ¡é€šå¸¸å…·æœ‰ä¸‰ä¸ªæ˜¾è‘—ç‰¹ç‚¹:</p>
<ol>
<li>they are short-lived</li>
<li>they touch a small subset of data using index look-ups (no full table scans or large joins)</li>
<li>they are repetitive (i.e., executing the same queries with different inputs)</li>
</ol>
<p>Concurrency Control ä¸ºæ•°æ®åº“æä¾›äº† ACID ä¸­çš„ <code>Atomicity</code> å’Œ <code>Isolation</code>ã€‚æ‰€æœ‰çš„ Concurrency Control éƒ½å¯å½’ä¸ºä»¥ä¸‹ä¸¤ç±»:</p>
<ol>
<li>Two-Phase Locking (Pessimistic): Assume transactions will conflict so they must acquire locks on database objects before they are allowed to access them.
<ul>
<li>different transactions cannot simultaneously own conflicting locks</li>
<li>once a transaction surrenders ownership of a lock, it may never obtain additional locks</li>
</ul>
</li>
<li>Timestamp Ordering (Optimistic): Assume that conflicts are rare so transactions do not need to first acquire locks on database objects and instead check for conflicts at commit time.
<ul>
<li>a transaction is assigned a unique, monotonically increasing timestamp before it is executed</li>
<li>this timestamp is used by the DBMS to process conflicting operations in the proper order</li>
</ul>
</li>
</ol>
<p>2PL å¤§å¤§å‡å°‘äº†æ­»é”çš„æ¦‚ç‡ï¼Œä½†å´ä¸èƒ½é¿å…æ­»é”çš„å‘ç”Ÿï¼Œå› æ­¤ä¸åŒçš„å˜ç§æ¥è§£å†³æ­»é”çš„é—®é¢˜:</p>
<ol>
<li>2PL with Deadlock Dection (DL_DETECT): ç»´æŠ¤ä¸€ä¸ª <code>wait-for graph</code> å¹¶æ£€æŸ¥æ˜¯å¦æœ‰ç¯æ¥åˆ¤æ–­æ˜¯å¦å‡ºç°äº†æ­»é”ï¼Œå½“æ£€æµ‹åˆ°æœ‰ç¯å‡ºç°æ—¶ï¼Œç³»ç»Ÿéœ€è¦ abort ä¸€ä¸ªäº‹åŠ¡æ¥æ‰“ç ´è¿™ä¸ªç¯</li>
<li>2PL with Non-waiting Deadlock Prevention (NO_WAIT): å½“è·å–ä¸åˆ°é”æ—¶ï¼Œç›´æ¥å°†è‡ªå·± abort æ‰ï¼Œé¿å…æ­»é”çš„å‡ºç°</li>
<li>2PL with Waiting Deadlock Prevention (WAIT_DIE): äº‹åŠ¡å…è®¸ç­‰å¾…æ¯”å®ƒæ–°çš„äº‹åŠ¡æŒæœ‰çš„é”ï¼Œå¦‚æœè¦è·å–çš„é”è¢«ä¸€ä¸ªè¾ƒè€çš„äº‹åŠ¡æŒæœ‰ï¼Œåˆ™å°†è‡ªå·± abort æ‰ï¼Œè¿™ç§ç®—æ³•éœ€è¦åœ¨äº‹åŠ¡å¼€å§‹æ—¶è·å–ä¸€ä¸ªæ—¶é—´æˆ³ï¼ŒT/O ä¿è¯äº†ä¸ä¼šå‡ºç°æ­»é”</li>
</ol>
<p>T/O æ ¹æ®å†²çªæ£€æŸ¥çš„ç²’åº¦ï¼ˆè¡Œçº§æˆ–åˆ†åŒºçº§ï¼‰å’Œæ£€æŸ¥çš„æ—¶æœºï¼ˆäº‹åŠ¡è¿è¡Œä¸­æˆ–äº‹åŠ¡ç»“æŸæ—¶ï¼‰å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªå˜ç§:</p>
<ol>
<li>Basic T/O (TIMESTAMP): äº‹åŠ¡å¼€å§‹æ—¶è·å¾—æ—¶é—´æˆ³ï¼Œå¦‚æœäº‹åŠ¡çš„æ—¶é—´æˆ³å°äºå…ƒç»„æœ€åä¸€æ¬¡å†™çš„æ—¶é—´æˆ³ï¼Œåˆ™æ‹’ç»è¯»å†™ï¼›å¦‚æœäº‹åŠ¡çš„æ—¶é—´æˆ³å°äºå…ƒç»„çš„æœ€åä¸€æ¬¡è¯»æ—¶é—´æˆ³ï¼Œåˆ™æ‹’ç»å†™ã€‚è¯¥å˜ç§è¿˜éœ€è¦æ‹·è´å…ƒç»„æ¥ä¿è¯ <code>repeatable read</code></li>
<li>Multi-version Concurrency Control (MVCC): æ¯ä¸ªå†™æ“ä½œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬æ ‡è®°æœ‰ç©¿ä»¶å®ƒçš„æ—¶é—´æˆ³ã€‚è¯¥å˜ç§çš„ä¼˜ç‚¹æ˜¯ <strong>è¯»ä¸é˜»å¡å†™ï¼Œå†™ä¸é˜»å¡è¯»</strong></li>
<li>Optimisitic Concurrency Control (OCC): äº‹åŠ¡å¼€å§‹æ—¶ä¸åˆ†é…æ—¶é—´æˆ³ï¼Œ<strong>Read Phase</strong> å°†éœ€è¦è¯»å†™çš„å…ƒç»„åŠå†™æ“ä½œéƒ½è®°å½•åœ¨äº‹åŠ¡ç§æœ‰çš„å·¥ä½œåŒºï¼Œ<strong>Validation Phase</strong> å¯¹è¦å†™çš„å…ƒç»„ <strong>åŠ é”</strong> å¹¶æ£€æŸ¥æ˜¯å¦å¯ä»¥æœ‰å†²çªï¼Œ<strong>Write Phase</strong> åˆ™å°†æ²¡æœ‰å†²çªçš„äº‹åŠ¡ä¿®æ”¹ merge åˆ°æ•°æ®åº“å¹¶ <strong>é‡Šæ”¾é”</strong></li>
<li>T/O with Partion-level Locking (H-STORE): å°†æ•°æ®åº“åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partition è¢«ä¸€æŠŠé”ä¿æŠ¤ï¼Œäº‹åŠ¡åˆ°æ¥æ—¶åˆ†é…ä¸€ä¸ªæ—¶é—´æˆ³å¹¶å°†äº‹åŠ¡æ”¾åˆ°æ‰€æœ‰ä¸äº‹åŠ¡ç›¸å…³çš„ç›®æ ‡åˆ†åŒºçš„ <code>lock acquisition queue</code> ä¸­ï¼Œæ‰§è¡Œå¼•æ“æ ¹æ®é˜Ÿåˆ—ä¸­äº‹åŠ¡çš„æ—¶é—´æˆ³å¤§å°æ¥æ‰§è¡Œç›¸åº”çš„äº‹åŠ¡</li>
</ol>
<h4 id="ç»“è®º"><a class="header" href="#ç»“è®º">ç»“è®º</a></h4>
<p>å®éªŒæ˜¾ç¤ºä¸åŒå¹¶å‘æ§åˆ¶ç®—æ³•åœ¨ multi-core æ¶æ„ä¸Šçš„ Scalability éƒ½é‡åˆ°äº†ç“¶é¢ˆ:</p>
<ul>
<li><strong>Lock Thrashing</strong>: ä¸€ä¸ªäº‹åŠ¡çš„ç­‰å¾…ä¼šé€ æˆå¦å¤–ä¸€ä¸ªäº‹åŠ¡æ›´é•¿çš„ç­‰å¾…æ—¶é—´
<ul>
<li>DL_DETECT</li>
<li>WAIT_DIE</li>
</ul>
</li>
<li><strong>Timestamp Allocation</strong>: æ‰€æœ‰éœ€è¦åˆ†é…æ—¶é—´æˆ³çš„ç®—æ³•éƒ½ä¼šé‡åˆ°æ—¶é—´æˆ³åˆ†é…çš„é—®é¢˜
<ul>
<li>All T/O algorithms</li>
<li>WAIT_DIE</li>
<li>HSTORE</li>
</ul>
</li>
<li><strong>Memory Allocations</strong>: å› ä¸ºéœ€è¦æ‹·è´å…ƒç»„éœ€è¦åˆ†é…å†…å­˜
<ul>
<li>OCC</li>
<li>MVCC</li>
</ul>
</li>
<li><strong>Abort Rate</strong>: ç”±äºå†²çªé€ æˆçš„äº‹åŠ¡å›æ»š
<ul>
<li>OCC</li>
<li>NO_WAIT</li>
</ul>
</li>
</ul>
<p>å…·ä½“çš„ç»“æœæ•°æ®å‚è§åŸè®ºæ–‡ã€‚</p>
<h4 id="references-1"><a class="header" href="#references-1">References</a></h4>
<p>[1] <a href="https://www.youtube.com/watch?v=a70jRWLjQFk&amp;list=PLSE8ODhjZXjasmrEd2_Yi1deeE360zv5O&amp;index=3">CMU 15-721 In-Memory Databases</a> and <a href="https://15721.courses.cs.cmu.edu/spring2020/notes/02-inmemory.pdf">the note</a> <br></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="online-analytical-processing"><a class="header" href="#online-analytical-processing">Online Analytical Processing</a></h2>
<ul>
<li><strong><a href="databases/olap/lakehouse.html">Lakehouse: A New Generation of Open Platforms that Unify DataWarehousing and Advanced Analytics</a></strong></li>
<li><strong><a href="databases/olap/delta-lake.html">Delta Lake: HighPerformance ACID Table Storage over Cloud Object Stores</a></strong></li>
<li><strong><a href="databases/olap/vertica.html">The Vertica Analytic Database: C-Store 7 Years Later</a></strong></li>
<li><strong><a href="databases/olap/duckdb.html">Data Management for Data Science Towards Embedded Analytics</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesolapassetspdfslakehousepdflakehouse-a-new-generation-of-open-platforms-that-unify-datawarehousing-and-advanced-analyticsa"><a class="header" href="#a-hrefdatabasesolapassetspdfslakehousepdflakehouse-a-new-generation-of-open-platforms-that-unify-datawarehousing-and-advanced-analyticsa"><a href="databases/olap/../../assets/pdfs/lakehouse.pdf">Lakehouse: A New Generation of Open Platforms that Unify DataWarehousing and Advanced Analytics</a></a></h3>
<blockquote>
<p>CIDR 2021. Matei Zaharia, Ali Ghodsi, Reynold Xin, Michael Armbrust</p>
<p>https://dblp.org/rec/conf/cidr/Zaharia0XA21.html</p>
</blockquote>
<p>æ•°æ®åˆ†æå¹³å°å‘å±•å†ç¨‹ç»å†äº†å¦‚ä¸‹ä¸¤ä»£:</p>
<ul>
<li>ç¬¬ä¸€ä»£: <code>schema-on-write</code>ã€‚é€šè¿‡å°† <a href="https://en.wikipedia.org/wiki/Operational_database">Operational database</a> çš„æ•°æ®æ”¶é›†åˆ°æ•°ä»“ä»¥æ”¯æŒ Decision Support åŠ Business Intelligenceã€‚Figure 1-aã€‚</li>
<li>ç¬¬äºŒä»£: <code>schema-on-read</code>ã€‚å°†å¼€æ”¾æ–‡ä»¶æ ¼å¼ï¼ˆå¦‚ Apache Parquet å’Œ ORCï¼‰çš„æ•°æ®ç¦»çº¿å­˜å‚¨åœ¨æˆæœ¬è¾ƒä½ Data Lake ä¸­ï¼ˆå¦‚ HDFSï¼‰ï¼Œé€šè¿‡ ETL æ“ä½œå°†ä¸€éƒ¨åˆ†æ•°æ®æŠ½å–åˆ°æ•°ä»“åæä¾› DS åŠ BI çš„èƒ½åŠ›ã€‚è¿™ç§æ¶æ„åœ¨æä¾›ä½æˆæœ¬å­˜å‚¨å„ç§æ•°æ®ç±»å‹çš„åŒæ—¶ç‰ºç‰²äº†æ•°æ®è´¨é‡åŠæ²»ç†èƒ½åŠ›ã€‚ä» 2015 å¹´å¼€å§‹ï¼ŒCloud Data Lakeï¼ˆS3ï¼ŒGCS ç­‰ï¼‰ç”±äºå…·æœ‰æä½çš„æˆæœ¬åŠä¼˜ç§€çš„æŒä¹…æ€§å¼€å§‹æ›¿ä»£ä¼ ç»Ÿçš„ Data Lakeï¼Œé€æ¸å½¢æˆäº† data lake + data warehouse çš„ä¸¤å±‚æ¶æ„ã€‚Figure 1-bã€‚</li>
</ul>
<p><img src="databases/olap/./../../assets/images/lakehouse-two-tier-model.jpg" alt="two-tier model and lakehouse model" /></p>
<p>ä¸¤å±‚æ¶æ„ç”±äºå­˜ (å¦‚ S3) ç®— (å¦‚ Redshift) çœ‹èµ·æ¥å¾ˆä¾¿å®œï¼Œä½†ä»ç”¨æˆ·è§’åº¦å´éå¸¸å¤æ‚ï¼Œæ•°æ®é¦–å…ˆéœ€è¦ä» OLTP æ•°æ®åº“ ETL åˆ° Data Lakeï¼Œç„¶åå†ä» Data Lake ETL åˆ°æ•°ä»“ã€‚è¿™ç§æ¶æ„ä¸»è¦å­˜åœ¨å››ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>Reliablity: å¤šæ¬¡ ETL é™ä½äº†æ•°æ®å¯é æ€§</li>
<li>Data Staleness: ç›¸æ¯”ç¬¬ä¸€ä»£æ¶æ„æ•°æ®ç›´æ¥ ETL åˆ°æ•°ä»“ï¼Œä¸¤å±‚æ¶æ„åè€Œå¢åŠ äº†æ—¶å»¶</li>
<li>Limited support for advanced analytics: é€šè¿‡ ODBC/JDBC è¯»å–æœºå™¨å­¦ä¹ éœ€è¦å¤„ç†å¤§é‡çš„ dataset éå¸¸ä½æ•ˆï¼Œå› è€Œé«˜çº§åˆ†æå·¥å…·å—é™</li>
<li>Totol cost of ownship: æ•°ä»“ä¸­çš„æ•°æ®ç”±äºåœ¨ Data Lake ä¸­ä¹Ÿä¿å­˜äº†ä¸€ä»½ï¼Œå› è€Œå¢åŠ äº†å­˜å‚¨æˆæœ¬</li>
</ul>
<p><em>ä¸¤å±‚æ¶æ„é€šè¿‡å¢åŠ å¯¹ Parquet å’Œ ORC å¤–è¡¨çš„æ”¯æŒï¼Œå¯ä»¥ä½¿ç”¨ç›¸åŒçš„ SQL å¼•æ“æŸ¥è¯¢ Data Lake ä¸Šçš„æ•°æ®ï¼Œä½†è¿™é€šå¸¸å…·æœ‰è¾ƒå·®çš„æ€§èƒ½ï¼›ä¸€äº›ç ”ç©¶å°† SQL å¼•æ“ï¼ˆå¦‚ Prestoï¼‰ç›´æ¥è¿è¡Œåœ¨ Data Lake ä¹‹ä¸Šï¼Œä½†ä¾ç„¶æœªæ”¯æŒ ACID äº‹åŠ¡ã€å¤šç‰ˆæœ¬ç­‰ç‰¹æ€§ã€‚</em></p>
<p>ç”±äºè¿™äº›é—®é¢˜çš„å­˜åœ¨ï¼Œæœ¬æ–‡è®¨è®ºçš„ä¸»é¢˜å›´ç»•ä¸€ä¸ªæŠ€æœ¯é—®é¢˜å±•å¼€:</p>
<blockquote>
<p>Is it possible to turn data lakes based on standard open data formats,
such as Parquet and ORC, into high-performance systems that can
provide both the performance and management features of data
warehouses and fast, direct I/O from advanced analytics workloads?</p>
</blockquote>
<p>ä½œè€…è®¤ä¸º Lakehouseï¼ˆData <code>Lake</code> + Data Ware<code>house</code>ï¼‰æ¹–ä»“ä¸€ä½“çš„ç¬¬ä¸‰ä»£æ¶æ„çš„æ—¶ä»£å³å°†æ¥ä¸´ï¼Œå®ƒå…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>Reliable data management on data lakes: æ•°æ®ä»¥å¼€æ”¾æ ¼å¼å­˜æ”¾åœ¨ä½æˆæœ¬å¯¹è±¡å­˜å‚¨ï¼Œå¹¶æ”¯æŒäº‹åŠ¡ã€ç‰ˆæœ¬ç®¡ç†åŠé›¶æ‹·è´å…‹éš†ï¼ˆå¦‚ Delta Lakeã€Apache Icebergï¼‰ç­‰ç‰¹æ€§</li>
<li>Support for machine learning and data science: é€šè¿‡å£°æ˜å¼ DataFrame API æ”¯æŒæœºå™¨å­¦ä¹ å’Œç§‘å­¦è®¡ç®—ç­‰è´Ÿè½½æ¨¡å‹</li>
<li>SQL performance: é€šè¿‡ç»´æŠ¤ç¼“å­˜ã€Parquet/ORC æ–‡ä»¶çš„è¾…åŠ©æ•°æ®ï¼ˆStatics/Bloomfilter based indexï¼‰åŠä¼˜åŒ–æ•°æ®å¸ƒå±€ï¼ˆZ-order/Hilbert Curvesï¼‰æ¥æå‡æŸ¥è¯¢æ€§èƒ½</li>
</ul>
<p>Databricks é€šè¿‡ Delta Lakeã€Delta Engine å’Œ Databricks ML Runtime ä¸‰ä¸ªé¡¹ç›®æ„å»ºäº†ä¸€ä¸ª Lakehouse æ•°æ®åˆ†æå¹³å°ã€‚</p>
<img src="databases/olap/./../../assets/images/lakehouse-metadata-layer.jpg" alt="two-tier model and lakehouse model" width="500"/>
<p>ä¸€ä¸ªå°æ„Ÿæƒ³:</p>
<p>Lakehouse æœ¬èº«å¹¶æ²¡æœ‰æå‡ºä»€ä¹ˆæ–°æŠ€æœ¯ï¼Œæ›´åƒæ˜¯å¯¹å·²æœ‰æŠ€æœ¯çš„é‡æ–°ç»„ç»‡ï¼Œé€šè¿‡æä¾›æ›´ä½çš„æˆæœ¬å’Œä¸°å¯Œçš„ç‰¹æ€§ä¸ºç”¨æˆ·åˆ›é€ ä»·å€¼ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesolapassetspdfsdelta-lakepdfdelta-lake-highperformance-acid-table-storage-over-cloud-object-storesa"><a class="header" href="#a-hrefdatabasesolapassetspdfsdelta-lakepdfdelta-lake-highperformance-acid-table-storage-over-cloud-object-storesa"><a href="databases/olap/../../assets/pdfs/delta-lake.pdf">Delta Lake: HighPerformance ACID Table Storage over Cloud Object Stores</a></a></h3>
<blockquote>
<p>Proceedings of the VLDB Endowment, August 2020</p>
<p>https://doi.org/10.14778/3415478.3415560</p>
</blockquote>
<p>å¯¹è±¡å­˜å‚¨ï¼ˆS3ï¼ŒAzure Blob Serviceï¼‰æ˜¯è§„æ¨¡æœ€å¤§ä¸”æœ€å…·æˆæœ¬æ•ˆç›Šçš„å­˜å‚¨ç³»ç»Ÿï¼Œè®¸å¤šç»„ç»‡ç”¨å®ƒæ¥ç®¡ç†æ•°æ®ä»“åº“å’Œæ•°æ®æ¹–ä¸­çš„å¤§å‹ç»“æ„åŒ–æ•°æ®é›†ã€‚ä½†å¯¹è±¡å­˜å‚¨çš„ kv å½¢æ€å’Œ immutable çš„ç‰¹æ€§ä½¿å¾—åœ¨å…¶ä¸Šå®ç°æ•°æ®ä»“åº“çš„åŠŸèƒ½å…·æœ‰ä¸€å®šéš¾åº¦ã€‚</p>
<p>å­˜åœ¨çš„ä¸¤ä¸ªä¸»è¦é—®é¢˜:</p>
<ul>
<li>correctness: ä¸€ä¸ªè¡¨ç”±å¤šä¸ªå¯¹è±¡æ„æˆï¼Œå¤šå¯¹è±¡çš„æ›´æ–°ä¸å…·å¤‡åŸå­æ€§ï¼Œä¼šå‡ºç°ä¸€è‡´æ€§é—®é¢˜</li>
<li>performance: å½“ä¸€ä¸ªè¡¨ç”±ç™¾ä¸‡çº§å¯¹è±¡æ„æˆæ—¶ï¼Œå…ƒæ•°æ®æ“ä½œï¼ˆå¦‚ Listï¼‰å¼€é”€éå¸¸å¤§</li>
</ul>
<p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒDatabricks è®¾è®¡äº† Delta Lakeï¼Œå…¶æ ¸å¿ƒæ€æƒ³:</p>
<blockquote>
<p>we maintain information about which objects are part of a Delta table in an ACID
manner, using a write-ahead log that is itself stored in the cloud object store.</p>
</blockquote>
<p>åŸºäº ACID çš„è®¾è®¡ï¼Œå¯ä»¥åœ¨ Delta Lake ä¸Šå¼€å‘ä¼ ç»Ÿ Data Lake ä¸å…·æœ‰çš„ç‰¹æ€§:</p>
<ul>
<li>Time travel</li>
<li>UPSERT, DELETE and MERGE operations</li>
<li>Efficient streaming I/O</li>
<li>Caching</li>
<li>Data layout optimization</li>
<li>Schema evolution</li>
<li>Audit logging</li>
</ul>
<p>è¿™äº›ç‰¹æ€§ä¸€èµ·æå‡äº†å¯¹è±¡å­˜å‚¨ä½œä¸ºæ•°ä»“å’Œæ•°æ®æ¹–çš„å¯ç®¡ç†æ€§å’Œæ€§èƒ½ï¼ŒåŒæ—¶æ˜ å°„äº† Databricks æå‡ºçš„ç¬¬ä¸‰ä»£æ•°æ®åˆ†æå¹³å° â€”â€” <code>lakehouse</code> â€”â€” å…¼å…·æ•°ä»“å’Œæ•°æ®æ¹–çš„å…³é”®ç‰¹æ€§ï¼Œé¿å…äº†ä¼ ç»Ÿéƒ¨ç½²ä¸Šæ¹–ä»“å­˜å‚¨å†—ä½™æ•°æ®çš„é—®é¢˜ã€‚Delta Lake æä¾›çš„æŸ¥è¯¢æ¥å£å¯ä»¥ç›´è¢« BI å·¥å…·ä½¿ç”¨ï¼Œè§ä¸‹å›¾:</p>
<p><img src="databases/olap/../../assets/images/deltalake-figure-1.jpg" alt="" /></p>
<p>åœ¨å¯¹è±¡å­˜å‚¨ä¸Šç®¡ç†è¡¨æ•°æ®é›†ä¸»è¦æœ‰ä¸‰ç§æ–¹æ³•:</p>
<h4 id="1-directories-of-files"><a class="header" href="#1-directories-of-files">1. Directories of Files</a></h4>
<p>è¿™ç§æ–¹å¼æŠŠè¡¨å½“åšä¸€å †æ–‡ä»¶å¯¹è±¡ï¼ˆjust a bunch of objectsï¼‰ï¼Œå¯ä»¥ç”±å¤šç§å·¥å…·è®¿é—®ï¼Œä½†å­˜åœ¨ä¸€äº›æŒ‘æˆ˜:</p>
<ul>
<li>No atomicity across multiple objects</li>
<li>Eventual consistency</li>
<li>Poor performance</li>
<li>No management functionality</li>
</ul>
<h4 id="2-custom-storage-engines"><a class="header" href="#2-custom-storage-engines">2. Custom Storage Engines</a></h4>
<p>ä¾èµ–å¤–éƒ¨å¼ºä¸€è‡´æœåŠ¡ï¼ˆé«˜å¯ç”¨ï¼‰æ¥ç®¡ç†å…ƒæ•°æ®ï¼Œå…¸å‹ä»£è¡¨ä¸º Snowflakeï¼Œå­˜åœ¨çš„é—®é¢˜:</p>
<ul>
<li>All I/O operations to a table need contact the metadata service</li>
<li>Connectors to existing computing engines require more engineering work to implement than an approach that reuses existing open formats such as Parquet</li>
<li>The proprietary metadata service ties users to a specific service provider</li>
</ul>
<h4 id="3-metadata-in-object-stores"><a class="header" href="#3-metadata-in-object-stores">3. Metadata in Object Stores</a></h4>
<p>ç¬¬ä¸€ç§æ–¹å¼å¤ªè¿‡ç²—çŠ·ï¼Œç¬¬äºŒç§æ–¹å¼åˆå¤ªè¿‡å¨‡å«©ï¼Œä¸€ç§æŠ˜ä¸­çš„æ–¹å¼æ˜¯æŠŠå…ƒæ•°æ®ä¹Ÿå­˜åˆ°å¯¹è±¡å­˜å‚¨ä¸­ï¼Œå¹¶ä½¿ç”¨ä¸€ç»„é¢„ç½®çš„åè®®æ¥å®ç°å¯ä¸²è¡ŒåŒ–ã€‚</p>
<p>Delta Lake çš„å­˜å‚¨æ ¼å¼å¦‚ä¸‹:</p>
<p><img src="databases/olap/../../assets/images/deltalake-storage-format.jpg" alt="storage format" /></p>
<p><code>_delta_log</code> ç›®å½•ä¸­å­˜å‚¨äº†è¡¨çš„å„ç§å…ƒæ•°æ®ï¼Œè¯»å–æ“ä½œå¯ä»¥æ ¹æ® <code>_last_checkpoint</code> æ–‡ä»¶ä¸­ checkPoint ID æ¥è·å–æœ€æ–°çš„å¿«ç…§ç‰ˆæœ¬ï¼Œæˆ–è€…ä¼ å…¥ä¸€ä¸ªæ—§çš„ checkpointID æ¥è·å–ä¸€ä¸ªå†å²ç‰ˆæœ¬ï¼›å†™å…¥æ“ä½œé€šè¿‡ <code>copy on write</code> çš„æ–¹å¼å®Œæˆ ACID ç‰¹æ€§ã€‚</p>
<p>è®ºæ–‡ä¸­ Section 3 æè¿°äº† Delta Lake æ—¥å¿—å†…å®¹å’Œ checkpoint æœºåˆ¶ï¼Œå¯ä»¥ç»“åˆæºç è¿›è¡Œæ·±å…¥å­¦ä¹ ï¼Œè¿™é‡Œå¿½ç•¥ã€‚</p>
<p>ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒDelta Lake åšäº†ä¸€äº›ä¼˜åŒ–:</p>
<ul>
<li>OPTIMIZE å‘½ä»¤: å°†å°æ–‡ä»¶åˆå¹¶ä¸ºå¤§å°ä¸º 1GB çš„æ–‡ä»¶</li>
<li>Z-Ordering: æŒ‰ç…§ç»™å®šçš„å±æ€§é›†ä»¥ Z-order é‡æ–°ç»„ç»‡è¡¨ä¸­çš„è®°å½•ï¼Œä»¥å®ç°å¤šä¸ªç»´åº¦çš„å±€éƒ¨æ€§</li>
<li>Caching: ç¼“å­˜éƒ¨åˆ†æ•°æ®åœ¨è®¡ç®—èŠ‚ç‚¹ä»¥ä¼˜åŒ–æŸ¥è¯¢æ•ˆç‡</li>
</ul>
<p>è®ºæ–‡å‘è¡¨æ—¶ Apache Hudi è¿˜ä¸æ”¯æŒ Z-Orderï¼Œç°åœ¨æ”¯æŒäº†ï¼Œè§ <a href="https://hudi.apache.org/blog/2021/12/29/hudi-zorder-and-hilbert-space-filling-curves/">Hudi Z-Order and Hilbert Space Filling Curves</a>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesolapassetspdfsvertica-cstore-7-years-laterpdfthe-vertica-analytic-database-c-store-7-years-latera"><a class="header" href="#a-hrefdatabasesolapassetspdfsvertica-cstore-7-years-laterpdfthe-vertica-analytic-database-c-store-7-years-latera"><a href="databases/olap/../../assets/pdfs/vertica-cstore-7-years-later.pdf">The Vertica Analytic Database: C-Store 7 Years Later</a></a></h3>
<blockquote>
<p>Proceedings of the VLDB Endowment, 2012</p>
<p>https://dl.acm.org/doi/10.14778/2367502.2367518</p>
</blockquote>
<p>Vertica æ˜¯ <a href="databases/olap/../../datalayout/c-store.html">C-Store</a> å­¦æœ¯åŸå‹çš„ä¸€ä¸ªå•†ä¸šåŒ–åˆ†æå‹æ•°æ®åº“ï¼Œé‡‡ç”¨åˆ†å¸ƒå¼ share-nothing çš„æ¶æ„ï¼Œé€šè¿‡å¯¹ C-Store è®¾è®¡è¦ç‚¹çš„åˆç†å–èˆï¼Œå®ç°äº†ä¸€ä¸ªä¸ºæ”¯æŒ ACID ä¸”èƒ½é«˜æ•ˆå¤„ç† PB çº§æ•°æ®çš„åˆ†æå‹æ•°æ®åº“ã€‚</p>
<h3 id="æ•°æ®æ¨¡å‹"><a class="header" href="#æ•°æ®æ¨¡å‹">æ•°æ®æ¨¡å‹</a></h3>
<p><strong>Projection</strong></p>
<p>ä¸€å¼ è¡¨çš„å„ä¸ªå±æ€§è¢«æ‹†åˆ†æˆå¤šä¸ªæŠ•å½±ï¼Œæ¯ä¸ªæŠ•å½±æŒ‰ç…§è‡ªå·±åŒ…å«çš„å±æ€§è‡ªè¡Œæ’åºï¼Œé€šè¿‡ <code>position index</code> è®°å½•å…¶ç‰©ç†ä½ç½®å’Œå…¶åœ¨åŸå§‹è¡¨ä½ç½®çš„å¯¹åº”å…³ç³»ã€‚åŒ…å«æ‰€æœ‰å±æ€§çš„æŠ•å½±è¢«ç§°ä¸º <code>super projection</code>ï¼Œå…¶å®ƒæŠ•å½±å«ä½œ <code>non super projection</code>ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€å¼ è¡¨ç”±ä¸€ä¸ª <code>super projection</code> å’Œ <code>0-3 ä¸ª non super projection</code> æ„æˆã€‚</p>
<p>Vertica æ²¡æœ‰å®ç° C-Store çš„ <code>join index</code>ï¼ŒåŸå› åœ¨äºå®ç°èµ·æ¥è¾ƒä¸ºå¤æ‚ï¼Œä¸”åœ¨åˆ†å¸ƒå¼æ‰§è¡Œå™¨é‡æ„å…ƒç»„æ˜¯çš„æ¶ˆè€—è¿œå¤§äºå…¶å¸¦æ¥çš„æ”¶ç›Šã€‚</p>
<blockquote>
<p>Vertica does not implement join indices at all, instead requiring at least
one super projection containing every column of the anchoring table.</p>
</blockquote>
<p><strong>Prejoin Projection</strong></p>
<p>Vertica å…è®¸å°†ç»´è¡¨ä¸­çš„æ•°æ®å’Œäº‹å®è¡¨ä¸­çš„ N:1 çš„ join å…³ç³»ä¿å­˜åœ¨ <code>prejoin projection</code> ä¸­ï¼Œç”±äºåˆ—å¼å­˜å‚¨å…·æœ‰è‰¯å¥½çš„å‹ç¼©æ¯”ä¾‹ï¼Œè¿™ç§ denormalization å¹¶ä¸ä¼šæ¶ˆè€—è¿‡å¤šçš„ç‰©ç†å­˜å‚¨ã€‚è¯¥ç‰¹æ€§æ¥è‡ª C-Storeï¼Œä½†åœ¨ Vertica ä¸­å¹¶æ²¡æœ‰è¢«ç”¨æˆ·é¢‘ç¹ä½¿ç”¨ï¼ŒåŸå› åœ¨äº Vertica çš„æ‰§è¡Œå¼•æ“å¯¹äºå°ç»´è¡¨çš„ join å¤„ç†åœ°å¾ˆå‡ºè‰²ï¼ˆusing highly optimized hash and merge
join algorithmsï¼‰ã€‚</p>
<p><strong>Encoding and Compression</strong></p>
<p>åˆ—å­˜æ ¼å¼å¢åŠ äº†ç¼–ç å’Œå‹ç¼©çš„å¯èƒ½ï¼ŒVertica æ”¯æŒå¦‚ä¸‹ç¼–ç å‹ç¼©æ–¹å¼:</p>
<ul>
<li>Auto: å½“åˆ—ä¸Šçš„ä½¿ç”¨æ ·ä¾‹ä¸è¶³æ—¶ï¼Œè‡ªåŠ¨é€‰å–æœ€ä¼˜çš„å‹ç¼©ç®—æ³•</li>
<li>RLE: best for low cardinality columns that are sorted</li>
<li>Delta Value: best used for many-valued, unsorted integer or integer-based columns</li>
<li>Block Dictionary: best for few-valued, unsorted columns such as stock prices</li>
<li>Compressed Delta Range: ideal for many-valued float columns that are either sorted or confined to a range</li>
<li>Compressed Common Delta: best for sorted data with predictable sequences and occasional sequence breaks</li>
</ul>
<p><strong>Partitioning &amp; Segmentation</strong></p>
<p>Partitioning æ˜¯èŠ‚ç‚¹å†…ï¼ˆintra-nodeï¼‰æ•°æ®åˆ‡åˆ†ï¼Œé€šå¸¸ä½¿ç”¨æ—¶é—´ä½œä¸ºåˆ‡åˆ†æ¡ä»¶ï¼›Segmentation åœ¨æœ‰äº› OLAP æ•°æ®åº“ä¸­è¢«ç§°ä¸º Distributionï¼Œæ˜¯èŠ‚ç‚¹é—´ï¼ˆinter-nodeï¼‰çš„æ•°æ®åˆ‡åˆ†ã€‚</p>
<p>Partitioning çš„ä½œç”¨ä¸€æ˜¯åˆ†åŒºè£å‰ªå¢åŠ æŸ¥è¯¢æ•ˆç‡ï¼ŒäºŒæ˜¯æä¾›äº†å¿«é€Ÿ bulk deletionï¼Œé€šè¿‡ç›´æ¥åˆ é™¤æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶ç«‹é©¬å›æ”¶ç©ºé—´ã€‚Segmentation çš„ä½œç”¨ä¸€æ˜¯æé«˜å¹¶è¡Œåº¦ï¼Œå¢åŠ æŸ¥è¯¢æ•ˆç‡ï¼ŒäºŒæ˜¯å¢å¤§å­˜å‚¨ç©ºé—´ä»¥ä¿å­˜æ›´å¤šçš„æ•°æ®ã€‚</p>
<p><strong>Read and Write Optimized Stores</strong></p>
<p>ROS å’Œ WOS çš„æ¦‚å¿µä¹Ÿæ˜¯æ¥è‡ª C-Storeï¼ŒWOS ä¿å­˜åœ¨å†…å­˜ä¸ä¸‹ç›˜ï¼Œä¸ºè¡Œå­˜ï¼ˆVertica åœ¨å®ç°çš„æ—¶å€™ç”±è¡Œå­˜æ”¹ä¸ºåˆ—å­˜ï¼Œåæ¥åˆæ”¹å›è¡Œå­˜ï¼‰ã€‚</p>
<p>ROS ä¸­çš„æ•°æ®ç‰©ç†ä¸Šä¿å­˜åœ¨å¤šä¸ª ROS Container ä¸­:</p>
<blockquote>
<p>Each ROS container logically contains some number of complete tuples sorted by the projectionâ€™s
sort order, stored as a pair of files per column</p>
</blockquote>
<p>Vertica ä¸ºçº¯åˆ—å­˜å­˜å‚¨ï¼Œä¸€åˆ—æ•°æ®åœ¨ ROS Container ä¸­å­˜å‚¨ä¸ºæ•°æ®å’Œ <code>position index</code> ä¸¤ä¸ªæ–‡ä»¶ã€‚</p>
<blockquote>
<p>Data is identified within each ROS container by a position which is simply its ordinal position
within the file. Positions are implicit and are never stored explicitly.</p>
</blockquote>
<p>è¿™é‡Œå¯¹ <code>position index</code> çš„æè¿°æœ‰ç‚¹æ¨¡ç³Šï¼Œæ–‡ä¸­è¯´ç´¢å¼•ç»“æ„æ²¡æœ‰ä½¿ç”¨ B-treeï¼ˆå› ä¸ºæ–‡ä»¶ä¸€æ—¦å†™å…¥ä¸ä¼šä¿®æ”¹ï¼‰ï¼Œåˆè¯´äº†ç´¢å¼•åªå­˜å‚¨æ¯ä¸ª disk block çš„èµ·å§‹ä½ç½®ä»¥åŠ min/max ç­‰å…ƒæ•°æ®ã€‚å…¶å®ç°å‚ç…§äº† <strong><a href="https://dl.acm.org/doi/10.5555/645924.671173">Small Materialized Aggregates: A Light Weight Index Structure for data warehousing</a></strong>ï¼Œåé¢æœ‰æ—¶é—´å­¦ä¹ ä¸€ä¸‹ã€‚</p>
<p>Vertica ä¹Ÿæ”¯æŒå°†å¤šåˆ—ä¿å­˜ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä½†æ˜ç¡®è¡¨ç¤ºäº†è¿™ç§å­˜å‚¨æ ¼å¼æ€§èƒ½è¾ƒå·®:</p>
<blockquote>
<p>This hybrid row-column storage mode is very rarely used in practice because of the
performance and compression penalty it exacts.</p>
</blockquote>
<p>è¿™å¯èƒ½æ˜¯å› ä¸º Vertica å¹¶æ²¡æœ‰æƒ³å‡ºç±»ä¼¼äº ORC çš„æ•°æ®å¸ƒå±€ã€‚</p>
<p>æ•°æ®çš„ä¿®æ”¹æˆ–åˆ é™¤é€šè¿‡ Delete Vector æ¥å®ç°ï¼ŒDelete Vector å’Œç”¨æˆ·æ•°æ®ä¸€æ ·ï¼Œå…ˆå†™å…¥å†…å­˜ä¸­çš„ DVWOSï¼Œç„¶åç”± Tuper Mover ç§»åŠ¨åˆ° DVROS Container ä¸­çš„ç£ç›˜ç»“æ„ä¸­ã€‚</p>
<h3 id="tuper-mover"><a class="header" href="#tuper-mover">Tuper Mover</a></h3>
<p>WOS é€šè¿‡ç¼“å­˜ä¸€äº›å†™ï¼Œç„¶åæ‰¹é‡å°† WOS è½¬æ¢ä¸º ROS ä¸­çš„åˆ—å­˜ï¼ŒROS çš„æ•°æ®ä¹Ÿä¼šåˆå¹¶ä¸ºæ›´å¤§çš„æ–‡ä»¶æ¥è§£å†³ç£ç›˜åŠæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚Tuper Mover æ˜¯è´Ÿè´£è¯¥å·¥ä½œçš„æ¨¡å—:</p>
<ul>
<li>Moveout: asynchronously moves data from the WOS to the ROS</li>
<li>Mergeout: merges multiple ROS files together into larger ones</li>
</ul>
<p>ç±»ä¼¼ LSM-tree çš„å·¥ä½œæ–¹å¼ï¼Œä¸èµ˜è¿°ã€‚</p>
<p>äº‹åŠ¡åŠæŸ¥è¯¢ä¼˜åŒ–ç›¸å…³çš„æè¿°æ„Ÿè§‰ä¹Ÿæ¯”è¾ƒæ™¦æ¶©ï¼Œæš‚ä¸”å¿½ç•¥ç›¸å…³çš„ç¬”è®°ã€‚</p>
<p>å…¶ä¸­æåˆ°äº†ä¸€ä¸ª Database Designer (DBD) çš„å·¥å…·ï¼Œå¯æ ¹æ® shema å’Œå°‘é‡æ•°æ®åˆ†æå‡ºå¦‚ä½•æ‹†åˆ† Projection èƒ½èŠ‚çœå­˜å‚¨ç©ºé—´æˆ–æå‡æŸ¥è¯¢æ•ˆç‡ã€‚ä¸ªäººæ„Ÿè§‰è¿™ç§å·¥å…·å¢åŠ äº†ç”¨æˆ·çš„ä½¿ç”¨è´Ÿæ‹… ; (</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefhttpsduckdborgpdfcidr2020-raasveldt-muehleisen-duckdbpdfdata-management-for-data-science-towards-embedded-analyticsa"><a class="header" href="#a-hrefhttpsduckdborgpdfcidr2020-raasveldt-muehleisen-duckdbpdfdata-management-for-data-science-towards-embedded-analyticsa"><a href="https://duckdb.org/pdf/CIDR2020-raasveldt-muehleisen-duckdb.pdf">Data Management for Data Science Towards Embedded Analytics</a></a></h3>
<blockquote>
<p>CIDR 2020</p>
</blockquote>
<p>è¯¥è®ºæ–‡æ¢è®¨äº†æ•°æ®ç§‘å­¦é¢†åŸŸå¯¹æ•°æ®ç®¡ç†è§£å†³æ–¹æ¡ˆçš„éœ€æ±‚ï¼Œå¹¶æå‡ºäº†ä¸€ç±»æ–°çš„æ•°æ®ç®¡ç†ç³»ç»Ÿï¼šåµŒå…¥å¼åˆ†æç³»ç»Ÿï¼ˆembedded analytical systemsï¼‰ã€‚</p>
<p>æ•°æ®ç§‘å­¦å´›èµ·å¯¼è‡´æ•°æ®åˆ†æä»»åŠ¡å¤æ‚æ€§å¢åŠ ï¼Œæ•°æ®ç§‘å­¦å®¶é€šå¸¸ä½¿ç”¨è„šæœ¬è¯­è¨€ï¼ˆå¦‚ Python æˆ– Rï¼‰åœ¨ä¸ªäººç”µè„‘ä¸Šè¿›è¡Œä¸­ç­‰è§„æ¨¡çš„åˆ†æï¼Œä¼ ç»Ÿçš„ RDBMS ä¸èƒ½æ»¡è¶³æ•°æ®ç§‘å­¦å®¶çš„éœ€æ±‚ï¼Œä¸é€‚åˆæœ¬åœ°æ•°æ®åˆ†æç”¨ä¾‹ã€‚</p>
<p>åµŒå…¥å¼åˆ†æç³»ç»Ÿä¸ºäº†å¡«è¡¥äº†è¿™ä¸€ç©ºç™½ï¼Œè¦è§£å†³å¦‚ä¸‹ä¸€äº›é—®é¢˜:</p>
<ul>
<li>Combined OLAP &amp; ETL Workloads: é«˜æ•ˆç‡åœ°æ”¯æŒ OLAP å·¥ä½œè´Ÿè½½ä»¥åŠæ‰¹é‡è¿½åŠ å’Œæ›´æ–°</li>
<li>Transfer Efficiency: æ•°æ®åº“å’Œåº”ç”¨ç¨‹åºåœ¨åŒä¸€è¿›ç¨‹å’Œåœ°å€ç©ºé—´ä¸­è¿è¡Œï¼Œéœ€è¦æœ‰æ•ˆåˆ©ç”¨è¿™ä¸€æœºä¼šå®ç°é«˜æ•ˆçš„æ•°æ®å…±äº«</li>
<li>Resilience: åµŒå…¥å¼æ•°æ®åº“éœ€è¦èƒ½å¤Ÿæ£€æµ‹ç¡¬ä»¶é—®é¢˜å¹¶é˜²æ­¢æ•°æ®æŸå</li>
<li>Cooperation: ç³»ç»Ÿéœ€è¦èƒ½å¤Ÿé€‚åº”èµ„æºç«äº‰ï¼Œä¸ä¸»æœºåº”ç”¨ç¨‹åºå…±äº«ç¡¬ä»¶èµ„æº</li>
</ul>
<p><strong>DuckDB</strong></p>
<p>DuckDB æ˜¯ä¸€ä¸ªä¸ºåµŒå…¥å¼åˆ†æè®¾è®¡çš„æ–°å‹å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿã€‚</p>
<ul>
<li>OLAP &amp; ETLï¼šä½¿ç”¨çŸ¢é‡åŒ–è§£é‡Šæ‰§è¡Œå¼•æ“ï¼Œä¼˜åŒ–äº† OLAP æŸ¥è¯¢</li>
<li>å¼¹æ€§ï¼šDuckDB è®¡ç®—å¹¶å­˜å‚¨æŒä¹…å­˜å‚¨å—çš„æ ¡éªŒå’Œï¼Œå¹¶åœ¨è¯»å–æ—¶éªŒè¯ï¼Œä»¥ä¿æŠ¤æ•°æ®å®Œæ•´æ€§</li>
<li>åä½œï¼šDuckDB å…è®¸ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®å†…å­˜å’Œ CPU æ ¸å¿ƒä½¿ç”¨ç‡çš„ç¡¬é™åˆ¶ï¼Œå¹¶è®¡åˆ’å®ç°è‡ªé€‚åº”èµ„æºä½¿ç”¨æ–¹æ¡ˆ</li>
<li>ä¼ è¾“æ•ˆç‡ï¼šDuckDB å®ç°äº†é«˜æ•ˆçš„å®¢æˆ·ç«¯ APIï¼Œå…è®¸å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºç›´æ¥æˆä¸ºç‰©ç†æŸ¥è¯¢å¤„ç†è®¡åˆ’çš„æ ¹ç®—å­</li>
</ul>
<h3 id="code"><a class="header" href="#code">Code</a></h3>
<p><a href="https://github.com/duckdb/duckdb">DuckDB is an in-process SQL OLAP Database Management System</a></p>
<h3 id="further-readings-4"><a class="header" href="#further-readings-4">Further readings</a></h3>
<ul>
<li><a href="https://duckdb.org/pdf/SIGMOD2019-demo-duckdb.pdf">DuckDB: an Embeddable Analytical Database</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="hybrid-transactional-and-analytical-process"><a class="header" href="#hybrid-transactional-and-analytical-process">Hybrid Transactional and Analytical Process</a></h2>
<ul>
<li><strong><a href="databases/htap/greenplum-htap.html">Greenplum: A Hybrid Database for Transactional and Analytical Workloads</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabaseshtapassetspdfsgreenplumpdfgreenplum-a-hybrid-database-for-transactional-and-analytical-workloadsa"><a class="header" href="#a-hrefdatabaseshtapassetspdfsgreenplumpdfgreenplum-a-hybrid-database-for-transactional-and-analytical-workloadsa"><a href="databases/htap/../../assets/pdfs/greenplum.pdf">Greenplum: A Hybrid Database for Transactional and Analytical Workloads</a></a></h3>
<blockquote>
<p>SIGMOD '21</p>
<p>https://doi.org/10.1145/3448016.3457562</p>
</blockquote>
<p>ä¸å•çº¯çš„ OLTP æˆ–è€… OLAP ç³»ç»Ÿç›¸æ¯”ï¼ŒHTAP ç³»ç»Ÿå…·æœ‰å¦‚ä¸‹ä¸¤ç§ä¼˜åŠ¿:</p>
<ol>
<li>reduce the waiting time of new data analysis tasks significantly, as there is no ETL transferring delay.</li>
<li>reduce the overall business cost in terms of hardware and administration.</li>
</ol>
<p>HTAP å¸¸è§çš„æ¼”è¿›è·¯å¾„æœ‰ä¸¤ç§:</p>
<ol>
<li>From OLTP to HTAP: Oracle Exadata, Amazon Aurora</li>
<li>From NewSQL to HTAP: TiDB with TiFlash, Google F1</li>
</ol>
<p>Greenplum åˆ™é€‰æ‹©äº†å¦ä¸€æ¡è·¯å¾„ï¼Œåœ¨ OLAP æ•°ä»“ä¸Šå¢åŠ  OLTP çš„èƒ½åŠ›æ¥è·å–ä¸€ä¸ª HTAP ç³»ç»Ÿã€‚</p>
<h4 id="greenplums-mpp-architecture"><a class="header" href="#greenplums-mpp-architecture">Greenplum's MPP Architecture</a></h4>
<p><img src="databases/htap/../../assets/images/gpdb_architecture.jpg" alt="gpdb architecture" /></p>
<p>Greenplum æ„é€ äº†ä¸€ä¸ª MPP æ•°æ®åº“ï¼ˆshare-nothingï¼‰æ¥è§£å†³å•æœºç³»ç»Ÿå¸¦æ¥çš„é—®é¢˜:</p>
<ol>
<li>Data Scalability: the total amount of data is too large to store in a single host.</li>
<li>Compute Scalability: the ability to handle concurrency is limited by the compute resources of a single host, e.g., CPUs, memory, and IO.</li>
<li>High Availability: if the single host is unavailable, so is the whole database system.</li>
</ol>
<p>è¿™ç§æ¶æ„åŒæ ·å¸¦æ¥äº†ä¸€äº›æŒ‘æˆ˜:</p>
<p>ç”±äºæ¯ä¸ª segment ä¸Šåªä¿å­˜äº†éƒ¨åˆ†æ•°æ®ï¼Œå› æ­¤åœ¨ä½œ join çš„æ—¶å€™éœ€è¦å¯¹æ•°æ®è¿›è¡Œ shuffle ä»¥ä¿è¯ join conditionã€‚å› æ­¤ GPDB çš„ä¼˜åŒ–å™¨å’Œæ‰§è¡Œå™¨éƒ½æ˜¯åˆ†å¸ƒå¼çš„ï¼Œä¸ºæ­¤ GPDB å¼•å…¥äº†ä¸€ç§æ–°çš„è®¡åˆ’èŠ‚ç‚¹ <code>Motion plan node</code>ã€‚ä¸ºäº†ä¿è¯ ACIDï¼ŒGPDB ä½¿ç”¨äº†åˆ†å¸ƒå¼å¿«ç…§å’Œä¸¤é˜¶æ®µæäº¤åè®®ã€‚</p>
<blockquote>
<p>Motion plan nodes naturally cut the plan into pieces, each piece 
below or above the Motion is called a <strong>slice</strong> in Greenplum. Each
slice is executed by a group of distributed processes, and
the group of processes is called <strong>gang</strong>.</p>
</blockquote>
<p><img src="databases/htap/../../assets/images/gpdb_distributed_plan_and_executor.jpg" alt="gpdb distributed plan and executor" /></p>
<p>ä¸ºäº†å°† OLAP å˜ä¸º OLTPï¼ŒGreenplum åšäº†å¦‚ä¸‹å‡ ç‚¹ä¼˜åŒ–:</p>
<p><strong>Object Lock Optimization</strong></p>
<p>GPDB ä¸­æœ‰ä¸‰ç§é”: spinlocks, LWlocks å’Œ Object locksï¼Œå‰ä¸¤ç§é”å¯ä»¥é€šè¿‡éµå¾ªä¸€å®šè§„åˆ™æ¥é¿å…æ­»é”ï¼ˆå¦‚è·å–é”çš„æ—¶å€™ä½¿ç”¨ç›¸åŒçš„é¡ºåºï¼‰ï¼Œè€Œå¯¹è±¡é”åˆ™éœ€è¦æ­»é”æ£€æµ‹ç®—æ³•æ¥è¯†åˆ«ã€‚ç”±äºæ˜¯åˆ†å¸ƒå¼çš„æ¶æ„ï¼ŒPostgreSQL å•æœºç‰ˆçš„æ­»é”æ£€æµ‹ç®—æ³•ä¸å†é€‚ç”¨ï¼ŒGPDB æå‡ºäº† GDDï¼ˆGlobal Deadlock Detectionï¼‰ç®—æ³•æ¥æ£€æµ‹æ­»é”ï¼Œè¿‡ç¨‹å¦‚ä¸‹:</p>
<ul>
<li>Greenplum launches a daemon on the coordinator segment</li>
<li>The daemon periodically collects wait-for graphs on each segment</li>
<li>The daemon checks if a global deadlock happens</li>
<li>The daemon breaks the global deadlock using predefined policies such as terminating the youngest transaction</li>
</ul>
<p>æ­»é”æ£€æµ‹ç®—æ³•å¦‚ä¸‹:</p>
<p><img src="databases/htap/../../assets/images/gpdb_gdd.jpg" alt="gdd" /></p>
<p>æœ‰äº† GDDï¼Œæ’å…¥å’Œæ›´æ–°æ“ä½œå°±ä¸å†éœ€è¦é«˜çº§åˆ«çš„é”äº†ï¼Œå› æ­¤èƒ½æé«˜æ“ä½œçš„å¹¶å‘åº¦ã€‚</p>
<p><strong>Distributed Transaction Management</strong></p>
<p>ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ç”± Coordinator æŒ‡å®šä¸€ä¸ª distributed transaction identifierï¼Œé€æ¸é€’å¢ä¸”å…¨å±€å”¯ä¸€ï¼Œåˆ†å‘ç»™ segmentã€‚Segment å¯¹äº‹åŠ¡ä¾æ—§ä¼šåˆ†é…ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡idï¼ŒçœŸæ­£å†™å…¥ç£ç›˜çš„ä¹Ÿæ˜¯æœ¬åœ°äº‹åŠ¡ï¼Œæ¯ä¸ª segment ç»´æŠ¤äº†ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ id å’Œæœ¬åœ°äº‹åŠ¡ id çš„ä¸€ä¸ªæ˜ å°„ï¼Œå¯¹ä¸€ä¸ªåˆ†å¸ƒå¼å¿«ç…§æ¥è¯´ï¼Œåˆ¤æ–­å…ƒç»„çš„å¯è§æ€§å°±éœ€è¦ç»“åˆè¿™ä¸ªæ˜ å°„å’Œå…ƒç»„è®°å½•çš„æœ¬åœ°äº‹åŠ¡ id æ¥åˆ¤æ–­ã€‚</p>
<p>è¿™ä¸ªæ˜ å°„å…³ç³»å¦‚æœå¾ˆå¤§ä¼šå½±å“æ€§èƒ½ï¼ŒGPDB é€šè¿‡åªå°†ç°æœ‰åˆ†å¸ƒå¼å¿«ç…§å¯è§çš„æœ€è€çš„åˆ†å¸ƒå¼äº‹åŠ¡ id ä¹‹åçš„ id è®°å½•åœ¨ map ä¹‹ä¸­æ¥å‡å°‘ mapping meta-data çš„å¤§å°ã€‚</p>
<p>Coordinator ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤æ¥ä¿è¯äº‹åŠ¡åœ¨æ‰€æœ‰ segments ä¸Šçš„åŸå­æ€§ï¼ŒGPDB å¯¹äºåªæ¶‰åŠä¸€ä¸ª segment çš„äº‹åŠ¡åšäº†ä¸€ä¸ªä¼˜åŒ–ï¼Œå°†ä¸¤é˜¶æ®µæäº¤å˜ä¸ºä¸€é˜¶æ®µæäº¤ï¼ˆçœå» Prepare/Preparedï¼‰æ¥å‡å°‘ç½‘ç»œå¼€é”€ã€‚</p>
<p><strong>Resource Isolation</strong></p>
<p>é€šè¿‡åˆ›å»ºèµ„æºéš”ç¦»ï¼ˆCPUã€Memoryã€Concurrencyï¼‰å¹¶å°†å…¶æŒ‡å®šç»™è§’è‰²ï¼Œå°† OLAP å’Œ OLTP å¯ç”¨çš„èµ„æºè¿›è¡Œéš”ç¦»ï¼Œä»è€Œå‡å°‘ OLAP æŸ¥è¯¢å¯¹ OLTP çš„å½±å“ã€‚</p>
<p>é€šå¸¸ OLAP éœ€è¦æ›´å¤šçš„ Memoryï¼Œå°‘é‡çš„è¿æ¥ï¼Œè€Œ OLTP å¯¹æ—¶å»¶æ¯”è¾ƒæ•æ„Ÿï¼Œå¦‚æœèƒ½åˆ†é…ç‹¬å çš„ CPU ä¼šæé«˜æ€§èƒ½ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="vector-db"><a class="header" href="#vector-db">vector db</a></h2>
<blockquote>
<p>Consider a query q, and suppose the algorithm outputs a set X of k candidate near neighbors, and suppose G is
the ground-truth set of the k closest neighbors to q from among the points of the base dataset. Then, we define the k-recall@k
of this set X to be <strong>|Xâˆ©G| / k</strong>.</p>
</blockquote>
<blockquote>
<p>The goal of an ANN algorithm then is to <strong>maximize recall</strong> while retrieving the results as quickly as possible, which results in the <strong>recall-vs-latency tradeoff</strong>.</p>
</blockquote>
<p><a href="https://github.com/dangkhoasdc/awesome-vector-database">Awesome Vector Database</a> <a href="https://github.com/sindresorhus/awesome"><img src="https://cdn.jsdelivr.net/gh/sindresorhus/awesome@d7305f38d29fed78fa85652e3a63e154dd8e8829/media/badge.svg" alt="Awesome" /></a></p>
<p>A curated list of awesome works related to high dimensional structure/vector search &amp; database </p>
<h3 id="vector-databases"><a class="header" href="#vector-databases">Vector databases</a></h3>
<ul>
<li><a href="databases/vectordb//assets/pdfs/SIGMOD21_Milvus.pdf">Milvus: A Purpose-Built Vector Data Management System</a>, SIGMOD '21</li>
<li><a href="databases/vectordb//assets/pdfs/manu_2206.13843.pdf">Manu: A Cloud Native Vector Database Management System</a>, 2022</li>
<li><a href="databases/vectordb//assets/pdfs/vbase-osdi23.pdf">VBASE: Unifying Online Vector Similarity Search and Relational Queries via Relaxed Monotonicity</a>, OSDI 2023 <a href="https://github.com/microsoft/MSVBASE">codebase</a></li>
</ul>
<h3 id="graph-index"><a class="header" href="#graph-index">Graph Index</a></h3>
<ul>
<li><a href="databases/vectordb//assets/pdfs/Approximatenearest_neighbor_algorithm_based_on_navigable_small_world_graphs.pdf">Approximate nearest neighbor algorithm based on navigable small world graphs</a>, 2014</li>
<li><a href="databases/vectordb/hnsw.html">Efficient and robust approximate nearest neighbor search using Hierarchical Navigable Small World graphs</a>, 2016</li>
<li><a href="databases/vectordb/ivf-hnsw.html">Revisiting the Inverted Indices for Billion-Scale Approximate Nearest Neighbors</a>, 2018</li>
<li><a href="https://arxiv.org/abs/2206.11408">FINGER: Fast Inference for Graph-based Approximate Nearest Neighbor Search</a>, 2022 <a href="https://www.youtube.com/watch?v=OsxZG2XfcZA">HNSW-FINGER Explained!</a></li>
<li><a href="databases/vectordb/diskann.html">DiskANN: Fast Accurate Billion-point Nearest Neighbor Search on a Single Node</a>, 2019</li>
</ul>
<h3 id="quantization"><a class="header" href="#quantization">Quantization</a></h3>
<ul>
<li><a href="databases/vectordb/pq.html">Product Quantization for Nearest Neighbor Search</a>, 2010</li>
<li><a href="databases/vectordb//assets/pdfs/A_Survey_of_Quantization_Methods_for_Efficient_Neural_Network_Inference.pdf">A Survey of Quantization Methods for Efficient Neural Network Inference</a>, 2021</li>
</ul>
<h3 id="misc-1"><a class="header" href="#misc-1">Misc</a></h3>
<ul>
<li><a href="databases/vectordb//assets/pdfs/The_FAISS_LIBRARY_2401.08281.pdf">THE FAISS LIBRARY</a>, 2024</li>
<li><a href="https://www.pinecone.io/learn/series/faiss/">Faiss: The Missing Manual</a></li>
<li><a href="https://zhang-yang.medium.com/cosine-similarity-dot-product-for-normalized-vectors-c07bdb61c9d1">Cosine similarity = dot product for normalized vectors</a></li>
<li><a href="https://news.ycombinator.com/item?id=36942993">USearch: Smaller and faster single-file vector search engine</a></li>
<li><a href="https://github.com/spotify/annoy">Annoy(Approximate Nearest Neighbors Oh Yeah)</a></li>
<li><a href="https://github.com/rapidsai/raft">RAPIDS RAFT library</a></li>
<li><a href="https://developer.nvidia.com/blog/accelerating-vector-search-using-gpu-powered-indexes-with-rapids-raft/">Accelerating Vector Search: Using GPU-Powered Indexes with RAPIDS RAFT</a></li>
<li><a href="https://developer.nvidia.com/blog/accelerating-vector-search-fine-tuning-gpu-index-algorithms/">Accelerating Vector Search: Fine-Tuning GPU Index Algorithms</a></li>
<li><a href="https://developer.nvidia.com/blog/accelerated-vector-search-approximating-with-rapids-raft-ivf-flat/">Accelerated Vector Search: Approximating with RAPIDS RAFT IVF-Flat</a></li>
<li><a href="https://www.pinecone.io/learn/semantic-search/">Semantic Search: Measuring Meaning From Jaccard to Bert</a></li>
<li><a href="https://www.pinecone.io/learn/splade/">SPLADE for Sparse Vector Search Explain</a></li>
<li><a href="https://medium.com/@infiniflowai/sparse-embedding-or-bm25-84c942b3eda7">Sparse embedding or BM25?</a></li>
<li><a href="https://zilliz.com/blog/unlock-advanced-recommendation-engines-with-milvus-new-range-search">Unlock Advanced Recommendation Engines with Milvus' New Range Search</a></li>
<li><a href="https://blog.vespa.ai/billion-scale-knn/">Billion-scale vector search with Vespa - part one</a></li>
<li><a href="https://blog.vespa.ai/billion-scale-knn-part-two/">Billion-scale vector search with Vespa - part two</a></li>
<li><a href="https://blog.vespa.ai/vespa-hybrid-billion-scale-vector-search/">Billion-scale vector search using hybrid HNSW-IF</a></li>
<li><a href="https://www.youtube.com/watch?v=4sLJapXEPd4&amp;list=PLSE8ODhjZXjYVdJKka5g3xTKfPBITrxOu">Weaviate: An Architectural Deep Dive (Etienne Dilocker)</a> with HNSW and PQ detailed</li>
<li><a href="https://www.youtube.com/watch?v=kIj-KKnC-PA&amp;list=PLSE8ODhjZXjYVdJKka5g3xTKfPBITrxOu">Milvus: A Purpose-Built Vector Data Management System! (Li Liu)</a> Milvus 2.0 architecture explained</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesvectordbassetspdfshnsw_160309320pdfefficient-and-robust-approximate-nearest-neighbor-search-using-hierarchical-navigable-small-world-graphsa"><a class="header" href="#a-hrefdatabasesvectordbassetspdfshnsw_160309320pdfefficient-and-robust-approximate-nearest-neighbor-search-using-hierarchical-navigable-small-world-graphsa"><a href="databases/vectordb//assets/pdfs/hnsw_1603.09320.pdf">Efficient and robust approximate nearest neighbor search using Hierarchical Navigable Small World graphs</a></a></h3>
<blockquote>
<p>https://arxiv.org/abs/1603.09320</p>
</blockquote>
<p>ç†è§£ HNSW çš„å…³é”®åœ¨äºç†è§£ <strong>Skip List</strong> å’Œ <strong>NSW</strong>ã€‚NSW å…·æœ‰å°ä¸–ç•Œç½‘ç»œå’Œå¯å¯¼èˆªçš„ç‰¹ç‚¹ï¼Œå³ short-range link èšç±»ï¼Œlong-range link å¿«é€Ÿæ£€ç´¢ï¼ŒHNSW åˆ©ç”¨è·³è¡¨çš„æ€æƒ³å®ç°äº† long-range link å¿«é€Ÿæ£€ç´¢çš„èƒ½åŠ›ã€‚</p>
<blockquote>
<p>Hierarchical NSW algorithm can be seen as an extension of the probabilistic skip list structure with proximity graphs instead of the linked lists.</p>
</blockquote>
<p>ç®—æ³•æœ¬èº«è®ºæ–‡æè¿°çš„éå¸¸æ¸…æ™°ï¼Œäº†è§£ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°å¯¹ç†è§£å’Œä½¿ç”¨ HNSW éƒ½éå¸¸æœ‰å¸®åŠ©:</p>
<ul>
<li>M â€” the number of nearest neighbors that each vertex will connect to. A reasonable range of M is from 5 to 48.</li>
<li>efSearch â€” how many entry points will be explored between layers during the search.</li>
<li>efConstruction â€” how many entry points will be explored when building the index.</li>
</ul>
<h4 id="open-source-implementations"><a class="header" href="#open-source-implementations">Open Source Implementations</a></h4>
<ul>
<li><a href="https://github.com/nmslib/hnswlib">hnswlib</a> Header-only C++/python library for fast approximate nearest neighbors</li>
<li><a href="https://github.com/facebookresearch/faiss/blob/main/faiss/IndexHNSW.cpp">IndexHNSW from faiss</a></li>
<li><a href="https://github.com/pgvector/pgvector">pgvector</a></li>
</ul>
<p>hnswlib çš„å†…å­˜ layout å¦‚ä¸‹ï¼Œå¯ä»¥å¸®åŠ©ç†è§£ hnswlib çš„ä»£ç :</p>
<p><img src="databases/vectordb//assets/images/hnswlib_layout.png" alt="hnswlib layout" /></p>
<h4 id="references-2"><a class="header" href="#references-2">References:</a></h4>
<ul>
<li><a href="https://www.youtube.com/watch?v=4PsyNdFlxmk">Graph-Based Approximate Nearest Neighbors (ANN) and HNSW</a></li>
<li><a href="https://www.pinecone.io/learn/series/faiss/hnsw/">Hierarchical Navigable Small Worlds (HNSW)</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/441470968">HNSWç®—æ³•åŸç†</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesvectordbassetspdfsivf-hnsw_180202422pdfrevisiting-the-inverted-indices-for-billion-scale-approximate-nearest-neighborsa"><a class="header" href="#a-hrefdatabasesvectordbassetspdfsivf-hnsw_180202422pdfrevisiting-the-inverted-indices-for-billion-scale-approximate-nearest-neighborsa"><a href="databases/vectordb//assets/pdfs/ivf-hnsw_1802.02422.pdf">Revisiting the Inverted Indices for Billion-Scale Approximate Nearest Neighbors</a></a></h3>
<blockquote>
<p>https://arxiv.org/abs/1802.02422</p>
</blockquote>
<p>IVF åœ¨è¾ƒå¤§ç æœ¬ï¼ˆcodebook, K &gt; 2^17ï¼‰çš„æƒ…å†µä¸‹å…·æœ‰æ›´å¥½çš„æœç´¢æ•ˆæœï¼Œä½†æŸ¥æ‰¾ç›¸è¿‘ Centroid ä¼šç›¸å¯¹æ¯”è¾ƒè´¹æ—¶ã€‚</p>
<blockquote>
<p>The only practical reason, preventing their usage, is the expensive procedure of query assignment that takes O(K) operations.</p>
</blockquote>
<p>ä½¿ç”¨ HNSW å¯¹ Centroid set æ„å»ºä¸€ä¸ªç´¢å¼•èƒ½å¤Ÿè·å¾—ä¸é”™çš„æ•ˆæœï¼ˆä¹‹å‰æœ‰ç ”ç©¶ç”¨ kd-tree æ¥æŸ¥æ‰¾æœ€è¿‘ centroids æ•ˆæœå¹¶ä¸ç†æƒ³ï¼‰ã€‚</p>
<blockquote>
<p>HNSW allows obtaining a small top of the closest centroids with almost perfect accuracy in a submillisecond time.</p>
</blockquote>
<p align="center">
<img src="databases/vectordb//assets/images/ivf-hnsw.png" alt="ivf-hnsw" width="600"/>
</p>
<p>æ–‡ä¸­æåˆ°çš„ <code>Grouping and pruning</code> èƒ½å¤Ÿå¯¹å­åˆ†åŒºæ›´å¥½åœ°åˆ’åˆ†ä»¥æé«˜æŸ¥è¯¢ç²¾åº¦ï¼Œå¯ç”¨äºå¤§æ•°æ®çš„æ•°æ®å‹ç¼©ã€‚</p>
<h4 id="open-source-implementations-1"><a class="header" href="#open-source-implementations-1">Open Source Implementations</a></h4>
<ul>
<li><a href="https://github.com/dbaranchuk/ivf-hnsw">ivf-hnsw</a></li>
</ul>
<h4 id="references-3"><a class="header" href="#references-3">References:</a></h4>
<ul>
<li><a href="https://www.pinecone.io/learn/series/faiss/composite-indexes/">Facebook AI and the Index Factory</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesvectordbassetspdfsdiskann_2019pdfdiskann-fast-accurate-billion-point-nearest-neighbor-search-on-a-single-nodea"><a class="header" href="#a-hrefdatabasesvectordbassetspdfsdiskann_2019pdfdiskann-fast-accurate-billion-point-nearest-neighbor-search-on-a-single-nodea"><a href="databases/vectordb//assets/pdfs/DiskANN_2019.pdf">DiskANN: Fast Accurate Billion-point Nearest Neighbor Search on a Single Node</a></a></h3>
<blockquote>
<p>https://dl.acm.org/doi/abs/10.5555/3454287.3455520</p>
</blockquote>
<blockquote>
<p>Current state-of-the-art approximate nearest neighbor search (ANNS) algorithms generate indices that must be stored in main memory for fast high-recall search. This makes them expensive and limits the size of the dataset.</p>
</blockquote>
<p>å¯¹äºè¾ƒå¤§çš„æ•°æ®é›†ï¼Œå¯ä»¥é€šè¿‡ PQ å°†æ•°æ®è¿›è¡Œå‹ç¼©æˆ–å°†æ•°æ®é›†åˆ†ç‰‡åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œä½†ä¸¤ç§æ–¹å¼éƒ½æœ‰ä¸è¶³ï¼ŒPQ ä¼šé™ä½å¬å›ç‡ï¼Œè€Œ sharding éœ€è¦æ›´å¤šçš„ç¡¬ä»¶èµ„æº:</p>
<ol>
<li>their 1-recall@1 is rather low (around 0.5) since the data compression is lossy.</li>
<li>extending this to web scale data with hundreds of billions of points would require thousands of machines.</li>
</ol>
<h4 id="diskann"><a class="header" href="#diskann">DiskANN</a></h4>
<p>DiskANN, an SSD-resident ANNS system based on our new <strong>graph-based</strong> indexing algorithm called <strong>Vamana</strong>.</p>
<p>Vamana ç”Ÿæˆçš„å›¾ç´¢å¼•ç›¸å¯¹ <a href="databases/vectordb//databases/vectordb/hnsw.html">HNSW</a> æˆ– NSG å…·æœ‰æ›´å°çš„ç›´å¾„ï¼ˆdiameterï¼‰ï¼Œä»è€Œæœ€å°åŒ–ç£ç›˜è¯» I/Oã€‚å¦å¤–:</p>
<ul>
<li>Vamana ç”Ÿæˆçš„å›¾ç´¢å¼•ä¹Ÿå¯ç›´æ¥åœ¨å†…å­˜ä¸­ä½¿ç”¨ï¼Œå…¶æœç´¢æ€§èƒ½å¯ä»¥åª²ç¾æˆ–è¶…è¶Š HNSW æˆ– NSG ç­‰å†…å­˜å›¾ç´¢å¼•ç®—æ³•</li>
<li>Vamana å¯ä»¥å°†æ•°æ®é›†çš„å¤šä¸ªåˆ†åŒºåˆ†åˆ«ç”Ÿæˆçš„ç´¢å¼• merge æˆä¸€ä¸ªç´¢å¼•ï¼Œå…¶æœç´¢æ€§èƒ½å‡ ä¹ä¸ä¸ºæ•´ä¸ªæ•°æ®é›†æ„å»ºçš„å•ä¸ªç´¢å¼•ç›¸åŒï¼Œè¿™å¯¹å°å†…å­˜ç¯å¢ƒéå¸¸å‹å¥½</li>
<li>Vamana å¯ä»¥ä¸ PQ ç»“åˆä½¿ç”¨ï¼Œå°†å‹ç¼©è¿‡çš„æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­æ¥åŠ é€Ÿæœç´¢è¿‡ç¨‹ä¸­çš„è·ç¦»è®¡ç®—</li>
</ul>
<h4 id="vamana-graph-construction-algorithm"><a class="header" href="#vamana-graph-construction-algorithm">Vamana Graph Construction Algorithm</a></h4>
<p>HNSWï¼ŒNSG å’Œ Vamana æœ¬è´¨ä¸Šéƒ½æ˜¯å›¾ç®—æ³•ï¼Œéƒ½å¯ä»¥æŠ½è±¡ä¸ºä¸¤ä¸ªæ“ä½œ GreedySearch å’Œ RobustPrune:</p>
<p><img src="databases/vectordb//assets/images/graph_index_two_options.png" alt="GreedySearch and RobustPrune" /></p>
<p>æ‰€ä¸åŒçš„æ˜¯:</p>
<ul>
<li>HNSW å’Œ NSG æ²¡æœ‰å¯ä»¥è°ƒæ•´çš„å‚æ•° Î±ï¼Œéšå¼åœ°ä½¿ç”¨ Î± = 1ï¼Œè€Œè¿™æ­£æ˜¯ Vamana èƒ½å¤Ÿåœ¨ graph degree å’Œ diameter ä¸Šè¿›è¡Œ trade-off çš„å…³é”®</li>
<li>å¦å¤–ï¼ŒVamana å’Œ NSG ä½¿ç”¨ GreedySearch(s, p, 1, L) æ´»åŠ¨çš„æ‰€æœ‰ç‚¹çš„é›†åˆä½œä¸º RobustPrune çš„å€™é€‰é›†ï¼Œä»¥æ­¤æ¥ç»™å›¾å¢åŠ  long-range edgedï¼Œè€Œ HNSW åˆ™æ˜¯é€šè¿‡åˆ†å±‚æ¥è¾¾åˆ°æ­¤æ•ˆæœ</li>
<li>NSG çš„åˆå§‹å›¾æ˜¯ä¸€ä¸ªæ•°æ®é›†è¿‘ä¼¼çš„ K-nearest neighbor graphï¼Œè€—æ—¶ç›¸å¯¹è¾ƒé•¿ä¸”æ¶ˆè€—æ›´å¤šå†…å­˜ï¼Œè€Œ HNSW å’Œ Vamana çš„åˆå§‹å›¾åˆ™ç›¸å¯¹ç®€å•ï¼Œå‰è€…ä»¥ç©ºå›¾å¼€å§‹ï¼Œåè€…ä»¥éšæœºå›¾å¼€å§‹</li>
<li>Vamana éœ€è¦æ‰«ä¸¤è¾¹æ•°æ®é›†ï¼Œç¬¬äºŒéèƒ½å¤Ÿæé«˜å›¾çš„è´¨é‡</li>
</ul>
<p><img src="databases/vectordb//assets/images/vamana_indexing_algorithm.png" alt="Vamana Indexing algorithm" /></p>
<p>ä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºï¼Œç¬¬ä¸€è¡Œä½¿ç”¨ Î± = 1 æ¶ˆé™¤äº†å¾ˆå¤šä¸å¿…è¦çš„è¾¹ï¼Œç¬¬äºŒè¡Œä½¿ç”¨ Î± &gt; 1 å°†ä¸€äº›æ‰€è°“çš„ long-range edges åŠ å›åˆ°å›¾ä¸­:</p>
<p><img src="databases/vectordb//assets/images/vamana_graph_generation.png" alt="Progression of the graph generated by the Vamana" /></p>
<p>DiskANN é€šè¿‡ BeamSearch(è®¾ç½® beamwidth ä¸€æ¬¡è¯»å¤šä¸ªæ•°æ®å—) å’Œç¼“å­˜æœ€å¸¸è®¿é—®çš„èŠ‚ç‚¹ï¼ˆeg. by caching all vertices that are C = 3 or 4 hops from the starting point sï¼‰æ¥åŠ é€ŸæŸ¥è¯¢ã€‚ å¦å¤–ï¼ŒDiskANN å°†é‚»å±…èŠ‚ç‚¹çš„å‘é‡ä¿å­˜åœ¨ç£ç›˜ç´¢å¼•æ–‡ä»¶ä¸­ï¼Œæ¥æé«˜æœç´¢çš„ç²¾åº¦ï¼ˆImplicit Re-Ranking Using Full-Precision Vectorsï¼‰ã€‚</p>
<h3 id="code-1"><a class="header" href="#code-1">Code</a></h3>
<ul>
<li><a href="https://github.com/microsoft/DiskANN">microsoft/DiskANN</a>, Graph-structured Indices for Scalable, Fast, Fresh and Filtered Approximate Nearest Neighbor Search</li>
</ul>
<h3 id="further-readings-5"><a class="header" href="#further-readings-5">Further readings</a></h3>
<ul>
<li><a href="databases/vectordb//assets/pdfs/FreshDiskANN_2021.pdf">FreshDiskANN: A Fast and Accurate Graph-Based ANN Index for Streaming Similarity Search</a>, 2021</li>
<li><a href="databases/vectordb//assets/pdfs/OOD-DiskANN-2022.pdf">OOD-DiskANN: Efficient and Scalable Graph ANNS for Out-of-Distribution Queries</a>, 2022</li>
<li><a href="databases/vectordb//assets/pdfs/Filtered-DiskANN_2023.pdf">Filteredâˆ’DiskANN: Graph Algorithms for Approximate Nearest Neighbor Search with Filters</a>, 2023</li>
</ul>
<h4 id="references-4"><a class="header" href="#references-4">References:</a></h4>
<ul>
<li><a href="https://milvus.io/blog/2021-09-24-diskann.md">DiskANN, A Disk-based ANNS Solution with High Recall and High QPS on Billion-scale Dataset</a></li>
<li><a href="https://weaviate.io/blog/ann-algorithms-vamana-vs-hnsw">Vamana vs. HNSW - Exploring ANN algorithms Part 1</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesvectordbassetspdfsproduct_quantization_for_nearest_neighbor_searchpdfproduct-quantization-for-nearest-neighbor-searcha"><a class="header" href="#a-hrefdatabasesvectordbassetspdfsproduct_quantization_for_nearest_neighbor_searchpdfproduct-quantization-for-nearest-neighbor-searcha"><a href="databases/vectordb//assets/pdfs/Product_Quantization_for_Nearest_Neighbor_Search.pdf">Product Quantization for Nearest Neighbor Search</a></a></h3>
<blockquote>
<p>https://ieeexplore.ieee.org/document/5432202</p>
</blockquote>
<p>Product Quantization æ˜¯ä¸€ç§ç”¨äºé«˜ç»´å‘é‡å‹ç¼©å’Œè¿‘ä¼¼ç›¸ä¼¼åº¦æœç´¢çš„æŠ€æœ¯ã€‚å®ƒçš„æ€æƒ³æ˜¯å°†é«˜ç»´å‘é‡åˆ†å‰²æˆå¤šä¸ªè¾ƒä½ç»´çš„å­å‘é‡ï¼Œå¹¶å¯¹æ¯ä¸ªå­å‘é‡è¿›è¡Œç‹¬ç«‹çš„é‡åŒ–ã€‚è¿™ç§åˆ†å‰²å’Œé‡åŒ–çš„è¿‡ç¨‹å¯ä»¥å‡å°‘ Memory footprint å’Œè®¡ç®—æˆæœ¬ï¼Œå¹¶ä¸”åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¿æŒåŸå§‹å‘é‡çš„ç›¸ä¼¼æ€§ã€‚</p>
<p><img src="databases/vectordb/" alt="" /></p>
<p align="center">
<img src="databases/vectordb//assets/images/pq_subvector.png" alt="pq subvector" width="600"/>
</p>
<p>PQ çš„ä¸¤ä¸ªå‚æ•°:</p>
<ul>
<li>m: å­å‘é‡çš„ä¸ªæ•°ï¼Œéœ€è¦ä¿è¯ D % m = 0</li>
<li>k*: å¯¹æ¯ä¸ª D* ç»´çš„å­å‘é‡è¿›è¡Œèšç±»å centroid çš„ä¸ªæ•°ï¼ˆ2 çš„å¹‚æ¬¡æ–¹ï¼‰</li>
</ul>
<blockquote>
<p>The input vector x is split into m distinct subvectors <code>uj , 1 â‰¤ j â‰¤ m</code> of dimension <strong>D* = D/m</strong>, where D is a multiple of m. The subvectors are quantized separately using <strong>m distinct quantizers</strong>.</p>
</blockquote>
<p align="center">
<img src="databases/vectordb//assets/images/pq_equation.png" alt="pq equations" width="600"/>
</p>
<p>PQ çš„æœ¬è´¨æ˜¯å°†åŸå§‹é«˜ç»´ç©ºé—´åˆ†è§£ä¸ºå¤šä¸ªä½ç»´å­ç©ºé—´ï¼Œå¹¶å¯¹è¿™äº›å­ç©ºé—´è¿›è¡Œç‹¬ç«‹çš„é‡åŒ–ã€‚æ¯ä¸ªå­ç©ºé—´çš„é‡åŒ–ç»“æœå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªç æœ¬ï¼ˆcodebookï¼‰ï¼Œç”±ä¸€ç»„ç¦»æ•£çš„ä»£è¡¨æ€§å‘é‡æ„æˆã€‚<strong>PQ å¯ä»¥çœ‹ä½œæ˜¯å¯¹è¿™äº›å­ç©ºé—´çš„ç¬›å¡å°”ç§¯è¿›è¡Œç¼–ç </strong>ã€‚</p>
<p>PQ è®¡ç®—ä¸¾ä¾‹çš„ä¸¤ç§ç­–ç•¥:</p>
<ul>
<li>Symmetric distance computation (SDC): both the vectors x and y are represented by their respective centroids q(x) and q(y).</li>
<li>Asymmetric distance computation (ADC): the database vector y is represented by q(y), but the query x is not encoded.</li>
</ul>
<p align="center">
<img src="databases/vectordb//assets/images/pq_distance_computation.png" alt="pq distance computation" width="600"/>
</p>
<p>SDC éœ€è¦å¯¹æŸ¥è¯¢å‘é‡è¿›è¡Œ quantization ä¹‹åå»æŸ¥è¯¢ï¼Œè·ç¦»è®¡ç®—è½¬æ¢ä¸ºæŸ¥è¡¨ï¼ŒADC ä¸éœ€è¦é‡åŒ–ä½†éœ€è¦è®¡ç®—è·ç¦»ã€‚</p>
<blockquote>
<p>The only advantage of SDC over ADC is to limit the memory usage associated with the queries, as the query vector
is defined by a code. This is most cases not relevant and one should then use the asymmetric version, which obtains a lower
distance distortion for a similar complexity.</p>
</blockquote>
<p>PQ æ˜¯ä¸€ç§å‹ç¼©ç®—æ³•ï¼Œå¦‚æœéœ€è¦æ›´å¿«çš„æ£€ç´¢é€Ÿåº¦ï¼Œéœ€è¦æ­é…ä¸€äº›å…¶å®ƒç®—æ³•æ¥å®ç°ï¼Œå¦‚ IVFPQã€‚</p>
<p align="center">
<img src="databases/vectordb//assets/images/pq_ivfadc.png" alt="IVFADC" width="600"/>
</p>
<h4 id="references-5"><a class="header" href="#references-5">References:</a></h4>
<ul>
<li><a href="https://www.pinecone.io/learn/series/faiss/product-quantization/">Product Quantization: Compressing high-dimensional vectors by 97%</a></li>
<li><a href="https://mccormickml.com/2017/10/13/product-quantizer-tutorial-part-1/">Product Quantizers for k-NN Tutorial Part 1</a></li>
<li><a href="https://mccormickml.com/2017/10/22/product-quantizer-tutorial-part-2/">Product Quantizers for k-NN Tutorial Part 2</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="graph-database"><a class="header" href="#graph-database">graph database</a></h2>
<blockquote>
<p>A graph database (GDB) is a database that uses graph structures for semantic queries with nodes, edges, and properties to represent and store data.
A key concept of the system is the graph (or edge or relationship). The graph relates the data items in the store to a collection of nodes and edges, the edges representing the relationships between the nodes.</p>
</blockquote>
<ul>
<li><a href="https://arxiv.org/pdf/2112.06217">Graph Pattern Matching in GQL and SQL/PGQ</a> <a href="https://dl.acm.org/doi/10.1145/3514221.3526057">SIGMOD '22</a></li>
<li><a href="https://dl.acm.org/doi/pdf/10.14778/3611540.3611614">DuckPGQ: Bringing SQL/PGQ to DuckDB</a> VLDB, 2023</li>
<li><a href="https://www.cidrdb.org/cidr2023/papers/p66-wolde.pdf">DuckPGQ: Efficient Property Graph Queries in an analytical RDBMS</a> CIDR 2023</li>
<li><a href="databases/graphdb/kuzu.html">KÃ™ZU Graph Database Management System</a> CIDR 2023</li>
</ul>
<h3 id="benchmarks-1"><a class="header" href="#benchmarks-1">Benchmarks</a></h3>
<ul>
<li><a href="https://arxiv.org/abs/2001.02299">The LDBC Social Network Benchmark</a></li>
<li><a href="https://arxiv.org/abs/2306.15975">The LDBC Financial Benchmark</a></li>
</ul>
<h3 id="misc-2"><a class="header" href="#misc-2">Misc</a></h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=NZN2jVyRKVc&amp;list=PLar5iR7mhb4dJHDSjmeo6W7HomHBSZf9t">Knowledge Graphs (lecture)</a> - Talks and lectures by the Knowledge-Based Systems group at TU Dresden, covering research and foundations related to knowledge representation, AI, databases, and related topics.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefhttpswwwcidrdborgcidr2023papersp48-jinpdfkÃ™zu-graph-database-management-systema"><a class="header" href="#a-hrefhttpswwwcidrdborgcidr2023papersp48-jinpdfkÃ™zu-graph-database-management-systema"><a href="https://www.cidrdb.org/cidr2023/papers/p48-jin.pdf">KÃ™ZU Graph Database Management System</a></a></h3>
<blockquote>
<p>CIDR 2023</p>
</blockquote>
<p>KÃ¹zu çš„ç›®æ ‡æ˜¯æˆä¸ºä¸€ä¸ªåŠŸèƒ½å®Œå¤‡ã€ç”¨æˆ·å‹å¥½ã€å¯æ‰©å±•çš„ GDBMSã€‚å®ƒåŸºäºç£ç›˜å­˜å‚¨ï¼Œæ”¯æŒäº‹åŠ¡å¤„ç†ï¼Œå¹¶ä¸”ä¼˜åŒ–äº†å›¾æ•°æ®çš„å­˜å‚¨å’ŒæŸ¥è¯¢å¤„ç†ã€‚å…¶è®¾è®¡é‡ç‚¹åœ¨äºä¼˜åŒ–m-nè¿æ¥çš„ä¸­é—´ç»“æœè¡¨ç¤ºï¼ˆé€šè¿‡å› å¼åˆ†è§£ï¼ˆFactorizationï¼‰ï¼‰å’Œé¿å…å…¨åˆ—æ‰«ææˆ–è¿æ¥ç´¢å¼•æ‰«æï¼Œä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚</p>
<p>ä¸‰ä¸ªæ ¸å¿ƒæŠ€æœ¯ï¼š</p>
<ul>
<li>å› å¼åˆ†è§£ï¼šKÃ¹zu ä½¿ç”¨å› å¼åŒ–å‘é‡æ¥è¡¨ç¤ºä¸­é—´ç»“æœï¼Œé¿å…äº†ä¼ ç»Ÿå—å¤„ç†ä¸­æ•°æ®å†—ä½™çš„é—®é¢˜ã€‚å› å¼åŒ–å‘é‡é€šè¿‡å°†ä¸­é—´ç»“æœè¡¨ç¤ºä¸ºç¬›å¡å°”ç§¯çš„å½¢å¼ï¼Œå‡å°‘äº†æ•°æ®çš„å­˜å‚¨å’Œå¤„ç†å¼€é”€ã€‚</li>
<li>ASP-Join ç®—æ³•ï¼šKÃ¹zu çš„ ASP-Join ç®—æ³•æ˜¯ä¸€ç§æ”¹è¿›çš„å“ˆå¸Œè¿æ¥ç®—æ³•ï¼ŒåŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼šç§¯ç´¯æ¢é’ˆä¾§çš„å› å¼åŒ–å…ƒç»„ã€æ„å»ºå“ˆå¸Œè¡¨ã€æ¢é’ˆå“ˆå¸Œè¡¨ã€‚ASP-Join èƒ½å¤ŸåŒæ—¶å®ç°å› å¼åŒ–ç»“æ„å’Œé¡ºåºæ‰«æï¼Œè§£å†³äº†ä¼ ç»Ÿ INLJï¼ˆç´¢å¼•åµŒå¥—å¾ªç¯è¿æ¥ï¼‰ç®—æ³•åœ¨éé¡ºåºæ‰«ææ—¶çš„æ€§èƒ½é—®é¢˜ã€‚</li>
<li>å¤šè·¯ WCOï¼ˆæœ€åæƒ…å†µæœ€ä¼˜ï¼‰è¿æ¥ç®—æ³•ï¼šKÃ¹zu è¿˜å®ç°äº†åŸºäº ASP-Join çš„å¤šè·¯ WCO è¿æ¥ç®—æ³•ï¼Œç”¨äºå¤„ç†å¾ªç¯è¿æ¥æŸ¥è¯¢ã€‚è¿™ç§ç®—æ³•é€šè¿‡äº¤é›†å¤šä¸ªé‚»æ¥åˆ—è¡¨æ¥æ‰©å±•å‰ç¼€å…ƒç»„ï¼Œé¿å…äº†å…¨è¡¨æ‰«æï¼Œå¹¶ä¸”èƒ½å¤Ÿåˆ©ç”¨å› å¼åŒ–ç»“æ„æé«˜æ€§èƒ½ã€‚</li>
</ul>
<h3 id="more-readings"><a class="header" href="#more-readings">More readings</a></h3>
<ul>
<li><a href="https://blog.kuzudb.com/post/what-every-gdbms-should-do-and-vision/">What every competent GDBMS should do (a.k.a. the goals and vision of Kuzu)</a></li>
<li><a href="https://blog.kuzudb.com/post/factorization/">Factorization and great ideas from database theory</a></li>
<li><a href="https://blog.kuzudb.com/post/wcoj/">Why (Graph) DBMSs Need New Join Algorithms (The Story of Worst-case Optimal Join Algorithms)</a></li>
<li><a href="https://www.youtube.com/watch?v=4XCHUJC81KU">KÃ™ZU Graph Database Management System (CIDR 2023) presentation record</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesassetspdfscituspdfcitus-distributed-postgresql-for-data-intensive-applicationsa"><a class="header" href="#a-hrefdatabasesassetspdfscituspdfcitus-distributed-postgresql-for-data-intensive-applicationsa"><a href="databases/../assets/pdfs/citus.pdf">Citus: Distributed PostgreSQL for Data-Intensive Applications</a></a></h3>
<blockquote>
<p>SIGMOD '21 Umur Cubukcu, etc.</p>
<p>https://dl.acm.org/doi/10.1145/3448016.3457551</p>
</blockquote>
<p>Citus æ˜¯ PostgreSQL çš„ä¸€ä¸ªå¼€æºæ‰©å±•ï¼Œå®ƒå®ç°äº†ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“å¼•æ“ï¼Œä¸ºç”¨æˆ·æä¾›åœ¨ä¸€ç»„ PG å®ä¾‹é›†ç¾¤ä¸Šå­˜å‚¨ã€æŸ¥è¯¢çš„èƒ½åŠ›ã€‚</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ç°ä¸€ä¸ªå…¼å®¹å·²æœ‰å…³ç³»å‹ DMBS çš„åˆ†å¸ƒå¼ DBMS ä¼šä½¿ç”¨å¦‚ä¸‹ä¸‰ç§æ–¹æ³•ä¸­çš„ä¸€ç§:</p>
<ol>
<li>build the database engine from scratch and write a layer to provide over-the-wire SQL compatibility (CockroachDB/TiDB)</li>
<li>fork an open source database systems and build new features on top of it (Greenplum)</li>
<li>provide new features through a layer that sits between the application and database, as middleware (Vitess)</li>
</ol>
<p>è¿™äº›æ–¹æ³•éƒ½ä¸èƒ½å®Œå…¨å…¼å®¹æ•°æ®åº“çš„æœ€æ–°ç‰¹æ€§ï¼Œæœ‰çš„ç”šè‡³è½åå¤šå¹´ä»¥è‡³äºå¾ˆéš¾ä»ä¸Šæ¸¸åŒæ­¥ä»£ç ã€‚Citus åˆ™æ˜¯é€šè¿‡ PostgreSQL æä¾›çš„æ‰©å±• API æ¥æä¾›å®ƒçš„åˆ†å¸ƒå¼èƒ½åŠ›ã€‚</p>
<blockquote>
<p>The extension APIs provide sufficient control over the behavior of PostgreSQL to integrate a sharding layer,
a distributed query planner and executor, and distributed transactions in a way that is transparent to the application.</p>
</blockquote>
<h3 id="workload-requirements"><a class="header" href="#workload-requirements">WORKLOAD REQUIREMENTS</a></h3>
<p>ä½œä¸º PostgreSQL çš„ extension ä½¿å¾— Citus åœ¨å…¼å®¹ Postgres æ–°ç‰¹æ€§æ—¶éå¸¸å®¹æ˜“ã€‚ä½†æ˜¯åšåˆ° 100% å…¼å®¹ä¸”æ²¡æœ‰æ€§èƒ½å›é€€ä¹Ÿä¸å¤ªç°å®ï¼Œä¹Ÿæ²¡æœ‰å¿…è¦ã€‚é€šè¿‡å¯¹å®¢æˆ·éœ€æ±‚çš„åˆ†æï¼ŒCitus è®¤ä¸ºèƒ½å—ç›Šäºæ¨ªå‘æ‰©å±•çš„åº”ç”¨å¤§å¤šå½’ä¸ºä»¥ä¸‹å››ç±»:</p>
<ol>
<li>Multi-tenant/SaaS</li>
<li>real-time analytics</li>
<li>high-performance CRUD</li>
<li>data warehousing</li>
</ol>
<p><img src="databases/../assets/images/citus_four_workload_patterns.png" alt="Four Workload Pattern" /></p>
<p>ä¸åŒçš„ Workload Pattern åˆå¯¹åˆ†å¸ƒå¼æ•°æ®åº“ä¸åŒèƒ½åŠ›ç»„åˆæœ‰ç€ä¸åŒçš„éœ€æ±‚:</p>
<p><img src="databases/../assets/images/citus_distributed_relational_db_cap.png" alt="RDBMS capabilities" /></p>
<h4 id="multi-tenant"><a class="header" href="#multi-tenant">Multi-tenant</a></h4>
<p>å¤šç§Ÿæˆ·åº”ç”¨é€šå¸¸ä½¿ç”¨ä¸€ä¸ªåç«¯ç¨‹åºæœåŠ¡å¤šä¸ªç›¸å¯¹ç‹¬ç«‹çš„ç§Ÿæˆ·ï¼Œä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯ SaaSã€‚æ¯”å¦‚åƒé’‰é’‰æˆ–ä¼ä¸šå¾®ä¿¡è¿™ç±»æœåŠ¡ï¼Œå…¶æ•°æ®æ¨¡å‹å¯ç®€åŒ–ä¸ºä¸‹å›¾:</p>
<p><img src="databases/../assets/images/citus_multi_tenant_data_model.png" alt="Data Model for simple multi-tenant" /></p>
<p>ç”±äºç‹¬ç«‹ç§Ÿæˆ·çš„æ•°é‡å¾ˆå¤§ï¼Œè¿™ç±»åº”ç”¨è´Ÿè½½æ‰©å±•æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚ä¼ ç»Ÿçš„æ–¹å¼æ˜¯æ‰‹åŠ¨åšåˆ†åº“åˆ†è¡¨ï¼ˆshardingï¼‰ï¼Œæ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®è¢«å•ç‹¬æ”¾åœ¨ä¸€ä¸ª database æˆ– schema ä¸­ï¼Œåº”ç”¨ç¨‹åºå±‚é¢éœ€è¦ç»´æŠ¤æ•°æ®çš„æ”¾ç½®ä½ç½®ã€æ•°æ®åŒæ­¥ã€è¡¨ç»“æ„å˜æ›´ç­‰é—®é¢˜ã€‚</p>
<p>Citus ä½¿ç”¨çš„æ–¹å¼æ˜¯å…±äº« schema å¹¶åœ¨åŒ…å«ç§Ÿæˆ·æ•°æ®çš„æ¯ä¸ªè¡¨éƒ½å¢åŠ ä¸€åˆ— tenant IDï¼Œè¿™æ ·åŒä¸€ä¸ªç§Ÿæˆ·çš„æ•°æ®å¯ä»¥æŒ‰ç…§ tenant ID è¢«åˆ†å¸ƒåˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè¿›è€Œæ»¡è¶³å¤æ‚ SQLã€å¤–é”®ã€çº¦æŸã€ç´¢å¼•ç­‰ç‰¹æ€§ã€‚ç§Ÿæˆ·ä¹‹é—´å…±äº«çš„æ•°æ®åˆ™ä½¿ç”¨ <code>Reference Table</code> å¤åˆ¶åˆ°æ¯ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<p>ç”±äºç§Ÿæˆ·ä¹‹é—´çš„æ•°æ®é‡å¯èƒ½å­˜åœ¨éå¸¸å¤§çš„å·®è·ï¼ŒCitus è¿˜æä¾›äº†è§£å†³çƒ­ç‚¹çš„ç‰¹æ€§ï¼Œå³ç²¾ç»†åœ°æ§åˆ¶ç§Ÿæˆ·çš„æ”¾ç½®ç­–ç•¥ã€‚</p>
<h4 id="real-time-analytics"><a class="header" href="#real-time-analytics">Real-time Analytics</a></h4>
<p>å®æ—¶åˆ†æé€šå¸¸ç”¨äºåœ¨å¤§è§„æ¨¡æ•°æ®æµä¸Šï¼ˆäº‹ä»¶æ•°æ®æˆ–æ—¶é—´åºåˆ—æ•°æ®ï¼‰è¿›è¡Œäº¤äº’å¼åˆ†ææˆ–æœç´¢ï¼Œè¦æ±‚å»¶è¿Ÿå°ï¼ˆäºšç§’çº§åˆ«ï¼‰ï¼Œå¸¸è§çš„åœºæ™¯å¦‚ç³»ç»Ÿç›‘æ§ã€å¼‚å¸¸æ£€æµ‹ï¼ˆæ¬ºè¯ˆæ£€æµ‹ï¼‰ã€è¡Œä¸ºåˆ†æã€åœ°ç†ç©ºé—´æ•°æ®åˆ†æç­‰ã€‚æ•°æ®åº“éœ€è¦æŒç»­å†™å…¥å¤§é‡äº‹ä»¶æµï¼Œå¹¶æœåŠ¡äºåº”ç”¨å±‚ä¸‹å‘çš„æ¯ç§’ä¸Šç™¾æ¡åˆ†ææŸ¥è¯¢ã€‚è¿™äº›æŸ¥è¯¢é€šå¸¸æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨ç´¢å¼•ã€ç‰©åŒ–è§†å›¾ã€æ•°æ®è½¬æ¢ï¼ˆrollupï¼‰ç­‰æŠ€æœ¯æ¥ç¼©çŸ­æŸ¥è¯¢æ—¶é—´ã€‚ä¸‹å›¾ä¸ºå®æ—¶åˆ†æçš„ä¸€ä¸ªç®€åŒ–æµç¨‹:</p>
<p><img src="databases/../assets/images/citus_real_time_analysis_pipeline.png" alt="A simple real-time analytics pipeline" /></p>
<p>PostgreSQL å…·æœ‰å¾ˆå¤šæ„å»ºå®æ—¶åˆ†æç¨‹åºçš„èƒ½åŠ›ï¼ŒåŒ…æ‹¬:</p>
<ul>
<li>heap storage å’Œ COPY å‘½ä»¤å¯ä»¥å…è®¸éå¸¸å¿«çš„å†™å…¥</li>
<li>MVCC å…è®¸æŸ¥è¯¢å’Œå†™å…¥åŒæ—¶è¿›è¡Œ</li>
<li>å®Œå–„çš„æ•°æ®ç±»å‹å’Œç´¢å¼•ç±»å‹</li>
</ul>
<p>å”¯ä¸€çš„ç¼ºé™·åœ¨äºå•æœº PG ä¸èƒ½å®¹çº³å®æ—¶åˆ†æçš„æ•°æ®é‡ï¼Œå¹¶ä¸” PG çš„æŸ¥è¯¢å¤§å¤šæ˜¯å•çº¿ç¨‹çš„ã€‚ä¸ºäº†æ‰©å±•å®æ—¶æŸ¥è¯¢çš„è´Ÿè½½ï¼Œæ•°æ®åº“ç³»ç»Ÿéœ€è¦æ”¯æŒå°†æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œå¹¶ä¸”æ”¯æŒå¹¶è¡Œæ‰¹é‡å¯¼å…¥ç­‰èƒ½åŠ›ã€‚</p>
<h4 id="high-performance-crud"><a class="header" href="#high-performance-crud">High-performance CRUD</a></h4>
<p>è¿™ç§åº”ç”¨è´Ÿè½½æ¶‰åŠå¾ˆå¤šå¯¹è±¡ï¼ˆå¦‚ JSONï¼‰æˆ–æ–‡æ¡£çš„ç‹¬ç«‹ä¿®æ”¹ï¼Œæ“ä½œé€šå¸¸éƒ½é€šè¿‡ä¸»é”®å¯¹æ•°æ®è¿›è¡Œå¢åˆ æ”¹æŸ¥ï¼Œä½†ä¹Ÿä¼šæœ‰ä¸€äº›è´Ÿè½½çš„æŸ¥è¯¢ã€‚å½“æ•°æ®é›†è¿‡å¤§æ—¶ï¼ŒPostgres ä¼šé‡åˆ°æ‰©å±•çš„é—®é¢˜ï¼Œå¦‚ vacuum è·Ÿä¸ä¸Šæ•°æ®æ›´æ”¹çš„é€Ÿåº¦ã€è¿æ¥æ•°è¿‡å¤šç­‰ã€‚Citus é€šè¿‡æ ¹æ® key å°†è¡¨åˆ†å¸ƒåˆ°ä¸åŒèŠ‚ç‚¹ï¼ŒCRUD æ“ä½œå¯ä»¥è·¯ç”±åˆ°å¯¹åº”èŠ‚ç‚¹ï¼Œåˆ©ç”¨ä¸»é”®ç´¢å¼•å¯ä»¥åŠ é€ŸæŸ¥è¯¢ä»¥è¾¾åˆ°é«˜ååå’Œä½æ—¶å»¶ã€‚Vacuum ä¹Ÿèƒ½åœ¨å„ä¸ªèŠ‚ç‚¹å¹¶è¡Œæ‰§è¡Œã€‚å¦å¤–ä¸ºäº†æ‰©å±•è¿æ¥æ•°ï¼Œæ¯ä¸ª server éƒ½éœ€è¦èƒ½å¤Ÿå¤„ç†åˆ†å¸ƒå¼æŸ¥è¯¢ï¼ŒCitus åœ¨æ‰©å±•è¿æ¥æ•°çš„èƒ½åŠ›ä¸Šåœ¨ä¸ç¤¾åŒºä¸€èµ·æ¨è¿›ã€‚</p>
<h4 id="data-warehousing"><a class="header" href="#data-warehousing">Data warehousing</a></h4>
<p>æ•°ä»“å°†æ¥è‡ªä¸åŒ operational æ•°æ®åº“çš„æ•°æ®ç»“åˆåˆ°ä¸€ä¸ªæ•°æ®åº“ç³»ç»Ÿï¼Œæä¾› ad-hoc çš„æŸ¥è¯¢åˆ†æï¼Œæ­¤ç±»åº”ç”¨ä¸éœ€è¦é«˜ååå’Œä½å»¶æ—¶ï¼Œä½†éœ€è¦æ‰«æå¤§é‡çš„æ•°æ®é›†ã€‚Citus é€šè¿‡å¹¶è¡Œï¼Œåˆ†å¸ƒå¼ select å’Œ columnar storage æ¥æé«˜æ‰«æçš„é€Ÿåº¦ã€‚
åœ¨ Join çš„å¤„ç†ä¸Šï¼ŒCitus å¯¹ non-co-located joins çš„æ”¯æŒè¿˜ä¸å®Œå–„ã€‚</p>
<h3 id="citus-architecture"><a class="header" href="#citus-architecture">CITUS ARCHITECTURE</a></h3>
<p>Citus ä½¿ç”¨ PostgreSQL æ‰©å±•æ¥å£æ”¹å˜æ•°æ®çš„è¡Œä¸º:</p>
<ul>
<li>First, Citus replicates database objects such as custom types and functions to all servers.</li>
<li>Second, Citus adds two new table types that can be used to take advantage of additional servers.</li>
</ul>
<p>Citus æ’ä»¶ä½¿ç”¨äº† PostgreSQL æä¾›çš„å¦‚ä¸‹æŠ€æœ¯æ¥å®Œæˆå…¶åŠŸèƒ½:</p>
<ol>
<li>UDF: ä¸»è¦ç”¨äºæ“ä½œ Citus å…ƒæ•°æ®åŠå®ç° RPCã€‚</li>
<li>Planner &amp; Executor hooks: æ˜¯ PG çš„å…¨å±€å‡½æ•°æŒ‡é’ˆï¼Œæ‰©å±•å¯ç”¨æ¬¡æ›¿æ¢åŸæœ‰çš„ä¼˜åŒ–å™¨å’Œæ‰§è¡Œå™¨ã€‚å½“æ£€æµ‹åˆ°æ˜¯ Citus table çš„æ—¶å€™ï¼ŒCitus ç”Ÿæˆä¸€ä¸ªåŒ…å« CustomScan node çš„æŸ¥è¯¢æ ‘ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªåˆ†å¸ƒå¼çš„æŸ¥è¯¢è®¡åˆ’ã€‚</li>
<li>CustomScan: è°ƒç”¨åˆ†å¸ƒå¼æ‰§è¡Œå™¨ï¼Œå‘é€æŸ¥è¯¢ç»™ worker node å¹¶æ”¶é›†æŸ¥è¯¢å¾—åˆ°çš„ç»“æœè¿”å›ç»™ PG çš„æ‰§è¡Œå™¨ã€‚</li>
<li>Transaction callbacks: Citus ä½¿ç”¨å®ƒæ¥å®ç°åˆ†å¸ƒå¼äº‹ç‰©ã€‚</li>
<li>Utility hook: Citus ä½¿ç”¨å®ƒæ¥æ”¹å†™ DDL åŠ COPY ç­‰å‘½ä»¤ã€‚</li>
<li>Backgroud workers: Citus å®ç°ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ç”¨äºå®Œæˆ åˆ†å¸ƒå¼é”æ£€æµ‹ã€2PC äº‹ç‰©æ¢å¤å’Œæ¸…ç†ã€‚</li>
</ol>
<p>ä¸€ä¸ªå…¸å‹çš„ Citus é›†ç¾¤åŒ…å«ä¸€ä¸ª Coordinator å’Œ 0-n ä¸ª workerï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="databases/../assets/images/citus_deployment.png" alt="Citus deployment" /></p>
<p>å½“æ•°æ®é‡ä¸å¤šæ—¶ï¼Œä¸€ä¸ª Coordinator å°±å¯ä»¥ä½œä¸ºä¸€ä¸ª Citus é›†ç¾¤ã€‚Citus å¼•å…¥äº†ä¸¤ç§è¡¨ç±»å‹: Distributed table å’Œ Reference tableï¼Œæ‰€æœ‰çš„ table åœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æ™®é€šçš„ heap è¡¨ï¼Œç”¨ç›¸åº”çš„ udf æŠŠè¡¨è½¬æ¢ä¸ºæœŸæœ›çš„è¡¨ç±»å‹ï¼ˆæ˜¯å› ä¸º parser æ˜¯ä¸èƒ½é€šè¿‡æ’ä»¶æ‰©å±•ï¼Œå› æ­¤ citus æ²¡æœ‰å¢åŠ å»ºè¡¨è¯­æ³•ï¼Ÿä½¿ç”¨ reloption æ¥æ ‡è®°è¡¨çš„å±æ€§åº”è¯¥ä¹Ÿè¦ä¿®æ”¹ pg æºç ï¼‰ã€‚</p>
<p><strong>Distributed table</strong></p>
<p>åˆ†å¸ƒè¡¨æ ¹æ®åˆ†å¸ƒåˆ—è¿›è¡Œå“ˆå¸Œåˆ†åŒºï¼Œåˆ†åŒºæˆå¤šä¸ªé€»è¾‘åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡åŒ…å«ä¸€æ®µè¿ç»­çš„å“ˆå¸Œå€¼èŒƒå›´ï¼ˆconsistent hashï¼‰ã€‚å“ˆå¸Œåˆ†åŒºçš„ä¼˜åŠ¿åœ¨äºï¼Œå®ƒå¯ä»¥å®ç°æ•°æ®çš„ co-location ä¸”æ— éœ€é¢‘ç¹é‡æ–°åˆ†ç‰‡å°±èƒ½è¾¾åˆ°æ•°æ®çš„å¹³è¡¡ã€‚</p>
<pre><code class="language-SQL">CREATE TABLE my_table (. . . );
SELECT create_distributed_table('my_table',
    'distribution_column');

CREATE TABLE other_table (. . . );
SELECT create_distributed_table('other_table',
    'distribution_column', colocate_with := 'my_table');
</code></pre>
<p><strong>Reference table</strong></p>
<p>Reference table ä¼šå¤åˆ¶åˆ°é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬ Coordinatorã€‚åˆ†å¸ƒè¡¨å’Œå¼•ç”¨è¡¨ä¹‹é—´çš„ join æ˜¯é€šè¿‡å°†åˆ†å¸ƒè¡¨çš„æ¯ä¸ªåˆ†ç‰‡ä¸å¼•ç”¨è¡¨çš„æœ¬åœ°å‰¯æœ¬è¿›è¡Œ join æ¥å®ç°çš„ï¼Œä¸éœ€è¦ç½‘ç»œæµé‡ã€‚</p>
<pre><code class="language-SQL">CREATE TABLE dimensions (. . . );
SELECT create_reference_table('dimensions');
</code></pre>
<h4 id="data-rebalancing"><a class="header" href="#data-rebalancing">Data rebalancing</a></h4>
<p>ç”±äºä¸šåŠ¡ä¸å‡ï¼Œworker ä¸Šçš„æ•°æ®ä¼šäº§ç”Ÿå€¾æ–œï¼Œä¸ºäº†è¾¾åˆ°å‡åŒ€çš„åˆ†å¸ƒï¼ŒCitus æä¾›äº† <code>shard rebalancer</code>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œrebalancer ä¾æ®å„èŠ‚ç‚¹çš„ shard æ•°ç›®è¿›è¡Œè¿ç§»ï¼Œä½†ç”¨æˆ·å¯ä»¥åˆ›å»º <code>custom policy</code> æ¥è¿›è¡Œä¸åŒç­–ç•¥çš„å¹³è¡¡ã€‚</p>
<p>å½“é›†ç¾¤èŠ‚ç‚¹å˜æ›´æ—¶ï¼Œrebalancer é€‰æ‹©ä¸€ä¸ª shard ä»¥åŠä¸å®ƒ co-located çš„ shardsï¼Œæäº¤ä¸€ä¸ª shard ç§»åŠ¨æ“ä½œã€‚Citus é¦–å…ˆåˆ©ç”¨ logic replication åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹åˆ›å»ºè¯¥ shard çš„å‰¯æœ¬ï¼ŒåŸ shard ä¾æ—§å¯ä»¥è¿›è¡Œè¯»å†™ï¼Œå½“å‰¯æœ¬è¿½ä¸Š source æ—¶ï¼ŒCitus åœ¨ source shard ä¸Šè·å–ä¸€æŠŠå†™é”ï¼ˆä¼šçŸ­æš‚åœæ­¢å†™å…¥æ“ä½œï¼Œé€šå¸¸åªæœ‰å‡ ç§’ï¼‰ï¼Œç­‰å¾…å¤åˆ¶çš„å®Œæˆï¼Œæ›´æ–°åˆ†å¸ƒè¡¨çš„å…ƒæ•°æ®ã€‚ä¹‹åçš„è¯»å†™æ“ä½œéƒ½åˆ‡æ¢åˆ°äº†æ–°çš„ shard ä¸Šã€‚</p>
<h4 id="distributed-query-planner"><a class="header" href="#distributed-query-planner">Distributed query planner</a></h4>
<p>å½“ SQL æŸ¥è¯¢ç”¨åˆ° Citus è¡¨æ—¶ï¼Œåˆ†å¸ƒå¼ planner ä¼šç”Ÿæˆä¸€ä¸ªåŒ…å« CustomScan node çš„æŸ¥è¯¢è®¡åˆ’ï¼Œè¯¥ node åŒ…å«åˆ†å¸ƒå¼æŸ¥è¯¢è®¡åˆ’ã€‚åˆ†å¸ƒå¼æŸ¥è¯¢è®¡åˆ’ç”±ä¸€ç»„éœ€è¦åœ¨ worker èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ä»»åŠ¡(å¯¹åˆ†ç‰‡çš„æŸ¥è¯¢)ç»„æˆï¼Œè¿˜å¯ä»¥é€‰æ‹©æ€§åœ°åŒ…å«ä¸€ç»„ç»“æœéœ€è¦å¹¿æ’­æˆ–é‡æ–°åˆ†åŒºå­è®¡åˆ’ï¼Œä»¥ä¾¿åç»­ä»»åŠ¡è¯»å–å…¶ç»“æœã€‚</p>
<p>Citus é’ˆå¯¹ä¸åŒçš„æŸ¥è¯¢ç±»å‹æœ‰å››ç§ planner:</p>
<p><img src="databases/../assets/images/citus_four_planner.png" alt="Citus planning examples" /></p>
<ol>
<li>Fast path planner: æ ¹æ®æŸ¥è¯¢æ¡ä»¶ä¸­çš„åˆ†å¸ƒåˆ—çš„å€¼æ‰¾åˆ° match çš„ shardï¼Œæ”¹å†™ CRUD æŸ¥è¯¢çš„ table name ä¸ºå¯¹åº”çš„ shard nameï¼Œå¸¸ç”¨äº high-throughput CRUD åœºæ™¯</li>
<li>Router planner: æ¨æ–­æ‰€æœ‰åˆ†å¸ƒè¡¨æ˜¯å¦å…·æœ‰ç›¸åŒçš„åˆ†å¸ƒé”®ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†æŸ¥è¯¢ä¸­çš„è¡¨åé‡å†™ä¸ºä¸åˆ†å¸ƒåˆ—å€¼åŒ¹é…çš„ shard çš„åç§°ã€‚</li>
<li>Logical planner: è´Ÿè´£å°†è·¨ shard çš„æŸ¥è¯¢æ„é€ æˆä¸€ä¸ª multi-relational algebra treeã€‚å¹¶å°½å¯èƒ½çš„å°†è®¡ç®—ä¸‹æ¨åˆ° worker èŠ‚ç‚¹ã€‚</li>
</ol>
<ul>
<li>Logical pushdown planner: å¦‚æœæ‰€æœ‰åˆ†å¸ƒè¡¨éƒ½ co-located ä¸”å­æŸ¥è¯¢ä¸éœ€è¦å…¨å±€åˆå¹¶ï¼ˆå³ group by å¿…é¡»åŒ…å«åˆ†å¸ƒé”®ï¼‰ï¼Œåˆ™å¯ä»¥å°† join tree å®Œå…¨ä¸‹æ¨åˆ° worker èŠ‚ç‚¹</li>
<li>Logical join order planner: å½“æ¶‰åŠ non-co-located çš„åˆ†å¸ƒè¡¨æ—¶ï¼Œé€šè¿‡è¯„ä¼° co-located join, broadcast join, repartion join ä¸åŒçš„ç»„åˆé¡ºåºï¼Œæ‰¾åˆ°ç½‘ç»œå¼€é”€æœ€å°çš„æŸ¥è¯¢è®¡åˆ’</li>
</ul>
<p>å¯¹æ¯ä¸ªæŸ¥è¯¢ï¼ŒCitus ç”±ä½åˆ°é«˜è¿­ä»£è¿™å››ä¸ª plannerï¼Œå¦‚æœ planner èƒ½æ»¡è¶³æŸ¥è¯¢ï¼Œåˆ™ä½¿ç”¨å®ƒã€‚</p>
<h4 id="distributed-query-executor"><a class="header" href="#distributed-query-executor">Distributed query executor</a></h4>
<p>ç”± Distributed query planner ç”Ÿæˆçš„è®¡åˆ’åŒ…å«ä¸€ä¸ª CustomScan nodeï¼Œå®ƒä¼šè°ƒç”¨ Distributed query executorã€‚å¯¹äº fast path æˆ– router planner ç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’ï¼Œæ•´ä¸ª plan å°±æ˜¯ä¸€ä¸ª CustomScanï¼Œå› ä¸ºæ‰§è¡Œè¿‡ç¨‹æŒ‡æ´¾ç»™äº†ä¸€ä¸ª workerã€‚å¯¹äº logical planner ç”Ÿæˆçš„è®¡åˆ’ï¼Œåœ¨ CustomScan ä¹‹ä¸Šè¿˜æœ‰é¢å¤–çš„æ‰§è¡ŒèŠ‚ç‚¹ç”¨äºç»“æœçš„åˆå¹¶ï¼Œè¿™ä¸€æ­¥ç”± PostgreSQL çš„æ‰§è¡Œå™¨å¤„ç†ã€‚</p>
<p>å½“ PostgreSQL æ‰§è¡Œå™¨è°ƒç”¨åˆ° CustomScan çš„æ—¶å€™ï¼Œå®ƒé¦–å…ˆæ‰§è¡Œå¯èƒ½å­˜åœ¨çš„ subplansï¼Œç„¶åå†å»è°ƒç”¨ä¸€ä¸ªå«ä½œ Adaptive executor çš„æ¨¡å—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="databases/../assets/images/citus_executor_call_flow.png" alt="Citus Call flow" /></p>
<p>Adaptive executor çš„è®¾è®¡æ˜¯ä¸ºäº†æ”¯æŒæ··æ‚åœ¨ä¸€èµ·çš„æŸ¥è¯¢å’Œ PG process-per-connection çš„æ¶æ„ï¼Œæœ‰äº›æŸ¥è¯¢åªæœ‰ä¸€ä¸ª taskï¼Œå¦å¤–ä¸€äº›æŸ¥è¯¢æ¶‰åŠåˆ°å¤šä¸ª tasks å¹¶ç”± Citus æ‰“å¼€å¤šä¸ªè¿æ¥å¹¶è¡Œæ‰§è¡Œã€‚æ‰“å¼€è¿‡å¤šè¿æ¥å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼ŒAdaptive executor ä¸ºäº†å‡è¡¡å¹¶è¡Œåº¦å’Œä½å»¶æ—¶ä½¿ç”¨äº†ä¸€ç§ç§°ä½œ <code>slow start</code> çš„æŠ€æœ¯:</p>
<ul>
<li>åœ¨æŸ¥è¯¢å¼€å§‹æ—¶ï¼Œæ‰§è¡Œå™¨å¯ä»¥å¯¹æ¯ä¸ª worker ä½¿ç”¨ä¸€ä¸ªè¿æ¥ (n=1)</li>
<li>æ¯è¿‡ 10msï¼Œå¯ä»¥å¼€å¯çš„æ–°è¿æ¥æ•°å¢åŠ  1 (n=n+1)</li>
<li>å¦‚æœä¸€ä¸ª worker æœ‰ t ä¸ªå¾…å¤„ç†çš„ä»»åŠ¡æœªæŒ‡æ´¾ç»™ç‰¹å®šè¿æ¥ï¼Œåˆ™æ‰§è¡Œå™¨ä¼šä¸ºè¯¥å·¥ä½œèŠ‚ç‚¹å¢åŠ  min(n,t) ä¸ªæ–°çš„è¿æ¥åˆ°è¿æ¥æ± ä¸­</li>
</ul>
<h4 id="distributed-transactions"><a class="header" href="#distributed-transactions">Distributed transactions</a></h4>
<p>å¯¹äºåªæ¶‰åŠå•ä¸ª worker çš„äº‹åŠ¡ï¼ŒCitus å°†äº‹åŠ¡çš„å¤„ç†æŒ‡æ´¾ç»™ worker èŠ‚ç‚¹ã€‚å¯¹äºæ¶‰åŠå¤šä¸ª worker çš„äº‹åŠ¡ï¼ŒCitus ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤(2PC)æ¥ç¡®ä¿åŸå­æ€§ã€‚Citus åŸºäº PostgreSQL æä¾›çš„ PREPARE TRANSACTION/COMMIT PREPARED/ROLLBACK PREPARED æ¥å®ç° 2PCã€‚</p>
<p>Citus è¿˜å®ç°äº†åˆ†å¸ƒå¼æ­»é”æ£€æµ‹æœºåˆ¶ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="optimizer"><a class="header" href="#optimizer">Optimizer</a></h2>
<ul>
<li>Michael Jungmair, et al., PVLDB 2022 <a href="https://www.vldb.org/pvldb/vol15/p2389-jungmair.pdf">Designing an Open Framework for Query Optimization and Compilation</a>
<ul>
<li>propose to extend the scope of query compilers to also perform query optimization as a sequence of compiler passes</li>
</ul>
</li>
</ul>
<h4 id="optional-readings-1"><a class="header" href="#optional-readings-1">Optional readings</a></h4>
<ul>
<li>Michael S. Kester, et al., SIGMOD '17 <a href="databases/optimizer//assets/pdfs/Access_Path_Selection_in_Main-Memory_Optimized_Data_Systems.pdf">Access Path Selection in Main-Memory Optimized Data Systems: Should I Scan or Should I Probe?</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="executor"><a class="header" href="#executor">Executor</a></h2>
<ul>
<li><strong><a href="databases/executor/volcano.html">Volcano â€” An Extensible and Parallel Query Evaluation System</a></strong></li>
</ul>
<h4 id="optional-readings-2"><a class="header" href="#optional-readings-2">Optional readings</a></h4>
<ul>
<li>K Krikellas, et al. ICDE, 2010 <a href="databases/executor//assets/pdfs/hique.pdf">Generating code for holistic query evaluation</a></li>
<li>Thomas Neumann, VLDB, 2011 <a href="databases/executor//assets/pdfs/Efficiently_Compiling_Efficient_Query_Plans_for_Modern_Hardware.pdf">Efficiently Compiling Efficient Query Plans for Modern Hardware</a></li>
<li>T. Kersten, et al. VLDB, 2018 <a href="databases/executor//assets/pdfs/p2209-kersten.pdf">Everything You Always Wanted to Know About Compiled and Vectorized Queries But Were Afraid to Ask</a></li>
<li>Prashanth Menon, et al. VLDB, 2017 <a href="databases/executor//assets/pdfs/Relaxed_Operator_Fusion.pdf">Relaxed Operator Fusion for In-Memory Databases: Making Compilation, Vectorization, and Prefetching Work Together At Last</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesexecutorassetspdfsvalcanopdfvolcano--an-extensible-and-parallel-query-evaluation-systema"><a class="header" href="#a-hrefdatabasesexecutorassetspdfsvalcanopdfvolcano--an-extensible-and-parallel-query-evaluation-systema"><a href="databases/executor/../../assets/pdfs/valcano.pdf">Volcano â€” An Extensible and Parallel Query Evaluation System</a></a></h3>
<blockquote>
<p>Goetz Graefe, IEEE Transactions on Knowledge and Data Engineering, February 1994</p>
<p>https://dl.acm.org/doi/10.1109/69.273032</p>
</blockquote>
<p>Volcano æ˜¯ä¸ºäº†ç ”ç©¶æ•°æ®åº“æŸ¥è¯¢å¤„ç†ç³»ç»Ÿ<strong>å¯æ‰©å±•æ€§</strong>å’Œ<strong>å¹¶è¡Œæ€§</strong>è€Œå¼€å‘çš„ä¸€ä¸ªå®éªŒæ€§è´¨çš„æ•°æ®æµæŸ¥è¯¢æ‰§è¡Œç³»ç»Ÿã€‚æ“ä½œç³»ç»Ÿçš„ã€æœºåˆ¶å’Œç­–ç•¥åˆ†ç¦»ã€çš„è®¾è®¡å“²å­¦å½±å“äº† Volcano çš„è®¾è®¡ã€‚</p>
<p>Volcano çš„è¿­ä»£å™¨æ¨¡å‹ï¼Œå³ <code>open-next-close</code> æ ‡å‡†æ¥å£ï¼Œä½¿å¾—å¢åŠ æ–°çš„ç®—å­å’Œç®—æ³•éƒ½éå¸¸å®¹æ˜“ï¼›åŒæ—¶å¤„ç†æ¨¡å‹ä¸ä¾èµ–æ•°æ®æ¨¡å‹ï¼Œè€Œæ˜¯é€šè¿‡æä¾›å…·ä½“çš„ <strong>support function</strong> æ¥ä¾› Volcano æ¡†æ¶è°ƒç”¨ã€‚è¿™äº›éƒ½ä½¿å¾— Volcano å…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç»å¸¸è°ˆåŠçš„ Volcano Iterator æ‰§è¡Œæ¨¡å‹ã€‚ä¸‹å›¾æ˜¯ä¸¤ä¸ªç®—å­çš„ç¤ºä¾‹:</p>
<p><img src="databases/executor/../../assets/images/volcano_two_operator.jpg" alt="Two operators in a query evaluation plan" /></p>
<p>Volcano è®¾è®¡äº†ä¸¤ä¸ªå…ƒç®—å­ï¼Œç¬¬ä¸€ä¸ª <code>choose-plan</code> å…ƒç®—å­ä½¿å¾—æŸ¥è¯¢å¼•æ“èƒ½å¤ŸåŠ¨æ€é€‰æ‹©æ‰§è¡Œçš„è·¯å¾„ï¼ˆç±»ä¼¼ Adaptive query execution çš„æ¦‚å¿µï¼‰ï¼Œè¯¥ç®—å­æœ¬èº«ä¸æ‰§è¡Œä»»ä½•æ•°æ®æ“ä½œï¼Œå¯ä»¥æ’å…¥åˆ°æ‰§è¡Œè®¡åˆ’æ ‘çš„ä»»æ„ä½ç½®ï¼Œå…¶ open æ“ä½œå†³ç­–æ‰§è¡Œçš„ç®—å­ï¼Œnext å’Œ close è°ƒç”¨å­ç®—å­å¯¹åº”çš„ next å’Œ closeã€‚</p>
<p><img src="databases/executor/../../assets/images/volcano_aqe.jpg" alt="Volcano AQE" /></p>
<p>å¦ä¸€ä¸ªå…ƒç®—å­ <code>exchange</code> èƒ½å¤Ÿè®©ç³»ç»Ÿæ›´å®¹æ˜“åœ°åˆ©ç”¨å¤šå¤„ç†å™¨ç³»ç»Ÿä»è€Œæé«˜å¹¶è¡Œåº¦ï¼ŒåŒ…æ‹¬ inter-operator parallelism(å‚ç›´å¹¶è¡Œå’Œ bushy å¹¶è¡Œ) å’Œ intra-operator parallelismï¼ˆåŒä¸€ç®—å­é€šè¿‡ partition å¯¹ä¸åŒåˆ†åŒºè¿›è¡Œå¹¶è¡Œï¼‰ã€‚</p>
<p><img src="databases/executor/../../assets/images/volcano_exchange.jpg" alt="Volcano exchange" /></p>
<p><em>æ³¨ï¼šæœ¬ paper æ˜¯ä¸€ç¯‡ Volcano ç»¼è¿°æ€§çš„è®ºæ–‡ï¼Œè¯¥å›¢é˜Ÿé’ˆå¯¹ Volcano ä¸åŒæ¨¡å—å‘è¡¨äº†å¤šç¯‡ paperï¼Œå› è€Œ Volcano æ˜¯ä¸€ä¸ªè®ºæ–‡ç³»åˆ—ã€‚</em></p>
<h4 id="more-to-explore"><a class="header" href="#more-to-explore">More to explore:</a></h4>
<p>[1] <a href="https://www.bilibili.com/video/BV18Y4y1x7k7/">ã€è®ºæ–‡åˆ†äº«ã€‘ç§‹å®ï¼šVolcano-An Extensible and Parallel Query Evaluation System</a></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="concurrency-control-1"><a class="header" href="#concurrency-control-1">concurrency control</a></h2>
<ul>
<li><strong><a href="databases/concurrencycontrol/empirical-evaluation-of-mvcc.html">An Empirical Evaluation of In-Memory Multi-Version Concurrency Control</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesconcurrencycontrolassetspdfsempirical-evaluation-of-in-memory-mvccpdfan-empirical-evaluation-of-in-memory-multi-version-concurrency-controla"><a class="header" href="#a-hrefdatabasesconcurrencycontrolassetspdfsempirical-evaluation-of-in-memory-mvccpdfan-empirical-evaluation-of-in-memory-multi-version-concurrency-controla"><a href="databases/concurrencycontrol/../../assets/pdfs/empirical-evaluation-of-in-memory-mvcc.pdf">An Empirical Evaluation of In-Memory Multi-Version Concurrency Control</a></a></h3>
<blockquote>
<p>PVLDB, March 2017</p>
<p>https://dl.acm.org/doi/10.14778/3067421.3067427</p>
</blockquote>
<p>MVCC æ˜¯ç°ä»£ DBMSs æœ€æµè¡Œçš„äº‹åŠ¡ç®¡ç†æ–¹å¼ï¼Œå®ƒæœ€æ—©å‡ºç°åœ¨ 1979 å¹´çš„ä¸€ç¯‡åšå£«è®ºæ–‡é‡Œï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯ä¸ºæ•°æ®åº“ä¸­çš„æ¯ä¸ªé€»è¾‘å¯¹è±¡ç»´æŠ¤å¤šä¸ªç‰©ç†ç‰ˆæœ¬ï¼Œä»¥æ­¤æ¥å…è®¸å¯¹åŒä¸€é€»è¾‘å¯¹è±¡çš„å¹¶è¡Œæ“ä½œã€‚è¿™äº›å¯¹è±¡å¯ä»¥æ˜¯ä»»æ„ç²’åº¦ï¼Œä½†é€šå¸¸ DBMSs é€‰æ‹©å…ƒç»„ä¸º MVCC çš„åŸºæœ¬å•å…ƒï¼Œä»¥è¾¾åˆ°å¹¶è¡Œå’Œç‰ˆæœ¬è¿½è¸ªå¼€é”€çš„å¹³è¡¡ã€‚</p>
<p>è™½ç„¶ç°åœ¨å‡ ä¹æ‰€æœ‰æœ€æ–°çš„ DBMSs éƒ½ä½¿ç”¨äº† MVCCï¼Œä½†å´æ²¡æœ‰ä¸€ä¸ª<strong>æ ‡å‡†</strong>çš„å®ç°ã€‚</p>
<blockquote>
<p>Despite all these newer systems using MVCC, there is no one <strong>standard</strong>
implementation. There are several design choices that have different 
trade-offs and performance behaviors.</p>
</blockquote>
<p>æœ¬è®ºæ–‡ç ”ç©¶äº† MVCC æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„å››ä¸ªå…³é”®äº‹åŠ¡ç®¡ç†è®¾è®¡ä¸Šçš„å†³ç­–:</p>
<ol>
<li>concurrency control protocol</li>
<li>version storage</li>
<li>garbage collection</li>
<li>index management</li>
</ol>
<p>åœ¨ä»¥å…ƒç»„ä¸ºå¯¹è±¡çš„ MVCC å®ç°ä¸­ï¼Œé€šå¸¸éƒ½ä¼šåœ¨æ¯ä¸ªç‰©ç†ç‰ˆæœ¬çš„ header ä¸­å¢åŠ å‡ ä¸ªå…ƒæ•°æ®æ¥æ§åˆ¶è¯¥ç‰ˆæœ¬çš„è¯»å†™ã€åŠ é”åŠå¯è§æ€§åˆ¤æ–­:</p>
<pre><code class="language-txt"> ----------------------------------------------------------------
| txn-id | begin-ts | end-ts | pointer | ... |      columns      |
 ----------------------------------------------------------------
|&lt;----------------- header -----------------&gt;|&lt;---- Contents ---&gt;|
</code></pre>
<ul>
<li><code>txn-id</code> field serves as the version's write lock</li>
<li><code>begin-ts</code> and <code>end-ts</code> timestamps that represent the lifetime of the tuple version</li>
<li><code>pointer</code> stores the address of the neighboring (previous or next) version (if any)</li>
</ul>
<p><em>ä¸åŒçš„åè®®æ ¹æ®éœ€è¦ä¼šå¢åŠ é¢å¤–çš„å­—æ®µ</em></p>
<h3 id="concurrency-control-protocol"><a class="header" href="#concurrency-control-protocol">concurrency control protocol</a></h3>
<p>å¹¶å‘æ§åˆ¶åè®®å†³å®šäº†:</p>
<ol>
<li>ä¸€ä¸ªäº‹åŠ¡æ˜¯å¦å¯ä»¥åœ¨è¿è¡Œæ—¶è®¿é—®æˆ–ä¿®æ”¹ä¸€ä¸ªç‰¹å®šçš„å¯¹è±¡ç‰ˆæœ¬</li>
<li>æ˜¯å¦å…è®¸ä¸€ä¸ªäº‹åŠ¡æäº¤å®ƒæ‰€ä½œçš„ä¿®æ”¹</li>
</ol>
<h4 id="timestamp-ordering-mvto"><a class="header" href="#timestamp-ordering-mvto">Timestamp Ordering (MVTO)</a></h4>
<p>è¯¥åè®®åœ¨ header ä¸­å¢åŠ äº†ä¸€ä¸ªé¢å¤–çš„å­—æ®µ <code>read-ts</code>ï¼Œç”¨äºè®°å½•è¯»å–è¯¥è®°å½•çš„æœ€æ–°äº‹åŠ¡ã€‚å½“ä¸€ä¸ªäº‹åŠ¡æƒ³è¦ä¿®æ”¹ä¸€ä¸ªç‰©ç†è®°å½•ï¼ˆå³åˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬ï¼‰æ—¶ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶:</p>
<ol>
<li>è¯¥ç‰ˆæœ¬ä¸Šæ²¡æœ‰å…¶å®ƒäº‹åŠ¡çš„å†™é”ï¼Œé€šè¿‡ <code>txn-id</code> æ˜¯å¦ä¸º 0 è¿›è¡Œåˆ¤æ–­</li>
<li>äº‹åŠ¡çš„ Tid è¦å¤§äºè¯¥ç‰ˆæœ¬çš„ <code>read-ts</code>ï¼Œå› ä¸ºä¸èƒ½ä¿®æ”¹å‘ç”Ÿåœ¨æœªæ¥çš„è¯»å–</li>
</ol>
<h4 id="optimistic-concurrency-control-mvocc"><a class="header" href="#optimistic-concurrency-control-mvocc">Optimistic Concurrency Control (MVOCC)</a></h4>
<p>OCC çš„ä¸€ä¸ªå‡è®¾æ˜¯äº‹åŠ¡ä¹‹é—´å¾ˆå°‘ä¼šå‘ç”Ÿå†²çªï¼Œå› æ­¤åœ¨è¯»å–æˆ–æ›´æ–°å…ƒç»„æ—¶ä¸éœ€è¦è¿›è¡ŒåŠ é”ã€‚</p>
<p>MVOCC å°†äº‹åŠ¡åˆ†ä¸ºäº†ä¸‰ä¸ªé˜¶æ®µï¼Œread phaseã€validate phase å’Œ write phaseã€‚å…·ä½“çš„ç®—æ³•æè¿°æ„Ÿè§‰ paper é‡Œæè¿°çš„ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œè¿™é‡Œç•¥è¿‡ã€‚</p>
<h4 id="two-phase-locking-mv2pl"><a class="header" href="#two-phase-locking-mv2pl">Two-phase Locking (MV2PL)</a></h4>
<p>æ¯ä¸ªäº‹åŠ¡åœ¨å…è®¸è¯»å–æˆ–ä¿®æ”¹ä¸€ä¸ªç‰©ç†ç‰ˆæœ¬ä¹‹å‰éƒ½è¦åŠ ä¸Šå¿…è¦çš„é”ã€‚åœ¨ disk-based DBMS ä¸­ï¼Œéœ€è¦é¢å¤–å°†é”ä¿¡æ¯ä¿å­˜åœ¨å¦å¤–åœ°æ–¹ä»¥ä¿è¯ä¸ä¼šè¢«å†™å…¥ diskï¼Œè€Œå†…å­˜æ•°æ®åº“ä¸­åˆ™å¯ä»¥ç›´æ¥å°†é”ä¿¡æ¯ä¿å­˜åœ¨å…ƒç»„çš„ header ä¸­ã€‚åœ¨ MV2PL ä¸­ï¼Œ<code>txn-id</code> ç”¨ä½œ write lockï¼Œæ–°å¢ä¸€ä¸ª <code>read-cnt</code> ä½œä¸º read lockã€‚</p>
<p>å¯¹äºè¯»ï¼Œåªéœ€è¦åˆ¤æ–­ <code>txn-id</code> ä¸º 0ï¼Œç„¶åå¯¹ <code>read-cnt</code> + 1 å³å¯ã€‚</p>
<p>å¯¹äºå†™ï¼Œåˆ™éœ€è¦ <code>txn-id</code> å’Œ <code>read-cnt</code> éƒ½ä¸º 0ã€‚</p>
<h4 id="serialization-certifier"><a class="header" href="#serialization-certifier">Serialization Certifier</a></h4>
<p>ä½¿ç”¨ SSI(Serializable Snapshot Isolation) æˆ– SSN(Serail Safety net) å¯ä»¥é¿å… snapshot éš”ç¦»çº§åˆ«ä¸­çš„ write-skew anomaliesã€‚</p>
<h3 id="version-storage"><a class="header" href="#version-storage">Version Storage</a></h3>
<p>äº‹åŠ¡åœ¨æ›´æ–°è®°å½•çš„æ˜¯å¦ä¼šäº§ç”Ÿæ–°ç‰ˆæœ¬ï¼Œæ ¹æ®æ–°ç‰ˆæœ¬å­˜æ”¾çš„ä½ç½®ã€ç‰ˆæœ¬é“¾çš„å‰åé¡ºåºä»¥åŠæ˜¯å¦ä¿å­˜å…ƒç»„çš„æœ‰æ‰€å­—æ®µï¼Œå°† version storage è¿›è¡Œä»¥ä¸‹åˆ†ç±»:</p>
<ul>
<li>Append-only: æ–°ç‰ˆæœ¬ä¸æ—§ç‰ˆæœ¬å­˜å‚¨åœ¨ç›¸åŒçš„è¡¨ç»“æ„ä¸­ï¼Œä¸”ä¿å­˜å…ƒç»„çš„æ‰€æœ‰å­—æ®µ
<ul>
<li>Oldest-to-Newest (O2N): version chain çš„å¤´æŒ‡å‘æ—§ç‰ˆæœ¬ï¼Œæ›´æ–°ä¸éœ€è¦ä¿®æ”¹ indexï¼Œä½†ä¼šå¢åŠ  pointer chasing çš„æ—¶é—´ä¸”ä¼šæ±¡æŸ“ CPU cache</li>
<li>Newest-to-Oldest (N20): version chain çš„å¤´æŒ‡å‘æ–°ç‰ˆæœ¬ï¼Œæ›´æ–°éœ€è¦ä¿®æ”¹æ‰€æœ‰ index (å¯é€šè¿‡å¢åŠ ä¸€ä¸ªä¸­é—´å±‚æ¥è§£å†³æ­¤é—®é¢˜)ï¼Œé¿å…äº†å¤§é‡ pointer chasing</li>
</ul>
</li>
<li>Time-Travel: æ–°ç‰ˆæœ¬ä¿å­˜åœ¨åŸæ¥çš„è¡¨ç»“æ„ï¼Œæ—§ç‰ˆæœ¬ä¿å­˜åœ¨åˆ†å¼€çš„ time-travel è¡¨ï¼Œä¸”ä¿å­˜æ‰€æœ‰å­—æ®µ</li>
<li>Delta Storage: æ–°ç‰ˆæœ¬ä¿å­˜åœ¨åŸæ¥çš„è¡¨ç»“æ„ä¸­ï¼Œè¢«ä¿®æ”¹å­—æ®µçš„æ—§æ•°æ®ä¿å­˜åœ¨å¦å¤–çš„ delta å­˜å‚¨ä¸­</li>
</ul>
<h3 id="gabage-collection"><a class="header" href="#gabage-collection">Gabage Collection</a></h3>
<p>å¦‚æœæ²¡æœ‰åƒåœ¾å›æ”¶ï¼Œä¼šæŠŠå­˜å‚¨ç©ºé—´è€—å°½ä¸”å½±å“æ€§èƒ½ã€‚ç°æœ‰åƒåœ¾å›æ”¶çš„æ–¹å¼:</p>
<ul>
<li>Tuple-level GC
<ul>
<li>Background Vacuuming (VAC): è¿è¡Œä¸€ä¸ªåå°ä»»åŠ¡å®šæ—¶å»æ£€æµ‹æ˜¯å¦æœ‰è¿‡æœŸçš„æ•°æ®</li>
<li>Cooperative Cleaning: åœ¨ pointer chasing å¯»æ‰¾å¯è§ç‰ˆæœ¬çš„æ—¶å€™æ¥è¯†åˆ«è¿‡æœŸæ•°æ®ï¼Œä»…é€‚ç”¨äº O2Nï¼Œä¸”æœ‰ <code>dusty corners</code> çš„é—®é¢˜</li>
</ul>
</li>
<li>Transaction-level GC: åœ¨ epoch ç»“æŸçš„æ—¶å€™ï¼Œæ‰€æœ‰å±äºé‚£ä¸ª epoch äº‹åŠ¡äº§ç”Ÿçš„ç‰ˆæœ¬éƒ½å¯ä»¥è¢«åˆ é™¤</li>
</ul>
<h3 id="index-management"><a class="header" href="#index-management">Index Management</a></h3>
<p>åˆ†ä¸º Logical Pointers å’Œ Physical Pointersï¼Œå…¶ä¸­ Logical Pointers åˆå¯åˆ†ä¸º Primary Key(Pkey) å’Œ Tuple Id(TupleId) ä¸¤ç§å®ç°ã€‚</p>
<p>æœ€åç»™å‡ºè®ºæ–‡ä¸­æ€»ç»“çš„ä¸åŒ DBMSs çš„ MVCC å®ç°å†³ç­–è¡¨æ ¼:</p>
<p><img src="databases/concurrencycontrol/../../assets/images/mvcc-evaluation-design-decisions.jpg" alt="design decisions" /></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="change-data-capture"><a class="header" href="#change-data-capture">Change Data Capture</a></h2>
<ul>
<li><strong><a href="databases/cdc/dblog.html">DBLog: AWatermark Based Change-Data-Capture Framework</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasescdcassetspdfsdblog_a_watermark_based_change-data-capture_frameworkpdfdblog-awatermark-based-change-data-capture-frameworka"><a class="header" href="#a-hrefdatabasescdcassetspdfsdblog_a_watermark_based_change-data-capture_frameworkpdfdblog-awatermark-based-change-data-capture-frameworka"><a href="databases/cdc/../../assets/pdfs/DBLog_A_Watermark_Based_Change-Data-Capture_Framework.pdf">DBLog: AWatermark Based Change-Data-Capture Framework</a></a></h3>
<blockquote>
<p>Andreas Andreakis, Ioannis Papapanagiotou. 2020</p>
<p>https://arxiv.org/abs/2010.12597</p>
</blockquote>
<p>ä¸åŒç‰¹æ€§æ•°æ®åº“ä¹‹é—´çš„åŒæ­¥æ˜¯ä¸€ä¸ªæ™®éå­˜åœ¨çš„éœ€æ±‚ã€‚dual-write å’Œåˆ†å¸ƒå¼äº‹åŠ¡æ˜¯å°è¯•è§£å†³æ­¤é—®é¢˜çš„ä¸€ç§æ¨¡å¼ï¼Œä½†è¿™ä¸¤ç§æ–¹å¼åœ¨å¯è¡Œæ€§ã€é²æ£’æ€§å’Œå¯ç»´æŠ¤æ€§ç­‰æ–¹é¢æˆ–å¤šæˆ–å°‘å­˜åœ¨ä¸€äº›é—®é¢˜ï¼›CDC åˆ™æ˜¯é€šè¿‡æ•è·æ•°æ®åº“äº‹åŠ¡æ—¥å¿—äº‹ä»¶æ¥è¾¾åˆ°ä¸‹æ¸¸æ•°æ®åº“åŒæ­¥çš„å¦ä¸€ç§æ¨¡å¼ï¼Œä½†äº‹åŠ¡æ—¥å¿—å¯èƒ½å¹¶éåŒ…å«æ‰€æœ‰çš„å˜æ›´äº‹ä»¶ï¼ˆcreate/update/deleteï¼‰ï¼Œå› æ­¤éœ€è¦åŒæ­¥æ•°æ®åº“çš„å…¨çŠ¶æ€ï¼ˆfull stateï¼‰ã€‚</p>
<p>DBLog é€šè¿‡äº‹åŠ¡æ—¥å¿—æ•è·å˜æ›´äº‹ä»¶ï¼Œé€šè¿‡ <code>select</code> æ¥è·å–æ•°æ®çš„å…¨çŠ¶æ€ã€‚æ ¹æ®ä¸»é”®å°†è¡¨åˆ‡åˆ†ä¸ºå¤šä¸ª <code>chunk</code>ï¼Œæ¯ä¸ª chunk çš„ select å’Œäº‹åŠ¡æ—¥å¿—åŒæ—¶è¿›è¡Œï¼Œä¸ºäº†ä¿è¯äº‹ä»¶çš„å†å²é¡ºåºï¼ŒDBLog åœ¨æºæ•°æ®åº“ä¸­ç»´æŠ¤äº†ä¸€ä¸ªå•è¡Œå•åˆ—çš„è¡¨ä½œä¸ºè¾…åŠ©ï¼Œé€šè¿‡åœ¨ select å‰ååˆ†åˆ«æ›´æ–°è¯¥è®°å½•ä½¿å¾—åœ¨äº‹åŠ¡æ—¥å¿—ä¸­å¤šäº†ä¸¤ä¸ªäº‹ä»¶ lw(ä½æ°´ä½) å’Œ hw(é«˜æ°´ä½)ï¼Œç„¶åå°†æŸ¥è¯¢å‡ºæ¥çš„äº‹ä»¶å’Œ [lw, hw] ä¹‹é—´çš„äº‹ä»¶åšä»¥ä¸‹ç®—æ³•ï¼Œç”Ÿæˆä¸€ä¸ªæ–°äº‹ä»¶æµã€‚</p>
<p><img src="databases/cdc/./../../assets/images/dblog-algorithm1.jpg" alt="db log algorithm" /></p>
<p>paper ä¸­çš„ç¤ºä¾‹å›¾ (Figure 3 &amp;&amp; Figure 4) éå¸¸æ˜ç™½åœ°è§£é‡Šäº†ä¸Šè¿°ç®—æ³•:</p>
<p><img src="databases/cdc/../../assets/images/dblog_watermark-based_chunk_selection.jpg" alt="Watermark-based Chunk Selection" /></p>
<p><img src="databases/cdc/../../assets/images/dblog_interleaving.jpg" alt="Interleaving log capture with full data capture" /></p>
<p>ç®—æ³•æ­£ç¡®æ€§ä¾èµ–æ•°æ®åº“çš„ RC æˆ– RR éš”ç¦»çº§åˆ«ï¼Œselect è¿”å›çš„ result set æ˜¯ (lw, hw) ä¹‹é—´çš„ä¸€ä¸ªç‚¹çš„è§†å›¾ï¼Œæˆ‘ä»¬ä»¥ RR éš”ç¦»çº§åˆ«åˆ†åˆ«ç”¨å›¾ç¤ºè®ºè¯å¢æ”¹åˆ çš„æ­£ç¡®æ€§:</p>
<p>1 insert log event</p>
<p>insert æ—¥å¿—åœ¨ select ä¹‹å‰ï¼Œselect æ—¥å¿—ä¸­èƒ½ä¼šåŒ…å«è¯¥æ’å…¥è®°å½•ï¼Œå› æ­¤ä» result set å°†å…¶åˆ é™¤é¿å…äº†é‡å¤æ’å…¥ã€‚</p>
<pre><code class="language-txt"> ---lw------select-------hw-----
        ^
        |
      insert
</code></pre>
<p>insert æ—¥å¿—åœ¨ select ä¹‹åï¼Œresult set ä¸­ä¸å«è¯¥æ’å…¥è®°å½•ï¼Œæ–°çš„äº‹ä»¶æµåªåŒ…å«ä¸€æ¬¡è¯¥è®°å½•ã€‚</p>
<pre><code class="language-txt"> ---lw------select-------hw-----
                    ^
                    |
                  insert
</code></pre>
<p>2 update log event</p>
<p>update æ—¥å¿—åœ¨ select ä¹‹å‰ï¼Œselect ç»“æœä¸­åŒ…å«äº†æ›´æ–°åçš„ç»“æœï¼Œè€Œ update æ—¥å¿—åŒ…å«äº†æ›´æ–°å‰åçš„æ•°æ®ï¼Œå°† result set ä¸­å¯¹åº”çš„è®°å½•åˆ é™¤ï¼Œæ–°çš„äº‹ä»¶æµä¸­åŒ…å« update åçš„è®°å½•ï¼Œå¯ä¿è¯æ­£ç¡®æ€§ã€‚</p>
<pre><code class="language-txt"> ---lw------select-------hw-----
        ^
        |
      update
</code></pre>
<p>update æ—¥å¿—åœ¨ select ä¹‹åï¼Œselect ä¸­åŒ…å«æ›´æ–°å‰çš„ç»“æœï¼Œå°† result set ä¸­å¯¹åº”çš„è®°å½•åˆ é™¤äº†è€çš„å€¼ï¼Œä½† update æ—¥å¿—åŒ…å«äº†æ›´æ”¹å‰åçš„æ–°è€æ•°æ®ï¼ŒåŒæ ·å¯ä»¥ä¿è¯æ­£ç¡®æ€§ã€‚</p>
<pre><code class="language-txt"> ---lw------select-------hw-----
                    ^
                    |
                  update
</code></pre>
<p>3 delete log event</p>
<p>delete æ—¥å¿—åœ¨ select ä¹‹å‰ï¼Œresult set ä¸­ä¸å«è¯¥è®°å½•ï¼Œæ–°çš„äº‹ä»¶æµåˆ é™¤ä¸€ä¸ªä¸å­˜åœ¨çš„è®°å½•ä¸å½±å“æ­£ç¡®æ€§ã€‚</p>
<pre><code class="language-txt"> ---lw------select-------hw-----
        ^
        |
      delete
</code></pre>
<p>delete æ—¥å¿—åœ¨ select ä¹‹åï¼Œresult set åŒ…å«è¯¥è®°å½•ï¼Œéœ€è¦åˆ é™¤è¯¥è®°å½•æ¥ä¿è¯æ–°çš„äº‹ä»¶æµå…ˆåˆ é™¤ä¸€ä¸ªä¸å­˜åœ¨çš„è®°å½•ååˆå°†è¯¥è®°å½•æ’å…¥ã€‚</p>
<pre><code class="language-txt"> ---lw------select-------hw-----
                    ^
                    |
                  delete
</code></pre>
<h3 id="ç–‘é—®"><a class="header" href="#ç–‘é—®">ç–‘é—®</a></h3>
<p>output buffer ä¸­ä¸ºä½•è¿˜ä¿ç•™äº† lw ä¹‹å‰çš„äº‹åŠ¡æ—¥å¿—ï¼Ÿ</p>
<h3 id="more-readings-1"><a class="header" href="#more-readings-1">More readings</a></h3>
<p>[1] <a href="https://netflixtechblog.com/dblog-a-generic-change-data-capture-framework-69351fb9099b">DBLog: A Generic Change-Data-Capture Framework</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatabasesassetspdfsrumpdfdesigning-access-methods-the-rum-conjecturea"><a class="header" href="#a-hrefdatabasesassetspdfsrumpdfdesigning-access-methods-the-rum-conjecturea"><a href="databases/../assets/pdfs/rum.pdf">Designing Access Methods: The RUM Conjecture</a></a></h3>
<blockquote>
<p>19th International Conference on Extending Database Technology (EDBT), March 2016</p>
<p>https://stratos.seas.harvard.edu/files/stratos/files/rum.pdf</p>
</blockquote>
<p>æ•°æ®åº“é¢†åŸŸè‡´åŠ›äºç ”ç©¶å­˜å‚¨ã€è®¿é—®ã€æ›´æ–°æ•°æ®çš„æ–¹æ³•å·²æœ‰ 40 ä½™å¹´ï¼Œä¸åŒçš„æ•°æ®ç»“æ„å’Œç®—æ³•è¢«æå‡ºä»¥é€‚åº”ä¸æ–­å˜åŒ–çš„ç¡¬ä»¶å’Œå·¥ä½œè´Ÿè½½ã€‚éšç€æ–°çš„è´Ÿè½½è¦æ±‚ã€æ–°åº”ç”¨ç¨‹åºåŠæ–°ç¡¬ä»¶çš„å‡ºç°ï¼Œæ•°æ®è®¿é—®æ–¹æ³•é€æ¸è¶‹å‘äº <code>application-aware</code> å’Œ <code>hardware-aware</code>ã€‚</p>
<p>åœ¨è®¾è®¡æ•°æ®è®¿é—®æ–¹æ³•çš„æ—¶å€™æ€»æ˜¯å°è¯•æœ€å°åŒ–ä»¥ä¸‹ä¸‰ä¸ªå¼€é”€:</p>
<ul>
<li>Read Overhead (RO) â€”â€” ä¹Ÿç§°ä¸º read amplificationï¼Œå³è¯»æ”¾å¤§</li>
<li>Update Overhead (UO) â€”â€” ä¹Ÿç§°ä¸º write amplificationï¼Œå³å†™æ”¾å¤§</li>
<li>Memory Overhead (MO) â€”â€” ä¹Ÿç§°ä¸º space amplificationï¼Œå³ç©ºé—´æ”¾å¤§</li>
</ul>
<p>æœ¬è®ºæ–‡æå‡ºäº† RUM æ¨æµ‹:</p>
<blockquote>
<p>An access method that can set an upper bound for two out of the read, update,
and memory overheads, also sets a lower bound for the third overhead.</p>
</blockquote>
<p>å³ä¸‰è€…æ„æˆä¸€ä¸ª competing triangleï¼Œä¸‹å›¾å±•ç¤ºäº†ä¸€äº›æ•°æ®ç»“æ„åœ¨è¯¥ä¸‰è§’ä¸­çš„ä½ç½®:</p>
<p><img src="databases/../assets/images/rum-popular-ds.jpg" alt="Popular data structures in the RUM space." /></p>
<p>è®ºæ–‡ç»™å‡ºäº†ä¸€äº›å…¸å‹æ•°æ®ç»“æ„çš„å„ç§å¼€é”€æ•°æ®:</p>
<p><img src="databases/../assets/images/rum-ds-costs.jpg" alt="" /></p>
<p>RUM æ¨æµ‹æŒ‡å‡ºå®Œç¾çš„æ•°æ®è®¿é—®æ–¹æ³•ä¸å­˜åœ¨ï¼Œä½†è¿™å¹¶ä¸ä»£è¡¨åº”è¯¥åœæ­¢æ”¹è¿›ï¼Œæ°æ°ç›¸åï¼Œåº”è¯¥ä½¿ç”¨è¯¥ç†è®ºæŒ‡å¯¼æ•°æ®è®¿é—®æ–¹æ³•çš„ç ”ç©¶ï¼Œé’ˆå¯¹ä¸åŒçš„åº”ç”¨è´Ÿè½½å’Œä¸åŒçš„ç¡¬ä»¶ç‰¹æ€§ç ”å‘ä¸åŒçš„æ•°æ®è®¿é—®æ–¹æ³•ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="data-layout"><a class="header" href="#data-layout">data layout</a></h2>
<ul>
<li><strong><a href="datalayout/c-store.html">C-Store: A Column-oriented DBMS</a></strong></li>
<li><strong><a href="datalayout/c-store-compression.html">Integrating Compression and Execution in Column-Oriented Database Systems</a></strong></li>
<li><strong><a href="datalayout/dremel.html">Dremel: Interactive Analysis of WebScale Datasets</a></strong></li>
<li><strong><a href="datalayout/rcfile.html">RCFile: A fast and space-efficient data placement structure in MapReduce-based warehouse systems</a></strong></li>
<li><strong><a href="datalayout/orc.html">Major Technical Advancements in Apache Hive</a></strong></li>
<li><strong><a href="datalayout/table-placement-methods.html">Table Placement Methods</a></strong></li>
</ul>
<h4 id="further-readings-6"><a class="header" href="#further-readings-6">Further readings</a></h4>
<p>[1] <a href="http://dbmsmusings.blogspot.com/2017/10/apache-arrow-vs-parquet-and-orc-do-we.html">Apache Arrow vs. Parquet and ORC: Do we really need a third Apache project for columnar data representation?</a> by Daniel Abadi, 2017<br></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatalayoutassetspdfscstore-vldb05pdfc-store-a-column-oriented-dbmsa"><a class="header" href="#a-hrefdatalayoutassetspdfscstore-vldb05pdfc-store-a-column-oriented-dbmsa"><a href="datalayout/../assets/pdfs/cstore-vldb05.pdf">C-Store: A Column-oriented DBMS</a></a></h3>
<blockquote>
<p>VLDB 2005 Mike Stonebraker, etc.</p>
<p>https://dl.acm.org/doi/10.5555/1083592.1083658</p>
</blockquote>
<p>è¡Œå­˜ï¼ˆrow storeï¼‰RDBMS ä½œä¸ºå½“æ—¶çš„ä¸»æµï¼Œé€šå¸¸å°†åŒä¸€è¡Œè®°å½•çš„æ‰€æœ‰å±æ€§å­˜å‚¨åœ¨ç£ç›˜çš„è¿ç»­ç©ºé—´ï¼Œä»¥è·å¾—å“è¶Šçš„å†™æ€§èƒ½ï¼Œè¿™ç§æ–¹å¼ä¹Ÿè¢«ç§°ä¸º write-optimizedï¼Œé€‚ç”¨äº OLTP åœºæ™¯ã€‚è€Œæ•°æ®ä»“åº“ã€CRM ç­‰éœ€è¦ ad-hoc æŸ¥è¯¢å¤§é‡æ•°æ®çš„ç³»ç»Ÿåº”è¯¥å…·æœ‰ read-optimized çš„ç‰¹æ€§ï¼Œæ­¤ç±»ç³»ç»Ÿå¾€å¾€é€šè¿‡åˆ—å­˜ï¼ˆcolunm storeï¼‰æ¶æ„æ¥è·å¾—æ›´æœ‰æ•ˆçš„æ€§èƒ½ï¼ˆå¦‚ Sybase IQ, Addamark, KDBï¼‰ã€‚</p>
<p>åˆ—å­˜æ¶æ„ä¸­ï¼ŒæŸ¥è¯¢æ“ä½œåªéœ€æŒ‰éœ€è¯»å–æ‰€éœ€è¦çš„åˆ—ï¼Œé¿å…å°†æ— å…³æ•°æ®è¯»å–åˆ°å†…å­˜ã€‚CPU çš„æ€§èƒ½å¢é€Ÿè¦è¿œé«˜äºç£ç›˜çš„å¸¦å®½å¢é€Ÿï¼Œåœ¨ read-optimized ç³»ç»Ÿï¼Œç”¨ CPU cycles æ¢å–ç£ç›˜å¸¦å®½æ˜¯ä¸€ä»¶å€¼å¾—çš„äº‹æƒ…ï¼Œåˆ—å­˜é€šè¿‡ 1) code 2) densepack ä¸¤ç§æ–¹å¼è¾¾åˆ°ä»¥ CPU cycles æ¢å–ç£ç›˜å¸¦å®½çš„ç›®çš„ã€‚</p>
<p>C-Store æ˜¯ä½œè€…æå‡ºçš„ä¸€ä¸ªæ–°çš„åˆ—å­˜æ•°æ®åº“ï¼Œå…·æœ‰å¦‚ä¸‹é©æ–°ç‰¹æ€§ï¼š</p>
<ol>
<li>A hybrid architecture with a WS component optimized for frequent insert and update and an RS component optimized for query performance</li>
<li>Redundant storage of elements of a table in several overlapping projections in different orders, so that a query can be solved using the most advantageous projection</li>
<li>Heavily compressed columns using one of several coding schemes</li>
<li>A column-oriented optimizer and executor, with different primitives than in a row-oriented system</li>
<li>High availability and improved performance through K-safety using a sufficient number of overlapping projections</li>
<li>The use of snapshot isolation to avoid 2PC and locking for queries</li>
</ol>
<h3 id="æ··åˆæ¶æ„"><a class="header" href="#æ··åˆæ¶æ„">æ··åˆæ¶æ„</a></h3>
<p>äººä»¬å¯¹å®æ—¶æ•°ä»“æ•°æ®å¯è§æ€§çš„å»¶è¿Ÿè¦æ±‚è¶Šæ¥è¶Šé«˜ï¼ˆtoward 0ï¼‰ï¼ŒC-Store çš„ <code>Writeable Store</code> æ¨¡å—æ”¯æ’‘é¢‘ç¹åœ°æ’å…¥å’Œæ›´æ–°ï¼Œ<code>Read-optimized Store</code> æ¨¡å—æä¾›é«˜æ€§èƒ½æŸ¥è¯¢ï¼Œ<code>Tuple Mover</code> åˆ™è´Ÿè´£å°†æ•°æ®ä» WS merge åˆ° RSï¼Œè¿™æ˜¯ç»“æ„éå¸¸ç±»ä¼¼ LSMã€‚</p>
<h3 id="æ•°æ®æ¨¡å‹-1"><a class="header" href="#æ•°æ®æ¨¡å‹-1">æ•°æ®æ¨¡å‹</a></h3>
<p>C-Store æ”¯æŒæ ‡å‡†å…³ç³»æ•°æ®åº“çš„é€»è¾‘æ•°æ®æ¨¡å‹ â€”â€” æ•°æ®åº“ç”±è¡¨æ„æˆï¼Œæ¯ä¸ªè¡¨å«å¤šä¸ªæ•°æ®åˆ—ï¼Œè¡¨çš„å±æ€§å¯ä»¥ä½œä¸º primary key æˆ–å…¶å®ƒè¡¨çš„ foreign keyã€‚ä½† C-Store çš„ç‰©ç†å­˜å‚¨æ¨¡å‹ä¸åŒäºè¿™ç§é€»è¾‘æ¨¡å‹ï¼Œæ˜¯ä»¥ projection è¿›è¡Œå­˜å‚¨çš„ã€‚</p>
<ul>
<li>ä¸€ä¸ª projection å­˜å‚¨äº†ä¸€ä¸ªé€»è¾‘è¡¨çš„ä¸€ä¸ªæˆ–å¤šä¸ªåˆ—å±æ€§ï¼Œå®ƒè¿˜å¯ä»¥å­˜å‚¨å…¶å®ƒè¡¨çš„ä¸€ä¸ªæˆ–å¤šä¸ªå±æ€§ä»¥è¡¨ç¤ºå¤–é”®</li>
<li>ä¸€ä¸ª projection å’Œå®ƒçš„é”šè¡¨ï¼ˆanchor tableï¼‰å…·æœ‰çš„è¡Œæ•°ç›¸åŒ</li>
<li>ä¸€ä¸ª projection å…·æœ‰ä¸€ä¸ª <code>sort key</code>ï¼Œç”±è¯¥ projection çš„ä¸€ä¸ªæˆ–å¤šä¸ªåˆ—æ„æˆã€‚åŒä¸€ä¸ª projection ä¸­çš„ K ä¸ªå±æ€§å„è‡ªå­˜å‚¨äºä¸€ä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œä¸”éƒ½æŒ‰ç…§ <code>sort key</code> è¿›è¡Œæ’åº</li>
<li>æ¯ä¸ª projection éƒ½è¢«æ°´å¹³åˆ‡åˆ†ï¼ˆHorizontally partitionedï¼‰ä¸ºä¸€ä¸ªæˆ–å¤šä¸ª segmentï¼Œåˆ‡åˆ†çš„ä¾æ®ä¸º <code>sort key</code>ï¼Œè¿™æ ·æ¯ä¸ª segment éƒ½å¯¹åº”ä¸€æ®µ key range</li>
<li>ç”±äºæ¯ä¸ª projection çš„ <code>sort key</code> ä¸ä¸€è‡´ï¼Œå› æ­¤éœ€è¦ <code>join indexes</code> æ¥ç»´æŒä¸åŒ projection çš„å¯¹åº”å…³ç³»</li>
</ul>
<h4 id="storage-key"><a class="header" href="#storage-key">Storage key</a></h4>
<ul>
<li>åœ¨ RS ä¸Šï¼Œstorage key æ˜¯è®°å½•åœ¨ segement ä¸Šçš„åºæ•°ï¼Œä¸å­˜å‚¨ä¸”æŒ‰éœ€è®¡ç®—è·å¾—</li>
<li>åœ¨ WS ä¸Šæ‰§è¡Œå¼•æ“ç»™æ¯ä¸€æ¬¡æ’å…¥èµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„ storage key, å¤§äº RS ä¸Š storage key çš„æœ€å¤§å€¼</li>
<li>WS å’Œ RS æŒ‰ç…§ç›¸åŒçš„è§„åˆ™è¿›è¡Œæ°´å¹³åˆ‡åˆ†ï¼Œå› æ­¤ RS segement å’Œ WS segent æ˜¯ 1:1 å¯¹åº”çš„ï¼Œå› æ­¤ (sid, storage_key) åªèƒ½å­˜åœ¨ RS æˆ– WS ä¸­çš„ä¸€ä¸ª</li>
<li>ç”±äº WS åœ¨å°ºå¯¸ä¸Šç›¸å¯¹è¾ƒå°ï¼Œå› æ­¤ä½¿ç”¨ B-tree ç›´æ¥å­˜å‚¨ projection çš„æ¯ä¸€åˆ—ï¼ŒæŒ‰ storage key æ’åºï¼Œå¦å¤–ï¼ˆsort keyï¼Œ storage keyï¼‰ä»¥ <code>sort key</code> ä½œä¸º key ä¿å­˜ä¸º B-treeã€‚è¿™æ ·å°±æ ¹æ® sort key å¿«é€Ÿå®šä½åˆ° storage keyï¼Œç„¶åå†æ ¹æ® storage key æ‰¾åˆ°å¯¹åº”çš„åˆ—å€¼</li>
<li>WS æ„å»ºåœ¨ BerkeleyDB çš„ B-tree ç»“æ„ä¸Š</li>
</ul>
<h4 id="join-indices"><a class="header" href="#join-indices">Join Indices</a></h4>
<blockquote>
<p>If T1 and T2 are two projections that cover a table T, a join index from the M segments in T1 to the N
segments in T2 is logically a collection of M tables, one per segment, S, of T1 consisting of rows of the form:</p>
<p>(s: SID in T2, k: Storage Key in Segment s)</p>
</blockquote>
<p>Join Index æŒ‰ç…§ T1 çš„åˆ‡åˆ†æ–¹å¼è¿›è¡Œåˆ‡åˆ†ï¼Œä¸”è·Ÿ T1 çš„ segement ä¿å­˜åœ¨ä¸€èµ·ã€‚</p>
<p>Join Index åœ¨æ›´æ–°çš„æ—¶å€™éå¸¸éš¾ä»¥ç»´æŠ¤ï¼Œå› æ­¤ä¼šæŠŠæ¯ä¸ª column å­˜å‚¨åœ¨å¤šä¸ª projection ä¸Šï¼Œä½†è¿™å¯¹ DBA è®¾è®¡è¡¨ç»“æ„æå‡ºäº†æ›´é«˜çš„è¦æ±‚ï¼Œæ–‡ä¸­æåˆ°ä»–ä»¬æ­£åœ¨å†™ä¸€ä¸ªè‡ªåŠ¨åŒ–è¡¨ç»“æ„è®¾è®¡å·¥å…·ã€‚</p>
<h3 id="coding-schema"><a class="header" href="#coding-schema">Coding Schema</a></h3>
<p>projection ä¸­çš„æ¯ä¸€åˆ—éƒ½ç´§å‡‘åœ°å­˜å‚¨åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼ŒåŸºäºè¯¥åˆ—æ˜¯å¦æ˜¯ <code>sort key</code> ä»¥åŠè¯¥åˆ—ä¸åŒæ•°æ®çš„å¤šå°‘ï¼Œæ–‡ä¸­ç»™å‡ºäº†å››ç§ç¼–ç æ–¹å¼ï¼š</p>
<ol>
<li>Self-order, few distinct values</li>
<li>Foreign-order, few distinct values</li>
<li>Self-order, many distinct values</li>
<li>Foreign-order, many distinct values</li>
</ol>
<h3 id="column-oriented-optimizer-and-executor"><a class="header" href="#column-oriented-optimizer-and-executor">Column-oriented optimizer and executor</a></h3>
<p>è¿™å—ä¸æ‡‚ï¼Œåé¢æœ‰æœºä¼šå†è¡¥å……</p>
<h3 id="high-availability"><a class="header" href="#high-availability">High availability</a></h3>
<p>ç”±äºä¸åŒçš„åˆ—å­˜åœ¨ä¸å¤šä¸ª projectionï¼ŒC-Store åŸºäºæ­¤å¯ä»¥å®ç° K-safe çš„ç³»ç»Ÿã€‚</p>
<h3 id="snapshot-isolation"><a class="header" href="#snapshot-isolation">Snapshot Isolation</a></h3>
<blockquote>
<p>Snapshot isolation works by allowing read-only transactions to access the database as
of some time in the recent past, before which we can guarantee that there are no uncommitted transactions.</p>
</blockquote>
<p>å¯¹äºåªè¯»äº‹åŠ¡ï¼Œå¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ¥åˆ¤æ–­è®°å½•çš„å¯è§æ€§ï¼Œå› æ­¤å¯ä»¥ä¸ç”¨åŠ é”</p>
<p>å¯¹äº Read-write äº‹åŠ¡ï¼ŒC-Store éµå¾ªä¸¥æ ¼çš„ two-phase lockingï¼Œå¹¶ä½¿ç”¨äº† NO-Force, STEAL ç­–ç•¥ã€‚</p>
<p>äº‹åŠ¡ç›¸å…³çš„å†…å®¹æ„Ÿè§‰è·Ÿ Mysql æœ‰äº›ç›¸åƒï¼Œä½†æœ‰äº›å†…å®¹è¿˜æ²¡ææ˜ç™½ï¼Œè¿™å—åé¢æœ‰æœºä¼šå†ç ”ç©¶ä¸€ä¸‹ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatalayoutassetspdfsc-store-compressionpdfintegrating-compression-and-execution-in-column-oriented-database-systemsa"><a class="header" href="#a-hrefdatalayoutassetspdfsc-store-compressionpdfintegrating-compression-and-execution-in-column-oriented-database-systemsa"><a href="datalayout/../assets/pdfs/c-store-compression.pdf">Integrating Compression and Execution in Column-Oriented Database Systems</a></a></h3>
<blockquote>
<p>SIGMOD '06</p>
<p>https://doi.org/10.1145/1142473.1142548</p>
</blockquote>
<p>åˆ—å¼å­˜å‚¨å¢åŠ äº†ç£ç›˜ä¸Šç›¸é‚»è®°å½•çš„ç›¸ä¼¼æ€§ï¼Œå› æ­¤å¤§å¤§å¢åŠ äº†å‹ç¼©ç®—æ³•çš„ç”¨æ­¦ä¹‹åœ°ã€‚</p>
<blockquote>
<p>The ability to compress many adjacent tuples at once lowers the per-tuple cost of compression,
both in terms of CPU and space overheads.</p>
</blockquote>
<p>è™½ç„¶å‹ç¼©ç®—æ³•åœ¨è¡Œå¼å­˜å‚¨ä¹Ÿå¸¸è¢«ç”¨åˆ°ï¼Œä¾‹å¦‚å­—å…¸ç¼–ç å’Œ run-length encoding (RLE)ï¼Œä½†å…¶å‹ç¼©æ¯”ç›¸å¯¹åˆ—å¼å­˜å‚¨è¦æ˜¾å¾—é€Šè‰²å¾ˆå¤šã€‚</p>
<blockquote>
<p>Compression ratios are also generally higher in column-stores because consecutive entries in a
column are often quite similar to each other, whereas adjacent attributes in a tuple are not.</p>
</blockquote>
<p>å¯¹äºå®šé•¿å­—æ®µï¼Œåˆ—å¼å­˜å‚¨è¿˜èƒ½å……åˆ†åˆ©ç”¨ CPU çš„è¶…æ ‡é‡ç‰¹æ€§æ¥åŠ é€Ÿè§£å‹é€Ÿåº¦ã€‚</p>
<p>åˆ—å¼å­˜å‚¨çš„ç®—å­èƒ½å¤Ÿé€šè¿‡ç›´æ¥æ“ä½œå‹ç¼©æ•°æ®æ¥æå‡æŸ¥è¯¢æ€§èƒ½ã€‚</p>
<p>æ–‡ç« å¯¹ 5 ç§å‹ç¼©ç®—æ³•åœ¨åˆ—å¼å­˜å‚¨ä¸Šçš„æ€§èƒ½è¿›è¡Œäº†å……åˆ†çš„å®éªŒå¯¹æ¯”:</p>
<ul>
<li>Null Suppression</li>
<li>Dictionary Encoding</li>
<li>Run-length Encoding</li>
<li>BitVector Encoding</li>
<li>Lempel-Ziv Encoding</li>
</ul>
<p>å®éªŒå¯¹æ’åºæ•°æ®çš„ run-length å’Œ cardinality (NDV, Number of Distinct Values) è¿›è¡Œè°ƒæ•´ï¼Œå®éªŒç»“æœè§ Section 6ï¼Œæœ€ç»ˆæ ¹æ®ç»“æœç»™å‡ºäº†ä¸€ä¸ªå†³ç­–æ ‘ï¼Œæ¥æŒ‡å¯¼å‹ç¼©ç®—æ³•çš„é€‰æ‹©ã€‚</p>
<p><img src="datalayout/../assets/images/c-store-compression-decision-tree.jpg" alt="Decision tree" /></p>
<p>è¦æƒ³æ›´è¯¦ç»†åœ°äº†è§£ç®—æ³•å®ç°ï¼Œ<a href="https://github.com/apache/orc">ORC</a> çš„ä»£ç æ˜¯ä¸€ä¸ªä¸é”™çš„å‚è€ƒã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatalayoutassetspdfsdremelpdfdremel-interactive-analysis-of-web-scale-datasetsa"><a class="header" href="#a-hrefdatalayoutassetspdfsdremelpdfdremel-interactive-analysis-of-web-scale-datasetsa"><a href="datalayout/../assets/pdfs/dremel.pdf">Dremel: Interactive Analysis of Web-Scale Datasets</a></a></h3>
<blockquote>
<p>VLDB 2010</p>
<p>https://dl.acm.org/doi/10.14778/1920841.1920886</p>
</blockquote>
<p>Dremel æ˜¯ Google å†…éƒ¨ä½¿ç”¨çš„ä¸€ä¸ªå¯æ‰©å±•ã€äº¤äº’å¼æ•°æ®åˆ†æç³»ç»Ÿï¼Œé€šè¿‡å°† <strong>multi-level execution trees</strong> å’Œ<strong>åˆ—å­˜æ•°æ®å¸ƒå±€</strong>ç»“åˆï¼Œå¯ä»¥åœ¨ç§’çº§æ—¶é—´é‡çº§æ‰§è¡Œä¸‡äº¿ï¼ˆtrillionï¼‰è¡Œè¡¨çš„èšé›†æŸ¥è¯¢ã€‚</p>
<p>Dremel æ¶æ„å€Ÿç”¨äº†åˆ†å¸ƒå¼æœç´¢å¼•æ“ <code>serving tree</code> çš„æ¦‚å¿µï¼ŒæŸ¥è¯¢è¢«ä¸‹æ¨åˆ°æ ‘çš„å„ä¸ªèŠ‚ç‚¹å¹¶åœ¨æ¯ä¸€æ­¥è¿›è¡Œæ”¹å†™ï¼Œé€šè¿‡èšåˆä»ä½å±‚æ”¶åˆ°çš„å›å¤æ¥ç»„è£…ç»“æœï¼›å¦å¤–ï¼ŒDremel æä¾›äº†ä¸€ä¸ª SQL-like çš„é«˜çº§è¯­è¨€æ¥è¡¨è¾¾ <code>ad hoc</code> æŸ¥è¯¢ï¼Œä¸åŒäº Pig å’Œ Hiveï¼ŒDremel æŸ¥è¯¢ä¸ä¼šè½¬æ¢æˆ MR ä»»åŠ¡ã€‚</p>
<p>Dremel ä½¿ç”¨äº†åˆ—å­˜æ ¼å¼æ¥å­˜å‚¨æ•°æ®ï¼Œä»¥å‡å°‘ä¸ç›¸å…³çš„æ•°æ®è¯»å–å’Œ CPU æ¶ˆè€—ï¼ˆdue to cheaper compressionï¼‰ã€‚è™½ç„¶åˆ—å­˜æ ¼å¼åœ¨ OLAP é¢†åŸŸå¹¶ä¸å°‘è§ï¼Œä½† Dremel å¼€åˆ›æ€§åœ°å°†å…¶æ‰©å±•åˆ°äº†åµŒå¥—æ•°æ®æ ¼å¼ã€‚</p>
<h3 id="æ•°æ®æ¨¡å‹-2"><a class="header" href="#æ•°æ®æ¨¡å‹-2">æ•°æ®æ¨¡å‹</a></h3>
<p>Dremel çš„æ•°æ®æ¨¡å‹æ˜¯åŸºäºå¼ºç±»å‹çš„åµŒå¥—è®°å½•ï¼ŒæŠ½è±¡è¯­æ³•:</p>
<pre><code class="language-txt">t = dom | &lt;A1:t[*|?], ..., An:t[*|?]&gt;

t æ˜¯åŸå­ç±»å‹æˆ–ä¸€ä¸ªè®°å½•ç±»å‹ï¼ŒåŸå­ç±»å‹åŒ…æ‹¬æ•´å‹ã€æµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²ç­‰
Ai ä¸ºè®°å½•çš„ç¬¬ i ä¸ªå­—æ®µï¼Œå…¶åçš„ [*|?] è¡¨ç¤ºå…¶é‡å¤ç±»å‹
    * è¡¨ç¤ºè¯¥å­—æ®µä¸º Repeated
    ï¼Ÿè¡¨ç¤ºè¯¥å­—æ®µä¸º Optional
    æ— æ ‡è®°åˆ™è¡¨ç¤ºè¯¥å­—æ®µä¸º Required
</code></pre>
<p>è¿™ç§è¯­æ³•å¯ä»¥ä½¿ç”¨ ProtoBuffer è¿›è¡Œè¡¨ç¤ºï¼ŒPB åºåˆ—åŒ–åçš„æ•°æ®é€‚åˆç”¨äº RPCï¼Œä¸é€‚åˆä½œä¸ºä¸‹ç›˜æ ¼å¼ã€‚è¿™é‡Œæˆ‘ä»¬è®¤ä¸º PB æ•°æ®ä¸ºè¡Œå­˜æ ¼å¼ï¼Œä¸‹é¢é€šè¿‡ä¾‹å­æè¿°å¦‚ä½•å°† PB çš„æ•°æ®è½¬åŒ–ä¸º Dremel çš„åˆ—å­˜æ ¼å¼ã€‚</p>
<p><strong>Schema</strong></p>
<pre><code class="language-proto">message Document {
    required int64 DocId;
    optional group Links {
        repeated int64 Backward;
        repeated int64 Forward;
    }
    repeated group Name {
        repeated group Language {
            required string Code;
            optional string Country;
        }
        optional string Url;
    }
}
</code></pre>
<p>å¦‚ä¸Šçš„ Schema éå¸¸ç±»ä¼¼ JSONï¼Œç†è§£èµ·æ¥åº”è¯¥ä¸éš¾ã€‚é™¤äº†å¤šé‡æ€§æ ‡è®°ä¹‹å¤–ï¼Œ<code>full path</code> çš„æ¦‚å¿µè·Ÿåé¢çš„ Repetition Level å’Œ Definition Level æœ‰ç€å¯†åˆ‡çš„å…³ç³»ï¼š</p>
<table><thead><tr><th>Fild</th><th>Full Path</th></tr></thead><tbody>
<tr><td>DocId</td><td>DocId</td></tr>
<tr><td>Backward</td><td>Links.Back</td></tr>
<tr><td>Language</td><td>Name.Language</td></tr>
<tr><td>Country</td><td>Name.Language.Country</td></tr>
</tbody></table>
<p><strong>ä¸¤è¡Œç¬¦åˆä¸Šè¿° Schema çš„è®°å½•</strong></p>
<p><em>r1</em></p>
<pre><code class="language-yml">DocId: 10
Links
    Forward: 20
    Forward: 40
    Forward: 60
Name
    Language
        Code: 'en-us'
        Country: 'us'
    Language
        Code: 'en'
    Url: 'http://A'
Name
    Url: 'http://B'
Name
    Language
        Code: 'en-gb'
        Country: 'gb'
</code></pre>
<p><em>r2</em></p>
<pre><code class="language-yml">DocId: 20
Links
    Backward: 10
    Backward: 30
    Forward: 80
Name
    Url: 'http://C'
</code></pre>
<p>å¯¹äºè¿™ç§åµŒå¥—æ¨¡å¼ï¼Œå¦‚æœå•çº¯å°†åŒä¸€å­—æ®µçš„æ•°æ®è¿ç»­å­˜å‚¨ï¼Œä¸èƒ½ç¡®å®šä¸€ä¸ªæ•°æ®å±äºå“ªæ¡è®°å½•ã€‚Dremel å¼•å…¥ <code>Repetition Level</code> å’Œ <code>Definition Level</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><strong>Repetiton Level</strong> è®°å½•è¯¥å€¼åœ¨ <code>full path</code> çš„å“ªä¸€çº§è¿›è¡Œé‡å¤ï¼Œä»¥ Name.Language.Code ä¸ºä¾‹ï¼Œå®ƒå«æœ‰ä¸¤ä¸ªå¯é‡å¤å­—æ®µï¼š<code>Name</code> å’Œ <code>Language</code>ï¼Œå› æ­¤ <code>Code</code> çš„ Repetition Level å¯å–çš„å€¼ä¸º 0,1,2:</p>
<ul>
<li>0 è¡¨ç¤ºä¸€ä¸ªæ–°è¡Œ</li>
<li>1 è¡¨ç¤ºè¯¥å€¼æœ€è¿‘çš„é‡å¤çº§åˆ«ä¸º Name</li>
<li>2 è¡¨ç¤ºè¯¥å€¼æœ€è¿‘çš„é‡å¤çº§åˆ«ä¸º Language</li>
</ul>
<p>å¯¹ r1 è¿›è¡Œ Repetition Level æ ‡æ³¨ï¼š</p>
<pre><code class="language-yml">                  Repetition Level
DocId: 10                   0
Links
    Forward: 20             0
    Forward: 40             1
    Forward: 60             1
Name
    Language
        Code: 'en-us'       0
        Country: 'us'       0
    Language
        Code: 'en'          2
    Url: 'http://A'         0
Name
    Url: 'http://B'         1
Name
    Language
        Code: 'en-gb'       1
        Country: 'gb'       1
</code></pre>
<p>æ³¨æ„åˆ° r1 çš„ç¬¬äºŒä¸ª Name ä¸­æ²¡æœ‰ä»»ä½• Codeï¼Œä½†ä¸ºäº†è¡¨ç¤º en-gb æ˜¯å±äºç¬¬ä¸‰ä¸ª Nameï¼Œåœ¨ Code åˆ—ä¸­æ’å…¥äº†ä¸€æ¡ NULL(repetition level ä¸º 1)ã€‚Code åœ¨ Language ä¸­ä¸º <strong>Required</strong> å­—æ®µï¼Œæ‰€ä»¥å®ƒä¸º NULL éšå«äº† Language ä¹Ÿä¸º NULLã€‚å› æ­¤éœ€è¦é¢å¤–çš„ä¿¡æ¯æ¥æ•°æ®å±äºå“ªä¸ªçº§åˆ«ï¼Œä»¥é¿å…æ„é€ å‡ºå¤šä½™çš„æ•°æ®ç»“æ„ã€‚</p>
<p><strong>Definition Level</strong> è¡¨ç¤ºäº† full path ä¸Šçš„ optional æˆ– repeated å­—æ®µå®é™…å­˜åœ¨çš„ä¸ªæ•°ï¼Œå¯¹äºåŒåˆ—é NULL çš„æ‰€æœ‰è®°å½•ï¼Œå…¶å€¼æ˜¯ç›¸åŒçš„ã€‚</p>
<p>å¯¹ r1 è¿›è¡Œ Definition Level æ ‡æ³¨ï¼š</p>
<pre><code class="language-yml">                  Repetition Level      Definition Level
DocId: 10                   0               0
Links
    Forward: 20             0               2
    Forward: 40             1               2
    Forward: 60             1               2
Name
    Language
        Code: 'en-us'       0               2
        Country: 'us'       0               3
    Language
        Code: 'en'          2               2
    Url: 'http://A'         0               2
Name
    Url: 'http://B'         1               2
Name
    Language
        Code: 'en-gb'       1               2
        Country: 'gb'       1               3
</code></pre>
<p>Definition Level ä¸»è¦å¯¹ NULL æœ‰æ„ä¹‰ï¼Œåœ¨æ¢å¤æ•°æ®çš„æ—¶å€™å¯ä»¥é¿å…æ¢å¤å‡ºå¤šä½™çš„ç»“æ„ã€‚ä¸‹å›¾æ˜¯ r1ã€r2 å…¨é‡çš„åˆ—å­˜ç»“æ„ï¼š</p>
<p><img src="datalayout/./../assets/images/dremel_column_representation.jpg" alt="column-striped representation" /></p>
<p>å‡è®¾æ²¡æœ‰ Definition Levelï¼Œå°è¯•æ¢å¤ r1 çš„æ•°æ®ç»“æ„ï¼Œä¼šå¾—åˆ°å¦‚ä¸‹çš„ç»“æœï¼š</p>
<p>è¯»ç¬¬ä¸€è¡Œ en-usï¼š</p>
<pre><code class="language-yml">Document
    Name
        Language
            code: 'en-us'
</code></pre>
<p>è¯»ç¬¬äºŒè¡Œ enï¼š</p>
<pre><code class="language-yml">Document
    Name
        Language
            code: 'en-us'
        Language
            code: 'en'
</code></pre>
<p>è¯»ç¬¬ä¸‰è¡Œ NULLï¼š</p>
<pre><code class="language-yml">Document
    Name
        Language
            code: 'en-us'
        Language
            code: 'en'
    Name
        Language
</code></pre>
<p>è¯»ç¬¬å››è¡Œ en-gbï¼š</p>
<pre><code class="language-yml">Document
    Name
        Language
            code: 'en-us'
        Language
            code: 'en'
    Name
        Language
    Name
        Language
            code: 'en-gb'
</code></pre>
<p>å¯ä»¥çœ‹å‡ºç¬¬äºŒä¸ª Name ä¸­æ„é€ å‡ºäº† Languageï¼Œè¿™åœ¨ r1 æ˜¯ä¸å­˜åœ¨çš„ã€‚ä½†å¦‚æœæœ‰äº† Definition Levelï¼Œåœ¨è¯»å–ç¬¬ä¸‰è¡Œçš„æ—¶å€™å°±èƒ½çŸ¥é“å®é™…åªå­˜åœ¨ä¸€ä¸ªå­—æ®µï¼Œä¹Ÿå°±æ˜¯ Nameï¼Œè¿™æ ·åœ¨æ„é€ çš„æ—¶å€™å°±ä¸ä¼šæ„é€  Language ç»“æ„:</p>
<p>è¯»ç¬¬ä¸‰è¡Œ NULLï¼š</p>
<pre><code class="language-yml">Document
    Name
        Language
            code: 'en-us'
        Language
            code: 'en'
    Name
</code></pre>
<p>åœ¨å®é™…çš„ç¼–ç ä¸­ä¼šå¯¹ä¸Šé¢çš„ç»“æ„è¿›è¡Œç¼–ç ä»¥å‡å°‘ä¸å¿…è¦çš„å­˜å‚¨ç©ºé—´ã€‚è‡³æ­¤æˆ‘ä»¬å¯¹ Dremel çš„åˆ—å­˜æ ¼å¼æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚è®ºæ–‡çš„é™„å½•æœ‰è®°å½•åˆ‡åˆ†å’Œç»„è£…çš„å…·ä½“ç®—æ³•ï¼Œè¿™é‡Œä¸å†æè¿°ã€‚</p>
<h3 id="æŸ¥è¯¢æ‰§è¡Œ"><a class="header" href="#æŸ¥è¯¢æ‰§è¡Œ">æŸ¥è¯¢æ‰§è¡Œ</a></h3>
<p>Dremel ä½¿ç”¨ <code>multi-level serving tree</code> æ¥æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ ¹èŠ‚ç‚¹æ”¶åˆ°è¯·æ±‚ï¼Œè¯»å– metadata å¹¶æ®æ­¤å°†è¯·æ±‚è·¯ç”±åˆ°ä¸‹ä¸€çº§ï¼Œç›´åˆ°å¶å­èŠ‚ç‚¹ï¼Œå¶å­èŠ‚ç‚¹è¯·æ±‚å­˜å‚¨å±‚æˆ–ç›´æ¥è®¿é—®æœ¬åœ°ç›˜è·å–æ•°æ®ï¼Œå¤„ç†ä¹‹åé€çº§æ±‡æ€»åˆ°æ ¹èŠ‚ç‚¹ã€‚è¯·æ±‚åœ¨è·¯ç”±åˆ°ä¸‹ä¸€çº§ä¹‹å‰ä¼šè¿›è¡Œæ”¹å†™ã€‚</p>
<p><img src="datalayout/./../assets/images/dremel_query_execution.jpg" alt="System architecture and execution inside a server node" /></p>
<p>Dremel æ˜¯ä¸€ä¸ªå¤šç”¨æˆ·ç³»ç»Ÿï¼Œå…¶ query dispatcher ä¼šæ ¹æ®ä»»åŠ¡ä¼˜å…ˆçº§å’Œè´Ÿè½½å‡è¡¡è¿›è¡Œè°ƒåº¦ã€‚é€šè¿‡è®¾ç½®è¿”å›ç»“æœæ—¶å¿…é¡»æ‰«æ tablets çš„ç™¾åˆ†æ¯”ï¼ˆæ¯”å¦‚ 98%ï¼‰ï¼Œç‰ºç‰²ä¸€å®šç²¾ç¡®æ€§æ¥æ¢å–æ€§èƒ½ã€‚</p>
<p>Paper ä¸­æ²¡æœ‰æåˆ°ç´¢å¼•ã€è¿æ¥ã€æ•°æ®æ›´æ–°ç›¸å…³çš„å†…å®¹ã€‚</p>
<p><a href="https://github.com/apache/parquet-format">Apache Parquet</a> çš„å®ç°å‚è€ƒäº† Dremel çš„æ•°æ®æ¨¡å‹ï¼Œ<a href="https://github.com/apache/drill">Apache Drill</a> çš„å®ç°å‚è€ƒäº† Dremel çš„æŸ¥è¯¢æ¨¡å‹ã€‚</p>
<h4 id="references-6"><a class="header" href="#references-6">References:</a></h4>
<p>[1] <a href="https://blog.twitter.com/engineering/en_us/a/2013/dremel-made-simple-with-parquet">Dremel made simple with Parquet</a><br>
[2] <a href="https://github.com/julienledem/redelm/wiki/The-striping-and-assembly-algorithms-from-the-Dremel-paper">The striping and assembly algorithms from the Dremel paper</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatalayoutassetspdfsrcfilepdfrcfile-a-fast-and-space-efficient-data-placement-structure-in-mapreduce-based-warehouse-systemsa"><a class="header" href="#a-hrefdatalayoutassetspdfsrcfilepdfrcfile-a-fast-and-space-efficient-data-placement-structure-in-mapreduce-based-warehouse-systemsa"><a href="datalayout/../assets/pdfs/RCFile.pdf">RCFile: A fast and space-efficient data placement structure in MapReduce-based warehouse systems</a></a></h3>
<blockquote>
<p>IEEE 27th International Conference on Data Engineering, 2011</p>
<p>https://ieeexplore.ieee.org/document/5767933</p>
</blockquote>
<p>åŸºäº MapReduce çš„æ•°ä»“ç³»ç»Ÿåœ¨å¤§æ•°æ®åˆ†æé¢†åŸŸæ‰®æ¼”ç€ä¸€ä¸ªéå¸¸é‡è¦çš„è§’è‰²ï¼Œåœ¨è¿™æ ·çš„ç³»ç»Ÿä¸­ <code>data placement structure</code> æ˜¯å½±å“æ•°ä»“æ€§èƒ½çš„å…³é”®è¦ç´ ã€‚ä½œè€…æ ¹æ®å¯¹ Facebook ç”Ÿäº§ç³»ç»Ÿçš„è§‚å¯Ÿä¸åˆ†æï¼Œæ€»ç»“äº† <code>data placement structure</code> éœ€è¦æ»¡è¶³å¤§æ•°æ®å¤„ç†çš„å››ä¸ªè¦æ±‚:</p>
<ol>
<li>Fast data loading</li>
<li>Fast query processing</li>
<li>Highly efficient storage space utilization</li>
<li>Strong adaptivity to highly dynamic workload patterns</li>
</ol>
<p>æ–‡ç« å¯¹ä¸‰ç§åœ¨ä¼ ç»Ÿæ•°æ®åº“ç³»ç»Ÿæ¥å—åº¦ç”šå¹¿çš„æ•°æ®æ ¼å¼ â€”â€” row-stores, column-stores, hybrid-stores â€”â€” åŸºäº MapReduce ä½¿ç”¨åœºæ™¯åˆ†æäº†å®ƒä»¬ä¸é€‚åˆåˆ†å¸ƒå¼å¤§æ•°æ®åˆ†æç³»ç»Ÿçš„åŸå› ï¼Œå¹¶æå‡ºäº†ä¸€ç§æ–°çš„æ•°æ®æ ¼å¼ RCFile(Record Columnar File)ã€‚</p>
<h3 id="horizontal-row-store"><a class="header" href="#horizontal-row-store">Horizontal Row-store</a></h3>
<p>row-store å°†ä¸€è¡Œè®°å½•çš„æ‰€æœ‰å­—æ®µæŒ‰ç…§è¡¨çš„å®šä¹‰é€ä¸€é¡ºåºå­˜æ”¾åœ¨ç£ç›˜é¡µ:</p>
<p><img src="datalayout/../assets/images/rcfile_row_store_in_an_hdfs_block.jpg" alt="An example of row-store in an HDFS block" /></p>
<p>è¡Œå­˜å¯¹äºåªè¯»çš„æ•°ä»“ç³»ç»Ÿçš„å¼±ç‚¹å·²ç»è¢«å……åˆ†è®¨è®ºè¿‡ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>å¯¹äºåªå…³å¿ƒå°‘æ•°å‡ ä¸ªåˆ—çš„æŸ¥è¯¢ï¼Œè¡Œå­˜ä¸èƒ½å‡å°‘æ— ç”¨åˆ—çš„è¯»å–ï¼Œå› è€Œå¾ˆéš¾æä¾›å¿«é€Ÿçš„æŸ¥è¯¢</li>
<li>å„åˆ—ä¸åŒç±»å‹çš„æ•°æ®æ··åˆå­˜å‚¨ä½¿å¾—è¡Œå­˜å¾ˆéš¾è·å¾—è¾ƒé«˜çš„å‹ç¼©æ¯”ï¼ˆè™½ç„¶æœ‰ç ”ç©¶æŒ‡å‡ºé€šè¿‡ç»“åˆ<code>ç†µç¼–ç </code>å’Œ<code>åˆ—ç›¸å…³æ€§</code>èƒ½å¤Ÿä¸ºè¡Œå­˜æä¾›ä¼˜äºåˆ—å­˜çš„å‹ç¼©æ¯”ï¼Œä½†è§£å‹ä¼šæ¶ˆè€—æ›´å¤šçš„èµ„æºï¼‰</li>
</ul>
<p><strong>è¡Œå­˜æ»¡è¶³å¤§æ•°æ®å¤„ç†å››ä¸ªè¦æ±‚ä¸­çš„ 1ã€4</strong></p>
<h3 id="vertical-column-store"><a class="header" href="#vertical-column-store">Vertical Column-store</a></h3>
<p>åœ¨æ•°ä»“ç³»ç»Ÿä¸­å¹¿æ³›è¢«ä½¿ç”¨çš„è¯»ä¼˜åŒ–çš„åˆ—å­˜æ ¼å¼åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯å°†æ¯ä¸€åˆ—ä½œä¸ºä¸€ä¸ª <code>sub-relation</code> å•ç‹¬å­˜å‚¨ï¼Œå…¸å‹ä»£è¡¨å¦‚ <code>Decomposition Storage Model(DSM)</code> å’Œ MonetDBï¼›å¦ä¸€ç§å°†å…³ç³»ä¸­çš„æ‰€æœ‰åˆ—ç»„åˆæˆå¤šä¸ªçš„ <code>column group</code>ï¼Œå¹¶ä¸”å…è®¸ä¸åŒ <code>column group</code> ä¹‹é—´æœ‰ overlapï¼Œå…¸å‹ä»£è¡¨å¦‚ <code>C-store</code> å’Œ Yahoo Zebraã€‚æ–‡ä¸­ç§°ç¬¬ä¸€ç§æ¨¡å¼ä¸º <code>column-store</code>ï¼Œå°†ç¬¬äºŒç§æ¨¡å¼ç§°ä½œ <code>column-group</code>ã€‚</p>
<p><code>column-group</code> æ¨¡å¼ä¸­å•ä¸ª <code>group</code> çš„æ•°æ®ç»„ç»‡æ–¹å¼ä¾èµ–å…·ä½“å®ç°ï¼ŒC-store ä¸­æ¯ä¸ª group é‡‡ç”¨ <code>column-store</code>ï¼Œè€Œ Zebra ä¸­çš„æ¯ä¸ª group åˆ™é‡‡ç”¨è¡Œå­˜å­˜å‚¨ã€‚ä¸‹å›¾æ˜¯ä¸€ä¸ª <code>column-group</code> çš„ç¤ºä¾‹ï¼š</p>
<p><img src="datalayout/../assets/images/rcfile_colum_group.jpg" alt="An example of column-group in an HDFS block" /></p>
<p><code>column-store</code> èƒ½å¤Ÿé¿å…è¯»å–æ— ç”¨åˆ—çš„æ•°æ®ï¼Œå¹¶èƒ½æä¾›è¾ƒé«˜çš„å‹ç¼©æ¯”ã€‚ä½†åœ¨ HDFS ä¸­ï¼Œä¸åŒåˆ—çš„æ•°æ®ä¸èƒ½ä¿è¯å­˜å‚¨åœ¨åŒä¸€ä¸ª DataNode ä¸Šï¼Œå› æ­¤é‡æ„æ•°æ®æ—¶å­˜åœ¨å¤§é‡ç½‘ç»œå¼€é”€ã€‚</p>
<p><code>column-group</code> çš„æ¯ä¸ª group ç›¸å½“äºä¸€ä¸ªç‰©åŒ–è§†å›¾ï¼Œå¯ä»¥é¿å…æ•°æ®é‡æ„çš„ç½‘ç»œå¼€é”€ï¼Œä½†ç”±äºé¢„å…ˆè®¾è®¡å¥½çš„ projection åªå¯¹æœ‰é™çš„æŸ¥è¯¢è¯­å¥æœ‰æ•ˆï¼Œå› æ­¤ä¸æ”¯æŒ <code>highly dynamic workload</code>ã€‚è€Œä¸”ç”±äº <code>column-group</code> çš„æ•°æ®å­˜åœ¨ overlapï¼Œéš¾å…ä¼šé€ æˆæ•°æ®ç©ºé—´çš„è†¨èƒ€ã€‚</p>
<p><strong><code>column-store</code> æ»¡è¶³å¤§æ•°æ®å¤„ç†å››ä¸ªè¦æ±‚ä¸­çš„ 1ã€3ã€4</strong></p>
<p><strong><code>column-group</code> æ»¡è¶³å¤§æ•°æ®å¤„ç†å››ä¸ªè¦æ±‚ä¸­çš„ 1ã€2</strong></p>
<h3 id="hybrid-store-pax"><a class="header" href="#hybrid-store-pax">Hybrid Store: PAX</a></h3>
<p>PAX ä½¿ç”¨äº†ä¸€ç§æ•°æ®æ··åˆæ”¾ç½®çš„ç­–ç•¥ï¼ŒåŒä¸€è¡Œæ•°æ®çš„å„å­—æ®µä»ç„¶å­˜å‚¨åœ¨åŒä¸€ä¸ªç£ç›˜é¡µï¼Œåªæ˜¯å°†è¯¥ç£ç›˜é¡µçš„å¤šè¡Œè®°å½•è¿›è¡Œäº†é‡æ–°ç»„ç»‡ï¼Œå„ä¸ªåˆ—çš„å€¼è¿ç»­å­˜å‚¨åœ¨ mini-page ä¸­ï¼Œå¹¶åœ¨ page header ä¸­å­˜å‚¨ mini-page çš„æŒ‡é’ˆã€‚</p>
<p>PAX çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æé«˜ CPU ç¼“å­˜å‘½ä¸­ç‡ï¼ˆå‡å°‘ false sharingï¼‰ï¼Œé‰´äºä»¥ä¸‹ä¸‰ç‚¹åŸå› ï¼Œå®ƒä¸èƒ½æ»¡è¶³è¾ƒé«˜çš„å­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡åŠå¿«é€ŸæŸ¥è¯¢ï¼š</p>
<ol>
<li>æ•°æ®æœªè¿›è¡Œå‹ç¼©</li>
<li>ç”±äºå•ä¸ªç£ç›˜é¡µå­˜å‚¨çš„æ•°æ®å†…å®¹ä¸å˜ï¼ŒPAX ä¸èƒ½æ¶ˆé™¤æ— ç”¨åˆ—çš„ç£ç›˜è¯» I/O</li>
<li>PAX ä½¿ç”¨ fixed page ä½œä¸ºæ•°æ®è®°å½•ç»„ç»‡çš„åŸºæœ¬å•å…ƒ</li>
</ol>
<p><strong>PAX æ»¡è¶³å¤§æ•°æ®å¤„ç†çš„å››ä¸ªè¦æ±‚ä¸­çš„ 1ã€4</strong></p>
<h3 id="rcfile"><a class="header" href="#rcfile">RCFile</a></h3>
<p>RCFile åœ¨è®¾è®¡ä¸Šå€Ÿç”¨äº† PAX çš„ç†å¿µï¼š<code>First horizontally-partion, then vertically-partion</code>ã€‚å…¶å®ç°åœ¨ HDFS ä¹‹ä¸Šï¼Œè¡¨çš„æ•°æ®å¸ƒå±€ï¼š</p>
<ol>
<li>ä¸€ä¸ªè¡¨æœ‰å¤šä¸ª HDFS blocks</li>
<li>åœ¨æ¯ä¸ª HDFS block ä¸­ï¼ŒæŒ‰ç…§ row group ä¸ºåŸºæœ¬å•å…ƒå¯¹è®°å½•è¿›è¡Œç»„ç»‡ï¼Œæ ¹æ® row group size å’Œ HDFS block sizeï¼Œä¸€ä¸ª HDFS block å¯ä»¥å¯¹åº”ä¸€ä¸ªæˆ–å¤šä¸ª row group</li>
<li>æ¯ä¸ª row group åŒ…å«ä¸‰ä¸ªåˆ†åŒº: sync markerã€metadata headerã€table data</li>
</ol>
<p><img src="datalayout/../assets/images/rcfile_rcfile.jpg" alt="An example to demonstrate the data layout of RCFile in an HDFS block" /></p>
<p>RCFile ä½¿ç”¨ Run Length Encoding å¯¹ metadata header è¿›è¡Œå‹ç¼©ï¼Œtable data çš„æ•°æ®å„åˆ—æ•°æ®ä½¿ç”¨ Gzip è¿›è¡Œç‹¬ç«‹å‹ç¼©ï¼ˆA future work: æ ¹æ®ä¸åŒç±»å‹è‡ªåŠ¨é€‰æ‹©æœ€ä½³çš„å‹ç¼©ç®—æ³•ï¼‰ã€‚</p>
<p>RCFile æ•°æ®è¿½åŠ å†™çš„æ–¹å¼æ€»ç»“å¦‚ä¸‹ï¼š</p>
<blockquote>
<ol>
<li>
<p>RCFile creates and maintains an in-memory column holder for each column. When a record is appended,
all its fields will be scattered, and each field will be appended into its corresponding column holder. In
addition, RCFile will record corresponding metadata of each field in the metadata header.</p>
</li>
<li>
<p>RCFile provides two parameters to control how many records can be buffered in memory before they are
flushed into the disk. One parameter is the limit of the number of records, and the other parameter is the limit
of the size of the memory buffer.</p>
</li>
<li>
<p>RCFile first compresses the metadata header and stores it in the disk. Then it compresses each column holder
separately, and flushes compressed column holders into one row group in the underlying file system.</p>
</li>
</ol>
</blockquote>
<p>RCFile å¯ä»¥æ ¹æ®æŸ¥è¯¢è¯­å¥çš„éœ€è¦åªè¯»å– row group ä¸­æ‰€éœ€è¦çš„åˆ—ã€‚å‡è®¾ tbl æœ‰å››åˆ—æ•°æ®ï¼ˆc1, c2, c3, c4ï¼‰ï¼Œå¦‚ä¸‹è¯­å¥åªéœ€è¯»å–å¹¶è§£å‹ c1 å’Œ c4 åˆ—</p>
<pre><code class="language-sql">select c1 from tbl where c4 = 1
</code></pre>
<p>å½“ä¸€ä¸ª row group ä¸­æ²¡æœ‰æ»¡è¶³ c4 = 1 çš„è®°å½•æ—¶ï¼Œç”šè‡³ä¸éœ€è¦è¯»å– c1 åˆ—ï¼Œè¿™è¢«ç§°ä¸º <code>Lazy Decompression</code>ã€‚row group size çš„å¤§å°ä¹Ÿä¼šå½±å“ Lazy Decompression çš„æœ‰æ•ˆæ€§ï¼Œå› ä¸ºå½“ row group size æ¯”è¾ƒå¤§æ—¶ï¼Œå‘½ä¸­æ»¡è¶³æ¡ä»¶çš„è¡Œçš„å‡ ç‡ä¼šæ›´å¤§ï¼Œä»è€Œä½¿å¾— Lazy Decompression æ›´å®¹æ˜“å¤±æ•ˆã€‚</p>
<p>row group sizeã€å‹ç¼©ç‡ã€Lazy Decompression ä¹‹é—´çš„å…³ç³»å­˜åœ¨ trade offï¼Œæ–‡ä¸­ä½¿ç”¨æ•°æ®è¿›è¡Œäº†ä½è¯ã€‚</p>
<p><strong>RCFile æ»¡è¶³å¤§æ•°æ®å¤„ç†çš„å››ä¸ªè¦æ±‚ä¸­çš„ 1ã€2ã€3ã€4</strong></p>
<h4 id="more-readings-2"><a class="header" href="#more-readings-2">More Readings:</a></h4>
<p>[1] <a href="https://www.youtube.com/watch?v=1rOSia_r8hI">RCFile vs. ORC</a> from Hadoop In Real World</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatalayoutassetspdfsmajor_technical_advancements_in_apache_hivepdfmajor-technical-advancements-in-apache-hivea"><a class="header" href="#a-hrefdatalayoutassetspdfsmajor_technical_advancements_in_apache_hivepdfmajor-technical-advancements-in-apache-hivea"><a href="datalayout/../assets/pdfs/Major_Technical_Advancements_in_Apache_Hive.pdf">Major Technical Advancements in Apache Hive</a></a></h3>
<blockquote>
<p>SIGMOD 2014</p>
<p>https://dl.acm.org/doi/10.1145/2588555.2595630</p>
</blockquote>
<p>Apache Hive æ˜¯ Hadoop ç”Ÿæ€è¢«å¹¿æ³›ä½¿ç”¨çš„æ•°ä»“ç³»ç»Ÿï¼Œéšç€ç”¨é‡çš„å¢å¤§å¢å¤šï¼Œå‡ºç°äº†ä¸€äº›çŸ­æ¿ï¼Œä¸»è¦ä½“ç°åœ¨ <code>file formats</code>ã€<code>query planning</code> åŠ <code>query execution</code> ä¸‰ä¸ªæ–¹é¢ã€‚Hive éœ€è¦æ›´å¥½çš„æ–‡ä»¶æ ¼å¼æ¥å……åˆ†åˆ©ç”¨å­˜å‚¨ç©ºé—´å¹¶åŠ é€Ÿæ•°æ®è®¿é—®ï¼›æ›´å¥½çš„æŸ¥è¯¢ä¼˜åŒ–å™¨åŠæ‰§è¡Œå™¨æ¥æé«˜èµ„æºåˆ©ç”¨ç‡åŠæ‰§è¡Œæ€§èƒ½ã€‚</p>
<p>æœ¬ç¯‡ç¬”è®°ä¸»è¦å…³æ³¨è®ºæ–‡ä¸­çš„ <code>file formats</code>ï¼Œä¹Ÿå°±æ˜¯ ORC(Optimized Record Columnar) ç›¸å…³çš„å†…å®¹ã€‚</p>
<p>Hive æœ€åˆä½¿ç”¨ä¸¤ç§ç®€å•çš„æ–‡ä»¶æ ¼å¼ï¼šTextFile(plain text data) å’Œ SequenceFile(binary key/value pairs)ï¼Œç”±äºè¿™ä¸¤ç§å­˜å‚¨å¯¹å­˜å‚¨æ•°æ®ç±»å‹ä¸å¯çŸ¥ï¼ˆdata-type-agnosticï¼‰ä¸”æ•°æ®ä»¥ one-row-at-a-time çš„æ–¹å¼è¿›è¡Œå­˜å‚¨ï¼Œæ•°æ®å¾ˆéš¾è¢«æœ‰æ•ˆå‹ç¼©ã€‚Hive 0.4 å¼•å…¥çš„ <a href="datalayout/./rcfile.html">RCFile</a> åˆ—å­˜æ ¼å¼åœ¨å­˜å‚¨æ•ˆç‡ä¸Šæœ‰æ‰€æå‡ï¼Œä½†å…¶ä»ç„¶å¯¹æ•°æ®ç±»å‹ä¸å¯çŸ¥ä¸”é€è¡Œè¿›è¡Œåºåˆ—åŒ–ï¼Œåœ¨è¿™ç§æ ¼å¼ä¸‹ï¼Œdata-type specific compression æœªèƒ½è¢«æœ‰æ•ˆåˆ©ç”¨ã€‚å¦å¤–ï¼ŒRCFile ä¸»è¦ä¸º <code>sequential data scan</code> è€Œè®¾è®¡ï¼Œå®ƒå¹¶æœªæä¾›ä»»ä½•ç´¢å¼•æ¥å¸®åŠ©æŸ¥è¯¢è·³è¿‡æ— ç”¨æ•°æ®ã€‚æ–‡ä¸­è®¤ä¸º Hive <code>file formats</code> çš„ä¸¤ä¸ªä¸è¶³ï¼š</p>
<ul>
<li>data-type-agnostic file formats and one-row-at-a-time serialization prevent data values being efficiently compressed</li>
<li>data reading efficiency is limited by the lack of indexes and non-decomposed columns with complex data types</li>
</ul>
<h3 id="file-format"><a class="header" href="#file-format">File Format</a></h3>
<p>ä¸ºäº†è§£å†³å­˜å‚¨å’Œæ•°æ®è®¿é—®æ–¹é¢çš„ä¸è¶³ï¼ŒHive è®¾è®¡å¹¶å®ç°äº†ä¸€ä¸ªå¢å¼ºç‰ˆçš„æ–‡ä»¶æ ¼å¼ï¼šOptimized Record Columnar Fileï¼ˆORC Fileï¼‰ã€‚å…¶ 3 ä¸ªä¸»è¦æ”¹è¿›åŒ…æ‹¬:</p>
<ul>
<li>ORC file writer å¯¹æ•°æ®ç±»å‹å¯çŸ¥ï¼Œé€šè¿‡å¢åŠ å„ç§ type-specific æ•°æ®ç¼–ç æ¨¡å¼æ¥æ›´æœ‰æ•ˆåœ°å­˜å‚¨æ•°æ®</li>
<li>å¼•å…¥å„ç§ç´¢å¼•æ¥å¸®åŠ© ORC reader æŸ¥æ‰¾æ‰€éœ€æ•°æ®å¹¶è·³è¿‡æ— ç”¨æ•°æ®ï¼Œä»è€ŒåŠ é€Ÿæ•°æ®è®¿é—®</li>
<li>ç”±äº ORC writer æ•°æ®ç±»å‹å¯çŸ¥ï¼Œå¯ä»¥å°†å¤æ‚ç±»å‹ï¼ˆå¦‚ mapï¼‰è¿›ä¸€æ­¥åˆ†è§£</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼ŒORC è¿˜å…·æœ‰æ›´å¤§çš„é»˜è®¤ stripe size (RCFile ç§°ä¸º row group) å¹¶é€šè¿‡ memory manager ç»„ä»¶æ¥é˜²æ­¢ ORC writer è€—å°½å†…å­˜ã€‚</p>
<p>ORC æ–‡ä»¶çš„ç»“æ„ç¤ºæ„å›¾å¦‚ä¸‹ï¼Œæˆ‘ä»¬å€ŸåŠ©æ­¤å›¾ä» <code>Table Placement Method</code>ã€<code>Indexes</code> å’Œ <code>Compression</code> ä¸‰æ–¹é¢å¯¹ ORC è¿›è¡Œä»‹ç»ã€‚</p>
<p><img src="datalayout/../assets/images/orc_file_structure.jpg" alt="The structure of an ORC file" /></p>
<h4 id="the-table-placement-method"><a class="header" href="#the-table-placement-method">The Table Placement Method</a></h4>
<p>å½“ä¸€ä¸ªè¡¨å­˜å‚¨ä¸º ORC æ–‡ä»¶æ—¶ï¼Œå®ƒé¦–å…ˆè¢«æ°´å¹³åˆ‡åˆ†æˆå¤šä¸ª <code>stripe</code>ï¼Œåœ¨æ¯ä¸ª stripe ä¸­ï¼Œæ•°æ®æŒ‰ç…§ column by column çš„æ–¹å¼å­˜å‚¨ï¼Œè¿™è·Ÿ RCFile ä¿æŒäº†ä¸€è‡´ã€‚åŒä¸€ä¸ª stripe çš„æ‰€æœ‰åˆ—çš„æ•°æ®å­˜å‚¨åœ¨åŒä¸€ä¸ªæ–‡ä»¶ã€‚ä» Table Placement Method çš„è§’åº¦çœ‹ï¼ŒORC ç›¸å¯¹ RCFile æœ‰ä¸‰ä¸ªæ”¹è¿›ï¼š</p>
<ol>
<li>ORC æä¾›çš„é»˜è®¤ stripe size ä¸º 256MBï¼Œè€Œ RCFile é»˜è®¤ä¸º 4MBï¼Œæ›´å¤§çš„ stripe size å…·æœ‰æ›´å¥½çš„è¯»å–æ•ˆç‡</li>
<li>ORC å¯ä»¥å°†å¤æ‚ç±»å‹è¿›ä¸€æ­¥åˆ†è§£æˆ column treeï¼Œå…¶ä¸­é—´èŠ‚ç‚¹å­˜å‚¨ä¸º metadata streamï¼Œå¶èŠ‚ç‚¹å­˜å‚¨ä¸º data stream</li>
<li>ORC ç”¨æˆ·å¯ä»¥é€‰æ‹©å°† stripe çš„è¾¹ç•Œä¸ HDFS block çš„è¾¹ç•Œå¯¹é½ï¼Œä»¥é¿å…å°†ä¸€ä¸ª stripe å­˜å‚¨åœ¨ä¸¤ä¸ª HDFS block</li>
</ol>
<p>æˆ‘ä½œä¸ºè¯»è€…çš„ä¸€äº›ç–‘æƒ‘åŠè§£ç­”:</p>
<ol>
<li>RCFile é€‰æ‹© 4MB æ˜¯ç”±äº Lazy Decompressionï¼Œæœ¬æ–‡è®¤ä¸ºä½†åœ¨ Hive ä¸­ï¼ŒLazy Decompression å‡æ…¢äº† execution pilelineï¼Œè¿™åœ¨åæ–‡çš„ Qeury Execution ä¸€èŠ‚ä¸­æåˆ°</li>
<li>å¯¹åˆ†è§£ä¹‹åçš„å¤æ‚ç±»å‹å¦‚ä½•é‡æ„ä¸ºä¸€è¡Œæ²¡æœ‰è¿›è¡Œè¯´æ˜ï¼Œè¿™å¯èƒ½éœ€è¦å…·ä½“é˜…è¯»ç›¸å…³æºä»£ç </li>
</ol>
<h4 id="indexes"><a class="header" href="#indexes">Indexes</a></h4>
<p>ORC File è®¾è®¡äº†ä¸¤ç§ç¨€ç–ç´¢å¼• â€”â€” Data Statics å’Œ Position Pointersã€‚</p>
<p>Data Statics è¢« ORC Reader ç”¨æ¥é¿å…ä» HDFS è¯»å–ä¸å¿…è¦çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®ç”± ORC Writer åœ¨ç”Ÿæˆä¸€ä¸ª ORF file æ—¶åˆ›å»ºï¼Œé€šå¸¸åŒ…æ‹¬ min/max/sumã€length ç­‰æ•°æ®ã€‚Data Statics åœ¨ ORC File ä¸­åˆ†ä¸ºä¸‰çº§ï¼š</p>
<ul>
<li>File Level: è¯¥çº§åˆ«çš„æ•°æ®è®°å½•åœ¨æ–‡ä»¶ç»“å°¾ï¼Œé€šå¸¸ç”¨äºæŸ¥è¯¢ä¼˜åŒ–åŠå›ç­”ç®€å•çš„èšåˆæŸ¥è¯¢</li>
<li>Stripe Level: å¯¹ Stripe ä¸­çš„æ¯ä¸€åˆ—å€¼éƒ½å­˜å‚¨äº†ç›¸åº”çš„æ•°æ®ï¼Œå¯ä»¥ç”¨æ¥è·³è¿‡éå¿…è¦çš„æ•°æ®è®¿é—®</li>
<li>Index group Level: stripe ä¸­çš„æ¯ä¸€åˆ—å¯ä»¥ç»„æˆå¤šä¸ª index groupï¼Œé»˜è®¤æ¯ 10,000 è¡Œæ•°æ®æ„æˆä¸€ä¸ª index groupï¼ŒORC æä¾›äº† index group çº§åˆ«çš„ data staticsï¼Œä»è€Œå¯ä»¥æ›´ç»†ç²’åº¦çš„è·³è¿‡ä¸éœ€è¦çš„æ•°æ®ã€‚</li>
</ul>
<p>Position Pointers ä¸º ORC Reader æœ‰æ•ˆè¯»å–æ•°æ®æä¾›äº†ä¸¤ç§æ•°æ®ä½ç½®æŒ‡é’ˆ:</p>
<ol>
<li>start points of every index group in metadata streams and datastreams</li>
<li>starting point of a stripe</li>
</ol>
<h4 id="compression"><a class="header" href="#compression">Compression</a></h4>
<p>ORC ä½¿ç”¨äº†ä¸¤çº§å‹ç¼©æ¨¡å¼ï¼Œä¸€ä¸ªæµé¦–å…ˆæ ¹æ®å…¶æ•°æ®ç±»å‹è¿›è¡Œç¼–ç ï¼Œç„¶åå†ä½¿ç”¨é€šç”¨å‹ç¼©ç®—æ³•è¿›è¡Œå‹ç¼©ï¼ˆç¬¬äºŒæ­¥å¯é€‰ï¼‰ã€‚å¯¹äºä¸€åˆ—æ•°æ®ï¼Œå®ƒå¯ä»¥è¢«å­˜å‚¨åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªï¼ˆå¤æ‚ç±»å‹ï¼‰æµï¼Œæµåˆ†ä¸ºå››ç§ç±»å‹ï¼š</p>
<ul>
<li>Byte Stream</li>
<li>Run Length Byte Stream</li>
<li>Integer Stream</li>
<li>Bit Field Stream</li>
</ul>
<p>ä¸åŒç±»å‹çš„æ•°æ®å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç¼–ç æ–¹å¼ï¼Œæ–‡ä¸­åªä»‹ç»äº† Int ç±»å‹å’Œ String ç±»å‹å¦‚ä½•å°†ç¼–ç å¯¹åº”åˆ°ä¸Šé¢çš„å››ç§ç±»å‹ï¼Œæ›´è¯¦ç»†çš„å®ç°éœ€å‚è€ƒ Hive æºç ã€‚åœ¨å¦‚ä¸Šç¼–ç ä¹‹åï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ä½¿ç”¨é€šç”¨å‹ç¼©ç®—æ³•å¦‚ ZLIBï¼ŒSnappy æˆ– LZO å¯¹æµè¿›è¡Œè¿›ä¸€æ­¥å‹ç¼©ã€‚</p>
<h4 id="more-readings-3"><a class="header" href="#more-readings-3">More Readings:</a></h4>
<p>[1] <a href="https://issues.apache.org/jira/browse/HIVE-3874">Create a new Optimized Row Columnar file format for Hive</a><br>
[2] <a href="datalayout/../assets/ppts/OrcFileIntro.pptx">ORC File Intro</a><br>
[3] <a href="https://orc.apache.org/specification/ORCv2/">Evolving Draft for ORC Specification v2</a><br>
[4] <a href="https://github.com/apache/orc/blob/main/proto/orc_proto.proto">ORC proto</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatalayoutassetspdfsp1750-huaipdfunderstanding-insights-into-the-basic-structure-and-essential-issues-of-table-placement-methods-in-clustersa"><a class="header" href="#a-hrefdatalayoutassetspdfsp1750-huaipdfunderstanding-insights-into-the-basic-structure-and-essential-issues-of-table-placement-methods-in-clustersa"><a href="datalayout/../assets/pdfs/p1750-huai.pdf">Understanding Insights into the Basic Structure and Essential Issues of Table Placement Methods in Clusters</a></a></h3>
<blockquote>
<p>Proceedings of the VLDB Endowment, September 2013</p>
<p>https://dl.acm.org/doi/10.14778/2556549.2556559</p>
</blockquote>
<p>åŸºäº Hadoop ç”Ÿæ€çš„å¤šç§è¡¨æ”¾ç½®æ–¹æ³•ï¼ˆtable placement methodsï¼‰è¢«æå‡ºå¹¶å®ç°ï¼ŒCFileã€Column Formatã€RCFileã€ORCã€Parquetã€Segment-Level Column Group Store(SLC-Store)ã€Treviniã€Trojan Data Layouts(TDL) ç­‰é¡¹ç›®éƒ½æ˜¯ç‹¬ç«‹å®Œæˆï¼Œä¸”ç¼ºå°‘å¯¹å®ƒä»¬å…¨é¢ç³»ç»Ÿæ€§çš„ç ”ç©¶ã€‚</p>
<p>ä¸‰ä¸ªæœªè§£å†³çš„å…³é”®é—®é¢˜:</p>
<ol>
<li>The basic structure of a table placement method has not been defined. This structure should abstract the core operations to organize and to store data values of a table in the underlying cluster. It also serves as a foundation to design and implement a table placement method.</li>
<li>A fair comparison among different table placement methods is almost impossible due to heavy influences of diverse system implementations, various auxiliary data and optimization techniques, and different workload configurations.</li>
<li>There is no general guideline on how to adjust table placement methods to achieve optimized I/O read performance.</li>
</ol>
<p>æœ¬æ–‡çš„ä¸‰ä¸ªä¸»è¦è´¡çŒ®:</p>
<ol>
<li>å®šä¹‰äº† table placement method çš„åŸºæœ¬ç»“æ„ï¼ˆbasic structureï¼‰ï¼Œç”¨äºæŒ‡å¯¼ table placement method çš„è®¾è®¡ã€æŠ½è±¡å·²æœ‰ table placement method çš„å®ç°ã€è¡¨å¾ç°æœ‰ table placement method ä¹‹é—´çš„å·®å¼‚</li>
<li>è®¾è®¡å¹¶å®ç°äº†ä¸€ä¸ªåŸºå‡†æµ‹è¯•å·¥å…·ï¼ˆmicro-benchmarksï¼‰æ¥ç ”ç©¶ä¸åŒ table placement method çš„è®¾è®¡è¦ç´ </li>
<li>å…¨é¢ç ”ç©¶äº† table placement method ç›¸å…³çš„æ•°æ®è¯»å–é—®é¢˜ï¼Œå¹¶æä¾›äº†å¦‚ä½•é€šè¿‡è°ƒæ•´ table placement method æ¥è¾¾åˆ°ä¼˜åŒ– I/O è¯»å–çš„æŒ‡å—</li>
</ol>
<p>ä¸€ä¸ª table placement method çš„åŸºæœ¬ç»“æ„åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†:</p>
<pre><code class="language-txt">1. a row reordering procedure       fRR
2. a table partitioning procedure   fTP
3. a data packing procedure         fDP
</code></pre>
<h4 id="micro-benchmark"><a class="header" href="#micro-benchmark">MICRO-BENCHMARK</a></h4>
<p>ä»è¡¨ä¸­è¯»å–æ•°æ®å½±å“ I/O æ€§èƒ½çš„ 6 ä¸ªå› ç´ :</p>
<ol>
<li>Table organizations</li>
<li>Table placement methods</li>
<li>Storage device type</li>
<li>Access patterns of the application</li>
<li>Processing operations of the filesystem at the application level</li>
<li>Processing operations of the filesystem inside the local OS</li>
</ol>
<p>æ–‡ç« è®¾è®¡çš„å®éªŒä¸»è¦å…³æ³¨ä»¥ä¸Šå› ç´  2ã€3ã€4ï¼Œé€šè¿‡å®éªŒç»™å‡ºäº†ä»¥ä¸‹å»ºè®®:</p>
<ol>
<li>using a sufficiently large row group size</li>
<li>if a sufficiently large row group size is used and columns in a row group can be accessed in a column-oriented way, it is not necessary to group multiple columns to a column group</li>
<li>if a sufficiently large row group size is used, it is not necessary to pack column groups (or columns) intomultiple physical blocks.</li>
</ol>
<h4 id="macro-benchmark"><a class="header" href="#macro-benchmark">MACRO-BENCHMARK</a></h4>
<p>è¿™éƒ¨åˆ†è¯„ä¼°äº†ä» Star Schema Benchmarkã€TPC-H å’Œ SS-DB é€‰å–çš„æŸ¥è¯¢ã€‚</p>
<p>Row Group Size å¯¹æ€§èƒ½çš„å½±å“:</p>
<ol>
<li>From 4 MiB row group size to 64 MiB row group size, the elapsed times of the Map phase decrease significantly.</li>
<li>when further increase the row group size from 64 MiB to 128 MiB, the change on the elapsed times of the Map phase is not significant.</li>
</ol>
<p>Grouping Columns å¯¹æ€§èƒ½çš„å½±å“:</p>
<ol>
<li>When the row group size is small, grouping columns can provide benefits in two aspects:
<ul>
<li>because needed columns are stored together, a buffer read operation can load a less amount of unnecessary data from disks</li>
<li>a less number of disk seeks is needed to read needed columns</li>
</ul>
</li>
<li>when the row group size is large enough, grouping columns cannot provide significant performance benefits</li>
</ol>
<p>è®ºæ–‡ä¸­å¾—å‡ºæ¥çš„å¦ä¸€ä¸ªç»“è®ºè·Ÿå¹¶å‘ç›¸å…³ï¼š</p>
<blockquote>
<p>An optimal row group size is determined by a balanced trade-off between
the data reading efficiency and the degree of parallelism.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h2 id="data-structures"><a class="header" href="#data-structures">data structures</a></h2>
<ul>
<li><strong><a href="datastructure/btreefamily/index.html">B-Tree family</a></strong>
<ul>
<li><strong><a href="datastructure/btreefamily/bw-tree.html">The Bw-Tree: A B-tree for New Hardware Platforms</a></strong></li>
</ul>
</li>
<li><strong><a href="datastructure/hash/index.html">Hash Table</a></strong>
<ul>
<li><strong><a href="datastructure/hash/linear-hashing.html">Linear Hashing</a></strong></li>
</ul>
</li>
<li><strong><a href="datastructure/triefamily/index.html">Trie family</a></strong>
<ul>
<li><strong><a href="datastructure/triefamily/art.html">The Adaptive Radix Tree: ARTful Indexing for Main-Memory Databases</a></strong></li>
<li><strong><a href="datastructure/triefamily/hot.html">HOT: A Height Optimized Trie Index for Main-Memory Database Systems</a></strong></li>
</ul>
</li>
<li><strong><a href="datastructure/bitmap/index.htmp">Bitmaps</a></strong>
<ul>
<li><strong><a href="datastructure/bitmap/roaring.html">Better bitmap performance with Roaring bitmaps</a></strong></li>
</ul>
</li>
<li><strong><a href="datastructure/skiplist.html">Skip lists: a probabilistic alternative to balanced trees</a></strong></li>
<li><strong><a href="datastructure/bloom-filter.html">Space/time trade-offs in hash coding with allowable errors</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="b-tree-family"><a class="header" href="#b-tree-family">B-Tree family</a></h2>
<p><a href="https://infolab.usc.edu/csci585/Spring2010/den_ar/indexing.pdf">B-tree</a> æ˜¯ç”± Rudolf Bayer å’Œ Edward M. McCreight åœ¨ 1970 å¹´å‘æ˜çš„ã€é€‚ç”¨äºè¯»å–è¾ƒå¤§æ•°æ®å—ï¼ˆå¦‚ diskï¼‰çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œä½œä¸ºç´¢å¼•ï¼ˆindexï¼‰å±‚å¹¿æ³›åº”ç”¨äºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿã€‚å½“æ’å…¥æˆ–åˆ é™¤è®°å½•äº§ç”Ÿ underflow(due to deletion) æˆ– overflow(due to insertion) æ—¶ï¼ŒB-tree é€šè¿‡åˆ†è£‚æˆ–åˆå¹¶èŠ‚ç‚¹çš„æ–¹å¼ä¿æŒæ ‘çš„å¹³è¡¡ã€‚åœ¨ <a href="https://www.cs.usfca.edu/%7Egalles/visualization/BTree.html">B-Tree Visualization</a> å¯ä»¥ç›´è§‚æ„Ÿå—ä¸€ä¸‹ B-tree çš„ç»“æ„åŠç®—æ³•ã€‚</p>
<ul>
<li><strong><a href="datastructure/btreefamily/bw-tree.html">The Bw-Tree: A B-tree for New Hardware Platforms</a></strong></li>
</ul>
<h4 id="optional-readings-3"><a class="header" href="#optional-readings-3">Optional readings</a></h4>
<ul>
<li><a href="datastructure/btreefamily/../../assets/pdfs/open_bwtree.pdf">Building a Bw-Tree Takes More Than Just BuzzWords</a></li>
<li><a href="datastructure/btreefamily/../../assets/pdfs/masstree_eurosys12.pdf">Cache Craftiness for Fast Multicore Key-Value Storage</a> a.k.a Masstree</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatastructurebtreefamilyassetspdfsbwtree-icde2013pdfthe-bw-tree-a-b-tree-for-new-hardware-platformsa"><a class="header" href="#a-hrefdatastructurebtreefamilyassetspdfsbwtree-icde2013pdfthe-bw-tree-a-b-tree-for-new-hardware-platformsa"><a href="datastructure/btreefamily/../../assets/pdfs/bwtree-icde2013.pdf">The Bw-Tree: A B-tree for New Hardware Platforms</a></a></h3>
<blockquote>
<p>ICDE 2013</p>
<p>https://ieeexplore.ieee.org/document/6544834</p>
</blockquote>
<p>æ•°æ®åº“ç³»ç»Ÿå¤§å¤šè¿˜åœ¨ä½¿ç”¨ 70 å¹´ä»£é’ˆå¯¹ç¡¬ç›˜å’Œå•æ ¸ CPU è®¾è®¡çš„æ¶æ„ï¼Œç„¶è€Œæ–°çš„ç¡¬ä»¶å¹³å°å¤§å¤šä½¿ç”¨äº† multi-core cpu å’Œ ssd å­˜å‚¨è®¾å¤‡ï¼Œå¦‚ä½•æ¦¨å–æ–°ç¡¬ä»¶å¹³å°çš„æè‡´æ€§èƒ½æ˜¯ä¸€ä¸ªé‡è¦çš„ç ”ç©¶è¯é¢˜ã€‚Bw-tree å°±æ˜¯è¿™æ ·ä¸€ç§ä¸ºæ–°ç¡¬ä»¶å¹³å°è®¾è®¡çš„ç´¢å¼•ç»“æ„ã€‚</p>
<h4 id="architecture"><a class="header" href="#architecture">Architecture</a></h4>
<p><img src="datastructure/btreefamily/../../assets/images/bw-tree-architecture.jpg" alt="bw-tree architecture" /></p>
<p>Bw-tree åœ¨å¾ˆå¤šæ–¹é¢éƒ½ä¸ç»å…¸çš„ B+ tree éå¸¸ç›¸ä¼¼ï¼Œå®ƒæä¾› O(logn) çš„ç‚¹æŸ¥åŠçº¿æ€§çš„èŒƒå›´æŸ¥è¯¢ï¼Œä¸Šå›¾ä¸­çš„ <em>Bw-tree Layer</em> æä¾›äº†å¢åˆ æ”¹æŸ¥çš„æ¥å£ï¼ŒåŒæ—¶ä¸ä¸­é—´çš„ <em>Cache Layer</em> è¿›è¡Œäº¤äº’ã€‚</p>
<p><em>Cache Layer</em> ä½œä¸ºå†…å­˜æ•°æ®åº“çš„ç¼“å­˜ï¼Œä¸ä¸‹å±‚çš„ LSS (Log-structured store) è¿›è¡Œæ•°æ®äº¤æ¢ä»¥ä¿è¯ç³»ç»Ÿçš„ä¸€è‡´æ€§çš„åŒæ—¶ï¼Œè¿˜ç»´æŠ¤äº†ä¸€ä¸ª Bw-tree ç‰¹æœ‰çš„ <em>Mapping Table</em> ç»“æ„æ¥å°†é€»è¾‘é¡µå·ï¼ˆLogic Page Id, PIDï¼‰æ˜ å°„åˆ°å…·ä½“çš„ç‰©ç†å†…å­˜åœ°å€æˆ– SSD åç§»ã€‚</p>
<blockquote>
<p>The mapping table severs the connection between physical
location and inter-node links. This enables the physical location
of a Bw-tree node to change on every update and every
time a page is written to stable storage, without requiring that
the location change be propagated to the root of the tree.</p>
</blockquote>
<h4 id="in-memory-latch-free-pages"><a class="header" href="#in-memory-latch-free-pages">In-Memory Latch Free Pages</a></h4>
<p>Bw-tree çš„èŠ‚ç‚¹ä¸­å­˜å‚¨çš„ä¿¡æ¯ä¸ B+ tree å¾ˆç›¸ä¼¼ï¼Œéå¶å­èŠ‚ç‚¹å­˜å‚¨äº†ï¼ˆseperator key, pointerï¼‰ï¼Œå¶èŠ‚ç‚¹åˆ™å­˜å‚¨äº†ï¼ˆkey, recordï¼‰ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œé¡µé¢è¿˜å­˜å‚¨äº† 1) <strong>low key</strong> 2) <strong>high key</strong> 3) æŒ‡å‘å³å…„å¼Ÿçš„ <strong>side link key</strong>ã€‚</p>
<p>Bw-tree ä¸åŒäº B+ tree çš„è®¾è®¡åœ¨äº:</p>
<ol>
<li>é¡µé¢ä¸­å­˜å‚¨çš„ pointer æ˜¯é€»è¾‘é¡µé¢ï¼ˆPIDï¼‰ï¼Œé€šè¿‡ mapping table è¿›è¡Œè½¬æ¢ï¼Œä¸”é¡µé¢å¤§å°ä¸å›ºå®š</li>
<li>é¡µé¢ä¸å…è®¸ in-place updateï¼Œéœ€é€šè¿‡å°† <strong>delta record</strong> prepend åˆ°é¡µé¢æ¥è¿›è¡Œä¿®æ”¹</li>
</ol>
<p><img src="datastructure/btreefamily/../../assets/images/bw-tree-in-memory-pages.jpg" alt="in memory pages" /></p>
<p>ä¸€ä¸ªæ›´æ–°æ“ä½œé¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ª delta recordï¼Œè¯¥è®°å½•æŒ‡å‘è¯¥é¡µé¢çš„å½“å‰åœ°å€ï¼Œç„¶åé€šè¿‡ CAS æ“ä½œå°† mapping table çš„ç‰©ç†åœ°å€ä¿®æ”¹ä¸º delta record çš„åœ°å€ï¼ŒCAS èƒ½ä½¿å¾—åªæœ‰ä¸€ä¸ªæ›´æ–°æ“ä½œæˆåŠŸã€‚åœ¨å¤šæ¬¡æ›´æ–°æ“ä½œä¹‹åï¼Œä¸€ä¸ªç‰©ç†é¡µé¢ç”±ä¸€ä¸ª <strong>base page</strong> å’Œä¸€æ¡ <strong>delta chain</strong> æ„æˆã€‚delta chain è¿‡é•¿ä¼šå½±å“æŸ¥è¯¢æ€§èƒ½ï¼Œå› æ­¤éœ€è¦åœ¨è¾¾åˆ°ä¸€å®šé˜ˆå€¼ä¹‹åè¿›è¡Œ <strong>consolidation</strong>ï¼Œå³åˆ›å»ºä¸€ä¸ª <code>re-organized</code> çš„ base page å¹¶é€šè¿‡ CAS å°† mapping table ä¸­çš„æŒ‡é’ˆæ”¹ä¸ºæ–° base page çš„åœ°å€ã€‚</p>
<h4 id="structure-modifications"><a class="header" href="#structure-modifications">Structure Modifications</a></h4>
<p>é€š B+ tree ä¸€æ ·ï¼Œå½“é¡µé¢å¤§äºæˆ–å°äºä¸€å®šé˜ˆå€¼æ—¶ï¼ŒBw-tree ä¹Ÿéœ€è¦å¯¹èŠ‚ç‚¹è¿›è¡Œ split æˆ– merge æ“ä½œã€‚Bw-tree çš„ Split å’Œ Merge æ“ä½œåŒæ ·ä½¿ç”¨äº† CAS æ“ä½œã€‚</p>
<p><code>Node Split</code> åˆ†ä¸º <strong>Child Split</strong> å’Œ <strong>Parent Update</strong> ä¸¤æ­¥ï¼Œ<code>Node Merge</code> åˆ†ä¸º <strong>Marking for Delete</strong>ã€<strong>Merging Children</strong> åŠ <strong>Parent Update</strong> ä¸‰æ­¥ï¼Œå…¶å›¾ç¤ºå¦‚ä¸‹ï¼Œå…·ä½“æè¿°è®ºæ–‡é‡Œå¾ˆæ¸…æ¥šï¼Œè¿™é‡Œä¸å†æè¿°ã€‚</p>
<p><strong>Node Split</strong></p>
<p><img src="datastructure/btreefamily/../../assets/images/bw-tree-node-split.jpg" alt="Node Split" /></p>
<p><strong>Node Merge</strong></p>
<p><img src="datastructure/btreefamily/../../assets/images/bw-tree-node-merge.jpg" alt="Node Merge" /></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="hash-table"><a class="header" href="#hash-table">Hash Table</a></h2>
<ul>
<li><strong><a href="datastructure/hash/linear-hashing.html">Linear Hashing</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatastructurehashassetspdfsdynamic_hash_tablespdfdynamic-hash-tablesa"><a class="header" href="#a-hrefdatastructurehashassetspdfsdynamic_hash_tablespdfdynamic-hash-tablesa"><a href="datastructure/hash/../../assets/pdfs/dynamic_hash_tables.pdf">Dynamic hash tables</a></a></h3>
<blockquote>
<p>Communications of the ACM, April 1988</p>
<p>https://dl.acm.org/doi/10.1145/42404.42410</p>
</blockquote>
<p>æœ¬æ–‡ä»‹ç»äº†ä¸¤ç§åŠ¨æ€å“ˆå¸Œæ¨¡å¼ï¼šLinear Hashing å’Œ Spiral Storageã€‚</p>
<h4 id="linear-hashing"><a class="header" href="#linear-hashing">Linear Hashing</a></h4>
<p>åœ¨ load factor è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œåªå¯¹ä¸€ä¸ª bucket è¿›è¡Œåˆ†è£‚ï¼Œä»¥å‡å°‘ rehashing çš„æ—¶é—´ã€‚</p>
<p><img src="datastructure/hash/../../assets/images/dynamic_hash_tables_linear_hashing.jpg" alt="linear hashing" /></p>
<p>å“ˆå¸Œè¡¨ç»´æŠ¤ä¸¤ä¸ªå˜é‡æ¥ä»£è¡¨å…¶å½“å‰çŠ¶æ€ï¼š</p>
<ul>
<li>L: å“ˆå¸Œè¡¨ bucket æ•°ç›®ç¿»å€çš„æ¬¡æ•°ï¼ˆL &gt;= 0ï¼‰</li>
<li>p: æŒ‡å‘ä¸‹ä¸€ä¸ªè¦åˆ†ç¦» bucket ï¼ˆ0 &lt;= p &lt;= N x 2^Lï¼Œå…¶ä¸­ N æ˜¯å“ˆå¸Œè¡¨åˆå§‹ bucket ä¸ªæ•°ï¼‰</li>
</ul>
<p>ç”¨æ¥ç¡®å®šä¸€ä¸ªé”® K æ‰€åœ¨ bucket ä½ç½®çš„å“ˆå¸Œå‡½æ•°ä¸ºï¼š</p>
<blockquote>
<p>hj(K) = g(K) mod(N x 2^j),  j=0,1,...</p>
</blockquote>
<p>å…¶ä¸­ g(K) å¯ä»¥ä¸ºä»»æ„å¯ä»¥æ‰“æ•£æ•°æ®çš„å“ˆå¸Œå‡½æ•°ã€‚ä¸€ä¸ªä¾‹å­ï¼š</p>
<p><img src="datastructure/hash/../../assets/images/dynamic_hash_tables_linear_hashing_splitting.jpg" alt="splitting example" /></p>
<p>ä¸Šå›¾çš„ hash table æ‰©å±•ä¹‹å‰çš„çŠ¶æ€ä¸º L=0, p=0ï¼Œä½¿ç”¨ hL+1(K) å°† p æŒ‡å‘çš„ bucket è¿›è¡Œåˆ†è£‚ï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹å…¬å¼æ›´æ–° L å’Œ p å€¼ï¼š</p>
<pre><code class="language-txt">p := p + 1;
if p = N x 2^L then begin
    L := L + 1;
    p := 0;
end;
</code></pre>
<p>åœ¨æŸ¥æ‰¾ä¸€ä¸ª K æ—¶ï¼Œå®šä½å…¶æ‰€åœ¨ bucket ä½¿ç”¨çš„å…¬å¼ä¸ºï¼š</p>
<pre><code class="language-txt">addr := hL(K);
if addr &lt; p then addr := hL+1(K);
</code></pre>
<h4 id="spiral-storage"><a class="header" href="#spiral-storage">Spiral storage</a></h4>
<p>æ²¡è¯¦ç»†çœ‹ã€‚</p>
<p>è®ºæ–‡çš„å®éªŒç»“è®º:</p>
<blockquote>
<p>For applications where the cardinality of the key set is known in
advance, the best performance is obtained by a traditional
fixed-size hash table. For applications where the cardinality
of the key set is not known in advance,
linear hashing gives the best overall performance.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h2 id="trie"><a class="header" href="#trie">Trie</a></h2>
<p>å‰ç¼€æ ‘æˆ–å­—å…¸æ ‘ï¼Œæ˜¯ä¸€ç§æœ‰åºæ ‘ï¼Œå…¶å‘æ˜è€… Edward Fredkin æŠŠå®ƒè¯»ä½œ/ËˆtriË/ &quot;tree&quot;ï¼Œä½†æ›´å¤šäººæŠŠå®ƒè¯»ä½œ/ËˆtraÉª/ &quot;try&quot;ã€‚æœ´ç´ çš„ Trie ç”±äºå­˜å‚¨ç¨€ç–ï¼Œå­˜åœ¨ç©ºé—´åˆ©ç”¨ç‡ä½ä¸‹çš„é—®é¢˜ã€‚Radix tree (åˆè¢«ç§°ä¸º radix trieã€å‹ç¼©å‰ç¼€æ ‘ã€compressed trie) å°†ä½œä¸ºå”¯ä¸€å­èŠ‚ç‚¹çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¸å…¶çˆ¶èŠ‚ç‚¹åˆå¹¶ï¼Œæ˜¯ä¸€ç§æ›´èŠ‚çœç©ºé—´çš„å‰ç¼€æ ‘ï¼Œ<a href="https://github.com/antirez/rax">Rax</a> æ˜¯ä¸€ä¸ª Radix tree çš„ C è¯­è¨€å®ç°ã€‚</p>
<ul>
<li><strong><a href="datastructure/triefamily/art.html">The Adaptive Radix Tree: ARTful Indexing for Main-Memory Databases</a></strong></li>
<li><strong><a href="datastructure/triefamily/hot.html">HOT: A Height Optimized Trie Index for Main-Memory Database Systems</a></strong></li>
</ul>
<h4 id="optional-readings-4"><a class="header" href="#optional-readings-4">Optional readings</a></h4>
<ul>
<li>V. Alvarez, et al., <a href="datastructure/triefamily/../../assets/pdfs/comparison-of-art-and-hash-tables-icde2015.pdf">A Comparison of Adaptive Radix Trees and Hash Tables</a>, in ICDE, 2015</li>
<li>Viktor Leis, et al., <a href="datastructure/triefamily/../../assets/pdfs/the-art-of-practical-synchronization-damon2016.pdf">The ART of Practical Synchronization</a>, DaMoN '16. ä»‹ç»äº† ART å®ç°ä¸­ä½¿ç”¨çš„ä¸¤ç§å¤šçº¿ç¨‹åŒæ­¥æŠ€æœ¯ â€” 1) OPTIMISTIC LOCK COUPLING 2) READ-OPTIMIZED WRITE EXCLUSION (ROWEX)</li>
</ul>
<h4 id="references-7"><a class="header" href="#references-7">References</a></h4>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Trie">Trie</a></li>
<li><a href="https://en.wikipedia.org/wiki/Radix_tree">Radix tree</a></li>
<li><a href="https://lwn.net/Articles/175432/">Trees I: Radix trees</a> by J. Corbert, 2006</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatastructuretriefamilyassetspdfsartpdfthe-adaptive-radix-tree-artful-indexing-for-main-memory-databasesa"><a class="header" href="#a-hrefdatastructuretriefamilyassetspdfsartpdfthe-adaptive-radix-tree-artful-indexing-for-main-memory-databasesa"><a href="datastructure/triefamily/../../assets/pdfs/ART.pdf">The Adaptive Radix Tree: ARTful Indexing for Main-Memory Databases</a></a></h3>
<blockquote>
<p>ICDE 2013</p>
<p>https://ieeexplore.ieee.org/document/6544812</p>
</blockquote>
<p>Radix Treeï¼Œåˆå«åš Prefix Tree æˆ– Trieï¼Œé€šå¸¸è¢«ç”¨ä½œå­—ç¬¦ä¸²çš„ç´¢å¼•ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ ‘çš„é«˜åº¦ï¼ˆå’Œå¤æ‚æ€§ï¼‰å–å†³äº key çš„é•¿åº¦ï¼Œè€Œéæ ‘ä¸­å…ƒç´ çš„ä¸ªæ•°</li>
<li>ä¸éœ€è¦å¯¹æ ‘è¿›è¡Œ rebalanceï¼ŒåŒæ ·çš„æ•°æ®é›†ä»¥ä»»ä½•é¡ºåºæ’å…¥éƒ½å¾—åˆ°ä¸€æ ·çš„æ ‘</li>
<li>keys æŒ‰ç…§å­—å…¸é¡ºåºå­˜å‚¨</li>
<li>ä»æ ‘æ ¹åˆ°å¶å­çš„è·¯å¾„éšå¼åœ°ä»£è¡¨äº† keyï¼Œå› æ­¤å¯ä»¥æ ¹æ®è·¯å¾„é‡æ„å‡º key</li>
</ul>
<p>åœ¨å®ç° Trie çš„æ—¶å€™ï¼Œéœ€è¦é€‰æ‹© span å€¼ï¼ˆå³ç”¨å‡ ä¸ª bit å†³å®šå…¶ä¸‹ä¸€çº§å­èŠ‚ç‚¹ä¸ªæ•°ï¼Œåç”¨ s ä»£è¡¨ï¼‰çš„å¤§å°ï¼Œå½“ s è¾ƒå°æ—¶ï¼Œæ ‘é«˜ç›¸å¯¹è¾ƒé«˜ï¼Œä½†ç”±äºä¸å­˜åœ¨ç©ºé—´æµªè´¹ï¼Œå…¶æ¶ˆè€—çš„ç©ºé—´è¾ƒå°ï¼›å½“ s è¾ƒå¤§æ—¶ï¼Œæ ‘é«˜ç›¸å¯¹è¾ƒä½ï¼Œä½†å­˜åœ¨ä¸€äº›èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å¾ˆå°‘ï¼Œé€ æˆç©ºé—´çš„æµªè´¹ï¼Œè¿›è€Œä½¿å¾—ç´¢å¼•çš„å†…å­˜æ¶ˆè€—å¾ˆå¤§ã€‚è¿™æ˜¯ç”±äºä¼ ç»Ÿçš„ Trie åœ¨é€‰å®šäº† span ä¹‹åï¼Œå…¶ fanout å°±å›ºå®šäº†ã€‚</p>
<blockquote>
<p>trie height = âŒˆk/sâŒ‰</p>
<p>fanout = 2^s</p>
</blockquote>
<p><img src="datastructure/triefamily/../../assets/images/art-tree-hight-and-space-consumption.jpg" alt="tree height and space consumption" /></p>
<p>è€Œ ART åˆ™æ˜¯åœ¨é€‰æ‹©äº†è¾ƒé«˜ span å€¼ï¼ˆs = 8ï¼‰çš„å‰æä¸‹ï¼Œæä¾›äº†å››ç§ä¸åŒ fanout çš„èŠ‚ç‚¹ï¼Œè¿™æ ·èƒ½å¤Ÿåœ¨ä¿ç•™ Trie è¾ƒä½æ ‘é«˜çš„å‰æä¸‹èŠ‚çœäº†ç©ºé—´ä½¿ç”¨ï¼Œä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒART çš„æ ‘é«˜ä¸ s=8 çš„å‰ç¼€æ ‘æ ‘é«˜ç›¸åŒï¼Œä½†å…¶å†…å­˜æ¶ˆè€—å´åªç›¸å½“äº s=3 çš„å‰ç¼€æ ‘ã€‚ä¸‹å›¾å±•ç¤ºäº† ART çš„è®¾è®¡æ€æƒ³ï¼š</p>
<p><img src="datastructure/triefamily/../../assets/images/art-illustration.jpg" alt="art illustration" /></p>
<p>ART ä½¿ç”¨äº†å››ç§ Inner Node ç»“æ„å’Œ Leaf Nodesï¼ŒInner Nodes çš„ç»“æ„å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="datastructure/triefamily/../../assets/images/art-inner-nodes-structure.jpg" alt="inner nodes data structure" /></p>
<p>ART è¿˜ä½¿ç”¨äº† lazy expansion å’Œ path compression æ¥è¿›ä¸€æ­¥ç¼©å°å­˜å‚¨ç©ºé—´ï¼š</p>
<p><img src="datastructure/triefamily/../../assets/images/art-lazy-expansion-and-path-compression.jpg" alt="lazy expansion and path compression" /></p>
<p>è®ºæ–‡ä¸­è™½ç„¶æè¿°äº†ç®—æ³•çš„ä¼ªä»£ç ï¼Œä½†éå¸¸æ¨èç»“åˆ <a href="https://github.com/armon/libart">libart</a> ä»£ç ä¸€èµ·çœ‹ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªå€¼å¾—è¯´æ˜çš„ä¸€ç‚¹ï¼Œä¸åŒäºç›´æ¥æ¯”è¾ƒ key çš„æ•°æ®ç»“æ„ï¼ˆhash or comparison-based search treesï¼‰ï¼Œè¦æƒ³å°† trie ç”¨ä½œé€šç”¨çš„ç´¢å¼•ç»“æ„ï¼Œè¿˜éœ€è¦å°† key è½¬åŒ–ä¸º <code>Binary-comparable key</code>ã€‚</p>
<blockquote>
<p>Keys stored in radix trees are ordered bitwise lexicographically.
For some data types, e.g., ASCII encoded character strings, this yields
the expected order. For most data types this is not the case.</p>
<p>However, it is possible to obtain the desired order by transforming
the keys. We call the values resulting from such a transformation
binary-comparable keys.</p>
</blockquote>
<p>éœ€è¦è½¬åŒ–çš„ç±»å‹æœ‰ï¼š</p>
<ul>
<li>Unsigned Integers</li>
<li>Signed Integers</li>
<li>IEEE 754 Floating Point Numbers</li>
<li>Character Strings</li>
<li>Null</li>
</ul>
<p>å¦‚å¯¹äº Unicode å­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½¿ç”¨ <code>The Unicode Collation Algorithm</code> å®šä¹‰çš„è§„åˆ™è¿›è¡Œæ¯”è¾ƒã€‚</p>
<h4 id="art-implementations"><a class="header" href="#art-implementations">ART implementations</a></h4>
<ol>
<li><a href="https://github.com/armon/libart">libart</a></li>
<li><a href="https://github.com/rafaelkallis/adaptive-radix-tree">rafaelkallis/adaptive-radix-tree</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatastructuretriefamilyassetspdfshot-indexpdfhot-a-height-optimized-trie-index-for-main-memory-database-systemsa"><a class="header" href="#a-hrefdatastructuretriefamilyassetspdfshot-indexpdfhot-a-height-optimized-trie-index-for-main-memory-database-systemsa"><a href="datastructure/triefamily/../../assets/pdfs/hot-index.pdf">HOT: A Height Optimized Trie Index for Main-Memory Database Systems</a></a></h3>
<blockquote>
<p>SIGMOD '18</p>
<p>https://dl.acm.org/doi/10.1145/3183713.3196896</p>
</blockquote>
<p><a href="datastructure/triefamily/../triefamily/art.html">ART</a> çš„ span å›ºå®šä¸º 8 bitsï¼Œæ ¹æ®å­èŠ‚ç‚¹ä¸ªæ•°åŠ¨æ€è°ƒæ•´ node ç±»å‹ä»¥å‡å°‘ memory consumption å¹¶æé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼Œä½†å¯¹äºç¨€ç–çš„ç´¢å¼•é”®ç±»å‹ï¼Œå¦‚å­—ç¬¦ä¸²ï¼Œä½å±‚èŠ‚ç‚¹ fanout é€šå¸¸å¾ˆå°ã€‚HOT åˆ™é‡‡ç”¨äº†ä¸åŒçš„ç­–ç•¥ï¼Œå®ƒè§„å®šäº†æœ€å¤§çš„ fanoutï¼Œé€šè¿‡åŠ¨æ€è°ƒæ•´ span çš„ bits æ•°æ¥é¿å… fanout è¾ƒå°çš„èŠ‚ç‚¹ï¼Œè®© Trie çœ‹èµ·æ¥æ›´åƒ B-Treeã€‚</p>
<blockquote>
<p>The core algorithmic idea of HOT is to dynamically vary the number
of bits considered at each node, which enables a consistently high
fanout and thereby good cache efficiency.
The layout of each node is carefully engineered for compactness and
fast search using SIMD instructions.</p>
</blockquote>
<p>HOT ç”±äºèŠ‚ç‚¹ fanout è¾ƒå¤§ï¼Œå¯¼è‡´å…¶ space consumption åŠæ ‘é«˜åº¦çš„å‡å°‘:</p>
<p><img src="datastructure/triefamily/../../assets/images/hot-art-vs-hot.jpg" alt="art vs hot height" /></p>
<p>ä¸åŒ trie çš„å˜ç§ä¸ºäº†æå‡æ€§èƒ½åšäº†ä¸åŒçš„ä¼˜åŒ–ï¼Œå¦‚ä¸‹å›¾å±•ç¤º:</p>
<p><img src="datastructure/triefamily/../../assets/images/hot-trie-optimizations.jpg" alt="trie optimizations" /></p>
<ul>
<li>Binary trie ç”±äºæ ‘é«˜å¾ˆå¤§å¯¼è‡´æ€§èƒ½è¾ƒå·®</li>
<li>Patricia å°†åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹çš„èŠ‚ç‚¹å¿½ç•¥ï¼Œä»¥é™ä½æ ‘é«˜ï¼Œä½†ç”±äº fanout åªæœ‰ 2ï¼Œæ ‘é«˜ä¾ç„¶è¾ƒé«˜</li>
<li>Generalized Prefix Tree é€šè¿‡å¢åŠ  span bits æ¥å‡å°‘æ ‘é«˜ï¼Œä½†å¯¹äºç¨€ç–åˆ†å¸ƒçš„é”®ï¼Œå…¶ fanout é€šå¸¸è¿œå°äºæœ€ä¼˜å€¼ï¼Œä¸”æµªè´¹ç©ºé—´</li>
<li>å°† Patricia å¿½ç•¥èŠ‚ç‚¹çš„ä¼˜åŒ–ç”¨äº Generalized Prefix Treeï¼Œå¯ä»¥å‡å°‘ node ä¸ªæ•°ï¼Œä½†ä¸èƒ½å‡å°‘æ ‘é«˜</li>
<li>ART ä½¿ç”¨å›ºå®šçš„ span bitsï¼Œå¹¶åŠ¨æ€è°ƒæ•´èŠ‚ç‚¹ç±»å‹ï¼Œæ¥å‡å°‘ space consumptionï¼Œä½†ä¸èƒ½å‡å°‘æ ‘é«˜</li>
<li>HOT ä½¿ç”¨éå›ºå®šçš„ span bits åŠä¸åŒçš„èŠ‚ç‚¹ç±»å‹ï¼Œä½¿å¾—èŠ‚ç‚¹å…·æœ‰è¾ƒå¤§çš„ fanoutï¼Œå‡å°‘ space consumption çš„åŒæ—¶å‡å°‘äº†æ ‘é«˜</li>
</ul>
<blockquote>
<p>The optimizations discussed in the previous section combine the
nodes of a binary trie into compound nodes with a higher fanout.
The most important optimization is to increase the span of each
node.</p>
</blockquote>
<p>HOT çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§: </p>
<blockquote>
<p><strong>Every compound node represents a binary Patricia trie with a fanout of up to k.</strong></p>
</blockquote>
<p>ä¸€ä¸ªå…·æœ‰ <code>n</code> ä¸ª key çš„ binary Patricia trie æœ‰ <code>n âˆ’ 1</code> ä¸ª inner nodesï¼Œå› æ­¤ä¸€ä¸ª fanout ä¸º <code>k</code> çš„ HOT èŠ‚ç‚¹æœ€å¤šåªéœ€å­˜å‚¨ <code>k - 1</code> ä¸ª binary inner nodesï¼ˆåŠ ä¸Š <code>k</code> ä¸ªå­èŠ‚ç‚¹ï¼‰ã€‚</p>
<p>æ¯ä¸ª HOT compound node çš„é«˜åº¦å®šä¹‰ä¸º:</p>
<p><img src="datastructure/triefamily/../../assets/images/hot-compond-node-height.jpg" alt="node height" /></p>
<p>å‘ä¸€ä¸ª HOT trie ä¸­æ’å…¥é”®å€¼æ¶‰åŠå››ç§æ“ä½œï¼š</p>
<ol>
<li>normal insert</li>
<li>leaf-node pushdown</li>
<li>parent pull up</li>
<li>intermedia node creation</li>
</ol>
<p>Insert çš„ç®—æ³•æè¿°:</p>
<p><img src="datastructure/triefamily/../../assets/images/hot-insertion-algorithm.jpg" alt="insertion algorithm" /></p>
<p>æ–‡ä¸­ç»™å‡ºäº†ä¸€ä¸ªæ’å…¥ç¤ºä¾‹çš„å›¾ç¤º:</p>
<p><img src="datastructure/triefamily/../../assets/images/hot-insertion-example.jpg" alt="insertion example" /></p>
<p>Section 4 å…³äº <strong>Node Implementation</strong> çš„éƒ¨åˆ†æ²¡çœ‹æ‡‚ï¼Œæš‚æ—¶ä¸èŠ±æ—¶é—´ç»†çœ‹äº†â˜¹ï¸ã€‚</p>
<p>ç®—æ³•çš„å®Œæ•´å®ç°: <a href="https://github.com/speedskater/hot">https://github.com/speedskater/hot</a>ã€‚</p>
<p>è§†é¢‘ä»‹ç»: <a href="https://www.youtube.com/watch?v=1F1oMFwLTq0">Robert Binna, University of Innsbruck, HOT: A Height Optimized Trie Index for Main-Memory DBMS</a>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="bitmap"><a class="header" href="#bitmap">bitmap</a></h2>
<ul>
<li><strong><a href="datastructure/bitmap/roaring.html">Better bitmap performance with Roaring bitmaps</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatastructurebitmapassetspdfsbetter-bitmap-performance-with-roaring-bitmapspdfbetter-bitmap-performance-with-roaring-bitmapsa"><a class="header" href="#a-hrefdatastructurebitmapassetspdfsbetter-bitmap-performance-with-roaring-bitmapspdfbetter-bitmap-performance-with-roaring-bitmapsa"><a href="datastructure/bitmap/../../assets/pdfs/better-bitmap-performance-with-Roaring-bitmaps.pdf">Better bitmap performance with Roaring bitmaps</a></a></h3>
<blockquote>
<p>Software: Practice and Experience Volume 46, Issue 5, pages 709-719, May 2016</p>
<p>https://arxiv.org/abs/1402.6407</p>
</blockquote>
<p>bitmap å¸¸è¢«ç”¨ä½œæ•°æ®åº“å’Œæœç´¢å¼•æ“çš„ç´¢å¼•ï¼Œé€šè¿‡æ¯”ç‰¹çº§åˆ«çš„å¹¶è¡Œï¼Œå¯ä»¥æ˜¾è‘—åŠ é€ŸæŸ¥è¯¢ã€‚ä½†ç¨€ç–çš„ bitmap å¯èƒ½ä¼šå ç”¨éå¸¸å¤šå†…å­˜ï¼Œå¾ˆå¤šæ•°æ®ç»“æ„é€šè¿‡å‹ç¼©æ¥å‡å°‘å†…å­˜ä½¿ç”¨ï¼Œå¦‚ WAH(Word Aligned Hybrid compression scheme) å’Œ Concise(Compressed 'n' Composable Integer Set)ï¼Œè€Œä¸”å®ƒä»¬å¤§éƒ½è·Ÿéš Oracle çš„è„šæ­¥ï¼Œä½¿ç”¨ RLE æ¥å‹ç¼© bitmapã€‚ä¸åŒäºè¿™äº›ç»“æ„ï¼ŒRoaring bitmap ä½¿ç”¨ packed array æ¥å‹ç¼© bitmapã€‚</p>
<p>å½“ bitmap çš„åŸºæ•°ï¼ˆCardinalityï¼Œåç”¨ S è¡¨ç¤ºï¼‰æ‰€å  bitmap ä½æ•° n è¾ƒå¤§æ—¶ï¼Œå³ |S| &gt; n/64 æ—¶ï¼Œä½¿ç”¨æœªå‹ç¼©çš„ bitmap é€šå¸¸ä¼˜äº arraysã€hash setsã€trees ç­‰æ•°æ®ç»“æ„ï¼Œå½“ n/10000 &lt; |S| &lt; n/64 æ—¶ï¼Œå‹ç¼©çš„ bitmap ï¼ˆå¦‚ Conciseï¼‰é€šå¸¸ä¸ºæ›´åˆé€‚çš„é€‰æ‹©ã€‚</p>
<p>Roaring bitmap å°† 32-bit çš„ç´¢å¼•ï¼ˆ[0,n)ï¼‰ è¿›è¡Œåˆ†åŒºï¼Œæ¯ä¸ª chunk ä»£è¡¨çš„æ‰€æœ‰å€¼å…¶é«˜ 16 ç›¸åŒã€‚ä½¿ç”¨ä¸åŒçš„å®¹å™¨æ¥è¡¨ç¤ºè¯¥ chunk ä¸­æ‰€å­˜å‚¨æ•°å€¼çš„ä½ 16 ä½ã€‚å½“ chunk ä¸­çš„å€¼ä¸å¤šäº 4096 ä¸ªæ—¶ï¼Œä½¿ç”¨æ’åºçš„ 16-bit æ•´å‹æ•°ç»„æ¥è¡¨ç¤ºï¼Œå½“å¤šäº 4096 ä¸ªæ•°å€¼æ—¶ï¼Œä½¿ç”¨ 2^16 ä½çš„ bitmap æ¥è¡¨ç¤ºã€‚</p>
<blockquote>
<p>Thus, we have two types of containers: an array container for sparse chunks and a bitmap container for dense chunks.</p>
</blockquote>
<p>4096 ä¸ºç•Œé™ä¿è¯äº†åœ¨ container å±‚é¢ï¼Œæ¯ä¸ªæ•°å€¼å ç”¨çš„å†…å­˜ä¸è¶…è¿‡ 16 bitsã€‚</p>
<blockquote>
<p>we either use 2^16 bits for more than 4096 integers, using less than 16 bits/integer, or else we use exactly 16 bits/integer.</p>
</blockquote>
<p>å®¹å™¨å­˜å‚¨åœ¨ä¸€ä¸ªåŠ¨æ€å˜åŒ–çš„æœ‰åºæ•°ç»„ä¸­ï¼Œæ ¹æ®å®¹å™¨çš„é«˜ 16 ä½æ’åºï¼Œä½œä¸º roaring bitmap çš„ä¸€çº§ç´¢å¼•ã€‚å½“ n = 1000 000 æ—¶ï¼Œä¸€çº§ç´¢å¼•åªéœ€ä¿å­˜ 16 ä¸ª entriesï¼Œè¿™ä½¿å¾—è¯¥ç»“æ„å¯ä»¥å¸¸é©»åœ¨ CPU ç¼“å­˜ã€‚ä¸€ä¸ªç®€å•çš„ä¾‹å­å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="datastructure/bitmap/../../assets/images/roaring-bitmap-figure-1.jpg" alt="figure 1" /></p>
<p>Paper ä¸­æœ‰ä¸€ä¸ª typoï¼š</p>
<blockquote>
<p>We assume that there are far fewer containers than integers. More precisely, 
we assume that the density typically exceeds 0.1% or that n/|S| &gt; 0.001.</p>
</blockquote>
<p>åº”è¯¥ä¸º |S|/n &gt; 0.001ã€‚</p>
<p>roaring bitmap çš„å­˜å–æ“ä½œå’Œé€»è¾‘æ“ä½œæ¶‰åŠåˆ°ä¸¤ç§å®¹å™¨ä¹‹é—´çš„è½¬æ¢ï¼Œç®—æ³•å¹¶ä¸å¤æ‚ï¼Œä½†æœ‰å¾ˆå¤šå¯ä»¥ä¼˜åŒ–çš„ç‚¹ï¼Œè¯¦è§è®ºæ–‡ã€‚</p>
<h4 id="references-8"><a class="header" href="#references-8">References:</a></h4>
<p>[1] <a href="https://www.youtube.com/watch?v=ubykHUyNi_0">Engineering Fast Indexes for Big Data Applications</a><br>
[2] <a href="https://www.youtube.com/watch?v=1QMgGxiCFWE">Engineering Fast Indexes for Big Data Applications(deep dive)</a><br>
[3] <a href="http://roaringbitmap.org/publications/">Roaring Bitmaps publications</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatastructureassetspdfsskiplists-cacm1990pdfskip-lists-a-probabilistic-alternative-to-balanced-treesa"><a class="header" href="#a-hrefdatastructureassetspdfsskiplists-cacm1990pdfskip-lists-a-probabilistic-alternative-to-balanced-treesa"><a href="datastructure/../assets/pdfs/skiplists-cacm1990.pdf">Skip lists: a probabilistic alternative to balanced trees</a></a></h3>
<blockquote>
<p>Communications of the ACM, June 1990</p>
<p>https://dl.acm.org/doi/10.1145/78973.78977</p>
</blockquote>
<blockquote>
<p>Skip lists are a data structure that can be used in place of balanced trees.</p>
<p>Skip lists use probabilistic balancing rather than strictly enforced balancing
and as a result the algorithms for insertion and deletion in skip lists are
much simpler and significantly faster than equivalent algorithms for
balanced trees.</p>
</blockquote>
<p>è·³è¡¨æ˜¯å¯ä»¥ç”¨äºæ›¿ä»£å¹³è¡¡æ ‘ç»“æ„çš„ä¸€ç§æ›´ç®€å•ã€æ˜“äºå®ç°çš„æ•°æ®ç»“æ„ï¼ŒRocksDB ç”¨å®ƒå®ç° memtableã€‚</p>
<h4 id="ç®—æ³•æè¿°"><a class="header" href="#ç®—æ³•æè¿°">ç®—æ³•æè¿°</a></h4>
<p>è·³è¡¨ä¸­çš„å…ƒç´ ä½¿ç”¨ Node è¡¨ç¤ºï¼Œæ¯ä¸ª Node éƒ½æœ‰å¯¹åº”çš„ Levelï¼Œå…¶å€¼æ˜¯åœ¨å…ƒç´ æ’å…¥è·³è¡¨æ—¶é€šè¿‡æŸ¥è¯¢éšæœºæ•°ç”Ÿæˆå™¨å†³å®šçš„ã€‚</p>
<p><img src="datastructure/../assets/images/skiplist_random_level.jpg" alt="random level" /></p>
<p>è·³è¡¨çš„æœ€å¤§ Level ç”±å…¶å…ƒç´ ä¸ªæ•°ä¸Šé™ N å†³å®šï¼Œå¦‚æœ p = 1/2ï¼Œé‚£ä¹ˆ MaxLevel = 16 çš„è·³è¡¨å¯ä»¥å®¹çº³ 2^16 ä¸ªå…ƒç´ ã€‚</p>
<p>è·³è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ä¸º NILï¼Œå…¶ key å€¼å¤§äºä»»æ„å…ƒç´ çš„ keyï¼Œä»»æ„ Level çš„ç»“å°¾éƒ½æŒ‡å‘ NILã€‚</p>
<p><img src="datastructure/../assets/images/skiplist_example.jpg" alt="skip list" /></p>
<p><strong>Search Algorithm</strong></p>
<p><img src="datastructure/../assets/images/skiplist_search_algo.jpg" alt="skip list search algorithm" /></p>
<p><strong>Insertion Algorithm</strong></p>
<p><img src="datastructure/../assets/images/skiplist_insertion_algo.jpg" alt="skip list insertion algorithm" /></p>
<p>æ’å…¥ä¸€ä¸ªå…ƒç´ çš„å›¾ç¤º:</p>
<p><img src="datastructure/../assets/images/skiplist_insertion_example.jpg" alt="skip list insertion example" /></p>
<p><strong>Deletion Algorithm</strong></p>
<p><img src="datastructure/../assets/images/skiplist_deletion_algo.jpg" alt="skip list deletion algorithm" /></p>
<h4 id="p-å€¼çš„é€‰æ‹©"><a class="header" href="#p-å€¼çš„é€‰æ‹©">p å€¼çš„é€‰æ‹©</a></h4>
<p><img src="datastructure/../assets/images/skiplist_value_of_p.jpg" alt="value of p" /></p>
<blockquote>
<p>Since some of the constant overheads are related
to L(n) (rather than L(n)/p), choosing p = 1/4 (rather than
1/2) slightly improves the constant factors of the speed of the
algorithms as well. </p>
<p>I suggest that a value of 1/4 be used for p
unless the variability of running times is a primary concern, in
which case p should be 1/2.</p>
</blockquote>
<h4 id="ä¸å¹³è¡¡æ ‘çš„æ€§èƒ½å¯¹æ¯”"><a class="header" href="#ä¸å¹³è¡¡æ ‘çš„æ€§èƒ½å¯¹æ¯”">ä¸å¹³è¡¡æ ‘çš„æ€§èƒ½å¯¹æ¯”</a></h4>
<p><img src="datastructure/../assets/images/skiplist_performance_compare.jpg" alt="performance compare" /></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdatastructureassetspdfsbloom_filter_1970pdfspacetime-trade-offs-in-hash-coding-with-allowable-errorsa"><a class="header" href="#a-hrefdatastructureassetspdfsbloom_filter_1970pdfspacetime-trade-offs-in-hash-coding-with-allowable-errorsa"><a href="datastructure/../assets/pdfs/bloom_filter_1970.pdf">Space/time trade-offs in hash coding with allowable errors</a></a></h3>
<blockquote>
<p>Communications of the ACM, July 1970</p>
<p>https://dl.acm.org/doi/10.1145/362686.362692</p>
</blockquote>
<p>é€ä¸€æµ‹è¯•ä¸€ç»„æ¶ˆæ¯ï¼ˆmessagesï¼‰æ˜¯å¦ä¸ºç»™å®šæ¶ˆæ¯é›†ï¼ˆa given set of messagesï¼‰æˆå‘˜æ—¶ï¼Œå¦‚æœå…è®¸å°‘é‡æµ‹è¯•æ¶ˆæ¯è¢«é”™è¯¯è¯†åˆ«ä¸ºæ¶ˆæ¯é›†æˆå‘˜ï¼Œåˆ™å¯ä»¥åœ¨ä¸å¢åŠ æ‹’ç»æ—¶é—´ï¼ˆreject timeï¼‰çš„å‰æä¸‹å‡å°‘å“ˆå¸Œç©ºé—´ï¼ˆhash areaï¼‰ã€‚</p>
<blockquote>
<p>If a particular case is rejected, as would happen most 
of the time, the simple process would be used. </p>
<p>If a case is not rejected, it could then be subjected to a 
follow-up test to determine if it is actually a member of 
the minority set or an &quot;allowable error.&quot;</p>
</blockquote>
<p>è®ºæ–‡æå‡ºçš„ä¸¤ç§ hash-coding æ–¹æ³•ï¼Œé€‚ç”¨äºç»å¤§éƒ¨åˆ†è¢«æµ‹è¯•æ¶ˆæ¯ä¸å±äºç»™å®šçš„é›†åˆï¼Œä¸”å…è®¸å°‘é‡çš„ <strong>allowable error</strong> çš„åœºæ™¯ã€‚ç®—æ³•è€ƒè™‘äº†ä¸‰ç§è®¡ç®—å› ç´ :</p>
<ol>
<li>reject time</li>
<li>space (i.e. hash area size)</li>
<li>allowable fraction of errors</li>
</ol>
<blockquote>
<p>It will be shown that <strong>allowing</strong> a small number of test messages to 
be <strong>falsely identified</strong> as members of the given set will permit a 
much <strong>smaller hash area</strong> to be used without increasing the <strong>reject time</strong>.</p>
</blockquote>
<p>åœ¨ä¸€äº›å®é™…åº”ç”¨ä¸­ï¼Œå‡å°‘ hash ç©ºé—´èƒ½å¤ŸåŠ é€Ÿå¤„ç†é€Ÿåº¦ï¼ˆå½“å®ƒéœ€è¦å­˜å‚¨åœ¨ç£ç›˜ç­‰ä»‹è´¨æ—¶ï¼‰ã€‚</p>
<p>è®ºæ–‡ä¸­<strong>è‡ªåŠ¨æ–­å¥</strong>çš„ä¾‹å­ï¼Œ10% çš„å•è¯éœ€è¦é€šè¿‡è®¿é—®ç£ç›˜ä¸Šçš„ dictionaryï¼Œå¯¹è¿™ 10% çš„å•è¯æ„é€  hash ç©ºé—´ï¼Œå…¶å®ƒ 90% çš„å•è¯ä¸­çš„ç»å¤§éƒ¨åˆ†é€šè¿‡æŸ¥è¯¢ hash ç©ºé—´è¢« rejectï¼Œä½¿ç”¨ç®€å•è§„åˆ™å°±å¯ä»¥æ–­å¥ï¼Œä½† 90% ä¸­çš„ä¸€å°éƒ¨åˆ†ä¼šè¢«é”™è¯¯çš„è¢« hash ç©ºé—´ acceptï¼Œè¿›è€Œéœ€è¦æŸ¥è¯¢ç£ç›˜ä¸Šçš„ dictionaryï¼Œä½†è¿™äº›å•è¯å¹¶ä¸åœ¨ç£ç›˜ä¸Šï¼Œå› è€Œæœ€åè¿˜æ˜¯ä¼šä½¿ç”¨ç®€å•è§„åˆ™ã€‚</p>
<h4 id="method-1"><a class="header" href="#method-1">Method 1</a></h4>
<p>æ–¹æ³•ä¸€ç±»ä¼¼ä¼ ç»Ÿçš„ hash-coding æ–¹æ³•ï¼Œä½¿ç”¨å¤šä¸ª hash cell æ¥ä¿å­˜ hash codeï¼Œæµ‹è¯•æ˜¯æŒ‰ç…§ cell ç»´åº¦è¿›è¡Œæ¯”å¯¹ã€‚</p>
<blockquote>
<p>The code is generated from the message, and its size depends on the permissible fraction of errors.</p>
</blockquote>
<p>å½“å¯æ¥å—çš„é”™è¯¯æ¯”ä¾‹ P è¶Šå°ï¼Œæ‰€éœ€è¦çš„ hash cell çš„ä¸ªæ•°è¶Šå¤šã€‚</p>
<h4 id="method-2"><a class="header" href="#method-2">Method 2</a></h4>
<p>æ–¹æ³•äºŒåˆ™å°† hash area å½“åš N ä¸ªç‹¬ç«‹ç¼–å€çš„åˆå§‹å€¼ä¸º 0 çš„æ¯”ç‰¹ä½ï¼Œæ¯ä¸ª message set ä¸­çš„æ¶ˆæ¯çš„ hash code å¯¹åº”ä¸€ç»„æ¯”ç‰¹ä½ï¼Œa1, a2, ..., adï¼Œéƒ½åœ¨ hash area ä¸­è¢«ç½®ä¸º 1ã€‚å½“æµ‹è¯•ä¸€ä¸ªæ¶ˆæ¯æ˜¯å¦å±äºæ¶ˆæ¯é›†æ—¶ï¼Œå¦‚æœæ¶ˆæ¯ hash code å¯¹åº”çš„æ¯ä¸€ä¸ªæ¯”ç‰¹ä½åœ¨ hash area ä¸­çš„ä½ç½®éƒ½ä¸º 1ï¼Œåˆ™è¯¥æ¶ˆæ¯è¢« acceptï¼Œå¦åˆ™è¢« rejectã€‚</p>
<blockquote>
<p>To test a new message a sequence of <em>d</em> bit addresses, say a1', a2', ..., ad', is generated 
in the same manner as for storing a message. </p>
<p>If all <em>d</em> bits are 1, the new message is
accepted. If any of these bits is zero, the message is rejected.</p>
</blockquote>
<h4 id="bloom-filter-hash-å‡½æ•°ä¸ªæ•°çš„é€‰æ‹©"><a class="header" href="#bloom-filter-hash-å‡½æ•°ä¸ªæ•°çš„é€‰æ‹©">Bloom filter hash å‡½æ•°ä¸ªæ•°çš„é€‰æ‹©</a></h4>
<p>å¯¹äºä¸€ä¸ª m ä½ã€n ä¸ªæ’å…¥å…ƒç´ çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œéœ€è¦ hash å‡½æ•°çš„ä¸ªæ•° k = (m/n)ln(2)ï¼ŒBloom filter å„ä¸ªå˜é‡çš„é€‰æ‹©å¯ä½¿ç”¨å¦‚ä¸‹æµç¨‹:</p>
<ol>
<li>Choose a ballpark value for n</li>
<li>Choose a value for m</li>
<li>Calculate the optimal value of k</li>
<li>Calculate the error rate for our chosen values of n, m, and k. If it's unacceptable, return to step 2 and change m; otherwise we're done.</li>
</ol>
<h4 id="references-9"><a class="header" href="#references-9">References:</a></h4>
<p>[1] <a href="https://llimllib.github.io/bloomfilter-tutorial/">Bloom Filters by Example</a></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="distributed-system"><a class="header" href="#distributed-system">distributed system</a></h2>
<p>åœ¨ <a href="distributedsystem/../assets/pdfs/A%20brief%20introduction%20to%20distributed%20systems.pdf">A Brief Introduction to Distributed Systems</a> çš„ä»‹ç»ä¸­ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿè¢«å®šä¹‰ä¸º:</p>
<blockquote>
<p>A distributed system is a <strong>collection of autonomous computing elements</strong> that appears to its users as a <strong>single coherent system</strong>.</p>
</blockquote>
<p>å›¾çµå¥–è·å¾—è€… Leslie Lamport å°†åˆ†å¸ƒå¼ç³»ç»Ÿæè¿°ä¸º:</p>
<blockquote>
<p>one in which the failure of a computer you did not even know existed can render your own computer unusable.</p>
</blockquote>
<ul>
<li><strong><a href="distributedsystem/./consensus/index.html">consensus</a></strong>
<ul>
<li><strong><a href="distributedsystem/consensus/flp.html">Impossibility of Distributed Consensus with One Faulty Process</a></strong></li>
<li><strong><a href="distributedsystem/consensus/paxos-made-simple.html">Paxos Made Simple</a></strong></li>
<li><strong><a href="distributedsystem/consensus/paxos-made-live.html">Paxos Made Live</a></strong></li>
<li><strong><a href="distributedsystem/consensus/vr.html">Viewstamped Replication</a></strong></li>
<li><strong><a href="distributedsystem/consensus/zab.html">Zab: High-performance broadcast for primary-backup systems</a></strong></li>
<li><strong><a href="distributedsystem/consensus/paxos-vs-vr-vs-zab.html">Vive La Difference: Paxos vs. Viewstamped Replication vs. Zab</a></strong></li>
<li><strong><a href="distributedsystem/consensus/raft.html">In Search of an Understandable Consensus Algorithm</a></strong></li>
<li><strong><a href="distributedsystem/consensus/paxos-vs-raft.html">Paxos vs Raft: have we reached consensus on distributed consensus?</a></strong></li>
</ul>
</li>
<li><strong><a href="distributedsystem/primary-backup.html">A principle for resilient sharing of distributed resources</a></strong></li>
<li><strong><a href="distributedsystem/chain-replication.html">Chain Replication for Supporting High Throughput and Availability</a></strong></li>
<li><strong><a href="distributedsystem/bolosky.html">Paxos Replicated State Machines as the Basis of a High-Performance Data Store</a></strong></li>
<li><strong><a href="distributedsystem/holygrail.html">Detecting Causal Relationships in Distributed Computations: In Search of the Holy Grail</a></strong></li>
<li><strong><a href="distributedsystem/chandy.html">Distributed Snapshots: Determining Global States of Distributed Systems</a></strong></li>
<li><strong><a href="distributedsystem/abs.html">Lightweight Asynchronous Snapshots for Distributed Dataflows</a></strong></li>
<li><strong><a href="distributedsystem/zookeeper.html">ZooKeeper: wait-free coordination for internet-scale systems</a></strong></li>
<li><strong><a href="distributedsystem/./scheduler/index.html">scheduler</a></strong>
<ul>
<li><strong><a href="distributedsystem/scheduler/borg.html">Large-scale cluster management at Google with Borg</a></strong></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="consensus"><a class="header" href="#consensus">consensus</a></h2>
<p>å…±è¯†ç®—æ³•é€šå¸¸ä¼´éšç€å¤åˆ¶çŠ¶æ€æœºï¼ˆreplicated state machinesï¼‰é—®é¢˜ï¼Œå®ƒæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿèƒ½å¤Ÿå®¹é”™çš„åŸºç¡€ï¼Œå¤šå°æœåŠ¡å™¨å°±ä¸€ç³»åˆ—å€¼è¾¾æˆä¸€è‡´ï¼Œä¸€æ—¦å®ƒä»¬å°±æŸä¸ªå€¼åšå‡ºå†³å®šï¼Œè¯¥å†³å®šå°±ä¸èƒ½è¢«æ”¹å˜ã€‚</p>
<blockquote>
<p>ä»»ä½•å…·æœ‰ TAV ç‰¹æ€§çš„ç®—æ³•éƒ½å¯ä»¥è¢«è®¤ä¸ºåœ¨è§£å†³å…±è¯†é—®é¢˜</p>
<ul>
<li>termination: all non-faulty processes make a decision</li>
<li>agreement: all deciding processes make the same decision</li>
<li>validity: some process proposed the decision</li>
</ul>
</blockquote>
<ul>
<li><strong><a href="distributedsystem/consensus/flp.html">Impossibility of Distributed Consensus with One Faulty Process</a></strong></li>
<li><strong><a href="distributedsystem/consensus/paxos-made-simple.html">Paxos Made Simple</a></strong></li>
<li><strong><a href="distributedsystem/consensus/paxos-made-live.html">Paxos Made Live</a></strong></li>
<li><strong><a href="distributedsystem/consensus/vr.html">Viewstamped Replication</a></strong></li>
<li><strong><a href="distributedsystem/consensus/zab.html">Zab: High-performance broadcast for primary-backup systems</a></strong></li>
<li><strong><a href="distributedsystem/consensus/paxos-vs-vr-vs-zab.html">Vive La Difference: Paxos vs. Viewstamped Replication vs. Zab</a></strong></li>
<li><strong><a href="distributedsystem/consensus/raft.html">In Search of an Understandable Consensus Algorithm</a></strong></li>
<li><strong><a href="distributedsystem/consensus/paxos-vs-raft.html">Paxos vs Raft: have we reached consensus on distributed consensus?</a></strong></li>
</ul>
<h4 id="further-readings-7"><a class="header" href="#further-readings-7">Further readings</a></h4>
<p>[1] <a href="distributedsystem/consensus/../../assets/pdfs/disk-paxos.pdf">Disk Paxos</a> by Eli Gafni &amp; Leslie Lamport, 2002<br>
[2] <a href="distributedsystem/consensus/../../assets/pdfs/paxos-abcd.pdf">The ABCDâ€™s of Paxos</a> by Butler W. Lampson, PODC 2001<br>
[3] Paxos for System Builders: <a href="distributedsystem/consensus/../../assets/pdfs/paxos-for-system-builders-an-overview.pdf">An Overview</a> and <a href="distributedsystem/consensus/../../assets/pdfs/paxos_for_system_builders.pdf">The Complete Specification</a> by Yair Amir and Jonathan Kirsch, 2008<br>
[4] <a href="distributedsystem/consensus/../../assets/pdfs/how-to-build-a-highly-available-system-using-consensus.pdf">How to Build a Highly Available System Using Consensus</a> by Butler W. Lampson, 1996<br>
[5] <a href="distributedsystem/consensus/../../assets/pdfs/there_is_no_now.pdf">There is no now</a> by Justin Sheehy, 2015</p>
<h4 id="references-10"><a class="header" href="#references-10">References</a></h4>
<p>[1] <a href="https://blog.acolyer.org/2015/03/01/cant-we-all-just-agree/">Canâ€™t we all just agree?</a><br>
[2] <a href="https://github.com/heidihoward/distributed-consensus-reading-list">Distributed Consensus Reading List ğŸ“š</a> maintained by Heidi Howard</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemconsensusassetspdfsflppdfimpossibility-of-distributed-consensus-with-one-faulty-processa"><a class="header" href="#a-hrefdistributedsystemconsensusassetspdfsflppdfimpossibility-of-distributed-consensus-with-one-faulty-processa"><a href="distributedsystem/consensus/../../assets/pdfs/flp.pdf">Impossibility of Distributed Consensus with One Faulty Process</a></a></h3>
<blockquote>
<p>Proceedings of the 2nd ACM SIGACT-SIGMOD symposium on Principles of database systems, March 1983</p>
<p>https://dl.acm.org/doi/abs/10.1145/588058.588060</p>
</blockquote>
<blockquote>
<p>In this paper, it is shown that every protocol for consensus problem has the possibility of <strong>nontermination</strong>, even with only one faulty process.</p>
</blockquote>
<p>åœ¨å¼‚æ­¥ç¯å¢ƒä¸‹ï¼Œæˆ–è€…çœŸå®çš„ç³»ç»Ÿä¸­ï¼Œå¾€å¾€ä¼šå‡ºç°è¿›ç¨‹å´©æºƒã€ç½‘ç»œåˆ†åŒºã€æ¶ˆæ¯ä¸¢å¤±/ä¹±åº/å†—ä½™ç­‰é—®é¢˜ã€‚æœ¬æ–‡åœ¨å‡è®¾ç½‘ç»œå¯é ï¼ˆit delivers all messages correctly and exactly onceï¼‰ã€non-Byzantine Failure çš„å¼‚æ­¥ç³»ç»Ÿä¸­ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ä¸åˆé€‚çš„æ—¶é—´åœæœºï¼Œä¹Ÿä¼šå¯¼è‡´ä»»ä½•åˆ†å¸ƒå¼æäº¤åè®®å¤±è´¥ã€‚</p>
<p>FLP result çš„è¯æ˜è¿˜æœ‰å¦‚ä¸‹å‡ ç‚¹å‡è®¾:</p>
<ul>
<li>make no assumptions about the relative speeds of processes or about the delay time in delivering a message.</li>
<li>the processes do not have access to synchronized clocks, so algorithms based on time-outs can not be used.</li>
<li>do not postulate the ability to detect the death of a process</li>
</ul>
<p>è¯æ˜è¿‡ç¨‹æœ‰ç‚¹æ™¦æ¶©ï¼Œå¯ä»¥ç»“åˆå‚è€ƒä¸­çš„è¿æ¥å’Œ paper ä¸€èµ·ç†è§£ï¼Œæˆ‘åªæ˜¯æµè§ˆäº†ä¸€éï¼Œåé¢éœ€è¦å¯èƒ½éœ€è¦ç»§ç»­å­¦ä¹  :(</p>
<p>è®ºæ–‡çš„ç»“è®ºä¸­æŒ‡å‡ºï¼š</p>
<p>FLP result å¹¶éè®¤ä¸º <code>fault-tolerant cooperative computing</code> é—®é¢˜åœ¨å®é™…ä¸­ä¸å¯è§£å†³ï¼Œè€Œæ˜¯æŒ‡å‡ºäº†å¦‚æœæƒ³è¦è§£å†³è¿™äº›é—®é¢˜ï¼Œéœ€è¦æ›´ç»†åŒ–çš„é”™è¯¯æ¨¡å‹ï¼Œå¦‚å¯¹é€šä¿¡æ—¶é—´ã€å¤±è´¥æ£€æµ‹çš„å‡è®¾ã€‚</p>
<p>Paxos å’Œ Raft ç†è®ºä¸Šå¯èƒ½æ°¸è¿œè¿è¡Œå´ä¸èƒ½è¾¾æˆå…±è¯†ï¼ˆå³ nonterminationï¼‰ï¼Œè½¯ä»¶å·¥ç¨‹é€šå¸¸ä½¿ç”¨ random è¶…æ—¶æœºåˆ¶æ¥å‡å°‘è¿™ç§å¯èƒ½æ€§ã€‚</p>
<h4 id="references-11"><a class="header" href="#references-11">References</a></h4>
<p>[1] <a href="https://www.the-paper-trail.org/post/2008-08-13-a-brief-tour-of-flp-impossibility/">A Brief Tour of FLP Impossibility</a><br>
[2] <a href="https://www.youtube.com/watch?v=Vmlj-67aymw">John Feminella on Impossibility of Distributed Consensus with One Faulty Process</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemconsensusassetspdfspaxos-simplepdfpaxos-made-simplea"><a class="header" href="#a-hrefdistributedsystemconsensusassetspdfspaxos-simplepdfpaxos-made-simplea"><a href="distributedsystem/consensus/../assets/pdfs/paxos-simple.pdf">Paxos Made Simple</a></a></h3>
<blockquote>
<p>ACM SIGACT News (Distributed Computing Column) 32, 4 | December 2001, pp. 51-58</p>
<p>https://www.microsoft.com/en-us/research/publication/paxos-made-simple/</p>
</blockquote>
<p>Paxos åˆ†å¸ƒå¼å…±è¯†ç®—æ³•æ˜¯ä¸€ä¸ªç³»åˆ—ï¼ŒPaxos Made Simple æ˜¯å¯¹å…¶åŸºæœ¬ç®—æ³•çš„æè¿°ï¼Œç§°ä¸º Basic Paxosã€‚Paxos ç®—æ³•è¿è¡Œä¸€æ¬¡åªèƒ½å†³å®š<strong>ä¸€ä¸ª</strong>å€¼ï¼Œè€Œéå¤šä¸ªï¼Œå°†æ­¤ç‰¢è®°äºå¿ƒå¯ä»¥å¸®åŠ©ç†è§£ Paxosã€‚</p>
<p>ç®—æ³•åŒ…å«ä¸‰ç§è§’è‰²: <code>Proposer</code>ã€<code>Acceptor</code> å’Œ <code>Learner</code>ï¼ŒåŒä¸€è¿›ç¨‹å¯æ‰®æ¼”å¤šç§è§’è‰²ã€‚å…¶ä¸­ <code>Acceptor</code> çš„å¤šæ•°æ´¾æ„æˆ quorumï¼Œ2m+1 ä¸ª Acceptor å¯ä»¥å®¹å¿ m ä¸ªèŠ‚ç‚¹ fail-stop é”™è¯¯ï¼ˆéæ‹œå åº­å¤±è´¥ï¼‰ã€‚</p>
<p>ç®—æ³•åˆ†ä¸¤ä¸ªé˜¶æ®µ:</p>
<ul>
<li>Phase 1
<ul>
<li>A proposer selects a proposal number n and sends a prepare request with number n to a majority of acceptors.</li>
<li>If an acceptor receives a prepare request with number n greater than that of any prepare request to which it has already responded, then it responds to the request with a promise not to accept any more proposals numbered less than n and with the highest-numbered proposal (if any) that it has accepted.</li>
</ul>
</li>
<li>Phase 2
<ul>
<li>If the proposer receives a response to its prepare requests (numbered n) from a majority of acceptors, then it sends an accept request to each of those acceptors for a proposal numbered n with a value v, where v is the value of the highest-numbered proposal among the responses, or is any value if the responses reported no proposals.</li>
<li>If an acceptor receives an accept request for a proposal numbered n, it accepts the proposal unless it has already responded to a prepare request having a number greater than n.</li>
</ul>
</li>
</ul>
<p>ä»¥ä¸Šç®—æ³•æ²¡æœ‰æè¿° Learner æ˜¯å¦‚ä½•çŸ¥é“å…±è¯†å·²ç»è¾¾æˆï¼Œpaper ä¸­ç»™å‡ºäº†ä¸¤ç§æ–¹æ³•:</p>
<ul>
<li>For each acceptor, whenever it accepts a proposal, respond to all learners, sending them the proposal</li>
<li>A less reliable model, but one that reduces communication, is to have one or more nominated â€˜distinguished learnersâ€™ to which acceptors send their acceptance notifications, and these then broadcast to the rest of the learners.</li>
</ul>
<p>Paxos ç®—æ³•ä¸­ä¸€äº›è¦ç‚¹:</p>
<ul>
<li>Acceptor éœ€è¦æŒä¹…å­˜å‚¨è®°å½• minProposalã€acceptedProposalã€acceptedValue ç­‰çŠ¶æ€</li>
<li>Paxos ç®—æ³•çš„ä¸‰ä¸ªé‡Œç¨‹ç¢‘ï¼ˆè¯¦ç»†ä»‹ç»å‚è€ƒ [3]ï¼‰
<ul>
<li>When the proposer receives promise(n) messages from a majority of acceptors.</li>
<li>When a majority of acceptors all issue accepted(n,val) messages for proposal number n and some value val.</li>
<li>When the proposer(s) and learners receive accepted(n,val) messages from a majority of the acceptors.</li>
</ul>
</li>
<li>å¦‚æœéœ€è¦å¯¹ä¸€ç³»åˆ—å€¼è¿›è¡Œå†³ç­–ï¼Œéœ€è¦å¤šæ¬¡è¿è¡Œ Paxos ç®—æ³•ï¼Œè¿™ç§°ä¸º Multi-Paxosï¼ŒMulti-Paxos åœ¨å­¦æœ¯ç•Œæ²¡æœ‰æ˜ç¡®çš„é˜è¿°ï¼Œåœ¨å®ç°ä¸Šéœ€è¦è§£å†³å¾ˆå¤šé—®é¢˜ï¼Œ[4] ä¸­æœ‰ç›¸åº”ä»‹ç»</li>
</ul>
<h4 id="references-12"><a class="header" href="#references-12">References:</a></h4>
<p>[1] <a href="https://www.youtube.com/watch?v=d7nAGI_NZPk">The Paxos Algorithm</a>, A Google TechTalk presented by Luis Quesada Torres (Feb 2, 2018)<br>
[2] <a href="https://blog.acolyer.org/2015/03/04/paxos-made-simple/">Paxos made simple</a> by Adrian Colyer<br>
[3] <a href="https://www.youtube.com/watch?v=UCmAzWvrFmo">Distributed Systems Lecture 15</a> by Lindsey Kuper<br>
[4] <a href="https://www.youtube.com/watch?v=JEpsBg0AO6o">Paxos lecture (Raft user study)</a> by John Ousterhout</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemconsensusassetspdfspaxos-made-livepdfpaxos-made-live---an-engineering-perspectivea"><a class="header" href="#a-hrefdistributedsystemconsensusassetspdfspaxos-made-livepdfpaxos-made-live---an-engineering-perspectivea"><a href="distributedsystem/consensus/../../assets/pdfs/paxos-made-live.pdf">Paxos Made Live - An Engineering Perspective</a></a></h3>
<blockquote>
<p>PODC '07</p>
<p>https://dl.acm.org/doi/10.1145/1281100.1281103</p>
</blockquote>
<blockquote>
<p>By repeatedly applying such an algorithm on a sequence of input values, it is possible to build an
identical log of values on each replica.</p>
<p>If the values are operations on some data structure, application of
the same log on all replicas may be used to arrive at mutually consistent data structures on all replicas.</p>
<p>For instance, if the log contains a sequence of database operations, and if the same sequence of operations is
applied to the (local) database on each replica, eventually all replicas will end up with the same database
content (provided that they all started with the same initial database state).</p>
</blockquote>
<p>Chubby æ˜¯ Google å…¬å¸å†…éƒ¨ä½¿ç”¨çš„ä¸€ä¸ªæä¾›åˆ†å¸ƒå¼é”æœºåˆ¶å’Œå­˜å‚¨å°æ–‡ä»¶çš„å®¹é”™ç³»ç»Ÿï¼Œé€šå¸¸ä¸€ä¸ªæ•°æ®ä¸­å¿ƒè¿è¡Œä¸€ä¸ª Chubby å®ä¾‹ï¼ŒGFSã€Bigtable ç­‰åº”ç”¨ï¼ˆChubby Clientsï¼‰ä½¿ç”¨ Chubby ä½œä¸ºåè°ƒè€…æ¥å­˜å‚¨å°‘é‡å…ƒæ•°æ®ã€‚</p>
<p>Chubby é€šè¿‡å¤åˆ¶æ¥å®¹é”™ï¼Œä¸€ä¸ª Chubby å®ä¾‹é€šå¸¸ç”±äº”ä¸ªå‰¯æœ¬ï¼ˆreplicaï¼‰ç»„æˆï¼Œæ¯ä¸ªå‰¯æœ¬è¿è¡ŒåŒæ ·çš„ä»£ç ï¼Œå„è‡ªéƒ¨ç½²åœ¨ç‹¬ç«‹çš„æœºå™¨ä¸Šã€‚åœ¨ä»»ä¸€æ—¶åˆ»ï¼Œå…¶ä¸­çš„ä¸€ä¸ª replica è¢«è®¤ä¸ºæ˜¯ master ä¸”æœåŠ¡æ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚ä¸‹å›¾æ˜¯ä¸€ä¸ª replica çš„æ¶æ„ï¼š</p>
<p><img src="distributedsystem/consensus/../../assets/images/paxos_made_live_chubby_replica.jpg" alt="Chubby replica" /></p>
<p>å„æ¨¡å—çš„åŠŸèƒ½</p>
<ul>
<li>Fault-tolerant Log åŸºäº Paxos ç®—æ³•ï¼Œä¿è¯å„ replica æœ¬åœ°æ—¥å¿—çš„ä¸€è‡´æ€§</li>
<li>Log å³ replay-logï¼Œä¿å­˜ Fault-tolerant Log æŒä¹…åŒ–çš„æ—¥å¿—ï¼Œç”¨äºå¤±è´¥æ¢å¤</li>
<li>Fault-tolerant DB ä¿å­˜ Chubby çš„çŠ¶æ€</li>
<li>Snapshot ä¿å­˜ Fault-tolerant DB çš„çŠ¶æ€å¿«ç…§ï¼Œå¿«ç…§æˆåŠŸåå¯ä»¥æ¸…ç†æ— ç”¨çš„ replay-log ä»¥é¿å…å­˜å‚¨è€—å°½å’Œç¼©çŸ­æ—¥å¿—å›æ”¾æ—¶é—´</li>
</ul>
<p>å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ç§å…¸å‹çš„å¤åˆ¶çŠ¶æ€æœºæ¨¡å‹ï¼ˆreplicate state machineï¼‰ã€‚</p>
<h4 id="paxos"><a class="header" href="#paxos">Paxos</a></h4>
<p>è®ºæ–‡å¯¹äº Paxos ç®—æ³•çš„æè¿°ä¸åŒäº <a href="distributedsystem/consensus/paxos-made-simple.html">Paxos Made Simple</a>ï¼Œå°†å…¶åˆ†ä¸ºäº†ä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li>Elect a replica to be the <code>coordinator</code>.</li>
<li>The coordinator selects a value and broadcasts it to all replicas in a message called the <code>accept</code> message. Other replicas either <code>acknowledge</code> this message or <code>reject</code> it.</li>
<li>Once a majority of the replicas <code>acknowledge</code> the coordinator, <strong>consensus has been reached</strong>, and the coordinator broadcasts a <code>commit</code> message to notify replicas.</li>
</ol>
<p>è¿™ç§æè¿°æ˜¯ä¸ºäº†æ–¹ä¾¿å¼•å…¥ <code>Multi-Paxos</code>ï¼Œåœ¨åæ–‡çš„ä»‹ç»ä¸­æåˆ°ï¼Œä¸Šè¿°çš„åè°ƒè€…é€‰ä¸¾é˜¶æ®µåŒ…å«äº† Propose/Promise æ¶ˆæ¯ã€‚å½“åè°ƒè€…ä¸å˜çš„æƒ…å†µä¸‹ï¼Œä¸Šè¿°çš„ 2ã€3 å³å¯è¿ç»­æ‰§è¡Œä»¥ä¼˜åŒ–æ€§èƒ½ï¼Œå³ <code>Multi-Paxos</code>ã€‚</p>
<p>Paxos å­˜åœ¨å¤šä¸ª replica åŒæ—¶è®¤ä¸ºè‡ªå·±ä¸º Coordinator çš„æƒ…å½¢ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒPaxos é€šè¿‡é™„åŠ ä¸¤ä¸ªçº¦æŸæ¥ä¿è¯åœ¨ä¸€ä¸ªå€¼ä¸Šè¾¾æˆå…±è¯†ï¼š</p>
<ul>
<li>assigning an ordering to the successive coordinators</li>
<li>restricting each coordinatorâ€™s choice in selecting a value</li>
</ul>
<p>å¯¹åè°ƒè€…æ’åºä½¿å¾— replica èƒ½å¤ŸåŒºåˆ†å½“å‰çš„åè°ƒè€…å’Œè¿‡å»çš„åè°ƒè€…ï¼Œæ‹’ç»æ—§åè°ƒè€…çš„æ¶ˆæ¯ä½¿å¾— replica èƒ½å¤Ÿè¾¾æˆä¸€è‡´ã€‚Paxos ä½¿ç”¨é€’å¢åºå·æ¥å¯¹åè°ƒè€…è¿›è¡Œæ’åºï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Each replica keeps track of the most recent sequence number it has seen so far.</p>
<p>When a replica wants to become coordinator, it generates a unique sequence number higher than any it has seen, and broadcasts it to all replicas in a propose message.</p>
<p>If a majority of replicas reply and indicate they have not seen a higher sequence number, then the replica acts as a coordinator.</p>
</blockquote>
<p>å½“å¯¹ä¸€ä¸ªå€¼å½¢æˆå…±è¯†ä¹‹åï¼ŒPaxos éœ€è¦ä¿è¯ä¹‹åçš„åè°ƒè€…ä¸èƒ½æ”¹å˜å…¶å€¼:</p>
<blockquote>
<p>Once consensus is reached on a value, Paxos must force future coordinators to select that same value in order to ensure continued agreement.</p>
<p>To guarantee this, the promise messages from replicas include the most recent value they have heard, 
if any, along with the sequence number of the coordinator from whom they heard it.</p>
<p>The new coordinator chooses the value from the most recent coordinator. If none of the
promise messages contain a value, the coordinator is free to choose a submitted value.</p>
</blockquote>
<p>è¿™å—çš„æè¿°ä¸æ˜¯å¾ˆè¯¦å°½ï¼Œä½†çœ‹è¿‡ <a href="distributedsystem/consensus/./zab.html">zab</a> å’Œ <a href="distributedsystem/consensus/./raft.html">raft</a> çš„è¯»è€…åº”è¯¥èƒ½è”æƒ³åˆ° zab çš„ <code>Discovery Step l.1.2</code> å’Œ raft çš„ <code>Election restriction</code>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemconsensusassetspdfsvr-revisitedpdfviewstamped-replication-revisiteda"><a class="header" href="#a-hrefdistributedsystemconsensusassetspdfsvr-revisitedpdfviewstamped-replication-revisiteda"><a href="distributedsystem/consensus/../../assets/pdfs/vr-revisited.pdf">Viewstamped Replication Revisited</a></a></h3>
<blockquote>
<p>MIT technical report MIT-CSAIL-TR-2012-021, July 2012</p>
<p>https://pmg.csail.mit.edu/papers/vr-revisited.pdf</p>
</blockquote>
<p>Viewstamped Replication æœ€åˆåœ¨ 1988 å¹´å‘è¡¨çš„ <a href="distributedsystem/consensus/../../assets/pdfs/viewstamped-replication.pdf">Viewstamped Replication: A New Primary Copy Method to Support Highly-available Distributed Systems</a> ä¸­æå‡ºï¼Œå…¶åŸå§‹æè¿°ä¸åˆ†å¸ƒå¼ Transactions åè®®è€¦åˆåœ¨ä¸€èµ·ï¼Œç†è§£èµ·æ¥è¾ƒä¸ºå›°éš¾ã€‚2012 å¹´å‘è¡¨çš„ <strong>Viewstamped Replication Revisited</strong> å°†å…¶å…±è¯†ç®—æ³•æŠ½å–å‡ºæ¥ï¼Œå¯¹åè®®çš„æè¿°æ›´ä¸ºæ¸…æ™°ã€‚æœ¬æ–‡åŸºäº vr-revisited ä»‹ç» VR åè®®ã€‚</p>
<blockquote>
<p>VR was originally developed in the 1980s, at about the same time as Paxos, 
but without knowledge of that work. It differs from Paxos in that it is a 
<strong>replication protocol</strong> rather than a consensus protocol: it <strong>uses consensus</strong>, 
with a protocol very similar to Paxos, as part of supporting a 
<strong>replicated state machine</strong>.</p>
</blockquote>
<p>è™½ç„¶è®ºæ–‡å£°ç§° VR ä¸æ˜¯ consensusï¼Œè€Œæ˜¯ä½¿ç”¨äº† consensus çš„å¤åˆ¶åè®®ï¼Œä½†é€šå¸¸åœ¨æåˆ° VR åè®®æ—¶ï¼Œè®¤ä¸ºå®ƒå°±æ˜¯å…±è¯†ç®—æ³•ã€‚</p>
<h4 id="failure-mode"><a class="header" href="#failure-mode">Failure Mode</a></h4>
<p>VR å‡è®¾é›†ç¾¤ä¸­èŠ‚ç‚¹çš„å¤±æ•ˆæ¨¡å‹ä¸º <em>crash failures</em>ï¼Œè€Œé <em>Byzantine failures</em>ã€‚VR å·¥ä½œåœ¨å¼‚æ­¥ç½‘ç»œæ¨¡å‹ï¼ˆå¦‚ Internetï¼‰ï¼ŒåŒæ—¶å‡è®¾ç½‘ç»œä¸ä¼šè¢«æ¶æ„æ”»å‡»è€…ç¯¡æ”¹ã€‚</p>
<blockquote>
<p>Messages might be lost, delivered late or out of order, and 
delivered more than once; however, we assume that if sent 
repeatedly a message will eventually be delivered.</p>
</blockquote>
<p>VR æ˜¯ä¸€ä¸ªå¤šæ•°æ´¾çš„åè®®ï¼Œä¸€ä¸ª <strong>replica group</strong> ç”± 2f + 1 ä¸ªèŠ‚ç‚¹ç»„æˆï¼Œå¯ä»¥å¿å— f ä¸ªèŠ‚ç‚¹åŒæ—¶å¤±æ•ˆï¼Œf + 1 ä¸ªèŠ‚ç‚¹è¢«ç§°ä¸º <strong>quorum</strong>ï¼Œåè®®çš„æ­£ç¡®æ€§ä¾èµ– <strong>quorum intersection property</strong>:</p>
<blockquote>
<p>The quorum of replicas that processes a particular step of the protocol must
have a <strong>non-empty intersection</strong> with the group of replicas available to 
handle the next step, since this way we can ensure that at each next step 
at least one participant knows what happened in the previous step.</p>
</blockquote>
<h4 id="architecture-1"><a class="header" href="#architecture-1">Architecture</a></h4>
<p><img src="distributedsystem/consensus/../../assets/images/vr_architecture.jpg" alt="VR Architecture" /></p>
<p>ä¸Šå›¾æ˜¾ç¤ºäº† f = 1 çš„ VR æ¶æ„å›¾ï¼Œå®¢æˆ·ç«¯é€šè¿‡ VR Proxy å’Œé›†ç¾¤è¿›è¡Œäº¤äº’ï¼Œæ¯ä¸ª Replica åŒ…å«ä¸¤éƒ¨åˆ†ä»£ç :</p>
<ul>
<li>VR Code: è¿è¡Œ VR åè®®ï¼Œå½“ä¸€ä¸ªè¯·æ±‚å¯ä»¥è¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œäº§ç”Ÿä¸€ä¸ª up-call è®© service code æ‰§è¡Œè¯¥è¯·æ±‚</li>
<li>Service Code: æ‰§è¡Œè¯·æ±‚ï¼Œæ›´æ–°çŠ¶æ€å¹¶å°†ç»“æœè¿”å›ç»™ VR codeï¼ŒVR code å°†ç»“æœæ¶ˆæ¯å‘é€ç»™ client proxy</li>
</ul>
<h4 id="vr-protocol"><a class="header" href="#vr-protocol">VR Protocol</a></h4>
<p><strong>State machine replication</strong> è¦æ±‚æ‰€æœ‰çš„ replica ä»¥åŒæ ·çš„åˆå§‹çŠ¶æ€å¼€å§‹ï¼Œæ‰§è¡ŒåŒæ ·åºåˆ—çš„æ“ä½œï¼Œæœ€ç»ˆä¼šå¾—åˆ°ä¸€æ ·çš„çŠ¶æ€ã€‚</p>
<blockquote>
<p>The challenge for the replication protocol is to ensure that 
operations execute in the same order at all replicas in spite 
of concurrent requests from clients and in spite of failures.</p>
</blockquote>
<p>VR åè®®ä½¿ç”¨ä¸€ä¸ª <strong>primary</strong> replica å¯¹å®¢æˆ·ç«¯è¯·æ±‚è¿›è¡Œæ’åºï¼Œ<strong>backup</strong> replica æ¥å— primary é€‰æ‹©çš„è¯·æ±‚é¡ºåºã€‚å½“ primary å¤±æ•ˆï¼Œé›†ç¾¤é€šè¿‡ <em>view change protocol</em> é€‰æ‹©ä¸€ä¸ªæ–°çš„ primaryï¼Œå¦‚ä½•ä¿è¯æ–°çš„ primary èƒ½ååº”å·²ç»è¢«æ‰§è¡Œè¿‡çš„è¯·æ±‚æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚</p>
<blockquote>
<p>We support this requirement by having the primary wait until at least <strong>f + 1</strong> replicas 
(including itself) know about a client request before executing it, and by initializing 
the state of a new view by consulting at least <strong>f + 1</strong> replicas. Thus each request is 
known to a quorum and the new view starts from a quorum.</p>
</blockquote>
<p>VR ä½¿ç”¨ä¸‰ä¸ª sub-protocols æ¥ä¿è¯åè®®çš„æ­£ç¡®æ€§ï¼š</p>
<ul>
<li>Normal case processing of user requests.</li>
<li>View changes to select a new primary.</li>
<li>Recovery of a failed replica so that it can rejoin the group.</li>
</ul>
<p>æ¯ä¸ª replica æ ¹æ®å…¶ IP åœ°å€è¢«èµ‹äºˆä¸€ä¸ª idï¼Œé›†ç¾¤æ ¹æ® replica id å¾ªç¯ï¼ˆRound Robinï¼‰é€‰æ‹©ä¸‹ä¸€ä¸ª primary è§’è‰²ã€‚æ¯ä¸ª replica çš„ VR layer ç»´æŠ¤äº†å¦‚ä¸‹çŠ¶æ€:</p>
<ul>
<li>configuration: ä¾æ® 2f + 1 ä¸ª relica çš„ IP åœ°å€æ’åºçš„æ•°ç»„</li>
<li>replica number: è¯¥ replica åœ¨ configuration ä¸­æ’åºæ•°ç»„çš„ index</li>
<li>view-number: replica å½“å‰çš„è§†å›¾å·ï¼Œåˆå§‹å€¼ä¸º 0ï¼Œé€’å¢</li>
<li>status: replica å½“å‰çŠ¶æ€ï¼Œå¯èƒ½å€¼ä¸º normalã€view-change æˆ– recovering</li>
<li>op-number: èµ‹äºˆæœ€æ–°è¯·æ±‚çš„æ“ä½œidï¼Œåˆå§‹å€¼ä¸º 0ï¼Œé€’å¢</li>
<li>log: replica ä¸Šç»´æŠ¤çš„åŒ…å«æ“ä½œè®°å½•çš„æ•°ç»„</li>
<li>commit-number: æœ€æ–°æäº¤çš„è¯·æ±‚æ“ä½œçš„ op-number</li>
<li>client-table: å¯¹äºæ¯ä¸ªå®¢æˆ·ç«¯ç»´æŠ¤çš„æœ€æ–°çš„è¯·æ±‚ï¼Œå¦‚æœè¯¥è¯·æ±‚å·²ç»è¢«æ‰§è¡Œè¿‡ï¼Œåˆ™è¯¥ç»“æ„è¿˜ä¼šä¿å­˜è¯·æ±‚å¯¹åº”çš„å“åº”ç»“æœ</li>
</ul>
<p><strong>1. Normal Operation: request processing protocol</strong></p>
<p>åœ¨ primary èŠ‚ç‚¹ä¸å‡ºé”™çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªçŠ¶æ€ä¸º <em>normal</em> ä¸”åœ¨åŒä¸€ view çš„ replicas å‚ä¸è¯·æ±‚çš„å¤„ç†ã€‚</p>
<blockquote>
<p>Replicas only process normal protocol messages containing a view-number that matches 
the view-number they know.</p>
</blockquote>
<p>è¯¥åè®®å·¥ä½œæµç¨‹å¦‚ä¸‹:</p>
<p><img src="distributedsystem/consensus/../../assets/images/vr_normal_case.jpg" alt="normal case processing" /></p>
<ol>
<li>å®¢æˆ·ç«¯å‘é€ <code>&lt;Request op, c, s&gt;</code> æ¶ˆæ¯ç»™ primaryï¼Œå…¶ä¸­ op æ˜¯å®¢æˆ·ç«¯æƒ³è¦æ‰§è¡Œçš„è¯·æ±‚ï¼ˆåŒ…å«å‚æ•°ï¼‰ï¼Œc æ˜¯å®¢æˆ·ç«¯ idï¼Œs æ˜¯æŒ‡å®šç»™è¯·æ±‚çš„ request-number;</li>
<li>primary æ”¶åˆ°è¯·æ±‚åï¼Œå°† request-number å’Œ client-table ä¸­è®°å½•çš„ä¿¡æ¯è¿›è¡Œå¯¹æ¯”ã€‚å¦‚æœ request-number ä¸å¤§äº client-table è®°å½•çš„ request-numberï¼Œè¯¥ request è¢«ä¸¢å¼ƒï¼Œå¦‚æœè¯¥ request æ˜¯ client-table è®°å½•çš„æœ€æ–° requestï¼Œprimary ä¼šç»™å®¢æˆ·ç«¯é‡æ–°å‘é€è¯¥è¯·æ±‚å¯¹åº”çš„å“åº”;</li>
<li>primary å¢åŠ  op-number å€¼ï¼Œå°†è¯·æ±‚è¿½åŠ åˆ° logï¼Œæ›´æ–° client-table ä¸­å¯¹åº”è¯¥å®¢æˆ·ç«¯çš„ä¿¡æ¯ã€‚å‘å…¶å®ƒ replicas å‘é€ <code>&lt;Prepare v, m, n, k&gt;</code> æ¶ˆæ¯ï¼Œv æ˜¯ primary å½“å‰çš„ view-numberï¼Œm æ˜¯å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼ˆå³ Step 1 ä¸­çš„ Requestï¼‰ï¼Œn æ˜¯æŒ‡å®šç»™è¯·æ±‚çš„ op-numberï¼Œk æ˜¯ commit-number;</li>
<li>backups æŒ‰ç…§é¡ºåºå¤„ç† Prepare æ¶ˆæ¯ï¼Œå½“ backup æ”¶åˆ° Prepare æ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šç­‰å¾…æ‰€æœ‰æ›´æ—©çš„è¯·æ±‚éƒ½å­˜åœ¨äºå…¶ log åï¼Œå¢åŠ å…¶ op-number å€¼ï¼Œå°†è¯¥è¯·æ±‚è¿½åŠ åˆ° logï¼Œæ›´æ–° client-tableï¼Œç„¶åå‘ primary å‘é€ <code>&lt;PrepareOk v, n, i&gt;</code> æ¶ˆæ¯ï¼Œå‘Šè¯‰ primay è¯¥æ¶ˆæ¯å·²ç»åœ¨æœ¬åœ°æ—¥å¿—å°±ç»ª;</li>
<li>primary åœ¨æ”¶åˆ° f ä¸ªä¸åŒ backups è¿”å›çš„ PrepareOk æ¶ˆæ¯åï¼Œè®¤ä¸ºè¯¥æ“ä½œï¼ˆåŠæ‰€æœ‰å…ˆå‰çš„æ“ä½œï¼‰ä¸º committedï¼Œåœ¨æ‰§è¡Œäº†æ‰€æœ‰æ›´æ—©çš„æ“ä½œåï¼Œprimary é€šè¿‡ up-call è®© service code æ‰§è¡Œè¯¥æ“ä½œï¼Œå¹¶æ›´æ–° commit-numberã€‚ç„¶åå‘é€ <code>&lt;Reply v, s, x&gt;</code> æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ï¼Œv æ˜¯ primary å½“å‰çš„ view-numberï¼Œs æ˜¯å®¢æˆ·ç«¯çš„ request-numberï¼Œx æ˜¯ up-call è¿”å›çš„ç»“æœã€‚primary åŒæ—¶ä¼šæ›´æ–° client-table ä¸­å¯¹åº”è¯¥è¯·æ±‚çš„ç»“æœ;</li>
<li>é€šå¸¸æƒ…å†µä¸‹ï¼Œprimary é€šè¿‡ä¸‹æ¬¡ Prepare æ¶ˆæ¯é€šçŸ¥ backups å½“å‰çš„ commit-numberï¼Œä½†æ˜¯å½“åœ¨ä¸€å®šæ—¶é—´åæœªæ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚æ—¶ï¼Œprimary ä¼šç»™ backups è¿”é€ <code>&lt;Commit v, k&gt;</code> æ¶ˆæ¯ï¼Œv æ˜¯ primary å½“å‰çš„ view-numberï¼Œk æ˜¯å½“å‰çš„ commit-number;</li>
<li>backup åœ¨æ”¶åˆ° commit-number æ›´æ–°åï¼Œç­‰å¾… log ä¸­æ‰€æœ‰æ—©äº commit-number çš„è¯·æ±‚è¢«æ‰§è¡Œåï¼Œæ‰§è¡Œ up-call è®© service code å¤„ç† commit-number å¯¹åº”çš„æ“ä½œï¼Œé€’å¢ commit-number å€¼ï¼Œå¹¶æ›´æ–° client-tableï¼Œä¸è¿‡ backup ä¸éœ€è¦ç»™å®¢æˆ·ç«¯å›å¤ç»“æœã€‚</li>
</ol>
<p>å¦‚æœå®¢æˆ·ç«¯åœ¨ä¸€å®šæ—¶é—´åæœªæ”¶åˆ°è¯·æ±‚çš„å“åº”ï¼Œä¼šå°†è¯¥æ¶ˆæ¯å‘é€ç»™æ‰€æœ‰ replicasï¼Œè¿™æ ·èƒ½ä¿è¯ replica group è¿›å…¥ä¸‹ä¸€ä¸ª view åï¼Œè¯·æ±‚å¯ä»¥å‘é€ç»™æ–°çš„ primaryã€‚</p>
<p><strong>2. view change Protocol</strong></p>
<p>backup é€šè¿‡ <code>Prepare</code> å’Œ <code>Commit</code> æ¶ˆæ¯å¯¹ primary è¿›è¡Œæ¢æ´»ï¼Œå¦‚æœåœ¨ä¸€å®šæ—¶é—´å†…æœªæ”¶åˆ°æ¥è‡ª primary çš„æ¶ˆæ¯ï¼Œreplicas ä¼šé€šè¿‡ <strong>view change</strong> åˆ‡æ¢æ–°çš„ primaryã€‚</p>
<p>View Changes ä¿è¯æ­£ç¡®æ€§çš„å‰ææ˜¯ï¼šæ¯ä¸€ä¸ªé€šè¿‡ up-call è¢« service code æ‰§è¡Œçš„è¯·æ±‚ï¼Œå¿…é¡»å­˜æ´»äºä¸‹ä¸€ä¸ª view ä¸”ä¿è¯å…¶åœ¨ log ä¸­çš„é¡ºåºä¸æ‰§è¡Œé¡ºåºä¸€è‡´ã€‚</p>
<blockquote>
<p>The correctness condition for view changes is that every committed operation survives into 
all subsequent views in the same position in the serial order. This condition implies that 
any request that had been executed retains its place in the order.</p>
</blockquote>
<p>åªæœ‰ committed çš„æ“ä½œä¼šæ‰§è¡Œ up-callï¼Œè¿™æ„å‘³ç€æ—§çš„ primary å·²ç»æ”¶åˆ° f ä¸ª backup è¿”å› PrepareOK æ¶ˆæ¯ï¼Œè¿›è€Œæ„å‘³ç€è¯¥æ“ä½œå·²ç»åœ¨ f + 1 ä¸ª replica çš„ log ä¸­è¢«è®°å½•ã€‚å½“ <strong>view change protocol</strong> è·å–äº† f + 1 ä¸ª replica çš„æ—¥å¿—ä¿¡æ¯åï¼Œä¾æ® <strong>quorum intersection property</strong>ï¼Œæ‰€æœ‰ committed æ“ä½œéƒ½èƒ½è¢«æ–°çš„ view è·å–åˆ°ã€‚</p>
<p>è¯¥åè®®å·¥ä½œæµç¨‹å¦‚ä¸‹:</p>
<ol>
<li>replica i æ ¹æ®å…¶ timer æˆ–åœ¨æ”¶åˆ° <em>view-number</em> å¤§äºè¯¥ replica æœ¬èº« <em>view-number</em> çš„ StartViewChange æˆ– DoViewChange æ¶ˆæ¯åï¼Œæ‰§è¡Œ view changeï¼Œå°†è‡ªå·±çš„çŠ¶æ€ç½®ä¸º <em>view-change</em>ï¼Œå¢åŠ å…¶ <em>view-number</em>ï¼Œç„¶åç»™å…¶å®ƒ replicas å‘é€ <code>&lt;StartViewChange v, i&gt;</code> æ¶ˆæ¯ï¼Œå…¶ä¸­ v ä¸ºæ–°è§†å›¾çš„ <em>view-number</em>;</li>
<li>å½“ replica i æ”¶åˆ° f ä¸ªä¸å…¶ <em>view-number</em> ç›¸åŒçš„ StartViewChange æ¶ˆæ¯åï¼Œè¯¥ replica å‘é€ <code>&lt;DoViewChange v, l, v', n, k i&gt;</code> æ¶ˆæ¯ç»™ä¸‹ä¸€ä¸ªè§†å›¾çš„ primaryï¼ˆé€šè¿‡ Round Robin æŒ‡å®šï¼‰ã€‚å…¶ä¸­ v æ˜¯è¯¥ replica çš„ <em>view-number</em>ï¼Œl æ˜¯å®ƒçš„ logï¼Œv' æ˜¯çŠ¶æ€ä¸º <em>normal</em> çš„æœ€è¿‘çš„è§†å›¾çš„ <em>view-number</em>ï¼Œn ä¸º <em>op-number</em>, k ä¸º <em>commit-number</em>;</li>
<li>å½“æ–°çš„ primary ä»ä¸åŒ replicasï¼ˆåŒ…æ‹¬å…¶è‡ªå·±ï¼‰æ”¶åˆ° f + 1 ä¸ª DoViewChange æ¶ˆæ¯åï¼Œå®ƒå°†è‡ªå·±çš„ <em>view-number</em> åŠ log è®¾ç½®ä¸º v' æœ€å¤§æˆ–å¤šä¸ªå…·æœ‰æœ€å¤§ v' ä¸­ n æœ€å¤§çš„æ¶ˆæ¯å¯¹åº”çš„ v åŠ logï¼Œå°†å…¶ <em>op-number</em> è®¾ç½®ä¸ºæ–° log çš„æœ€å¤§ indexï¼Œå°†å…¶ <em>commit-number</em> è®¾ç½®ä¸ºæ‰€æœ‰ DoViewChange ä¸­æœ€å¤§çš„ <em>commit-number</em>ï¼Œç„¶åå°†å…¶çŠ¶æ€è®¾ç½®ä¸º normalï¼Œé€šè¿‡ç»™å„ replica å‘é€ <code>&lt;StartView v, l, l, n, k&gt;</code> æ¥é€šçŸ¥å…¶å®ƒ replica view change è¿‡ç¨‹ç»“æŸï¼Œå…¶ä¸­ l ä¸ºæ–°çš„æ—¥å¿—ï¼Œn ä¸º <em>op-number</em>ï¼Œk ä¸º <em>commit-number</em>;</li>
<li>æ–° replica å¼€å§‹æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå°†ä¹‹å‰æœªæ‰§è¡Œçš„ <code>committed</code> æ“ä½œæ‰§è¡Œä¸€éï¼Œæ›´æ–° client-tableï¼Œå¹¶ç»™å®¢æˆ·ç«¯å‘é€å“åº”;</li>
<li>å½“å…¶å®ƒ replica æ”¶åˆ° StartView æ¶ˆæ¯åï¼Œå®ƒä»¬æ›´æ–°æœ¬åœ°çš„ logã€op-number åŠ view-numberï¼Œå°†çŠ¶æ€è®¾ç½®ä¸º <em>normal</em>ï¼Œå¹¶æ›´æ–° client-table ä¸­çš„ä¿¡æ¯ã€‚å¦‚æœæ—¥å¿—ä¸­æœ‰æœªæäº¤çš„æ“ä½œï¼Œreplica ä¼šç»™ primary å‘é€ <code>&lt;PrepareOk v, n, i&gt;</code>ï¼Œç„¶åæ‰§è¡Œä¹‹å‰æœªæ‰§è¡Œçš„ <code>committed</code> æ“ä½œï¼Œå¢åŠ  <em>commit-number</em> å€¼ï¼Œå¹¶æ›´æ–° client-table çš„ä¿¡æ¯ã€‚</li>
</ol>
<blockquote>
<p>VR as originally defined used a slightly different approach: it assigned each operation a 
viewstamp. A viewstamp is a pair &lt;view-number, op-number&gt;, with the natural order: the 
view-number is considered first, and then the op-number for two viewstamps with the same 
view-number.</p>
</blockquote>
<p>VR åœ¨æœ€åˆçš„è®ºæ–‡ä¸­æ ¹æ®å¦‚ä¸Šå®šä¹‰è¢«å‘½åä¸º <em>viewstamps</em>ã€‚</p>
<p>ä¸€ä¸ª View Change è¿‡ç¨‹å¯èƒ½ç”±äºæ–° primary çš„å¤±è´¥è€Œå¤±è´¥ï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦æ‰§è¡Œæ–°ä¸€è½®çš„ View Changeã€‚</p>
<p><strong>3. recovery protocol</strong></p>
<p>å½“ä¸€ä¸ª replica ä»å¤±è´¥ä¸­æ¢å¤åï¼Œå®ƒä¸èƒ½å‚ä¸é›†ç¾¤çš„è¯·æ±‚å¤„ç†åŠ view changes ç›´åˆ°å®ƒè·å–åˆ°è‡³å°‘å®ƒå¤±è´¥æ—¶çš„çŠ¶æ€ã€‚å¦‚æœåœ¨ç£ç›˜ä¸Šè®°å½•äº†çŠ¶æ€ï¼ŒèŠ‚ç‚¹åœ¨è¯»å–ç£ç›˜é‡æ–°åˆå§‹åŒ–å…¶çŠ¶æ€åå¯ä»¥é©¬ä¸Šé‡æ–°åŠ å…¥åˆ°ç³»ç»Ÿä¸­:</p>
<blockquote>
<p>The reason is that in this case a recovering node hasnâ€™t forgotten anything 
it did before the crash (assuming the disk is intact). Instead it is the 
same as a node that has been unable to communicate for some period of time: 
its state is old but it hasnâ€™t forgotten anything it did before.</p>
</blockquote>
<p>ä½† VR ä¸ºäº†æé«˜å…¶ååï¼Œå¹¶æœªåœ¨å‘é€ Prepare åŠ PrepareOk æ¶ˆæ¯ä¹‹å‰å†™ç£ç›˜ï¼Œå…¶å‡è®¾æ‰€æœ‰å‡ ç‚¹ä¸ä¼šåœ¨åŒä¸€æ—¶åˆ»åŒæ—¶å¤±è´¥ï¼ŒåŠ replcas å…·æœ‰ <code>failure independent</code> çš„å±æ€§ï¼ˆä¾èµ– UPSã€non-volatime memory æˆ–å°† replica æ”¾ç½®åœ¨ä¸åŒçš„åœ°ç†ä½ç½®ï¼‰ã€‚</p>
<p>è¯¥åè®®å·¥ä½œæµç¨‹å¦‚ä¸‹:</p>
<ol>
<li>éœ€è¦æ¢å¤çš„ replica i ç»™å…¶å®ƒ replica å‘é€ <code>&lt;Recovery i, x&gt;</code>ï¼Œå…¶ä¸­ x æ˜¯ä¸€ä¸ªé€’å¢çš„ nonce å€¼;</li>
<li>replica j åœ¨çŠ¶æ€ä¸º <em>normal</em> çš„å‰æä¸‹å›å¤ <code>&lt;RecoveryResponse v, x, l, n, k, j&gt;</code> æ¶ˆæ¯ç»™ replica iï¼Œv æ˜¯ <em>view-number</em>ï¼Œx æ˜¯ Recovery æ¶ˆæ¯ä¸­çš„ nonce å€¼ï¼Œå¦‚æœ j ä¸ºå½“å‰è§†å›¾çš„ primaryï¼Œåˆ™ l æ˜¯å…¶ logï¼Œn ä¸º <em>op-number</em>ï¼Œk ä¸º <em>commit-number</em>ï¼Œå¦‚æœä¸º backupï¼Œåˆ™ lã€nã€k çš„å€¼éƒ½ä¸º nil;</li>
<li>å½“ replica i ä»ä¸åŒèŠ‚ç‚¹æ”¶åˆ° f + 1 ä¸ª RecoveryResponse æ¶ˆæ¯åï¼ˆæ‰€æœ‰æ¶ˆæ¯éœ€åŒ…å«ä¸ Recovery æ¶ˆæ¯ç›¸åŒçš„ nonceï¼Œä¸”è‡³å°‘æœ‰ä¸€ä¸ªåŒ…å«è¿™äº›æ¶ˆæ¯ä¸­å«æœ‰æœ€æ–°è§†å›¾çš„ primary èŠ‚ç‚¹çš„æ¶ˆæ¯ï¼‰ï¼Œreplica i ä¾æ® primary è¿”å›çš„ä¿¡æ¯æ›´æ–°å…¶ logã€<em>view-number</em>ã€<em>op-number</em> åŠ <em>commit-number</em>ï¼Œå¹¶å°†å…¶çŠ¶æ€æ”¹ä¸º <em>normal</em>ã€‚</li>
</ol>
<p>å½“éœ€è¦æ¢å¤çš„ replica i åŒæ—¶ä¸º view change çš„ new primary æ—¶ï¼Œç”±äº replica i ä¸ä¼šå›å¤ DoViewChange æ¶ˆæ¯ï¼Œå› æ­¤ view change ä¸èƒ½å®Œæˆã€‚è¿™ç§æƒ…å†µä¸‹ä¼šè¿›è¡Œæ–°ä¸€è½®çš„ view changeã€‚</p>
<p>nonce çš„ä½œç”¨åœ¨äºé¿å…éœ€è¦æ¢å¤çš„èŠ‚ç‚¹æ¥æ”¶ä¹‹å‰ Recovery æ¶ˆæ¯å¯¹åº”çš„ RecoveryResponseã€‚</p>
<blockquote>
<p>When a replica recovers it doesnâ€™t know what view it was in when it failed. 
However, when it receives <strong>f + 1</strong> responses to its RECOVERY message, it 
is certain to learn of a view at least as recent as the one that existed 
when it sent its last PREPAREOK, DOVIEWCHANGE, or RECOVERYRESPONSE message. 
Furthermore it gets its state from the primary of the latest view it hears 
about, which ensures it learns the latest state of that view.</p>
</blockquote>
<h4 id="efficient-log"><a class="header" href="#efficient-log">Efficient log</a></h4>
<p>å¦‚ä¸Šåè®®ä¸­çš„ log åœ¨é•¿æ—¶é—´è¿è¡Œä¹‹åå¯èƒ½ä¼šéå¸¸å·¨å¤§ï¼Œä¾èµ– application state åŠ checkpoints å¯ä»¥é«˜æ•ˆåœ°ç®¡ç†æ—¥å¿—ï¼Œå¹¶å¯ä»¥å°†æ— ç”¨çš„ log è¿›è¡Œ gcã€‚é«˜æ•ˆçš„æ—¥å¿—ç®¡ç†å¯¹äºæå‡ <strong>Recovery</strong>ã€<strong>State Transfer</strong>ã€<strong>View Changes</strong> çš„æ€§èƒ½éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œè¯¦ç»†åˆ†æè§è®ºæ–‡ã€‚</p>
<h4 id="optimizations"><a class="header" href="#optimizations">Optimizations</a></h4>
<p>è®ºæ–‡ä¸­æåˆ°äº†å‡ ä¸ªå¯ä»¥æé«˜åè®®æ€§èƒ½çš„ä¼˜åŒ–ç‚¹:</p>
<ul>
<li>Witnesses: åªæ‰§è¡Œ VR Codeï¼Œä¸æ‰§è¡Œ Service Codeã€‚åŒæ—¶æ‰§è¡Œ VR Code å’Œ Service Code çš„èŠ‚ç‚¹è¢«ç§°ä¸º <code>active replica</code>ï¼Œprimary æ€»æ˜¯ <code>active replica</code></li>
<li>Batching: primary æ”¶é›†ä¸€å †è¯·æ±‚åŒæ—¶è¿è¡Œ VR åè®®ï¼Œä»¥æé«˜ throughput</li>
<li>Fast Reads
<ul>
<li>Reads at the Primary: ä¾èµ– lease é¿å…è¯»å– old primary ä¸­ stale çš„æ•°æ®ï¼Œä¸€ä¸ªæ–° view åªä¼šåœ¨ view change ç®—æ³•çš„ f + 1 ä¸ªå‚ä¸è€…çš„ lease ç»“æŸåæ‰å¼€å§‹ï¼Œè¿™æ ·ä¿è¯äº†æ–°è§†å›¾åœ¨æ—§ primary åœæ­¢å›å¤è¯»å–æ“ä½œåæ‰å¼€å§‹</li>
<li>Reads at Backups: å®¢æˆ·ç«¯ç»´æŠ¤ <em>last-request-number</em>ï¼Œå½“è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œreplica è¿”å›è¯·æ±‚çš„ op-numberï¼›å½“è¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œreplica è¿”å›å½“å‰çš„ commit-numberã€‚å®¢æˆ·ç«¯å°† replica è¿”å›çš„å€¼ä¿å­˜åœ¨ <em>last-request-number</em>ï¼Œåœ¨è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œå°†è¯¥å€¼åŒ…å«åœ¨è¯»è¯·æ±‚ä¸­ï¼Œreplica åªæœ‰åœ¨è‡³å°‘æ‰§è¡Œåˆ° <em>last-request-number</em> å¯¹åº”çš„æ“ä½œæ—¶æ‰ä¼šå›å¤å®¢æˆ·ç«¯ã€‚</li>
</ul>
</li>
</ul>
<h4 id="reconfiguration"><a class="header" href="#reconfiguration">Reconfiguration</a></h4>
<p>å½“æœ‰æœºå™¨ä¸å¯æ¢å¤ã€æ”¹å˜æœºå™¨è§„æ ¼æˆ–è€…éœ€è¦å¢å¤§æˆ–ç¼©å°é›†ç¾¤æœ€å¤§å®¹é”™æ•° f æ—¶ï¼Œéœ€è¦å¯¹é›†ç¾¤è¿›è¡Œ Reconfigurationã€‚å…·ä½“ç»†èŠ‚è§ paperï¼Œæœ¬æ–‡ç•¥ã€‚</p>
<p>å¦å¤– VR çš„ Reconfiguration åœ¨è¿›è¡Œä¸­ä¸èƒ½å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè¿™ç‚¹ Raft æ›´å…·ä¼˜åŠ¿ ?</p>
<br>
<p><a href="https://github.com/coilhq/tigerbeetle">TigerBeetle</a> å®ç°äº† VR protocolã€‚</p>
<h4 id="references-13"><a class="header" href="#references-13">References:</a></h4>
<p>[1] <a href="https://blog.acolyer.org/2015/03/02/viewstamped-replication-a-new-primary-copy-method-to-support-highly-available-distributed-systems/">Viewstamped replication</a>, a walk-through by Adrian Colyer<br>
[2] <a href="https://blog.acolyer.org/2015/03/06/viewstamped-replication-revisited/">Viewstamped Replication Revisited</a>, a walk-through by Adrian Colyer<br>
[3] <a href="https://www.youtube.com/watch?v=1EzNa-zAYS8">Bruno Bonacci on Viewstamped Replication @PWL London</a><br>
[4] <a href="https://www.youtube.com/watch?v=Wii1LX_ltIs">Paper #74. Viewstamped Replication Revisited</a> by Joran Dirk Greef<br></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemconsensusassetspdfszabpdfzab-high-performance-broadcast-for-primary-backup-systemsa"><a class="header" href="#a-hrefdistributedsystemconsensusassetspdfszabpdfzab-high-performance-broadcast-for-primary-backup-systemsa"><a href="distributedsystem/consensus/../../assets/pdfs/zab.pdf">Zab: High-performance broadcast for primary-backup systems</a></a></h3>
<blockquote>
<p>International Conference on Dependable Systems &amp; Networks (DSN), 2011</p>
<p>https://ieeexplore.ieee.org/document/5958223</p>
</blockquote>
<p>Zab: Zookeeper atomic broadcastï¼ŒåŸå­å¹¿æ’­åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¹Ÿç§°ä¸º total order broadcastã€‚Zookeeper ä½¿ç”¨ Zab åè®®å°†ç³»ç»Ÿçš„å¢é‡çŠ¶æ€ä¿®æ”¹åŒæ­¥åˆ°å¤‡èŠ‚ç‚¹ã€‚</p>
<blockquote>
<p>Due the dependence of an incremental state change on the
sequence of changes previously generated, Zab must guarantee
that if it delivers a given state change, then all other changes it
depends upon must be delivered first.</p>
</blockquote>
<p>ZooKeeper å¯¹ç³»ç»Ÿçš„è¦æ±‚æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„å¤šä¸ªæ“ä½œéœ€è¦èƒ½åŒæ—¶æ‰§è¡Œï¼Œä¸”ä¸¥æ ¼æŒ‰ç…§æ“ä½œçš„é¡ºåºæäº¤ã€‚ä¼ ç»Ÿçš„ Paxos å®ç°æ²¡æœ‰ç›´æ¥æä¾›è¿™æ ·çš„èƒ½åŠ›ï¼Œå½“å¤šä¸ªæ“ä½œåŒæ—¶è¿›è¡Œçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸‹å›¾çš„é—®é¢˜ï¼Œè™½ç„¶æ¯ä¸ªå€¼éƒ½è¾¾æˆäº†å…±è¯†ï¼Œä½†ä¸èƒ½ä¿æŒæ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p>
<p><img src="distributedsystem/consensus/../../assets/images/zab_paxos_run.jpg" alt="Paxos run" /></p>
<p>Zab è¿›ç¨‹æœ‰ä¸¤ä¸ªè§’è‰²ï¼Œleader å’Œ followerã€‚</p>
<blockquote>
<p>A leader concurrently executes the primary role and proposes transactions according to the order of broadcast calls of the primary.</p>
<p>Followers accept transactions according to the steps of the protocol.</p>
</blockquote>
<p>Leader ä¹Ÿä¼šæ‰§è¡Œ Follower çš„æ­¥éª¤ã€‚</p>
<h4 id="ç®—æ³•"><a class="header" href="#ç®—æ³•">ç®—æ³•</a></h4>
<p>éœ€è¦æŒä¹…åŒ–çš„æ•°æ®ï¼š</p>
<p><img src="distributedsystem/consensus/../../assets/images/zab_persistent_variables.jpg" alt="persistent variables" /></p>
<p>Zab åè®®åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>discovery
<img src="distributedsystem/consensus/../../assets/images/zab_phase1_discovery.jpg" alt="phase 1" /></li>
<li>synchronization
<img src="distributedsystem/consensus/../../assets/images/zab_phase2_synchronization.jpg" alt="phase 2" /></li>
<li>broadcast
<img src="distributedsystem/consensus/../../assets/images/zab_phase3_broadcast1.jpg" alt="phase31" />
<img src="distributedsystem/consensus/../../assets/images/zab_phase3_broadcast2.jpg" alt="phase32" /></li>
</ul>
<p>å…¶ä¸­ Synchronization é˜¶æ®µ Leader å°† Discovery é˜¶æ®µä» Follower æ”¶é›†çš„ history æ•°æ®é€‰æ‹©æœ€æ–°çš„æ•°æ®ï¼ˆStep l.1.2ï¼‰å¹¿æ’­ç»™ Follower èŠ‚ç‚¹ã€‚æ–‡ä¸­æåˆ°è¿™å—å¯ä»¥åšä¸ªä¼˜åŒ–:</p>
<blockquote>
<p>use a leader election primitive that selects a leader that has the latest epoch and has
accepted the transaction with highest zxid among a quorum of processes.</p>
</blockquote>
<p>è¿™ä¸ªä¼˜åŒ–æ­£æ˜¯ Raft çš„é€‰ä¸¾é˜¶æ®µçš„ <code>Election restriction</code>ï¼ŒRaft å°†æ­¤ä½œä¸ºä¸€ä¸ª Safty Propertyã€‚</p>
<p>Zab åè®®çš„æµç¨‹å›¾ç¤º:</p>
<p><img src="distributedsystem/consensus/../../assets/images/zab_protocol_summary.jpg" alt="Zab protocol summary" /></p>
<p><a href="distributedsystem/consensus/../../assets/pdfs/zab_theory_and_practice.pdf">ZooKeeperâ€™s Atomic Broadcast Protocol: Theory and practice</a> å¯¹ zab åŸç†åŠ Zookeeper ä¸­ zab çš„å®ç°ä½œäº†è¿›ä¸€æ­¥ä»‹ç»ã€‚</p>
<h4 id="references-14"><a class="header" href="#references-14">References</a></h4>
<p>[1] <a href="https://blog.acolyer.org/2015/03/09/zab-high-performance-broadcast-for-primary-backup-systems/">Zab: High-performance broadcast for primary-backup systems</a> by Adrian Colyer</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemconsensusassetspdfsviveladifferencepdfvive-la-difference-paxos-vs-viewstamped-replication-vs-zaba"><a class="header" href="#a-hrefdistributedsystemconsensusassetspdfsviveladifferencepdfvive-la-difference-paxos-vs-viewstamped-replication-vs-zaba"><a href="distributedsystem/consensus/../../assets/pdfs/viveLaDifference.pdf">Vive La Difference: Paxos vs. Viewstamped Replication vs. Zab</a></a></h3>
<blockquote>
<p>IEEE Transactions on Dependable and Secure Computing ( Volume: 12, Issue: 4, July-Aug. 1 2015)</p>
<p>https://doi.org/10.1109/TDSC.2014.2355848</p>
</blockquote>
<p>æœ¬è®ºæ–‡ä½¿ç”¨ <strong>refinement</strong> çš„æ–¹æ³•å¯¹ <strong>Paxos</strong>ã€<strong>Viewstamped Replication</strong> å’Œ <strong>Zab</strong> ä¸‰ç§å¤åˆ¶åè®®è¿›è¡Œäº†å¯¹æ¯”ã€‚</p>
<p>æ–‡ä¸­ç»™å‡ºäº†é€šç”¨ç®—æ³•åŠä¸‰ç§åè®®ä¸åŒæœ¯è¯­çš„å¯¹æ¯”:</p>
<p><img src="distributedsystem/consensus/../../assets/images/vive_la_difference_terms.jpg" alt="terms" /></p>
<p>è®ºæ–‡åœ¨ Replication å±‚å°†ç®—æ³•åˆ†ä¸º Active Replication å’Œ Passive Replication:</p>
<ul>
<li>Active Replication: also known as <strong>state machine replication</strong>, each replica implements a deterministic state machine. All replicas process the same operations in the same order.</li>
<li>Passive Replication: also known as <strong>primary backup</strong>, a primary replica runs a deterministic state machine, while backups only store states. The primary computes a sequence of new application states by processing operations and forwards these states to each backup in order of generation.</li>
</ul>
<p>è®ºæ–‡å°† VR å’Œ Zab å½’ç±»ä¸º Passive Replicationï¼Œè¿™æ˜¯æˆ‘ä¸å¤ªç†è§£çš„åœ°æ–¹ã€‚æœ¬ç¯‡è®ºæ–‡åªæ˜¯æµè§ˆäº†ä¸€éï¼Œä¹‹åå¯èƒ½ä¼šå›è¿‡å¤´å†æ¬¡å­¦ä¹ ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemconsensusassetspdfsraftpdfin-search-of-an-understandable-consensus-algorithma"><a class="header" href="#a-hrefdistributedsystemconsensusassetspdfsraftpdfin-search-of-an-understandable-consensus-algorithma"><a href="distributedsystem/consensus/../../assets/pdfs/raft.pdf">In Search of an Understandable Consensus Algorithm</a></a></h3>
<blockquote>
<p>USENIX ATC'14</p>
<p>https://dl.acm.org/doi/10.5555/2643634.2643666</p>
</blockquote>
<p>å…±è¯†ç®—æ³•é€šå¸¸ä¼´éšç€å¤åˆ¶çŠ¶æ€æœºï¼ˆreplicated state machinesï¼‰ï¼Œè€Œå¤åˆ¶çŠ¶æ€æœºé€šå¸¸ä½¿ç”¨ <code>relicated log</code> å®ç°ï¼Œæ¯å°æœåŠ¡å™¨å­˜å‚¨åŒ…å«ä¸€ç³»åˆ—å‘½ä»¤çš„æ—¥å¿—ï¼ŒçŠ¶æ€æœºæŒ‰åºæ‰§è¡Œè¿™äº›æ—¥å¿—ï¼Œå¦‚æœå„çŠ¶æ€æœºä»¥ç›¸åŒçš„çŠ¶æ€å¼€å§‹å¹¶ä»¥ç›¸åŒçš„é¡ºåºæ‰§è¡Œç›¸åŒçš„è¾“å…¥ï¼Œå®ƒä»¬å°†ä»¥ç›¸åŒçš„çŠ¶æ€ç»“æŸå¹¶äº§ç”Ÿç›¸åŒçš„è¾“å‡ºã€‚</p>
<blockquote>
<p>Keeping the replicated log consistent is the job of the consensus algorithm.</p>
</blockquote>
<h4 id="whats-wrong-with-paxos"><a class="header" href="#whats-wrong-with-paxos">What's wrong with Paxos?</a></h4>
<ul>
<li>The first drawback is that Paxos is exceptionally difficult to understand.</li>
<li>The second problem with Paxos is that it does not provide a good foundation for building practical implementations.</li>
</ul>
<p>è€Œ Raft åˆ™å°† <strong>æ˜“äºç†è§£</strong> ä½œä¸ºæœ€é‡è¦çš„è®¾è®¡ç›®æ ‡ï¼Œç®—æ³•è®¾è®¡å‡ºæ¥åº”è¯¥èƒ½è¢«å¤§éƒ¨åˆ†äººè½»æ¾ç†è§£ï¼Œèƒ½å¤Ÿè®©äººäº§ç”Ÿç›´è§‰ï¼Œè¿›è€Œå¯ä»¥è¢«æ›´å¤šçš„å¼€å‘è€…å®ç°å‡ºæ¥ã€‚</p>
<h4 id="raft-åŸºæœ¬æ¦‚å¿µ"><a class="header" href="#raft-åŸºæœ¬æ¦‚å¿µ">Raft åŸºæœ¬æ¦‚å¿µ</a></h4>
<p>Raft ç®—æ³•åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†:</p>
<ul>
<li>Leader election</li>
<li>Log replication</li>
<li>Safty</li>
</ul>
<p>ä¸€ä¸ª Raft é›†ç¾¤åŒ…å«å¤šå°æœåŠ¡å™¨ï¼ˆé€šå¸¸ä¸ºå¥‡æ•°ï¼‰ï¼Œ<code>2f + 1</code> å°æœºå™¨èƒ½å®¹å¿ <code>f</code> å°æœºå™¨å‡ºé”™ï¼ˆnon-Byzantine faultï¼‰ï¼Œä¸€å°æœºå™¨åœ¨ä»»æ„æ—¶åˆ»å¤„äºä»¥ä¸‹ä¸‰ç§çŠ¶æ€ä¸­çš„ä¸€ç§:</p>
<ul>
<li>leader</li>
<li>follower</li>
<li>candidate</li>
</ul>
<p>å…¶çŠ¶æ€è½¬æ¢è¿‡ç¨‹:</p>
<p><img src="distributedsystem/consensus/../../assets/images/raft-server-states.jpg" alt="raft server states" /></p>
<p>Raft æŠŠæ—¶é—´åˆ†ä¸ºå¤šä¸ª <code>term</code>ï¼Œæ¯ä¸ª <code>term</code> çš„é•¿åº¦ç”±é›†ç¾¤çš„çŠ¶æ€å†³å®šï¼Œå½“ <code>leader</code> å¤±æ•ˆåï¼Œå…¶ä¸­ä¸€ä¸ª <code>follower</code> å˜ä¸º <code>candidate</code> å¹¶ä½œå‡ºé€‰ä¸¾ï¼Œç›¸åº”çš„ <code>term</code> è¿›è¡ŒåŠ ä¸€ï¼Œä½†ä¸€ä¸ª <code>term</code> ä¸ä¸€å®šæœ‰ <code>leader</code>ï¼Œè¿™æ˜¯ç”±äºå¤šä¸ª <code>follower</code> åŒæ—¶æå‡ºé€‰ä¸¾ï¼Œå¯èƒ½ä¼šå‡ºç° <code>split vote</code>ã€‚</p>
<p><img src="distributedsystem/consensus/../../assets/images/raft-terms.jpg" alt="raft terms" /></p>
<blockquote>
<p>Raftâ€™s basic consensus algorithm depends on only two message (RPC) types: RequestVote and AppendEntries.</p>
</blockquote>
<h4 id="leader-election"><a class="header" href="#leader-election">Leader election</a></h4>
<p>Raft ä½¿ç”¨å¿ƒè·³æœºåˆ¶ï¼ˆ<code>AppendEntries RPCs</code> that carry no log entriesï¼‰æ¥ç»´æŠ¤ <code>leader</code> çš„æƒå¨æ€§ï¼Œä¸€ä¸ª <code>follower</code> åªè¦æ”¶åˆ°å¿ƒè·³ä¼šä¸€ç›´ä¿æŒåœ¨ follower çŠ¶æ€ã€‚å¦‚æœ <code>follwer</code> åœ¨ <strong>election timeout (150-300ms ä¹‹é—´çš„ä¸€ä¸ªéšæœºå€¼)</strong> ä¹‹åæœªæ”¶åˆ°å¿ƒè·³ï¼Œå…¶çŠ¶æ€å˜ä¸º <code>candidate</code>ï¼Œterm + 1ï¼ŒæŠ•ç¥¨ç»™è‡ªå·±å¹¶ä½¿ç”¨ <code>RequestVote</code> RPC å‘å…¶å®ƒèŠ‚ç‚¹ç´¢è¦æŠ•ç¥¨ï¼Œè¯¥èŠ‚ç‚¹å¤„äº <code>candidate</code> çŠ¶æ€ç›´åˆ°ä»¥ä¸‹ä¸‰ç§æƒ…ä¹‹ä¸€å‘ç”Ÿ:</p>
<ol>
<li>å¾—åˆ°å¤šæ•°æŠ•ç¥¨èµ¢å¾—é€‰ä¸¾ï¼ŒçŠ¶æ€å˜ä¸º leader</li>
<li>å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹èµ¢å¾—é€‰ä¸¾ï¼ŒçŠ¶æ€å˜ä¸º follower</li>
<li>ä¸€æ®µæ—¶é—´è¿‡å»äº†ï¼Œæ²¡æœ‰ leader è¢«é€‰å‡ºï¼Œæ­¤æ—¶è¯¥ term å†…æ²¡æœ‰ leaderï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡é€‰ä¸¾</li>
</ol>
<p>å¦‚æœ RPC ä¸­è¿”å›çš„ term å¤§äº candidate è‡ªèº« termï¼Œæ›´æ–° term å¹¶å°†è‡ªèº«çŠ¶æ€å˜ä¸º followerï¼Œæ­¤ç§æƒ…å†µå½’ç±»ä¸ºå¦‚ä¸Š 2ã€‚</p>
<p><em>Liveness propery</em></p>
<p>éšæœºé€‰ä¸¾è¶…æ—¶æ—¶é—´ä¿è¯äº†çŸ­æ—¶é—´å†…æœ‰ <code>leader</code> å½“é€‰ï¼Œi.e. something good eventually happensã€‚</p>
<p><em>Safety property</em></p>
<p><code>votedFor</code> å’Œ <code>currentTerm</code> æŒä¹…åŒ–ä¿è¯äº†åŒä¸€ <code>term</code> åªèƒ½æœ‰ä¸€ä¸ª <code>leader</code> å½“é€‰ï¼Œi.e. nothing bad happensã€‚</p>
<h4 id="log-replication"><a class="header" href="#log-replication">Log replication</a></h4>
<p>å½“ä¸€ä¸ªèŠ‚ç‚¹è¢«é€‰ä¸º <code>leader</code> åï¼Œå®ƒå¼€å§‹æœåŠ¡å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚éƒ½åŒ…å«ä¸€ä¸ªéœ€è¦è¢« <code>relicated state machines</code> æ‰§è¡Œçš„å‘½ä»¤ï¼Œleader èŠ‚ç‚¹å°†è¯¥å‘½ä»¤åŒ…è£…ä¸º entry(leader çš„ currentTerm + å‘½ä»¤æœ¬èº«) è¿½åŠ å†™åˆ°è‡ªå·±çš„ logï¼Œç„¶åå°†è¯¥ entry å¹¶å‘ä½¿ç”¨ <code>AppendEntries</code> å‘é€ç»™ <code>follower</code> èŠ‚ç‚¹ï¼Œå½“å¤šæ•°æ´¾æ”¶åˆ°è¯¥ entry åï¼Œ<code>leader</code> å°†è¯¥ entry æäº¤ç»™çŠ¶æ€æœºæ‰§è¡Œï¼Œå¹¶è¿”å›å®¢æˆ·ç«¯æ‰§è¡Œç»“æœã€‚</p>
<p>å½“ <code>leader</code> èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°æ—¥å¿—ä¸ä¸€è‡´çš„æƒ…å†µï¼ŒRaft é€šè¿‡å¼ºåˆ¶ <code>follower</code> å¤åˆ¶ <code>leader</code> çš„æ—¥å¿—æ¥è§£å†³ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
<blockquote>
<p>To bring a followerâ€™s log into consistency with its own, the leader must find the latest log entry where the two
logs agree, delete any entries in the followerâ€™s log after that point, and send the follower all of the leaderâ€™s
entries after that point.</p>
</blockquote>
<p>é€šè¿‡åœ¨ Leader èŠ‚ç‚¹ä¸ºæ¯ä¸ª <code>follower</code> ç»´æŠ¤ä¸€ä¸ª <code>nextIndex</code> å€¼ï¼Œå½“ <code>AppendEntries</code> å‘é€çš„æ—¥å¿—ä¸ <code>follower</code> èŠ‚ç‚¹çš„æ—¥å¿—ä¸åŒ¹é…æ—¶ï¼Œ<code>leader</code> èŠ‚ç‚¹å°†å¯¹åº” <code>follower</code> çš„ <code>nextIndex</code> å€¼å‡ä¸€ï¼Œç›´åˆ°æ‰¾åˆ°åŒ¹é…çš„ä½ç½®é‡æ–°å‘é€ã€‚è¯¥è¿‡ç¨‹ä¿è¯äº† <code>Log Matching Property</code>:</p>
<blockquote>
<p>If two entries in different logs have the same index and term, then they store the same command.
If two entries in different logs have the same index and term, then the logs are identical in all preceding entries.</p>
</blockquote>
<p>è¿™ç§æœºåˆ¶ä½¿å¾— <code>leader</code> èŠ‚ç‚¹ä¸éœ€è¦åšä»»ä½•ç‰¹æ®Šå¤„ç†å°±èƒ½å¤Ÿæ¢å¤æ—¥å¿—çš„ä¸€è‡´æ€§ï¼Œ<code>leader</code> èŠ‚ç‚¹ä»ä¸è¦†ç›–å†™æˆ–åˆ é™¤å·²æœ‰çš„æ—¥å¿—ï¼ˆLeader Append-Only Propertyï¼‰ã€‚ä½†éœ€è¦å¯¹é€‰ä¸¾çš„è¿‡ç¨‹åšä¸€äº›é¢å¤–é™åˆ¶æ¥é¿å…å·²ç»æäº¤çš„æ—¥å¿—è¢«åˆ é™¤ã€‚</p>
<p><em>Election restriction</em></p>
<blockquote>
<p>A candidate must contact a majority of the cluster in order to be elected, which means that every
committed entry must be present in at least one of those servers. If the candidateâ€™s log is at least
as up-to-date as any other log in that majority then it will hold all the committed entries.</p>
</blockquote>
<p><code>up-to-date</code> å®šä¹‰ä¸º:</p>
<ul>
<li>If the logs have last entries with different terms, then the log with the later term is more up-to-date.</li>
<li>If the logs end with the same term, then whichever log is longer is more up-to-date.</li>
</ul>
<p><em>Commitment rules</em></p>
<ul>
<li>Raft never commits log entries from previous terms by counting replicas.</li>
<li>Only log entries from the leaderâ€™s current term are committed by counting replicas.</li>
<li>once an entry from the current term has been committed in this way, then all prior entries are committed indirectly because of the Log Matching Property.</li>
</ul>
<p>å¦‚ä¸Šè§„åˆ™èƒ½é¿å…ä¸‹å›¾ä¸­çš„é—®é¢˜:</p>
<p><img src="distributedsystem/consensus/../../assets/images/raft-never-commit-previouse-term-by-counting-replicas.jpg" alt="a leader cannot determine commitment using log entries from older terms" /></p>
<h4 id="rafts-5-guarantees"><a class="header" href="#rafts-5-guarantees">Raft's 5 guarantees</a></h4>
<ol>
<li><strong>Election Safety:</strong> at most one leader can be elected in a given term.</li>
<li><strong>Leader Append-Only:</strong> a leader never overwrites or deletes entries in its log; it only appends new entries.</li>
<li><strong>Log Matching:</strong> if two logs contain an entry with the same index and term, then the logs are identical in all entries up through the given index.</li>
<li><strong>Leader Completeness:</strong> if a log entry is committed in a given term, then that entry will be present in the logs of the leaders for all higher-numbered terms.</li>
<li><strong>State Machine Safety:</strong> if a server has applied a log entry at a given index to its state machine, no other server will ever apply a different log entry for the same index.</li>
</ol>
<h4 id="optimizations-1"><a class="header" href="#optimizations-1">Optimizations</a></h4>
<ol>
<li>when rejecting an AppendEntries request, the followe rcan include the term of the conflicting entry and the first index it stores for that term. With this information, the leader can decrement nextIndex to bypass all of the conflicting entries in that term</li>
<li>Diego Ongaro's Ph.D. dissertation describes an optional <code>PreVote</code> phase in Raft that is designed to prevent a partitioned server from disrupting the cluster by forcing a re-election when it rejoins the cluster.</li>
</ol>
<h4 id="cluster-membership-changes"><a class="header" href="#cluster-membership-changes">Cluster Membership Changes</a></h4>
<p>Raft ä½¿ç”¨ <code>joint consensus</code> ç®—æ³•æ¥ä¿è¯é…ç½®åˆ‡æ¢æœŸé—´ä¸ä¼šå‡ºç°åŒ <code>leader</code> ä¸”èƒ½æŒç»­æœåŠ¡å®¢æˆ·ç«¯ã€‚</p>
<h4 id="references-15"><a class="header" href="#references-15">References:</a></h4>
<p>[1] <a href="https://raft.github.io/">Raft Homepage</a><br>
[2] <a href="https://www.youtube.com/watch?v=YbZ3zDzDnrw">Raft lecture (Raft user study)</a> by by John Ousterhout<br>
[3] <a href="https://www.youtube.com/watch?v=vYp4LYbnnW8">Designing for Understandability: The Raft Consensus Algorithm</a> by John Ousterhout<br>
[4] <a href="distributedsystem/consensus/../../assets/pdfs/raft-extended-version.pdf">In Search of an Understandable Consensus Algorithm (Extended Version)</a><br>
[5] <a href="https://github.com/ongardie/dissertation#readme">Diego Ongaro's Ph.D. dissertation</a><br>
[6] <a href="https://thesquareplanet.com/blog/students-guide-to-raft/">Students' Guide to Raft</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemconsensusassetspdfspaxos_vs_raftpdfpaxos-vs-raft-have-we-reached-consensus-on-distributed-consensusa"><a class="header" href="#a-hrefdistributedsystemconsensusassetspdfspaxos_vs_raftpdfpaxos-vs-raft-have-we-reached-consensus-on-distributed-consensusa"><a href="distributedsystem/consensus/../../assets/pdfs/paxos_vs_raft.pdf">Paxos vs Raft: have we reached consensus on distributed consensus?</a></a></h3>
<blockquote>
<p>Proceedings of the 7th Workshop on Principles and Practice of Consistency for Distributed Data, April 2020</p>
<p>https://dl.acm.org/doi/abs/10.1145/3380787.3393681</p>
</blockquote>
<p>è™½ç„¶æœ‰å¾ˆå¤šåˆ†å¸ƒå¼å…±è¯†åè®®è¢«æå‡ºï¼ŒPaxos å’Œ Raft æ— ç–‘æ˜¯å·¥ä¸šç•Œçš„ä¸¤ä¸ªä¸»å®°ï¼ˆä½œè€…å¯èƒ½å°† Zab å½’ç±»ä¸º paxos alike ?ï¼‰ã€‚Paxos ç®—æ³•è¢«è®¤ä¸ºæ˜¯åˆ†å¸ƒå¼å…±è¯†çš„<em>åŒä¹‰è¯</em>ï¼Œä½†å®ƒä¹Ÿå› éš¾ç†è§£ã€éš¾å®ç°è€Œè‘—ç§°ï¼›Raft å°†æ˜“äºç†è§£è§†ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œå¹¶ä¸”èƒ½å¤Ÿè¾¾åˆ°è·Ÿ Paxos ä¸€æ ·çš„æ€§èƒ½ã€‚</p>
<p>Paxos å’Œ Raft éå¸¸ç›¸ä¼¼ï¼Œä»…ä»…åœ¨ <code>leader election</code> ä¸Šæœ‰æ‰€åŒºåˆ«ã€‚Raft é€šè¿‡ <code>Election restriction</code> é™åˆ¶äº†åªæœ‰å…¶æœ¬åœ°æ—¥å¿— up-to-date çš„ replica æ‰èƒ½è¢«é€‰ä¸¾ä¸º leaderï¼›è€Œ Paxos åˆ™å…è®¸æœ¬åœ°æ—¥å¿—é up-to-date çš„ replica è¢«é€‰ä¸º Leaderï¼Œç„¶åå°†å…¶æ—¥å¿—æ›´æ–°ä¸º up-to-dateã€‚</p>
<blockquote>
<p>Raftâ€™s approach is surprisingly efficient given its simplicity as, unlike Paxos, 
it does not require log entries to be exchanged during leader election.</p>
</blockquote>
<p>è®ºæ–‡ä»¥ Raft çš„æ¥å£é£æ ¼å®šä¹‰äº†ä¸€ç§ Paxos ç®—æ³•ï¼ˆè§é™„å½• A &amp; Bï¼‰ï¼Œreplica åœ¨ä»»æ„æ—¶åˆ»çš„çŠ¶æ€ä¸º <code>Follower</code>ã€<code>Candidate</code>ã€<code>Leader</code> å…¶ä¸­çš„ä¸€ç§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="distributedsystem/consensus/../../assets/images/paxos-vs-raft-state-transitions.jpg" alt="State transitions between the server states for Paxos &amp; Raft" /></p>
<p>åœ¨ Leader ä¸å¤±æ•ˆå¤„ç† Normal Operation æ—¶ï¼Œéƒ½æ˜¯ä¾èµ– quorum å®Œæˆå¤åˆ¶çŠ¶æ€æœºçš„æ“ä½œã€‚</p>
<p>å½“ Leader å¤±æ•ˆæ—¶ï¼Œéœ€è¦é€‰ä¸¾å‡ºæ–°çš„ Leaderï¼ŒPaxos å’Œ Raft åœ¨é€‰ä¸»çš„è¿‡ç¨‹ä¸­ä½¿ç”¨äº†ä¸åŒçš„æ–¹æ³•ï¼š</p>
<ul>
<li>Paxos
<ul>
<li>Follower åœ¨ä¸€å®šæ—¶é—´å†…æœªæ”¶åˆ° <code>AppendEntries</code>ï¼Œå°†çŠ¶æ€å˜ä¸º Candidateï¼Œå°†å…¶ term æ›´æ”¹ä¸º t (t mod n = s, n ä¸º replicas ä¸ªæ•°ï¼Œs ä¸ºè¯¥èŠ‚ç‚¹çš„ index)</li>
<li>Candidate å‘æ‰€æœ‰å…¶å®ƒ replica å‘é€ <code>RequestVote</code>ï¼ŒåŒ…å« t å’Œ commit index</li>
<li>å…¶å®ƒ replica æ”¶åˆ° <code>RequestVote</code> åï¼Œå¦‚æœè¯·æ±‚çš„ t å¤§äºè‡ªå·±çš„ termï¼Œåˆ™å›å¤è¯¥æ¶ˆæ¯ï¼Œé™„å¸¦æœ¬åœ° commit index ä¹‹åçš„æ—¥å¿—</li>
<li>åœ¨æ”¶åˆ°å¤šæ•°æ´¾ replica æ¢å¤çš„æ¶ˆæ¯ä¹‹åï¼ŒCandidate é€šè¿‡å¯¹æ¯”æ”¶åˆ°çš„æ—¥å¿—æ¥æ›´æ–°æœ¬åœ°æ—¥å¿—å¹¶å½“é€‰ Leader</li>
</ul>
</li>
<li>Raft
<ul>
<li>Follower åœ¨ä¸€å®šæ—¶é—´å†…æœªæ”¶åˆ° <code>AppendEntries</code>ï¼Œå°†è‡ªèº«çŠ¶æ€å˜ä¸º Candidate å¹¶å¢åŠ å…¶ term</li>
<li>Candidate å‘æ‰€æœ‰å…¶å®ƒ replica å‘é€ <code>RequestVote</code>ï¼ŒåŒ…å«å¢åŠ åçš„ term åŠæ—¥å¿— index</li>
<li>å…¶å®ƒ replica æ”¶åˆ° <code>RequestVote</code> åï¼Œå¦‚æœè¯·æ±‚é™„å¸¦çš„ term å¤§äºæˆ–ç­‰äº replica çš„ termï¼Œä¸” replica åœ¨è¯¥ term æœª VoteFor å…¶å®ƒ candidateï¼Œä¸” Candidate çš„æ—¥å¿—è‡³å°‘ä¸ replica çš„æ—¥å¿—ä¸€æ ·æ–°ï¼ˆby ensuring that the candidateâ€™s last log term is greater than the serverâ€™s or, if they are the same, that the candidateâ€™s last index is greater than the serverâ€™sï¼‰ï¼Œreplica å›å¤ Candidate</li>
<li>Candidate åœ¨æ”¶åˆ°å¤šæ•°æ´¾å›å¤æ¶ˆæ¯åï¼Œå½“é€‰ Leader å¹¶å¼€å§‹æœåŠ¡</li>
<li>Raft çš„ä¸€ä¸ª safty property: the leader does not update its commit index until at least one log entry from the new term has been committed</li>
</ul>
</li>
</ul>
<p>ä¸¤ç§ç®—æ³•éƒ½å…·æœ‰å¦‚ä¸‹ç‰¹æ€§:</p>
<ul>
<li>State Machine Safety: If a server has applied a log entry at a given index to its state machine, no other server will ever apply a different log entry for the same index.</li>
<li>Leader Completeness: If an operation op is committed at index i by a leader in term t then all leaders of terms &gt; t will also have operation op at index i.</li>
</ul>
<p>Raft å’Œ Paxos <code>leader election</code> çš„ä¸åŒæ€»ç»“å¦‚ä¸‹:</p>
<p><img src="distributedsystem/consensus/../../assets/images/paxos_vs_raft_difference.jpg" alt="Summary of the differences between Paxos and Raft" /></p>
<p>ç»“è®º:</p>
<blockquote>
<p>We conclude that there is no significant difference in understandability between the algorithms, 
and that Raftâ€™s leader election is surprisingly efficient given its simplicity.</p>
</blockquote>
<h4 id="references-16"><a class="header" href="#references-16">References:</a></h4>
<p>[1] <a href="https://www.youtube.com/watch?v=JQss0uQUc6o">Paxos vs Raft: Have we reached consensus on distributed consensus?</a> explained by Heidi Howard<br>
[2] <a href="https://www.youtube.com/watch?v=0K6kt39wyH0">Paxos vs Raft: Have we reached consensus on distributed consensus?</a> more detailed explanation by Heidi Howard</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="scheduler"><a class="header" href="#scheduler">scheduler</a></h2>
<ul>
<li><strong><a href="distributedsystem/scheduler/borg.html">Large-scale cluster management at Google with Borg</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemschedulerassetspdfsborgpdflarge-scale-cluster-management-at-google-with-borga"><a class="header" href="#a-hrefdistributedsystemschedulerassetspdfsborgpdflarge-scale-cluster-management-at-google-with-borga"><a href="distributedsystem/scheduler/../../assets/pdfs/borg.pdf">Large-scale cluster management at Google with Borg</a></a></h3>
<blockquote>
<p>Proceedings of the Tenth European Conference on Computer Systems, April 2015</p>
<p>https://dl.acm.org/doi/10.1145/2741948.2741964</p>
</blockquote>
<p>Borg ä½œä¸º Kubernetes çš„å‰èº«ï¼Œåœ¨ Google å†…éƒ¨ç®¡ç†ç€å¤šä¸ªæ‹¥æœ‰ä¸Šä¸‡å°æœºå™¨çš„é›†ç¾¤ã€‚å®ƒçš„ä¸‰ä¸ªä¸»è¦å¥½å¤„:</p>
<ol>
<li>hides the details of resource management and failure handling so its users can focus on application development instead</li>
<li>operates with very high reliability and availability, and supports applications that do the same</li>
<li>lets us run workloads across tens of thousands of machines effectively</li>
</ol>
<p>ç”¨æˆ·å°† job æäº¤ç»™ Borgï¼Œæ¯ä¸ªä»»åŠ¡è¿è¡Œåœ¨ä¸€ä¸ª Borg cellï¼ˆa set of machines that are managed as a unitï¼‰ ä¸­ï¼ŒBorg cells çš„ä»»åŠ¡è´Ÿè½½ä¸»è¦åŒ…å«ä¸¤ç±»ï¼š</p>
<ul>
<li>long-running services that should â€œneverâ€ go down, and handle short-lived latency-sensitive requests (a few ms to a few hundred ms).</li>
<li>batch jobs that take from a few seconds to a few days to complete; these are much less sensitive to short-term performance fluctuations.</li>
</ul>
<p>Google å†…éƒ¨çš„å¾ˆå¤šåº”ç”¨æ¡†æ¶éƒ½æ„å»ºåœ¨ Borg ä¹‹ä¸Šï¼Œæ¯”å¦‚ MapReduceã€FlumeJavaã€MillWheelã€Pregelï¼›GFSã€CFSã€Bigtableã€Megastore ç­‰åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿä¹Ÿéƒ½è¿è¡Œåœ¨ Borg ä¸Šã€‚</p>
<h4 id="borg-ä¸­çš„æ¦‚å¿µ"><a class="header" href="#borg-ä¸­çš„æ¦‚å¿µ">Borg ä¸­çš„æ¦‚å¿µ</a></h4>
<p>Borg çš„å·¥ä½œè´Ÿè½½æ²¡æœ‰è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šï¼Œå› ä¸º Google ä¸æƒ³æ‰¿æ‹…è¿™éƒ¨åˆ†å¼€é”€ã€‚</p>
<ul>
<li>cell: åŒ…å«ä¸€ç»„æœºå™¨ï¼Œä¸€ä¸ª median cell é€šå¸¸åŒ…å« 10k å°æœºå™¨</li>
<li>cluster: ä¸€ä¸ª cluster è¿è¡Œåœ¨æ•°æ®ä¸­å¿ƒçš„ä¸€ä¸ªå»ºç­‘ä¸­ï¼Œä¸€ä¸ª cluster é€šå¸¸æ‰˜ç®¡ä¸€ä¸ª large cell å¹¶ä¸”å¯èƒ½æ‰˜ç®¡å‡ ä¸ªæµ‹è¯•æˆ–ç‰¹æ®Šç›®çš„çš„å‡ ä¸ª small cell</li>
<li>job: è¿è¡Œåœ¨å•ä¸ª cellï¼ŒåŒ…å«äº† nameã€owener åŠè¿è¡Œ tasks æ•°é‡ç­‰å±æ€§ï¼Œå¹¶ä¸”çº¦æŸè¿è¡Œä»»åŠ¡æœºå™¨éœ€è¦æ»¡è¶³çš„æ¡ä»¶ï¼ˆCPU archã€OS versionã€external IP ç­‰ï¼‰</li>
<li>task: æ˜ å°„ä¸ºè¿è¡Œåœ¨å•æœºä¸Šçš„ä¸€ç»„ Linux è¿›ç¨‹ï¼Œæ¯ä¸ª Linux è¿›ç¨‹è¿è¡Œåœ¨ä¸€ä¸ªå®¹å™¨ä¸­</li>
<li>alloc: ä¸€å°æœºå™¨ä¸Šçš„ä¸€ç»„é¢„ç•™èµ„æº</li>
<li>priority: æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªæ•°å­—ä¼˜å…ˆçº§ï¼Œç”¨äºèµ„æºçš„æŠ¢å </li>
<li>quota: ç”¨äºå†³å®š job æ˜¯å¦èƒ½è¢«è°ƒåº¦ï¼Œquota è¡¨ç¤ºä¸ºèµ„æºï¼ˆCPU, RAM, diskï¼‰éœ€æ±‚é‡çš„æ•°ç»„</li>
<li>naming: ç”¨äºä»»åŠ¡å‘ç°ï¼Œå°†ä»»åŠ¡çš„ hostname åŠ port ç­‰ä¿¡æ¯æŒä¹…åŒ–åˆ° Chubby</li>
</ul>
<p>å¤§å¤šæ•° job å¯æè¿°ä¸ºå£°æ˜å¼çš„é…ç½®è¯­è¨€: BCLã€‚</p>
<p>job å’Œ task çš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="distributedsystem/scheduler/../../assets/images/borg-state-diagram.jpg" alt="state diagram for both jobs and tasks" /></p>
<blockquote>
<p>A user can change the properties of some or all of the tasks in a running job by 
pushing a new job configuration to Borg, and then instructing Borg to <strong>update</strong> 
the tasks to the new specification.</p>
</blockquote>
<h4 id="borg-architecture"><a class="header" href="#borg-architecture">Borg architecture</a></h4>
<p><img src="distributedsystem/scheduler/../../assets/images/borg-architecutre.jpg" alt="architecture" /></p>
<p>æ¯ä¸ª cell åŒ…å«ä¸€ç»„ Borgmaster å’Œ Schedulerï¼ŒBorgmaster é€»è¾‘ä¸Šæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œä½†å®é™…ä¸Šæœ‰ 5 ä¸ªå‰¯æœ¬ä»¥ä¿è¯é«˜å¯ç”¨ã€‚</p>
<blockquote>
<p>Each replica maintains an in-memory copy of most of the state of the cell, 
and this state is also recorded in a highly-available, distributed, 
Paxos-based store on the replicasâ€™ local disks.</p>
</blockquote>
<p>Borgmaster è´Ÿè´£å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆå¦‚ create jobã€lookup jobï¼‰ã€ç®¡ç†èµ„æºï¼ˆmachinesã€tasksã€allocsï¼‰çš„çŠ¶æ€æœºã€ä¸ Borglets é€šä¿¡å¹¶æä¾› web UIã€‚</p>
<p>å½“ä¸€ä¸ª job æäº¤åï¼ŒBorgmaster å°†å…¶æŒä¹…åŒ–åˆ° Paxos store å¹¶å°† job å¯¹åº”çš„ tasks é™„åŠ åˆ° pending é˜Ÿåˆ—ï¼Œscheduler å¼‚æ­¥æ‰«æåå°† tasks æŒ‡æ´¾ç»™æ»¡è¶³ job çº¦æŸçš„æœºå™¨ã€‚è°ƒåº¦ç®—æ³•åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†:</p>
<ol>
<li>feasibility checking: å¯»æ‰¾æ»¡è¶³ task çº¦æŸä¸”èµ„æºè¶³å¤Ÿçš„ä¸€ç»„æœºå™¨</li>
<li>scoring: æ ¹æ®è§„åˆ™ä»è¿™ç»„æœºå™¨é€‰æ‹©ä¸€ä¸ªæ¥è¿è¡Œ task</li>
</ol>
<blockquote>
<p>The score takes into account user-specified preferences, but is mostly driven by 
built-in criteria such as minimizing the number and priority of preempted tasks, 
picking machines that already have a copy of the taskâ€™s packages, spreading tasks 
across power and failure domains, and packing quality including putting a mix of 
high and low priority tasks onto a single machine to allow the high-priority ones 
to expand in a load spike.</p>
</blockquote>
<p>ä¸ºäº†ä¿æŒå¯ç”¨æ€§ï¼ŒBorg ä½¿ç”¨äº†å¦‚ä¸‹ç­–ç•¥:</p>
<ul>
<li>automatically reschedules evicted tasks, on a new machine if necessary;</li>
<li>reduces correlated failures by spreading tasks of a job across failure domains such as machines, racks, and power domains;</li>
<li>limits the allowed rate of task disruptions and the number of tasks from a job that can be simultaneously down during maintenance activities such as OS or machine upgrades;</li>
<li>uses declarative desired-state representations and idempotent mutating operations, so that a failed client can harmlessly resubmit any forgotten requests;</li>
<li>rate-limits finding new places for tasks from machines that become unreachable, because it cannot distinguish between large-scale machine failure and a network partition;</li>
<li>avoids repeating task::machine pairings that cause task or machine crashes;</li>
<li>recovers critical intermediate data written to local disk by repeatedly re-running a logsaver task, even if the alloc it was attached to is terminated or moved to another machine. Users can set how long the system keeps trying, a few days is common.</li>
</ul>
<h4 id="references-17"><a class="header" href="#references-17">References</a></h4>
<p>[1] <a href="https://kubernetes.io/blog/2015/04/borg-predecessor-to-kubernetes/">Borg: The Predecessor to Kubernetes</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemassetspdfsa_principle_for_resilient_sharing_of_distributed_reourcespdfa-principle-for-resilient-sharing-of-distributed-resourcesa"><a class="header" href="#a-hrefdistributedsystemassetspdfsa_principle_for_resilient_sharing_of_distributed_reourcespdfa-principle-for-resilient-sharing-of-distributed-resourcesa"><a href="distributedsystem/../assets/pdfs/a_principle_for_resilient_sharing_of_distributed_reources.pdf">A principle for resilient sharing of distributed resources</a></a></h3>
<blockquote>
<p>Proceedings of the 2nd International Conference on Software Engineering, October 1976</p>
<p>https://dl.acm.org/doi/10.5555/800253.807732</p>
</blockquote>
<p>æœ¬æ–‡æå‡ºäº† primary/backup å¤åˆ¶æ¨¡å‹ï¼Œå…¶æœ¬è´¨æ˜¯å°†å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºä¸»ï¼Œå…¶å®ƒå‡ ç‚¹ä½œä¸ºå¤‡ä»½ã€‚ä»»ä¸€å¤‡ä»½èŠ‚ç‚¹éƒ½å¯ä»¥æ‰§è¡Œä¸»èŠ‚ç‚¹çš„èŒè´£ï¼Œå› æ­¤ primary è§’è‰²å¯ä»¥è¿ç§»åˆ°ä»»ä¸€èŠ‚ç‚¹ã€‚</p>
<p>Resiliencyï¼ˆå³æ¢å¤èƒ½åŠ›ï¼‰ï¼Œå…·æœ‰å¦‚ä¸‹å››ä¸ªä¸»è¦ç‰¹æ€§:</p>
<ul>
<li>It is able to detect and recover from a given maximum number of errors</li>
<li>It is reliable to a sufficiently high degree that a user of the resilient service can ignore the possibility of service failure</li>
<li>If the service provides perfect detection and recovery from n errors, the (n+1)st error is not catastrophic. A &quot;best effort&quot; is made to continue service</li>
<li>The abuse of the service by a single user should have negligible effect on other users of the service</li>
</ul>
<p>åœ¨æœ¬æ–‡çš„ Resiliency æœåŠ¡ä¸­ï¼Œæ›´æ–°æ“ä½œå¯ä»¥è¢«å‘é€ç»™ä¸»æˆ–ä»»æ„å¤‡èŠ‚ç‚¹ï¼Œç„¶åç”¨æˆ·è¯·æ±‚è¢«é˜»å¡ï¼Œç­‰å¾…æœåŠ¡è¿”å›æˆ–è¶…æ—¶åé‡æ–°å‘é€è¯·æ±‚ã€‚å¦‚æœæ›´æ–°æ“ä½œè¢«å‘é€ç»™å¤‡èŠ‚ç‚¹ï¼Œå¤‡èŠ‚ç‚¹ä¼šå°†è¯·æ±‚è½¬å‘ç»™ä¸»ï¼Œæ‰€æœ‰çš„æ›´æ–°å¿…é¡»ç”±ä¸»èŠ‚ç‚¹å¼€å§‹æ›´æ–°ã€‚</p>
<p>å¤‡ä»½çš„æ¶æ„å¯ä»¥æ˜¯çº¿æ€§çš„ï¼ˆlinearlyï¼‰ï¼Œå¦‚ä¸‹å›¾:</p>
<p><img src="distributedsystem/../assets/images/primary_backup_message_flow.jpg" alt="Summary of the message flow for the resiliency scheme" /></p>
<p>ä¹Ÿå¯ä»¥æ˜¯å¹¿æ’­çš„æ¨¡å¼ï¼Œå¹¿æ’­çš„æ¨¡å¼å…·æœ‰æœ€å°çš„å»¶è¿Ÿã€éœ€è¦æ›´å°‘çš„å‘é€æ¶ˆæ¯ï¼Œä½†ç›¸å¯¹çº¿æ€§æ¨¡å¼å…¶é”™è¯¯æ¢å¤æ›´å¤æ‚ã€‚</p>
<p>ç³»ç»Ÿä¸­æœ‰ä¸¤ç§å¤±è´¥éœ€è¦è¢«å¤„ç†:</p>
<ul>
<li>host failure (easy to handle)</li>
<li>network partition (hard to handle)</li>
</ul>
<p>Host Failure çš„æ¢å¤ä½¿ç”¨ <code>structure modification</code> æ¶ˆæ¯æ¥å¤„ç†ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹ç›‘æµ‹åˆ°å…¶ä¸‹æ¸¸ä¸å¯ç”¨æ—¶ï¼Œä¼šå‘ primary æŠ¥å‘Šï¼Œprimary åˆ™å°†éœ€è¦çš„èŠ‚ç‚¹ä¿¡æ¯ä¼ é€’ç»™ä¸‹æ¸¸ï¼Œå…¶è¿‡ç¨‹å›¾:</p>
<p><img src="distributedsystem/../assets/images/primary_backup_restructuring.jpg" alt="Restructuring after a Host Failure" /></p>
<p>ç½‘ç»œåˆ†åŒºçš„å¤„ç†åˆ™å…ˆé€šè¿‡å‘é€ <code>are you alive</code> æ¶ˆæ¯ï¼Œæ¥åˆ¤æ–­æ˜¯å¦è¿›å…¥ <code>partitioned operation mode</code>ï¼Œåœ¨æ­¤æ¨¡å¼ä¸‹ï¼ŒæœåŠ¡å¯¹æ›´æ–°çš„çš„å¤„ç†å¾€å¾€ä¾èµ–åº”ç”¨ç¨‹åºã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemassetspdfschain-replicationpdfchain-replication-for-supporting-high-throughput-and-availabilitya"><a class="header" href="#a-hrefdistributedsystemassetspdfschain-replicationpdfchain-replication-for-supporting-high-throughput-and-availabilitya"><a href="distributedsystem/../assets/pdfs/chain-replication.pdf">Chain Replication for Supporting High Throughput and Availability</a></a></h3>
<blockquote>
<p>OSDI'04</p>
<p>https://dl.acm.org/doi/10.5555/1251254.1251261</p>
</blockquote>
<p>Chain Replication æ˜¯ä¸€ç§ä¸ºå¤§è§„æ¨¡å­˜å‚¨æœåŠ¡æä¾›é«˜ååã€é«˜å¯ç”¨ï¼Œä¸”æ— éœ€ç‰ºç‰²å¼ºä¸€è‡´æ€§çš„å¤åˆ¶åè®®ã€‚</p>
<p>CR ä¸­çš„èŠ‚ç‚¹åº”è¯¥å…·æœ‰ fail-stop ç‰¹æ€§ï¼ˆå³ non-byzantineï¼‰:</p>
<ul>
<li>each server halts in response to a failure rather than making erroneous state transitions</li>
<li>a serverâ€™s halted state can be detected by the environment</li>
</ul>
<p>ä¸€ä¸ªç”± n ä¸ªèŠ‚ç‚¹æ„æˆçš„ CR å¤åˆ¶é“¾è·¯å¯å®¹å¿ n-1 ä¸ªèŠ‚ç‚¹å¤±æ•ˆã€‚ä¸€æ¡é“¾è·¯æ˜¾ç¤ºå¦‚ä¸‹:</p>
<p><img src="distributedsystem/../assets/images/chain_replication_a_chain.jpg" alt="A chain" /></p>
<p>æ‰€æœ‰çš„ response éƒ½ç”± tail èŠ‚ç‚¹è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œupdate è¯·æ±‚æœ‰ head èŠ‚ç‚¹æ¥æ”¶å¹¶é€ä¸€å‘é€ç»™ä¸‹æ¸¸ï¼Œquery è¯·æ±‚åˆ™è¢«å‘é€åˆ° tail èŠ‚ç‚¹ã€‚</p>
<ul>
<li><strong>Reply Generation.</strong> The reply for every request is generated and sent by the tail.</li>
<li><strong>Query Processing.</strong> Each query request is directed to the tail of the chain and processed there atomically using the replica of objID stored at the tail.</li>
<li><strong>Update Processing.</strong> Each update request is directed to the head of the chain. The request is processed there atomically using replica of objID at the head, then state changes are forwarded along a reliable FIFO link to the next element of the chain (where it is handled and
forwarded), and so on until the request is handled by the tail.</li>
</ul>
<p>ç”±äºæŸ¥è¯¢å’Œæ›´æ–°éƒ½ç”±å°¾èŠ‚ç‚¹ä¸²è¡Œå¤„ç†ï¼Œå› æ­¤ Chain Replication éµå¾ªå¼ºä¸€è‡´æ€§ã€‚</p>
<p>èŠ‚ç‚¹çš„å¤±æ•ˆç”±ä¸€ä¸ªè¢«ç§°ä¸º master çš„æœåŠ¡ï¼ˆå®ç°äº† paxos ç®—æ³•ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªä¸ä¼šå¤±æ•ˆçš„å•ä¸€æœåŠ¡ï¼‰æä¾›å¦‚ä¸‹èƒ½åŠ›:</p>
<ul>
<li>detects failures of serversï¼ˆi. failure of the head; ii. failure of the tail; iii. failure of some other server in the chainï¼‰</li>
<li>informs each server in the chain of its new predecessor or new successor in the new chain obtained by deleting the failed server</li>
<li>informs clients which server is the head and which is the tail of the chain</li>
</ul>
<p><a href="distributedsystem/../assets/pdfs/craq.pdf">CRAQ</a> ç®—æ³•å¯¹ CR è¿›è¡Œäº†æ‰©å±•ï¼Œread æ“ä½œå¯ä»¥è¢«åˆ†æ´¾åˆ°ä»»æ„èŠ‚ç‚¹æ‰§è¡Œï¼Œå¯æä¾›ä¸‰ç§ä¸€è‡´æ€§æ¨¡å‹:</p>
<ul>
<li>Strong Consistency</li>
<li>Eventual Consistency</li>
<li>Eventual Consistency with Maximum-Bounded Inconsistency</li>
</ul>
<p>craq ä½¿ç”¨ zookeeper æ¥å®ç° CR ä¸­ master çš„åŠŸèƒ½ï¼Œå…¶ watcher æœºåˆ¶èƒ½æ›´å¥½åœ°æ£€æµ‹èŠ‚ç‚¹å¤±æ•ˆã€‚</p>
<p><img src="distributedsystem/../assets/images/craq_read_clean_and_dirty.jpg" alt="craq read" /></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemassetspdfsboloskypdfpaxos-replicated-state-machines-as-the-basis-of-a-high-performance-data-storea"><a class="header" href="#a-hrefdistributedsystemassetspdfsboloskypdfpaxos-replicated-state-machines-as-the-basis-of-a-high-performance-data-storea"><a href="distributedsystem/../assets/pdfs/Bolosky.pdf">Paxos Replicated State Machines as the Basis of a High-Performance Data Store</a></a></h3>
<blockquote>
<p>Proceedings of the 8th USENIX conference on Networked systems design and implementation, March 2011</p>
<p>https://dl.acm.org/doi/10.5555/1972457.1972472</p>
</blockquote>
<p>ä¼ ç»Ÿè§‚ç‚¹è®¤ä¸º Paxos å¯¹äºå¤§å®¹é‡ã€é«˜ååé‡ã€æ•°æ®å¯†é›†å‹åº”ç”¨è¿‡äºæ˜‚è´µï¼Œå› æ­¤ï¼Œå®¹é”™å­˜å‚¨ç³»ç»Ÿé€šå¸¸ä¾èµ–äºç‰¹æ®Šç¡¬ä»¶ã€å¼±äºé¡ºåºä¸€è‡´æ€§çš„è¯­ä¹‰ã€æœ‰é™çš„æ›´æ–°æ¥å£ï¼ˆä¾‹å¦‚ä»…è¿½åŠ ï¼‰ã€é€šè¿‡ä¸»èŠ‚ç‚¹åºåˆ—åŒ–æ‰€æœ‰è¯»å–çš„ä¸»å¤‡å¤åˆ¶æ–¹æ¡ˆã€æ—¶é’ŸåŒæ­¥ï¼Œæˆ–è€…å®ƒä»¬çš„æŸç§ç»„åˆï¼Œä»¥ç¡®ä¿æ­£ç¡®æ€§ã€‚</p>
<p>è®ºæ–‡è®¤ä¸ºåœ¨é€šè¿‡å±€åŸŸç½‘å¤åˆ¶å¹¶ä¸”ä¼´éšç€å¤§é‡ç¡¬ç›˜æ“ä½œçš„ç³»ç»Ÿä¸­ï¼ŒPaxos å¼•å…¥çš„é¢å¤–æ¶ˆæ¯å¼€é”€ç›¸å¯¹äºå¤§çº¦ä¸¤ä¸ªæ•°é‡çº§çš„ç£ç›˜å»¶è¿Ÿæ˜¾å¾—å¾®ä¸è¶³é“ã€‚æ­¤å¤–ï¼ŒPaxos å¤åˆ¶çŠ¶æ€æœºçš„ <strong>operation serialization</strong> å’Œ <strong>commit-before-reply</strong> ç‰¹æ€§çœ‹èµ·æ¥ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“èƒ½å¤Ÿä»ç£ç›˜è·å–é«˜æ€§èƒ½ï¼Œä½†é€šè¿‡ä»”ç»†çš„å®ç°ï¼Œèƒ½å¤Ÿåœ¨ä¿æŒ Paxos é¡ºåºä¸€è‡´æ€§çš„åŒæ—¶åšåˆ°é«˜æ•ˆæ“ä½œç£ç›˜ã€‚</p>
<h4 id="gaios-architecture"><a class="header" href="#gaios-architecture">Gaios Architecture</a></h4>
<p><img src="distributedsystem/../assets/images/bolosky_gaios_architecture.jpg" alt="Gaios Architecture" /></p>
<blockquote>
<p>One way to think of what SMARTER does is that it implements an asynchronous Remote Procedure Call (RPC) 
where the server (the state machine) runs on a fault-tolerant, replicated system.</p>
</blockquote>
<p>è®ºæ–‡çš„ç»“è®ºæ¯”è¾ƒæœ‰æ„æ€ï¼Œåè¾¹å†…å®¹ç®€å•æµè§ˆäº†ä¸€éï¼Œä»Šåæœ‰éœ€è¦å†è¯» ğŸ§</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemassetspdfsholygrailpdfdetecting-causal-relationships-in-distributed-computations-in-search-of-the-holy-graila"><a class="header" href="#a-hrefdistributedsystemassetspdfsholygrailpdfdetecting-causal-relationships-in-distributed-computations-in-search-of-the-holy-graila"><a href="distributedsystem/../assets/pdfs/holygrail.pdf">Detecting Causal Relationships in Distributed Computations: In Search of the Holy Grail</a></a></h3>
<blockquote>
<p>by R Schwarz Â· 1994</p>
<p>https://www.vs.inf.ethz.ch/publ/papers/holygrail.pdf</p>
</blockquote>
<p>å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ›´åƒæ˜¯ä¸€é—¨è‰ºæœ¯è€Œéå·¥ç¨‹é—®é¢˜ï¼Œç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„è¡Œä¸ºä»»ç„¶å……æ»¡äº†æŒ‘æˆ˜ã€‚ä¸ºäº†æ­£ç¡®ç†è§£åˆ†å¸ƒå¼ç¨‹åºåŠå…¶æ‰§è¡Œï¼Œç¡®å®šè®¡ç®—ä¸­äº‹ä»¶ä¹‹é—´çš„å› æœå…³ç³»å’Œæ—¶é—´å…³ç³»ã€‚å¹¶å‘æ€§å’Œéç¡®å®šæ€§åœ¨åˆ†æåˆ†å¸ƒå¼ç³»ç»Ÿçš„ç›‘æ§ã€è°ƒè¯•å’Œå¯è§†åŒ–ç­‰è¡Œä¸ºè¿‡ç¨‹ä¸­èµ·ç€éå¸¸é‡è¦çš„ä½œç”¨ã€‚</p>
<p>è¯¥è®ºæ–‡æ˜¯å¯¹å·²æœ‰å› æœå…³ç³»ç ”ç©¶æˆæœçš„æ±‡æ€»ï¼Œå¾ªå¾ªå–„è¯±åœ°å°† Lamport Clockã€Vector Timeã€Characterizing Concurrency with Concurrent Regionsã€Global Predicatesã€Behavioral Patterns ç­‰æ¦‚å¿µè¿›è¡Œåˆ†ææè¿°ã€‚</p>
<h4 id="causality-relation"><a class="header" href="#causality-relation">Causality relation</a></h4>
<p><img src="distributedsystem/../assets/images/holygrail-definition1-1.jpg" alt="causality relation" /></p>
<p>è¿™é‡Œçš„ <code>causality</code> å³ Lamport çš„ <code>happen before</code>ï¼Œä½†å› æœå…³ç³»çš„è¡¨è¿°æ›´å‡†ç¡®ã€‚</p>
<p><img src="distributedsystem/../assets/images/holygrail-definition1-2.jpg" alt="concurrency relation" /></p>
<p>å› æœå…³ç³»æ˜¯åˆ†å¸ƒå¼è®¡ç®—ä¸­å¾ˆå¤šé—®é¢˜çš„åŸºç¡€ï¼Œæ¯”å¦‚ consistent global snapshotã€determining consistent recovery pointsã€determining deadlocks or detecting the termination of a distributed computation ç­‰ã€‚</p>
<blockquote>
<p>Lamport Clock is consistent with causality but does not characterise it.</p>
</blockquote>
<h4 id="vector-time"><a class="header" href="#vector-time">Vector Time</a></h4>
<h5 id="causal-histories"><a class="header" href="#causal-histories">Causal Histories</a></h5>
<p><img src="distributedsystem/../assets/images/holygrail-definition2-1.jpg" alt="Causal histories" /></p>
<p><img src="distributedsystem/../assets/images/holygrail-lemma2-2.jpg" alt="Causality and causal history relation" /></p>
<p>Causal history èƒ½å¾ˆå¥½åœ°ååº”å› æœå…³ç³»ï¼Œä½†æ˜¯ Causal history set ç»´æŠ¤æ‰€æœ‰äº†çš„å‰ç½®äº‹ä»¶ï¼Œæ•°é‡è¿‡äºåºå¤§ï¼Œä½†é€šè¿‡è§‚å¯Ÿå¯ä»¥å‘ç°:</p>
<p><img src="distributedsystem/../assets/images/holygrail-observation2-3.jpg" alt="Observation-2-3" /></p>
<p>å› æ­¤å¯ä»¥ä½¿ç”¨ Vector Time æ¥æ›¿ä»£ Causal Historyï¼ŒVector Time çš„å®šä¹‰:</p>
<p><img src="distributedsystem/../assets/images/holygrail-definition2-5.jpg" alt="Vector Time" /></p>
<blockquote>
<p>the structure of vector time is isomorphic to the causality structure of the underlying distributed computation, a.k.a vector time charaterise causality.</p>
</blockquote>
<h4 id="efficient-realizations-of-vector-time"><a class="header" href="#efficient-realizations-of-vector-time">Efficient Realizations of Vector Time</a></h4>
<p>Vector Time çš„ä¸»è¦ç¼ºç‚¹æ˜¯å®ƒçš„å¤§å°ï¼Œç”±äºéœ€è¦åœ¨å‘é€æ¶ˆæ¯æ˜¯é™„åŠ ä¸€ä¸ª O(N) å¤§å°çš„å‘é‡æ—¶é—´ï¼Œå¯èƒ½ä¼šé€ æˆå¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—çš„ç“¶é¢ˆé—®é¢˜ã€‚</p>
<p>è§£å†³è¯¥é—®é¢˜çš„ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡åœ¨æ¯ä¸ªçº¿ç¨‹é¢å¤–ç»´æŠ¤ä¸¤ä¸ªæ•°ç»„ LSiï¼ˆ&quot;last sent&quot;ï¼‰å’Œ LUiï¼ˆ&quot;last update&quot;ï¼‰ï¼Œä»¥æ­¤æ¥å‡å°‘å‘é€æ¶ˆæ¯çš„å¤§å°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="distributedsystem/../assets/images/holygrail-figure4.jpg" alt="Singhalâ€™s and Kshemkalyaniâ€™s method to maintain vector time" /></p>
<p>ä½†è¿™å¯èƒ½ä¼šä½¿åŒä¸€ä¸ªæ¥æ”¶è€…æ¥æ”¶çš„ä¸åŒæ¶ˆæ¯ä¹‹é—´çš„å› æœå…³ç³»å˜å¾—ä¸ç¡®å®š:</p>
<p><img src="distributedsystem/../assets/images/holygrail-figure5.jpg" alt="Loss of information about the causal relationship between messages" /></p>
<h4 id="characterizing-concurrency-with-concurrent-regions"><a class="header" href="#characterizing-concurrency-with-concurrent-regions">Characterizing Concurrency with Concurrent Regions</a></h4>
<p>å¯¹äºæœ‰äº›åº”ç”¨ï¼Œåªéœ€è¦çŸ¥é“ä¸¤ä¸ªä»»æ„äº‹ä»¶ e å’Œ e' æ˜¯å¦åŒæ—¶å‘ç”Ÿï¼Œè€Œå®ƒä»¬çš„å› æœå…³ç³»åˆ™æ— å…³ç´§è¦ã€‚</p>
<h4 id="evaluating-global-predicates"><a class="header" href="#evaluating-global-predicates">Evaluating Global Predicates</a></h4>
<p>ç”±äºç›¸å¯¹è¾ƒéš¾ç†è§£ï¼Œè¿˜æ²¡æ·±å…¥çœ‹ :()</p>
<h4 id="detecting-behavioral-patterns"><a class="header" href="#detecting-behavioral-patterns">Detecting Behavioral Patterns</a></h4>
<p>ç”±äºç›¸å¯¹è¾ƒéš¾ç†è§£ï¼Œè¿˜æ²¡æ·±å…¥çœ‹ :()</p>
<h4 id="further-readings-8"><a class="header" href="#further-readings-8">Further readings</a></h4>
<p>[1] <a href="https://fileadmin.cs.lth.se/cs/Personal/Amr_Ergawy/dist-algos-papers/4.pdf">Timestamps in Message-Passing Systems That Preserve the Partial Ordering</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemassetspdfschandypdfdistributed-snapshots-determining-global-states-of-distributed-systemsa"><a class="header" href="#a-hrefdistributedsystemassetspdfschandypdfdistributed-snapshots-determining-global-states-of-distributed-systemsa"><a href="distributedsystem/../assets/pdfs/chandy.pdf">Distributed Snapshots: Determining Global States of Distributed Systems</a></a></h3>
<blockquote>
<p>ACM Transactions on Computer Systems, Volume 3, Issue 1 âˆ™ Feb. 1985 âˆ™ pp 63â€“75</p>
<p>https://doi.org/10.1145/214451.214456</p>
</blockquote>
<p>æœ¬æ–‡æå‡ºäº†ä¸€ä¸ªåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç”Ÿæˆå…¨å±€é€»è¾‘ä¸€è‡´æ€§å¿«ç…§çš„ç®—æ³•ï¼Œè¯¥ç®—æ³•ä¾é™„äºåº•å±‚çš„åˆ†å¸ƒå¼è®¡ç®—ï¼ˆå³ä¸éœ€è¦æš‚åœè®¡ç®—ä»»åŠ¡ï¼‰ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„è¿›ç¨‹é€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯è¿›è¡Œé€šä¿¡ï¼Œè¿›ç¨‹å¯ä»¥è®°å½•å®ƒè‡ªå·±çš„çŠ¶æ€å’Œå®ƒå‘é€å’Œæ¥æ”¶çš„æ¶ˆæ¯ï¼Œä¸è®°å½•ä»»ä½•å…¶å®ƒå†…å®¹ã€‚çº¿ç¨‹ä¹‹é—´ä¸å…±äº«æ—¶é’Ÿæˆ–å†…å­˜ã€‚</p>
<p>Chandy-Lamport å‡è®¾è¿›ç¨‹ä¹‹é—´çš„æ‹“æ‰‘æ˜¯å¼ºè¿æ¥ï¼ˆæ—¢ä»»ä½•ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´ç›´æ¥æˆ–é—´æ¥å¯ä»¥é€šä¿¡ï¼‰ï¼Œåœ¨è®²è¿°è¯¥ç®—æ³•æ—¶ï¼Œå¾ˆå¤šä¾‹å­ä¼šç”¨å…¨è¿æ¥çš„æ‹“æ‰‘è¿›è¡Œæè¿°ã€‚</p>
<p>å¼ºè¿æ¥:</p>
<p><img src="https://raw.githubusercontent.com/ChrisWhealy/DistributedSystemNotes/master/img/L9%20Connected%20Graph.png" alt="strongly connected" /></p>
<p>å…¨è¿æ¥:</p>
<p><img src="https://raw.githubusercontent.com/ChrisWhealy/DistributedSystemNotes/master/img/L9%20Total%20Graph.png" alt="complete graph" /></p>
<p>è¯¥ç®—æ³•æ­£ç¡®å·¥ä½œçš„å‰æ:</p>
<ul>
<li>FIFO Delivery</li>
<li>Reliable Delivery</li>
<li>Processes Don't Crash</li>
</ul>
<p>æ¯ä¸ªè¿›ç¨‹è´Ÿè´£è®°å½•:</p>
<ul>
<li>Its own internal state</li>
<li>The state of all messages on its incoming channels</li>
</ul>
<p>ç®—æ³•çš„æ ¸å¿ƒä¾èµ– Marker æ¶ˆæ¯åœ¨æ‹“æ‰‘å›¾ä¸­çš„ä¼ é€’ï¼Œå®Œæ•´çš„å…¨å±€çŠ¶æ€æ£€æµ‹ç®—æ³•ç”± <code>Marker Sending Rule</code> å’Œ <code>Marker Receiving Rule</code> è·å–:</p>
<ul>
<li>The Marker Sending Rule for a process p: for each channel c incident on, and directed away from p, p sends one marker along c after p records its state and before p sends any further messages along c.</li>
<li>The Marker Receiving Rule for a process q: on receiving a marker along a channel c, if q has not yet recorded its state then it records its state, and records the state of c as empty. However, if q has already recorded its state, then the state of c is simply recorded as the sequence of messages received along c in between q recording its state and receiving the marker on c.</li>
</ul>
<p><a href="https://www.youtube.com/watch?v=x1BCZ351dJk">CSE138 (Distributed Systems) L8: Chandy-Lamport snapshot algorithm</a> æè¿°äº†å…¨è¿æ¥æ‹“æ‰‘æ—¶çš„ Chandy-Lamport ç®—æ³•:</p>
<p><em>The Initiator Process</em></p>
<ul>
<li>Records its own state</li>
<li>Sends a marker message out on all its outgoing channels</li>
<li>Starts recording messages arriving on all incoming channels</li>
</ul>
<p><em>Processes Receiving a Marker Message</em> (å« Initiator è¿›ç¨‹)</p>
<p>å½“è¿›ç¨‹ç¬¬ä¸€æ¬¡çœ‹è§ Marker æ¶ˆæ¯æ—¶:</p>
<ul>
<li>Records its own state</li>
<li>Flags the channel on which the marker message was received as <strong>empty</strong></li>
<li>Sends out a marker message on each of its outgoing channels</li>
<li>Starts recording incoming messages on all channels <strong>except</strong> the one on which it received the original marker message (now flagged as empty)</li>
</ul>
<p>å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡çœ‹è§ï¼Œåˆ™æ„å‘³ç€è¯¥è¿›ç¨‹å·²ç»å‘å‡ºè‡ªå·±çš„ Marker æ¶ˆæ¯ä¹‹ååˆæ¥æ”¶åˆ°å…¶å®ƒçš„ Marker æ¶ˆæ¯:</p>
<ul>
<li>Stops recording incoming messages on that channel</li>
<li>Sets that channel's final state to be the sequence of all messages received whilst recording was active</li>
</ul>
<p>ç®€å•ç†è§£å°±æ˜¯ï¼Œå¯¹äºä¸€æ¡é“¾è·¯ï¼Œæ¥æ”¶ç«¯åœ¨æ¥æ”¶åˆ° marker æ¶ˆæ¯ä¹‹å‰çš„æ¶ˆæ¯éƒ½ä¼šè¢«æ¥æ”¶ç«¯çš„çŠ¶æ€è®°å½•ï¼Œå‘é€ç«¯å‘é€ marker æ¶ˆæ¯ä¹‹åçš„æ¶ˆæ¯éƒ½ä¼šè¢«æ¥æ”¶ç«¯å¿½ç•¥ã€‚</p>
<p>ç®—æ³•è®°å½•çš„å…¨å±€çŠ¶æ€è™½ç„¶å¯èƒ½å¯¹åº”ä¸ä¸Šç³»ç»Ÿæ‰€å¤„çš„ä»»ä½•çŠ¶æ€ï¼Œä½†å®ƒæä¾›äº†ä¸€ä¸ªé€»è¾‘ä¸€è‡´çš„å¿«ç…§çŠ¶æ€ï¼Œä¿è¯åˆå§‹ç³»ç»ŸçŠ¶æ€åˆ°æœ€ç»ˆç³»ç»ŸçŠ¶æ€æ˜¯å¯è¾¾çš„ã€‚</p>
<p>å¦å¤–ï¼Œç®¡ç†ç³»ç»Ÿå¿«ç…§éœ€è¦å¤–éƒ¨åè°ƒè¿›ç¨‹æ¥å¤„ç†:</p>
<ul>
<li>æ¥æ”¶æ‰€æœ‰è¿›ç¨‹è®°å½•çš„ local state å’Œ ingest channel state</li>
<li>æ•´ç†è¿™äº›çŠ¶æ€æ¥å½¢æˆå…¨å±€ç³»ç»Ÿå¿«ç…§</li>
</ul>
<p>å…¨å±€å¿«ç…§å¯ç”¨äºè§£å†³å¦‚ä¸‹é—®é¢˜:</p>
<ul>
<li>Checkpointing</li>
<li>Deadlock detection</li>
<li>Stable Property Detection</li>
</ul>
<h4 id="references-18"><a class="header" href="#references-18">References:</a></h4>
<p>[1] <a href="https://blog.acolyer.org/2015/04/22/distributed-snapshots-determining-global-states-of-distributed-systems/">Distributed Snapshots: Determining Global States of Distributed Systems</a> by Adrian Colyer<br>
[2] <a href="https://github.com/ChrisWhealy/DistributedSystemNotes/blob/master/Lecture%2008.md">Distributed Systems Lecture 8 Notes</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemassetspdfslightweightasynchronoussnapshotsfordistributeddataflowspdflightweight-asynchronous-snapshots-for-distributed-dataflowsa"><a class="header" href="#a-hrefdistributedsystemassetspdfslightweightasynchronoussnapshotsfordistributeddataflowspdflightweight-asynchronous-snapshots-for-distributed-dataflowsa"><a href="distributedsystem/../assets/pdfs/Lightweight.Asynchronous.Snapshots.for.Distributed.Dataflows.pdf">Lightweight Asynchronous Snapshots for Distributed Dataflows</a></a></h3>
<blockquote>
<p>arXiv:1506.08603 Â· 2015</p>
<p>https://arxiv.org/abs/1506.08603</p>
</blockquote>
<p>è¯»è¿‡ <a href="distributedsystem/./chandy.html">Chandy-Lamport</a>ï¼ˆåç®€ç§° CLï¼‰ä¹‹åï¼Œç†è§£ <code>Asynchronous Barrier Snapshotting</code>ï¼ˆåç®€ç§° ABSï¼‰å°±æ¯”è¾ƒå®¹æ˜“äº†ï¼ŒABS å¯ä»¥çœ‹åš CL çš„ä¸€ä¸ªç‰¹ä¾‹ã€‚ä¸åŒäº CL å‡è®¾çš„å¼ºè¿é€šå›¾ï¼ŒABS æ˜¯ä¸ºè§£å†³æœ‰å‘æ— ç¯å›¾è€Œè®¾è®¡çš„ï¼Œå…¶ä¸»è¦æ­¥éª¤åŒ…å«:</p>
<ul>
<li>A central coordinator periodically injects stage barriers to all the sources.</li>
<li>When a source receives a barrier it takes a snapshot of its current state, then broadcasts the barrier to all its outputs</li>
<li>When a non-source task receives a barrier from one of its inputs, it blocks that input until it receives a barrier from all inputs</li>
<li>When barriers have been received from all the inputs, the task takes a snapshot of its current state and broadcasts the barrier to its outputs</li>
<li>Then, the task unblocks its input channels to continue its computation</li>
</ul>
<p>å¯ä»¥çœ‹å‡ºï¼ŒABS çš„é Souce èŠ‚ç‚¹åœ¨ç¬¬ä¸€æ¬¡æ”¶åˆ° barrier çš„æ—¶å€™å¹¶æ²¡æœ‰é©¬ä¸Šè¿›è¡Œå¯¹å½“å‰çŠ¶æ€åš snapshotï¼Œè€Œæ˜¯ç­‰å¾…æ‰€æœ‰ input channel éƒ½æ”¶åˆ° barrier ä¹‹åæ‰è¿›è¡Œ snapshotï¼ˆå³ Flink ä¸­çš„ barrier alignmentï¼‰ï¼Œè¿™æ ·å‡å°‘äº† CL ä¸­å¯¹ channel çŠ¶æ€çš„è®°å½•ã€‚å…¶ç®—æ³•æè¿°ä¸º:</p>
<img src="distributedsystem/./../../assets/images/abs-algo-1.jpg" alt="Asynchronous Barrier Snapshotting for Acyclic Execution Graphs" width="400"/>
<p>ABS è¿˜å¯æ‰©å±•ç”¨äºæœ‰å‘å¾ªç¯å›¾ï¼Œé€šè¿‡é¢å¤–è®°å½• back-edgesï¼ˆa back-edge in a directed graph is an edge that points to a vertex that has already been visited during a depth-first searchï¼‰é€šé“çš„æ¶ˆæ¯ï¼Œä¸èŠ‚ç‚¹è®°å½•çš„çŠ¶æ€å…±åŒæ„æˆå¿«ç…§ï¼Œç®—æ³•æè¿°ä¸º:</p>
<img src="distributedsystem/./../../assets/images/abs-algo-2.jpg" alt="Asynchronous Barrier Snapshotting for Cyclic Execution Graphs" width="400"/>
<p>å¦å¤–è¯¥è®ºæ–‡è¿˜æè¿°äº† Failure Recovery çš„æ–¹æ³•ï¼Œæ•´ä¸ª execution graph ä»æœ€åä¸€ä¸ªå¿«ç…§é‡å¯ï¼Œæ¯ä¸ª task åšå¦‚ä¸‹æ“ä½œ:</p>
<ol>
<li>retrieves from persistent storage its associated state for the snapshot st and sets it as its initial state</li>
<li>recovers its backup log and processes all contained records</li>
<li>starts ingesting records from its input channels</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefdistributedsystemassetspdfszookeeperpdfzookeeper-wait-free-coordination-for-internet-scale-systemsa"><a class="header" href="#a-hrefdistributedsystemassetspdfszookeeperpdfzookeeper-wait-free-coordination-for-internet-scale-systemsa"><a href="distributedsystem/../assets/pdfs/zookeeper.pdf">ZooKeeper: wait-free coordination for internet-scale systems</a></a></h3>
<blockquote>
<p>USENIX ATC'10</p>
<p>https://dl.acm.org/doi/10.5555/1855840.1855851</p>
</blockquote>
<p>ZooKeeper æä¾›çš„æ¥å£å…·æœ‰ wait-free çš„ç‰¹ç‚¹ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ä»¥ <code>FIFO</code> é¡ºåºæ‰§è¡Œï¼ˆFIFO client orderï¼‰ï¼Œè€Œæ”¹å˜ ZooKeeper çŠ¶æ€çš„è¯·æ±‚åˆ™å…·æœ‰ <code>linearizablity</code> çš„ç‰¹æ€§ï¼ˆLinearizable writesï¼‰ã€‚</p>
<p>å¤§å‹åˆ†å¸ƒå¼åº”ç”¨å¾€å¾€éœ€è¦ä¸åŒå½¢å¼çš„ååŒ(coordination)ï¼ŒåŒ…æ‹¬:</p>
<ul>
<li>Configuration</li>
<li>Group membership</li>
<li>Leader election</li>
<li>Locks</li>
</ul>
<p>å…¶ä¸­ <code>Locks</code> ä½œä¸ºä¸€ç§è¾ƒå¼ºçš„ååŒæœåŠ¡å¯ä»¥ç”¨æ¥å®ç°è¾ƒå¼±çš„ååŒæœåŠ¡ï¼Œå¦‚ <code>Group membership</code>ã€<code>Leader election</code> ç­‰ã€‚ZooKeeper å®ç°äº†ä¸€ä¸ªç±»ä¼¼æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£ï¼Œå…·æœ‰æ“ä½œç®€å•ã€ <code>wait-free</code> çš„ç‰¹ç‚¹ã€‚</p>
<blockquote>
<p>Implementing wait-free data objects, however, differentiates Zookeeper significantly
from systems based on blocking primitives such as locks.</p>
</blockquote>
<p>ZooKeeper çš„çŠ¶æ€å˜æ›´ä¾èµ– <a href="distributedsystem/./consensus/zab.html">Zab</a> åŸå­å¹¿æ’­åè®®ã€‚æ‰€æœ‰çš„å†™æ“ä½œéƒ½ä¼šé‡å®šå‘åˆ° Leader èŠ‚ç‚¹ï¼Œè¯»æ“ä½œåˆ™ä½¿ç”¨åœ¨ Follower æœ¬åœ°æ‰§è¡Œã€‚</p>
<p>ZooKeeper é€šå¸¸ç”¨æ¥å­˜å‚¨åº”ç”¨çš„å…ƒæ•°æ®ï¼Œè¯»æ“ä½œçš„æ¯”ä¾‹å¾€å¾€è¿œå¤§äºå†™æ“ä½œï¼Œå› æ­¤åœ¨å®¢æˆ·ç«¯ç¼“å­˜æ•°æ®èƒ½æé«˜è¯»æ€§èƒ½ã€‚</p>
<blockquote>
<p>ZooKeeper uses a watch mechanism to enable clients to cache data without managing the client cache directly.</p>
</blockquote>
<p>ZooKeeper ä¸­çš„å‡ ä¸ªæ¦‚å¿µ:</p>
<ul>
<li>client: ä½¿ç”¨ ZooKeeper æœåŠ¡çš„ç”¨æˆ·</li>
<li>server: ZooKeeper é›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå³ zookeeper è¿›ç¨‹</li>
<li>znode: ZooKeeper ä¸­çš„å†…å­˜æ•°æ®èŠ‚ç‚¹ï¼Œç±»æ¯”æ–‡ä»¶ç³»ç»Ÿä¸­çš„ DIR æˆ– FILE</li>
<li>data tree: znode æ„æˆçš„åˆ†å±‚å‘½åç©ºé—´ï¼Œç±»æ¯”æ–‡ä»¶ç³»ç»Ÿ</li>
<li>session: å®¢æˆ·ç«¯è¿æ¥ ZooKeeper æœåŠ¡æ—¶åˆ›å»ºçš„è¿æ¥å¥æŸ„</li>
</ul>
<h4 id="znode"><a class="header" href="#znode">znode</a></h4>
<p>znode å…·æœ‰ä¸¤ç§å½¢æ€ï¼Œ<code>Regular</code> ç±»å‹çš„ znode éœ€è¦ç”¨æˆ·æ˜¾ç¤ºåˆ›å»ºå’Œåˆ é™¤ï¼›<code>Ephemeral</code> ç±»å‹çš„ znode ç”±ç”¨æˆ·åˆ›å»ºï¼Œsession æ–­å¼€åç”±ç³»ç»Ÿè‡ªåŠ¨åˆ é™¤ã€‚</p>
<blockquote>
<p>All znodes store data, and all znodes, except for <code>ephemeral</code> znodes, can have children.</p>
</blockquote>
<p>åˆ›å»º znode æ—¶å¯ä»¥æŒ‡å®š <code>sequential</code> æ ‡å¿—ã€‚znode å­˜å‚¨çš„æ•°æ®ä¸Šé™ä¸º 1MBã€‚</p>
<blockquote>
<p>Nodes created with the sequential flag set have the value of a monotonically increasing counter appended to its name.</p>
</blockquote>
<h4 id="client-api"><a class="header" href="#client-api">Client API</a></h4>
<ul>
<li>create(path, data, flags)</li>
<li>delete(path, version)</li>
<li>exists(path, watch)</li>
<li>getData(path, watch)</li>
<li>setData(path, data, version)</li>
<li>getChildren(path, watch)</li>
<li>sync(path)</li>
</ul>
<p>æ‰€æœ‰æ¥å£éƒ½å…·æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªåŒæ­¥ä¸€ä¸ªå¼‚æ­¥ã€‚</p>
<blockquote>
<p>The asynchronous API, however, enables an application to have both multiple
outstanding ZooKeeper operations and other tasks executed in parallel.</p>
</blockquote>
<p>ç”±äºè¯»æ“ä½œå¯ä»¥åœ¨ä»»æ„ server ä¸Šè¿›è¡Œï¼Œå› æ­¤å¯èƒ½è¯»åˆ°æ—§æ•°æ®ï¼Œ<code>sync</code> æ¥å£ç”¨ä»¥è§£å†³è¯¥é—®é¢˜:</p>
<blockquote>
<p>sync causes a server to apply all pending write requests before processing the
read without the overhead of a full write.</p>
</blockquote>
<h4 id="ä½¿ç”¨-zookeeper-api-å®ç°ååŒå…ƒè¯­"><a class="header" href="#ä½¿ç”¨-zookeeper-api-å®ç°ååŒå…ƒè¯­">ä½¿ç”¨ ZooKeeper API å®ç°ååŒå…ƒè¯­</a></h4>
<p>é€šè¿‡ ZooKeeper API å¯ä»¥åœ¨å®¢æˆ·ç«¯å®ç° <code>Configuration Management</code>ã€<code>Rendezvous</code>ã€<code>Group Membership</code>ã€<code>Locks</code>ã€<code>Double Barrier</code> ç­‰ååŒã€‚</p>
<p><strong>lock</strong></p>
<p><img src="distributedsystem/../assets/images/zookeeper_lock.jpg" alt="lock" /></p>
<p><strong>rwlock</strong></p>
<p><img src="distributedsystem/../assets/images/zookeeper_rwlock.jpg" alt="rwlock" /></p>
<h4 id="implementation"><a class="header" href="#implementation">Implementation</a></h4>
<p>ZooKeeper çš„å†…éƒ¨æ¨¡å—å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="distributedsystem/../assets/images/zookeeper_components.jpg" alt="zookeeper component" /></p>
<p>å†™æ“ä½œå‘é€ç»™ Leader çš„ <code>Request Processor</code> æ¨¡å—ï¼Œé€šè¿‡è®¡ç®—æ‰§è¡Œè¯¥æ“ä½œåçš„çŠ¶æ€æ¥åˆ¤æ–­è¯¥æ“ä½œæ˜¯å¦åº”è¯¥è¢« applyï¼Œå¦‚æœå¯è¡Œåˆ™ç”Ÿæˆä¸€ä¸ªå¹‚ç­‰çš„äº‹åŠ¡æäº¤ç»™ <code>Atomic Broadcast</code> æ¨¡å—ï¼Œè¯¥æ¨¡å—è´Ÿè´£å¤åˆ¶çŠ¶æ€æœºçš„ä¸€è‡´æ€§ï¼Œè¯»æ“ä½œåˆ™ç›´æ¥æäº¤ç»™ <code>Replicated Database</code>ã€‚</p>
<p><code>Replicated database</code> æ˜¯ä¸€ä¸ªå†…å­˜æ•°æ®åº“ï¼Œé€šè¿‡å®šæœŸæ‰§è¡Œ <code>fuzzy snapshot</code> æ¥å‡å°‘å›æ”¾çš„æ—¶é—´ï¼Œç”±äº WAL ä¸­è®°å½•çš„äº‹åŠ¡æ—¥å¿—å…·æœ‰å¹‚ç­‰çš„ç‰¹æ€§ï¼Œsnapshot ä¸éœ€è¦åŠ é”ã€‚</p>
<p>è¯»è¯·æ±‚åœ¨æ¯å°æœåŠ¡å™¨æœ¬åœ°å¤„ç†ã€‚æ¯ä¸ªè¯»è¯·æ±‚ç”¨å…¶æ‰€åœ¨æœåŠ¡å™¨çœ‹åˆ°çš„æœ€åä¸€ä¸ªäº‹åŠ¡çš„ zxid è¿›è¡Œæ ‡è®°åå¤„ç†ã€‚</p>
<p>ZooKeeper ä½¿ç”¨è¶…æ—¶æœºåˆ¶æ¥æ£€æµ‹å®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="filesystem"><a class="header" href="#filesystem">filesystem</a></h2>
<ul>
<li><strong><a href="fs/gfs.html">The Google File System</a></strong></li>
<li><strong><a href="fs/polarfs.html">PolarFS: An Ultralow Latency and Failure Resilient Distributed File System for Shared Storage Cloud Database</a></strong></li>
</ul>
<h3 id="further-readings-9"><a class="header" href="#further-readings-9">Further readings</a></h3>
<ul>
<li><a href="https://www.usenix.org/system/files/conference/fast17/fast17-vangoor.pdf">To FUSE or Not to FUSE: Performance of User-Space File Systems</a>, FAST â€™17</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefhttpsstaticgoogleusercontentcommediaresearchgooglecomenarchivegfs-sosp2003pdfthe-google-file-systema"><a class="header" href="#a-hrefhttpsstaticgoogleusercontentcommediaresearchgooglecomenarchivegfs-sosp2003pdfthe-google-file-systema"><a href="https://static.googleusercontent.com/media/research.google.com/en//archive/gfs-sosp2003.pdf">The Google File System</a></a></h3>
<blockquote>
<p>Proceedings of the nineteenth ACM symposium on Operating systems principles, October 2003</p>
<p>https://dl.acm.org/doi/10.1145/945445.945450</p>
</blockquote>
<p>GFS æ˜¯ä¸ºå¤§è§„æ¨¡åˆ†å¸ƒå¼æ•°æ®å¯†é›†å‹åº”ç”¨è®¾è®¡çš„ä¸€ä¸ªå¯æ‰©å±•çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒè¿è¡Œåœ¨å»‰ä»·æœåŠ¡å™¨ä¸Šï¼Œæä¾›å®¹é”™æœºåˆ¶ï¼Œä¸ºå¤§é‡å®¢æˆ·ç«¯æä¾›é«˜æ€§èƒ½å­˜å‚¨æœåŠ¡ã€‚</p>
<p>GFS ä¸å…¶å®ƒåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå…·æœ‰ç›¸åŒçš„è®¾è®¡ç›®æ ‡ï¼Œå¦‚:</p>
<ul>
<li>performance</li>
<li>scalability</li>
<li>reliability</li>
<li>availability</li>
</ul>
<p>åŒæ—¶å‡ºäºå¯¹ Google ä¸šåŠ¡åŠæŠ€æœ¯ç¯å¢ƒçš„è§‚å¯Ÿï¼ŒGFS å…·æœ‰ä¸€äº›ç‹¬ç‰¹çš„è®¾è®¡è¦ç‚¹ã€‚</p>
<p><strong>è®¾è®¡å‡è®¾</strong></p>
<ol>
<li>The system is built from many inexpensive commodity components that often fail</li>
<li>The system stores a modest number of large filesï¼ˆ&gt;100MBï¼‰</li>
<li>The workloads primarily consist of two kinds of reads: large streaming reads and small random reads</li>
<li>The workloads also have many large, sequential writes that <code>append</code> data to files</li>
<li>The system must efficiently implement well-defined semantics for multiple clients that concurrently append to the same file</li>
<li>High sustained bandwidth is more important than low latency</li>
</ol>
<p><strong>è®¾è®¡è¦ç‚¹åŠæ¶æ„</strong></p>
<p><img src="fs/../assets/images/gfs_architecture.jpg" alt="GFS Architecture" /></p>
<ul>
<li>ä¸€ä¸ª master, ç»´æŠ¤æ–‡ä»¶ç³»ç»Ÿæ‰€æœ‰çš„å…ƒæ•°æ®ï¼ˆæ–‡ä»¶å’Œ chunk çš„å‘½åç©ºé—´ã€æ–‡ä»¶åˆ° chunk çš„æ˜ å°„ã€chunk åˆ° chunkserver çš„æ˜ å°„ã€ACLã€chunk ç§Ÿçº¦ç®¡ç†ã€GC ç­‰ï¼‰</li>
<li>namespaces å’Œ file-to-chunk mapping æŒä¹…åŒ–åˆ° operation log, è€Œ chunk åˆ° chunkserver çš„æ˜ å°„å…³ç³»æ˜¯ master å‘ chunkserver ç´¢è¦çš„</li>
<li>å¤šä¸ª chunkserver, æ–‡ä»¶æ•°æ®è¢«åˆ†ä¸ºå›ºå®šå¤§å°çš„ chunk(64MB) ä¿å­˜åœ¨ chunkserver</li>
<li>ä¸‰å‰¯æœ¬ï¼Œåˆ†å¸ƒåœ¨å¤šä¸ªæœºå™¨ä¸Šå¹¶ä½äºä¸åŒ rack</li>
<li>master å’Œ chunckserver ä¹‹é—´é€šè¿‡å¿ƒè·³æ¶ˆæ¯æ¥ä¼ é€’æŒ‡ä»¤å¹¶æ”¶é›†çŠ¶æ€</li>
<li>client å’Œ master ä¹‹é—´é€šä¿¡è·å–å…ƒæ•°æ®ï¼Œä½†æ•°æ®çš„å­˜å–æ˜¯ç›´æ¥å’Œ chunkserver è¿›è¡Œçš„</li>
<li>master å¯ä»¥é€šè¿‡ operation log æ¥æ¢å¤å‘½åç©ºé—´ï¼Œä¸ºäº†å‡å°‘æ¢å¤æ—¶é—´ï¼Œè¦æ±‚ operation log ä¸èƒ½è¿‡å¤§ï¼Œé€šè¿‡ä½¿ç”¨ checkpointï¼ˆcompact B-tree like formï¼‰ æ¥è¾¾åˆ°æ­¤ç›®çš„</li>
<li>ä¸€è‡´æ€§æ¨¡å‹ï¼ŒGFS é€šè¿‡ä½¿ç”¨ <code>atomic record append</code> æ¥è¾¾åˆ°ä¸€ä¸ªæ¯”è¾ƒæ¾å¼›ï¼ˆrelaxedï¼‰çš„ä¸€è‡´æ€§æ¨¡å‹ï¼Œrecord append ä½¿ç”¨çš„æ˜¯ GFS é€‰æ‹©çš„ offset è€Œéåº”ç”¨æŒ‡å®šçš„ offset</li>
<li>GFS ä½¿ç”¨ç§Ÿçº¦ï¼ˆleaseï¼‰æ¥ä¿è¯å¤šå‰¯æœ¬é—´ä¸€è‡´çš„æ›´æ”¹é¡ºåºã€‚master æˆæƒå…¶ä¸­ä¸€ä¸ª chunk ä¸º primary, ç”±å®ƒæ¥ç¡®å®šå¤šä¸ªæ›´æ”¹çš„é¡ºåº</li>
<li>å¦‚æœ record append çš„æ•°æ®è¶…è¿‡äº† chunk çš„èŒƒå›´ï¼Œä¼šå°†æ¯ä¸ª replica padding åˆ°ç»“å°¾ã€‚record append çš„å¤§å°è¢«é™åˆ¶ä¸º 16MBï¼Œä»¥é¿å…è¿‡å¤šçš„ç©ºé—´æµªè´¹</li>
<li>GFS ä½¿ç”¨ <code>at-lease-once</code> è¯­ä¹‰ï¼Œç”±åº”ç”¨ç¨‹åºå¤„ç†å†—ä½™æ•°æ®</li>
</ul>
<p>GFS çš„ä¸€è‡´æ€§æ¨¡å‹æ˜¯æˆ‘è®¤ä¸ºæœ€éš¾æ‡‚çš„åœ°æ–¹ï¼Œéœ€ç»“åˆ 2.7ã€3.1 å’Œ 3.3 èŠ‚å¤šçœ‹å‡ éã€‚</p>
<h4 id="references-19"><a class="header" href="#references-19">References</a></h4>
<p>[1] Google Filesystem: Architecture + Consistency Model Overview <a href="https://www.youtube.com/watch?v=64ioICo0YBo">Part 1</a> &amp; <a href="https://www.youtube.com/watch?v=kVY_3CNPjhk">Part 2</a><br>
[2] GFS <a href="http://nil.lcs.mit.edu/6.824/2020/papers/gfs-faq.txt">FAQ</a> from MIT 6.824<br>
[3] <a href="fs/../assets/pdfs/1594204.1594206.pdf">Case Study GFS: Evolution on Fast-forward</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hreffsassetspdfsp1849-caopdfpolarfs-an-ultralow-latency-and-failure-resilient-distributed-file-system-for-shared-storage-cloud-databasea"><a class="header" href="#a-hreffsassetspdfsp1849-caopdfpolarfs-an-ultralow-latency-and-failure-resilient-distributed-file-system-for-shared-storage-cloud-databasea"><a href="fs/../assets/pdfs/p1849-cao.pdf">PolarFS: An Ultralow Latency and Failure Resilient Distributed File System for Shared Storage Cloud Database</a></a></h3>
<blockquote>
<p>Proceedings of the VLDB EndowmentVolume 11Issue 12August 2018 pp 1849â€“1862</p>
<p>https://doi.org/10.14778/3229863.3229872</p>
</blockquote>
<p>PolarFS æ˜¯ä¸º PolarDB è®¾è®¡çš„ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œé€šè¿‡åˆ©ç”¨ RDMAã€NVMe ç­‰ bypass kernel çš„æŠ€æœ¯ï¼Œä½¿ PolarFS å…·æœ‰ä½æ—¶å»¶ã€é«˜ååã€é«˜å¯ç”¨ç­‰ç‰¹æ€§ã€‚ä¸ºäº†æœ€å¤§åŒ– I/O ååï¼ŒPolarFS å¼€å‘äº† ParalleRaftï¼Œå®ƒåˆ©ç”¨æ•°æ®åº“èƒ½å¤Ÿå®¹å¿ä¹±åºå®Œæˆçš„èƒ½åŠ›ï¼Œæ‰“ç ´äº† Raft çš„ä¸¥æ ¼ä¸²è¡ŒåŒ–ã€‚</p>
<p>PolarFS çš„ç‰¹ç‚¹:</p>
<ul>
<li>ä½¿ç”¨ RDMAã€NVMe ç­‰æ–°å…´ç¡¬ä»¶ï¼Œå®ç°è½»é‡çš„ç”¨æˆ·æ€çš„ç½‘ç»œæ ˆå’Œ I/O æ ˆ</li>
<li>æä¾› POSIX-like æ–‡ä»¶ç³»ç»Ÿé“¾æ¥åº“ libpfsï¼Œåº”ç”¨ç›´æ¥è°ƒç”¨ libpfs æä¾›çš„æ¥å£è¿›è€Œç»•è¿‡ VFSã€‚è¿™æ ·æ‰€æœ‰ I/O è·¯å¾„éƒ½åœ¨ç”¨æˆ·æ€</li>
<li>å…³é”®æ•°æ®è·¯å¾„åœ¨è®¾è®¡ä¸Šé¿å…é”å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå……åˆ†åˆ©ç”¨ Zero-copy æŠ€æœ¯</li>
<li>ä½¿ç”¨å…è®¸ <code>out-of-order log acknowledging</code> çš„ ParalleRaft å…±è¯†ç®—æ³•ï¼Œæé«˜ I/O å¹¶å‘</li>
</ul>
<p>ä¸ºäº†æ”¯æ’‘ PolarDB çš„ä¸»(Primary)ä»(Read Only)å…±äº« redo æ—¥å¿—å’Œæ•°æ®æ–‡ä»¶çš„åŠŸèƒ½ï¼ŒPolarFS è¿˜å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹:</p>
<ul>
<li>å¯ä»¥åŒæ­¥æ–‡ä»¶å…ƒæ•°æ®çš„æ”¹åŠ¨ï¼Œä½¿å¾—è¿™äº›æ”¹åŠ¨å¯¹ä»èŠ‚ç‚¹å¯è§</li>
<li>æ–‡ä»¶å…ƒæ•°æ®çš„å¹¶å‘ä¿®æ”¹æ˜¯ä¸²è¡ŒåŒ–çš„ï¼Œä»¥ä¿è¯æ–‡ä»¶ç³»ç»Ÿåœ¨æ‰€æœ‰èŠ‚ç‚¹çš„ä¸€è‡´æ€§</li>
<li>å½“å‘ç”Ÿç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼ŒPolarFS ç¡®ä¿åªæœ‰ä¸€ä¸ª Primary node æä¾›æœåŠ¡ï¼Œé¿å…æ•°æ®å‡ºé”™</li>
</ul>
<h3 id="æ¶æ„-1"><a class="header" href="#æ¶æ„-1">æ¶æ„</a></h3>
<p>PolarFS ç”±å­˜å‚¨å±‚(Storage layer)å’Œæ–‡ä»¶ç³»ç»Ÿå±‚(File system layer)æ„æˆï¼Œå­˜å‚¨å±‚ç®¡ç†å­˜å‚¨èŠ‚ç‚¹çš„ç£ç›˜èµ„æºå¹¶ä¸ºæ¯ä¸ªæ•°æ®åº“å®ä¾‹æä¾›ä¸€ä¸ªæ•°æ®åº“å·(disk volumn)ï¼Œæ–‡ä»¶ç³»ç»Ÿå±‚è´Ÿè´£å·å†…çš„æ–‡ä»¶ç®¡ç†ä»¥åŠæ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®çš„å¹¶å‘åŠåŒæ­¥ç®¡ç†ã€‚</p>
<p><img src="fs/./../assets/images/polarfs_storage_layer_abstraction.jpg" alt="storage layer abstraction" /></p>
<h4 id="æ–‡ä»¶ç³»ç»Ÿå±‚"><a class="header" href="#æ–‡ä»¶ç³»ç»Ÿå±‚">æ–‡ä»¶ç³»ç»Ÿå±‚</a></h4>
<p>æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®çš„ç®¡ç†ï¼Œå…¶è´Ÿè´£åœ¨è¯¥é€»è¾‘å­˜å‚¨ç©ºé—´ä¸Šå®ç°æ–‡ä»¶ç®¡ç†ï¼Œå¹¶è´Ÿè´£æ–‡ä»¶å¹¶å‘è®¿é—®çš„åŒæ­¥å’Œäº’æ–¥ã€‚</p>
<ul>
<li>æä¾›ä¸€ä¸ªå…±äº«ã€å¹¶å‘çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥è¢«å¤šä¸ªæ•°æ®åº“å®ä¾‹è®¿é—®</li>
<li>libfs å®Œå…¨å®ç°åœ¨ç”¨æˆ·æ€ï¼Œæä¾›ä¸€ç»„ Posix-like æ–‡ä»¶ç³»ç»Ÿæ¥å£ï¼Œå¦‚ pfs_mount å°†åº”ç”¨ç¨‹åºé™„åŠ åˆ°ç›¸åº”çš„ Volumn ä¸Šï¼Œå¹¶åˆå§‹åŒ–æ–‡ä»¶ç³»ç»ŸçŠ¶æ€ï¼›pfs_mount_growfs å¯ä»¥å°† Volumn æ‰©å±•çš„ç©ºé—´æ ‡è¯†ä¸ºæ–‡ä»¶ç³»ç»Ÿå¯ç”¨</li>
<li>å…ƒæ•°æ®çš„ç®¡ç†åˆ†ä¸ºä¸¤éƒ¨åˆ†
<ul>
<li>organize metadata to access and update files and directories within a database node</li>
<li>coordinate and synchronize metadata modification among database nodes</li>
</ul>
</li>
<li>å…ƒæ•°æ®çš„æ›´æ”¹è®°å½•åœ¨ jounal ä¸­ï¼ŒRO å®ä¾‹é€šè¿‡è½®è¯¢æ—¥å¿— anchor çš„å˜åŠ¨æ¥å°†æ—¥å¿— replay åˆ°æœ¬èŠ‚ç‚¹çš„å…ƒæ•°æ®</li>
<li>å½“ç½‘ç»œåˆ†åŒºå‘ç”Ÿçš„æ—¶å€™ï¼Œæœ‰å¯èƒ½æœ‰å¤šä¸ªå®ä¾‹å†™ journalï¼Œå› æ­¤éœ€è¦ disk paxos ç®—æ³•æ¥ä¿è¯å¯¹ Journal æ–‡ä»¶çš„äº’æ–¥å†™</li>
</ul>
<h4 id="å­˜å‚¨å±‚"><a class="header" href="#å­˜å‚¨å±‚">å­˜å‚¨å±‚</a></h4>
<p>å­˜å‚¨èµ„æºçš„è™šæ‹ŸåŒ–ç®¡ç†ï¼Œå…¶è´Ÿè´£ä¸ºæ¯ä¸ªæ•°æ®åº“å®ä¾‹æä¾›ä¸€ä¸ªé€»è¾‘å­˜å‚¨ç©ºé—´ã€‚</p>
<p><strong>ChunkServer</strong></p>
<ul>
<li>ä¸€ä¸ªæ•°æ®åº“å®ä¾‹å¯¹åº”ä¸€ä¸ª Volumnï¼Œæ¯ä¸ª Volumn å¯¹åº”ä¸€ä¸ªæˆ–å¤šä¸ª Chunk</li>
<li>Chunk å¤§å°ä¸º 10G å›ºå®šï¼Œé€šè¿‡å°† Chunk Append åˆ° Volumn ä½¿ Volumn ç©ºé—´å¾—ä»¥æ‰©å±•</li>
<li>100TB çš„ Volumn åªéœ€åœ¨å…ƒæ•°æ®æ•°æ®åº“ä¸­å­˜å‚¨ 10,000 æ¡è®°å½•ï¼Œè¿™äº›å…ƒæ•°æ®è¿˜å¯ä»¥ç¼“å­˜åœ¨ PolarSwitch çš„å†…å­˜ä¸­</li>
<li>Volumn æä¾› 512B å­—èŠ‚åŸå­è¯»å†™</li>
<li>Chunk ç”± ChunkServer ç®¡ç†ï¼Œæ¯ä¸ª Chunk ä¼š replicate åˆ° 3 ä¸ª ChunkServer</li>
<li>Chunk è¢«è¿›ä¸€æ­¥åˆ‡åˆ†ä¸º Blockï¼Œæ¯ä¸ª Block 64KBã€‚ç£ç›˜ç©ºé—´æŒ‰ Block ç²’åº¦è¿›è¡Œåˆ†é…å¹¶ mapping åˆ° Chunk ä»¥è·å¾— thin provision</li>
<li>Chunk LBA åˆ° Block çš„ mapping è¡¨ï¼ˆ640KBï¼‰å­˜å‚¨åœ¨ ChunkServer ä¸Šå¹¶åœ¨å†…å­˜ç¼“å­˜</li>
<li>æ¯ä¸ª ChunkServer è¿›ç¨‹ç®¡ç†ä¸€ä¸ª NVMe SSD ç›˜å¹¶è¿›è¡Œäº†ç»‘æ ¸ä»¥å‡å°‘ ChunkServer é—´çš„èµ„æºç«äº‰</li>
<li>æ¯ä¸ª ChunkServer å¯¹åº”ä¸€ä¸ª WALï¼Œæ•°æ®çš„ä¿®æ”¹å…ˆä»¥ append çš„æ–¹å¼å†™å…¥ WALï¼Œç„¶åå¼‚æ­¥æ›´æ–°åˆ°å¯¹åº”çš„ Blockï¼Œä»¥ä¿è¯åŸå­æ€§å’ŒæŒä¹…æ€§</li>
<li>Consensus Group æŒ‰ ChunkServer ç²’åº¦å®ç°ï¼Œä½¿ç”¨ ParallelRaft ç®—æ³•å¤åˆ¶ I/O è¯·æ±‚ï¼Œè¿›è€Œä¿è¯æ•°æ®ä¸€è‡´æ€§</li>
</ul>
<p>é—®é¢˜ï¼š</p>
<ul>
<li>WAL å¯¹åº”çš„ 3D XPoint SSD ä¸ Chunk ç©ºé—´åˆ†é…æ–¹æ³•æ²¡æœ‰ç»†è‡´çš„æè¿°</li>
</ul>
<p><strong>PolarSwitch</strong></p>
<ul>
<li>åŒä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®åº“å®ä¾‹ä¸€èµ·éƒ¨ç½²åœ¨æ•°æ®åº“æœåŠ¡å™¨ä¸Š</li>
<li>libpfs å°† I/O è¯·æ±‚ä¼ é€’ç»™ PolarSwitchï¼Œæ¯ä¸ª I/O è¯·æ±‚åŒ…å« (volumn id, offset, length)</li>
<li>PolarSwitch æ ¹æ®ç¼“å­˜çš„ Volumn å…ƒæ•°æ®æŠŠ I/O å†å‘é€åˆ°å¯¹åº”çš„ ChunkServer</li>
<li>PolarSwitch ä¸Šçš„ Volumn å…ƒæ•°æ®è·Ÿ PolarCtrl æ˜¯åŒæ­¥çš„</li>
<li>Chunk çš„å‰¯æœ¬ä¿¡æ¯å…ƒæ•°æ®ç¼“å­˜åœ¨ PolarSwitch</li>
</ul>
<p><strong>PolarCtrl</strong></p>
<ul>
<li>PolarCtrl ä½œä¸º PolarFS çš„ç®¡æ§é¢ï¼Œéƒ¨ç½²åœ¨ä¸€ç»„ï¼ˆè‡³å°‘3ä¸ªï¼‰ä¸“ç”¨çš„æœåŠ¡å™¨ä¸Šä»¥ä¿è¯æœåŠ¡é«˜å¯ç”¨</li>
<li>ç›‘æµ‹é›†ç¾¤ä¸­ ChunkServer çš„æ´»åŠ¨çŠ¶æ€</li>
<li>åœ¨å…ƒæ•°æ®æ•°æ®åº“ï¼ˆMysql å®ä¾‹ï¼‰ä¸­ç»´æŠ¤ Volumns çŠ¶æ€ å’Œ Chunks ä½ç½®</li>
<li>åˆ›å»º Volumn å¹¶å°† Chunks åˆ†é…ç»™ ChunkServer</li>
<li>å°†å…ƒæ•°æ®åŒæ­¥åˆ° PolarSwitchï¼Œæ¨å’Œæ‹‰ä¸¤ç§æ–¹å¼éƒ½æœ‰</li>
<li>ç›‘æ§ Volumn å’Œ Chunk çš„ I/O æ—¶å»¶å’Œåå</li>
<li>å‘¨æœŸæ€§åœ°å‘èµ·å‰¯æœ¬å†…å’Œå‰¯æœ¬é—´çš„CRCæ•°æ®æ ¡éªŒ</li>
</ul>
<h4 id="io-æ‰§è¡Œæ¨¡å‹"><a class="header" href="#io-æ‰§è¡Œæ¨¡å‹">I/O æ‰§è¡Œæ¨¡å‹</a></h4>
<p>å¯¹äºå†™è¯·æ±‚ï¼Œæ•°æ®åº“å®ä¾‹é€šå¸¸ä¼šè°ƒç”¨ pfs_fallocate é¢„åˆ†é…ç©ºé—´ï¼Œä»¥æ­¤é¿å…æ˜‚è´µçš„å…ƒæ•°æ®æ“ä½œã€‚libpfs é€šè¿‡å…±äº«å†…å­˜ä¸ PolarSwitch è¿›è¡Œæ•°æ®äº¤æ¢ã€‚å…±äº«å†…å­˜ä»¥ç”Ÿäº§è€…æ¶ˆè´¹è€…çš„å½¢å¼ç»„æˆå¤šä¸ª ring bufferã€‚</p>
<p>è¯»è¯·æ±‚ç®€å•çš„ç”± Consensus Group çš„ Leader å¤„ç†ï¼Œè€Œå†™è¯·æ±‚åˆ™æ¶‰åŠæ‰€æœ‰çš„ Replicaã€‚ä¸‹å›¾å±•ç¤ºäº†å†™ I/O çš„æµç¨‹ï¼š</p>
<p><img src="fs/./../assets/images/polarfs_write_io_excution_flow.jpg" alt="write io excution flow" /></p>
<ol>
<li>PolarDB é€šè¿‡ libpfs å’Œ PolarSwitch ä¹‹é—´çš„ ring buffer å°† I/O è¯·æ±‚å‘é€ç»™ PolarSwitch</li>
<li>PolarSwitch é€šè¿‡ç¼“å­˜çš„å…ƒæ•°æ®ä¿¡æ¯å°† I/O è½¬å‘ç»™å¯¹åº”çš„ Chunk çš„ Leader èŠ‚ç‚¹</li>
<li>Leader Node é€šè¿‡ RDMA è¯­ä¹‰æ“ä½œï¼ˆé€šå¸¸æ˜¯å•è¾¹æ“ä½œï¼‰å°† I/O æ”¾åˆ°é¢„æ³¨å†Œå¥½çš„ buffer ä¸­ï¼Œå¹¶å°†è¯·æ±‚æ”¾åˆ°è¯·æ±‚é˜Ÿåˆ—ï¼Œä¸€ä¸ªä¸“ç”¨çš„çº¿ç¨‹å¾ªç¯ä»è¯¥é˜Ÿè½®è¯¢æ¶ˆæ¯</li>
<li>è¯·æ±‚é€šè¿‡ SPDK è¢«å†™å…¥æ—¥å¿—å¹¶ä¸”é€šè¿‡ RDMA å‘é€åˆ° Follower èŠ‚ç‚¹</li>
<li>åœ¨ Follower èŠ‚ç‚¹ï¼ŒRDMA NIC å°† Leader èŠ‚ç‚¹å‘æ¥çš„ I/O è¯·æ±‚æ”¾åˆ°ä¸æ³¨å†Œå¥½çš„ buffer ä¸­ï¼Œå¹¶å°†è¯·æ±‚æ”¾åˆ°è¯·æ±‚é˜Ÿåˆ—</li>
<li>Follower èŠ‚ç‚¹ä¹Ÿæœ‰ä¸€ä¸ªä¸“ç”¨çš„çº¿ç¨‹ä»é˜Ÿåˆ—è½®è¯¢å°†è¯·æ±‚é€šè¿‡ SDPK å¼‚æ­¥å†™å…¥ç£ç›˜</li>
<li>Follower å°†å†™å…¥æˆåŠŸçš„æ¶ˆæ¯é€šè¿‡ RDMA å‘é€ç»™ Leader</li>
<li>Leader èŠ‚ç‚¹æ”¶åˆ°å¤šæ•° Follower è¿”å›çš„å†™å…¥æˆåŠŸåï¼ŒLeader é€šè¿‡ SDPK å°†å†™è¯·æ±‚å†™å…¥ç£ç›˜ï¼ˆæ­¥éª¤4åªå†™äº†æ—¥å¿—ï¼‰</li>
<li>Leader é€šè¿‡ RDMA å›å¤ PolarSwitch</li>
<li>PolarSwitch å›å¤å®¢æˆ·ç«¯</li>
</ol>
<p>ä»ä¸Šè¿°è¿‡ç¨‹å¯ä»¥çœ‹å‡º PolarFS ä½¿ç”¨äº†å¤§é‡çš„ bypass kernel çš„æŠ€æœ¯ã€‚</p>
<h3 id="parallelraft"><a class="header" href="#parallelraft">ParallelRaft</a></h3>
<p>è¿™éƒ¨åˆ†åªæ˜¯ç®€å•æµè§ˆäº†ä¸€ä¸‹ï¼Œä»¥åæœ‰æœºä¼šå†è¯¦ç»†æ‹œè¯»ã€‚</p>
<h4 id="references-20"><a class="header" href="#references-20">References:</a></h4>
<p>[1] <a href="https://topic.atatech.org/articles/107314">PolarFSï¼šé¢å‘äº‘æ•°æ®åº“çš„è¶…ä½å»¶è¿Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆå‘è¡¨äºVLDB 2018ï¼‰</a> by é¸£åµ©</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="large-language-models"><a class="header" href="#large-language-models">Large Language Models</a></h2>
<ul>
<li><strong><a href="https://arxiv.org/abs/2303.18223">A Survey of Large Language Models</a></strong> Â· <a href="https://github.com/RUCAIBox/LLMSurvey">github</a> Â· <a href="llm//assets/pdfs/llm_survey_2303.18223.pdf">pdf</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="storage"><a class="header" href="#storage">storage</a></h2>
<ul>
<li><strong><a href="storage/kv/index.html">KV store</a></strong>
<ul>
<li><strong><a href="storage/kv/dynamo.html">Dynamo: Amazonâ€™s Highly Available Key-value Store</a></strong></li>
</ul>
</li>
<li><strong><a href="storage/kudu.html">Kudu: Storage for Fast Analytics on Fast Data</a></strong></li>
<li><strong><a href="storage/bluestore.html">File Systems Unfit as Distributed Storage Backends: Lessons from 10 Years of Ceph Evolution</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="kv-store"><a class="header" href="#kv-store">kv store</a></h2>
<ul>
<li><strong><a href="storage/kv/dynamo.html">Dynamo: Amazonâ€™s Highly Available Key-value Store</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefstoragekvassetspdfsamazon-dynamo-sosp2007pdfdynamo-amazons-highly-available-key-value-storea"><a class="header" href="#a-hrefstoragekvassetspdfsamazon-dynamo-sosp2007pdfdynamo-amazons-highly-available-key-value-storea"><a href="storage/kv/../../../assets/pdfs/amazon-dynamo-sosp2007.pdf">Dynamo: Amazonâ€™s Highly Available Key-value Store</a></a></h3>
<blockquote>
<p>ACM SIGOPS Operating Systems Review, Volume 41, Issue 6 â€¢ December 2007 â€¢ pp 205â€“220</p>
<p>https://dl.acm.org/doi/10.1145/1323293.1294281</p>
</blockquote>
<p>äºšé©¬é€Šç”µå­å•†åŠ¡å¹³å°è¿è¡Œåœ¨ç”±æ•°ä»¥ä¸‡è®¡çš„æœåŠ¡å™¨å’Œç½‘ç»œç»„ä»¶ã€åˆ†å¸ƒåœ¨ä¸–ç•Œå„åœ°çš„æ•°æ®ä¸­å¿ƒæ„æˆçš„åŸºç¡€è®¾æ–½ä¹‹ä¸Šï¼Œåœ¨è¿™æ ·çš„è§„æ¨¡ä¸‹ç¡¬ä»¶æ•…éšœéœ€è¦è¢«è§†ä¸ºå¸¸æ€ï¼Œè¿™é©±åŠ¨äº†è½¯ä»¶ç³»ç»Ÿå¯é æ€§å’Œå¯æ‰©å±•æ€§çš„è®¾è®¡ã€‚Dynamo ä½œä¸ºä¸€ä¸ªé«˜å¯ç”¨ï¼ˆalways writableï¼‰ã€é«˜å¯æ‰©å±•çš„ kv å­˜å‚¨ç³»ç»Ÿï¼Œä¸ºäºšé©¬é€Šçš„ä¸€äº›æ ¸å¿ƒæœåŠ¡æä¾›æ°¸è¿œåœ¨çº¿ï¼ˆalways-onï¼‰çŠ¶æ€å­˜å‚¨èƒ½åŠ›ã€‚</p>
<blockquote>
<p>Dynamo is used to manage the state of services that have very
high reliability requirements and need tight control over the
tradeoffs between availability, consistency, cost-effectiveness and
performance.</p>
</blockquote>
<p>äºšé©¬é€Šå¹³å°æœ‰å¾ˆå¤šåº”ç”¨æœåŠ¡åªéœ€è¦é€šè¿‡ä¸»é”®è®¿é—®æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯è´­ç‰©è½¦æœåŠ¡ã€‚Dynamo å°†é”®å’Œå€¼éƒ½è§†ä¸ºå­—èŠ‚æ•°ç»„ï¼Œé€šè¿‡ MD5 ç®—æ³•å°†ä¸»é”®æ˜ å°„ä¸ºä¸€ä¸ª 128 æ¯”ç‰¹çš„æ ‡è¯†ç¬¦ï¼Œå¹¶æš´éœ²äº†ä¸¤ä¸ªæ¥å£:</p>
<ul>
<li>get(key): {object, context}</li>
<li>put(key, context, object): void</li>
</ul>
<p><code>context</code> ä½œä¸º <code>object</code> çš„å…ƒæ•°æ®å’Œ <code>object</code> ä¸€èµ·å­˜å‚¨ï¼Œå®ƒç¼–ç äº† object çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚</p>
<p>Dynamo çš„ä¸»è¦è´¡çŒ®åœ¨äºè¯„ä¼°äº†å¦‚ä½•å°†ä¸åŒçš„çš„æŠ€æœ¯ç»“åˆèµ·æ¥æä¾›ä¸€ä¸ªé«˜å¯ç”¨æ€§ç³»ç»Ÿã€‚ä¸‹è¡¨å±•ç¤ºäº† Dynamo ä½¿ç”¨çš„æŠ€æœ¯åŠå…¶ä¼˜åŠ¿:</p>
<img src="storage/kv/../../../assets/images/dynamo_techniques.jpg" alt="Summary of techniques used in Dynamo and their advantages" width="700"/>
<h4 id="partitioning"><a class="header" href="#partitioning">Partitioning</a></h4>
<p>ä¸€è‡´æ€§ Hash ç®—æ³•æ¥å°†æ•°æ®åˆ†å¸ƒåˆ°ä¸åŒçš„å­˜å‚¨èŠ‚ç‚¹ï¼Œåœ¨æ­¤åŸºç¡€ä¹‹ä¸Šï¼ŒDynamo å°†èŠ‚ç‚¹ï¼ˆnodeï¼‰æ˜ å°„ä¸ºå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼ˆvnodeï¼‰ï¼Œæ¯ä¸ª vnode å¯¹åº”ä¸€è‡´æ€§ Hash ç®—æ³•ç¯ä¸Šçš„ä¸€ä¸ªç‚¹ã€‚ä½¿ç”¨ vnode çš„ä¼˜åŠ¿æœ‰:</p>
<ul>
<li>If a node becomes unavailable, the load handled by this node is evenly dispersed across the remaining available nodes.</li>
<li>When a node becomes available again, or a new node is added to the system, the newly available node accepts a roughly equivalent amount of load from each of the other available nodes.</li>
<li>The number of virtual nodes that a node is responsible can decided based on its capacity, accounting for heterogeneity in the physical infrastructure.</li>
</ul>
<h4 id="replication"><a class="header" href="#replication">Replication</a></h4>
<p>ä¸ºäº†å®ç°é«˜å¯ç”¨æ€§å’ŒæŒä¹…æ€§ï¼ŒDynamo å°†æ•°æ®å¤åˆ¶åˆ° N ä¸ªèŠ‚ç‚¹ï¼ˆvnodeï¼‰ï¼ŒN æ˜¯æ¯ä¸ª Dynamo å®ä¾‹çš„é…ç½®é¡¹ã€‚æ¯æ¡æ•°æ®çš„ key åœ¨å“ˆå¸Œç¯ä¸Šæ˜ å°„çš„ç¬¬ä¸€ä¸ª vnode ä½œä¸ºå®ƒæ‰€è´Ÿè´£èŒƒå›´çš„ coordinatorï¼Œä¸åç»­çš„ N - 1 ä¸ª vnode ä¸€èµ·æ„æˆå­˜å‚¨è¯¥é”®å€¼å¯¹çš„ <code>preference list</code>ã€‚ä¸ºäº†ä½¿æ•°æ®åˆ†å¸ƒåœ¨ N ä¸ªç‰©ç†èŠ‚ç‚¹ä¸Šï¼Œ<code>preference list</code> è¢«è®¾è®¡ä¸ºè·³è¿‡å·²åŒ…å«ç‰©ç†èŠ‚ç‚¹ä¸Šçš„å…¶å®ƒ vnodeã€‚</p>
<h4 id="data-versioning"><a class="header" href="#data-versioning">Data Versioning</a></h4>
<p>Dynamo è¢«è®¾è®¡ä¸ºä¸€ä¸ªæœ€ç»ˆä¸€è‡´æ€§å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ›´æ–°æœ€ç»ˆä¼šåˆ°è¾¾æ‰€æœ‰å‰¯æœ¬ã€‚åœ¨èŠ‚ç‚¹å¤±æ•ˆæˆ–ç½‘ç»œåˆ†åŒºçš„æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¿è¯å†™å¯ç”¨ï¼ŒDynamo å°†æ¯æ¬¡ä¿®æ”¹çš„ç»“æœè§†ä¸ºä¸€ä¸ªæ–°çš„ä¸å¯å˜çš„æ•°æ®ç‰ˆæœ¬ï¼Œç³»ç»ŸåŒä¸€æ—¶åˆ»å¯èƒ½å­˜åœ¨åŒä¸€æ•°æ®çš„ä¸åŒç‰ˆæœ¬ã€‚</p>
<blockquote>
<p>Most of the time, new versions subsume the previous version(s),
and the system itself can determine the authoritative version (syntactic reconciliation).</p>
<p>However, version branching may happen, in the presence of failures combined with concurrent 
updates, resulting in conflicting versions of an object.</p>
</blockquote>
<p>Dynamo ä½¿ç”¨<a href="storage/kv/../../distributedsystem/holygrail.html">å‘é‡æ—¶é’Ÿ</a>æ¥ç¡®å®šåŒä¸€æ•°æ®å¯¹è±¡ä¸åŒç‰ˆæœ¬ä¹‹é—´çš„å› æœå…³ç³»ã€‚</p>
<blockquote>
<p>If the counters on the first objectâ€™s clock are less-than-or-equal to all of the nodes
in the second clock, then the first is an ancestor of the second and can be forgotten.</p>
<p>Otherwise, the two changes are considered to be in conflict and require reconciliation.</p>
</blockquote>
<p>å½“ Dynamo æ›´æ–°ä¸€ä¸ªæ•°æ®å¯¹è±¡çš„æ—¶å€™ï¼Œå®ƒéœ€è¦æŒ‡å®šå®ƒè¦æ›´æ–°çš„æ•°æ®ç‰ˆæœ¬ï¼ˆvector clock ä¿¡æ¯ï¼‰ï¼Œè¿™äº›æ•°æ®åŒ…å«åœ¨ä¸ object ä¸€åŒä¿å­˜çš„ context ä¸­ã€‚åœ¨å¤„ç†ä¸€ä¸ªè¯»å–è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœ Dynamo è·å–äº†å¤šä¸ªä¸èƒ½åè°ƒçš„åˆ†æ”¯ï¼Œä¼šè¿”å›å¤šä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œç”± client ç«¯æ¥å†³ä½¿ç”¨ä»€ä¹ˆç­–ç•¥æ¥åè°ƒå¤šä¸ªæ•°æ®ç‰ˆæœ¬ï¼ˆ<code>merge</code> or <code>last write win</code>ï¼‰ã€‚ä¸‹å›¾å±•ç¤ºäº†ä½¿ç”¨å‘é‡æ—¶é’Ÿçš„æ•°æ®ç‰ˆæœ¬çš„æ¼”è¿›è¿‡ç¨‹:</p>
<img src="storage/kv/../../../assets/images/dynamo_version_evolution.jpg" alt="Version evolution of an object over time" width="450"/>
<p>ä½¿ç”¨å‘é‡æ—¶é’Ÿçš„ä¸€ä¸ªé—®é¢˜æ˜¯å½“èŠ‚ç‚¹å¤±è´¥æˆ–ç½‘ç»œåˆ†åŒºå‘ç”Ÿçš„æ—¶å€™ï¼Œå†™æ“ä½œéœ€è¦ <code>preference list</code> ä¹‹å¤–çš„èŠ‚ç‚¹æ¥ç®¡ï¼Œè¿™ä¼šé€ æˆ vector clock çš„å¤§å°å¢é•¿ï¼ŒDynamo ä½¿ç”¨äº†ä¸€ç§ clock truncate çš„æ¨¡å¼æ¥è§£å†³æ­¤é—®é¢˜ã€‚</p>
<h4 id="sloppy-quorum-protocol"><a class="header" href="#sloppy-quorum-protocol">Sloppy Quorum Protocol</a></h4>
<p>ä¼ ç»Ÿçš„ Quorum æœ‰ä¸¤ä¸ªå…³é”®çš„å¯é…ç½®å€¼ï¼šR å’Œ W:</p>
<ul>
<li>R æ˜¯å‚ä¸è¯»æ“ä½œå¿…é¡»æˆåŠŸçš„æœ€å°èŠ‚ç‚¹æ•°</li>
<li>W æ˜¯å‚ä¸å†™æ“ä½œå¿…é¡»æˆåŠŸçš„æœ€å°èŠ‚ç‚¹æ•°</li>
</ul>
<p>è®¾ç½® <code>R + W &gt; N</code> èƒ½ä¿è¯è¯»å’Œå†™è¦†ç›–ï¼Œå¯ç”¨äºå®ç°å¼ºä¸€è‡´æ€§ã€‚</p>
<p>ä¼ ç»Ÿçš„ Quorum åè®®åœ¨èŠ‚ç‚¹å¤±è´¥å’Œç½‘ç»œåˆ†åŒºçš„çš„æ—¶å€™ä¼šé€ æˆç³»ç»Ÿä¸å¯ç”¨ã€‚Dynamo ä½¿ç”¨ Sloppy Quorum æ¥è§£å†³æ­¤é—®é¢˜ã€‚</p>
<blockquote>
<p>All read and write operations are performed on the first N healthy nodes from
the preference list, which may not always be the first N nodes encountered while walking the consistent hashing ring.</p>
</blockquote>
<p>ä½¿ç”¨ <code>Hinted Handoff</code>ï¼ŒDynamo ç¡®ä¿è¯»å–å’Œå†™å…¥æ“ä½œä¸ä¼šå› ä¸´æ—¶èŠ‚ç‚¹æˆ–ç½‘ç»œçš„å¤±è´¥è€Œå¤±è´¥ï¼ŒSloppy Quorum æ˜¯ Dynamo <code>always writable</code> çš„å…³é”®ã€‚</p>
<h4 id="anti-entropy-using-merkle-trees"><a class="header" href="#anti-entropy-using-merkle-trees">Anti-entropy Using Merkle trees</a></h4>
<p>å½“ <code>Hinted Handoff</code> ä¸å¯ç”¨æ˜¯ï¼Œä¸åŒèŠ‚ç‚¹éœ€è¦åŒæ­¥æ•°æ®ä»¥ä¿è¯å‰¯æœ¬çš„ä¸€è‡´æ€§ï¼ŒDynamo ä½¿ç”¨ Merkle tree æ¥æ›´å¿«åœ°æ£€æµ‹å‰¯æœ¬ä¹‹é—´çš„ä¸ä¸€è‡´å¹¶æ˜¯éœ€è¦ä¼ è¾“çš„æ•°æ®é‡æœ€å°åŒ–ã€‚</p>
<blockquote>
<p>Each node maintains a separate Merkle tree for each key range (the set of
keys covered by a virtual node) it hosts. This allows nodes to compare whether the keys within a key range are up-to-date.</p>
</blockquote>
<h4 id="membership"><a class="header" href="#membership">Membership</a></h4>
<p>Dynamo çš„æœ€ç»ˆä¸€è‡´æ€§ä¸ä»…ä½“ç°åœ¨æ•°æ®ä¸Šï¼Œå…¶èŠ‚ç‚¹æˆå‘˜ä¿¡æ¯é€šè¿‡ <code>Gossp-based</code> åè®®è¾¾æˆæœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<blockquote>
<p>A gossip-based protocol propagates membership changes and maintains an eventually
consistent view of membership. Each node contacts a peer chosen at random every
second and the two nodes efficiently reconcile their persisted membership change histories.</p>
</blockquote>
<p>æ•°æ®åˆ†åŒºå’Œæ”¾ç½®ä¿¡æ¯ä¹Ÿæ˜¯é€šè¿‡ <code>Gossip-based</code> åè®®è¿›è¡Œä¼ æ’­ï¼Œä»¥ä¿è¯æ¯ä¸ªå­˜å‚¨èŠ‚ç‚¹çŸ¥é“å…¶å¯¹ç­‰æ–¹å¤„ç†çš„æ•°æ®èŒƒå›´ã€‚</p>
<p>Dynamo é€šè¿‡ä¸€äº›èŠ‚ç‚¹æ‰®æ¼” <code>seed</code> çš„è§’è‰²æ¥é˜²æ­¢ <code>logically partitioned ring</code>ã€‚</p>
<h4 id="references-21"><a class="header" href="#references-21">References:</a></h4>
<p>[1] <a href="https://www.youtube.com/watch?v=xakpenkbOr0">Review of the Amazon Dynamo Paper</a> by Lindsey Kuper</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefstorageassetspdfskudupdfkudu-storage-for-fast-analytics-on-fast-dataa"><a class="header" href="#a-hrefstorageassetspdfskudupdfkudu-storage-for-fast-analytics-on-fast-dataa"><a href="storage/../assets/pdfs/kudu.pdf">Kudu: Storage for Fast Analytics on Fast Data</a></a></h3>
<blockquote>
<p>2015</p>
<p>https://kudu.apache.org/kudu.pdf</p>
</blockquote>
<p>Kudu æ˜¯ä¸€ä¸ªå¼€æºçš„ç»“æ„åŒ–çš„å­˜å‚¨å¼•æ“ï¼Œå®ƒå¯ç”¨äºä½å»¶è¿Ÿçš„éšæœºè®¿é—®åŠé«˜æ•ˆçš„åˆ†æè®¿é—®æ¨¡å‹ã€‚Kudu çš„è®¾è®¡å¡«è¡¥äº†ã€é«˜ååé¡ºåºè®¿é—®ã€å’Œã€ä½å»¶è¿Ÿéšæœºè®¿é—®ã€ä¸¤ç§è®¿é—®æ¨¡å¼ä¸å¯å…¼å¾—çš„ç©ºç¼ºã€‚</p>
<blockquote>
<p>Kudu offers a &quot;happy medium&quot; alternative that can dramatically simplify the architecture of 
many common workloads. In particular, Kudu offers a simple API for row-level inserts, 
updates, and deletes, while <strong>providing table scans at throughputs similar to Parquet</strong>, 
a commonly-used columnar format for static data.</p>
</blockquote>
<h4 id="kude-at-a-high-level"><a class="header" href="#kude-at-a-high-level">Kude at a high level</a></h4>
<p>ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼ŒKudu æ˜¯ä¸€ä¸ªç”¨äºç»“æ„åŒ–æ•°æ®è¡¨çš„å­˜å‚¨ç³»ç»Ÿã€‚ä¸€ä¸ª Kudu é›†ç¾¤å¯ä»¥åŒ…å«ä»»æ„æ•°é‡çš„è¡¨ï¼Œæ¯ä¸ªè¡¨ç”±æœ‰é™ä¸ªæ•°çš„åˆ—æ„æˆï¼Œéƒ¨åˆ†åˆ—ä¼šè¢«å®šä¹‰ä¸º <em>primary key</em>ï¼ˆä¸æ”¯æŒäºŒçº§ç´¢å¼•ï¼‰ã€‚Kudu ä½¿ç”¨è¿™ç§å…³ç³»å‹æ•°æ®åº“çš„æ¨¡å¼ç”±ä»¥ä¸‹ä¸¤ä¸ªå› ç´ é©±ä½¿:</p>
<ol>
<li>Explicit types allow us to use type-specific columnar en-codings such as bit-packing for integers.</li>
<li>Explicit types allow us to expose SQL-like metadata to other systems such as commonly used business intelligence or data exploration tools.</li>
</ol>
<h4 id="architecture-2"><a class="header" href="#architecture-2">Architecture</a></h4>
<p>Kudu çš„æ¶æ„å»¶ç»­äº† BigTable å’Œ GFS çš„è®¾è®¡ï¼Œç”± master èŠ‚ç‚¹å’Œ tablet server èŠ‚ç‚¹æ„æˆã€‚</p>
<p><img src="storage/../assets/images/kudu_network_architecture.jpg" alt="kudu network architecture" /></p>
<p>Kudu master è´Ÿè´£å­˜å‚¨é›†ç¾¤çš„å…ƒæ•°æ®ï¼Œå¤šä¸ª master èŠ‚ç‚¹é€šè¿‡ Raft ç®—æ³•æ¥ä¿è¯é«˜å¯ç”¨ï¼Œleader è´Ÿè´£å“åº”å®¢æˆ·ç«¯è¯·æ±‚ã€‚master çš„ä¸»è¦èŒè´£:</p>
<ol>
<li>Act as a catalog manager, keeping track of which tables and tablets exist, as well as their schemas, desired replication levels, and other metadata.</li>
<li>Act as a cluster coordinator, keeping track of which servers in the cluster are alive and coordinating redistribution of data after server failures.</li>
<li>Act as a tablet directory, keeping track of which tablet servers are hosting replicas of each tablet.</li>
</ol>
<p>Tablet server è´Ÿè´£ä¿å­˜å’Œå¤„ç†æ•°æ®ï¼Œtablet åŒæ ·ä½¿ç”¨ Raft ç®—æ³•ï¼ˆé»˜è®¤ 3ï¼Œå¯ä»¥åœ¨åˆ›å»ºè¡¨æ—¶æŒ‡å®šï¼‰åŠ <em>one-by-one</em> çš„é…ç½®å˜æ›´ç®—æ³•ï¼ˆæ–°å¢æˆ–è¸¢é™¤ tabletï¼‰æ¥ä¿è¯æ•°æ®æ°¸è¿œå¯ç”¨ã€‚</p>
<p>åˆ†åŒºç”± <strong>hash-partitioning</strong> å’Œ <strong>range-partioning</strong> æ„æˆï¼Œç±»ä¼¼ AnalyticDB çš„ä¸€çº§åˆ†åŒºå’ŒäºŒçº§åˆ†åŒºã€‚</p>
<h4 id="tablet-storage"><a class="header" href="#tablet-storage">Tablet storage</a></h4>
<p>Kudu çš„ tablet å­˜å‚¨æœ‰å¦‚ä¸‹å‡ ä¸ªç›®æ ‡:</p>
<ol>
<li>Fast columnar scans</li>
<li>Low-latency random updates</li>
<li>Consistency of performance</li>
</ol>
<p>æ¯ä¸€ä¸ª tablet çš„å­˜å‚¨ä½œä¸º raft æ—¥å¿—åçš„çŠ¶æ€æœºï¼Œæ˜¯ä¸€ä¸ª LSM tree å•æœºå­˜å‚¨å¼•æ“ï¼ŒåŒ…å«å¦‚ä¸‹å‡ ä¸ªæ¨¡å—:</p>
<ul>
<li>MemRowSet: å­˜å‚¨æ’å…¥çš„æ•°æ®ï¼Œå½“ size è¾¾åˆ°ä¸€å®šé˜ˆå€¼åå†™å…¥ç£ç›˜å½¢æˆä¸€ä¸ª DistRowSet</li>
<li>DistRowSet: ç”± MemRowSet åˆ·ç›˜è€Œæ¥ï¼ŒåŒ…å« <em>base data</em> å’Œ <em>delta store</em></li>
<li>DeltaMemStore: ç”±äº base data çš„ä¸å¯å˜æ›´æ€§ï¼Œå°†æ›´æ–°æ•°æ®å†™å…¥è¯¥ç»“æ„</li>
<li>DeltaFile: DeltaMemStore åˆ·ç›˜è€Œæ¥</li>
</ul>
<p>tablet å­˜å‚¨çš„è®¾è®¡éœ€è¦æ»¡è¶³ä»¥ä¸‹çº¦æŸ:</p>
<ol>
<li>æ¯ä¸ªä¸»é”®åªèƒ½å­˜åœ¨ä¸€ä¸ª RowSetï¼ˆMemRowSet æˆ– DistRowSetï¼‰</li>
<li>ä¸åŒçš„ RowSet çš„ key range ä¼šæœ‰é‡åˆ</li>
</ol>
<p>ç¬¬äºŒä¸ªçº¦æŸä¸éš¾ç†è§£ï¼ŒLSM tree éƒ½æœ‰è¿™æ ·çš„ç‰¹æ€§ã€‚æ¯ä¸ªä¸»é”®åªèƒ½åœ¨ä¸€ä¸ª RowSet åˆ™éœ€è¦åœ¨æ›´æ–°çš„æ’å…¥çš„æ—¶å€™å…ˆæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ primary keyï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å°†æ›´æ–°å†™å…¥å¯¹åº”çš„ DistRowSet çš„ DeltaMemStoreï¼Œå¦åˆ™ç›´æ¥æ’å…¥åˆ° MemRowSetï¼Œè¯¥è¿‡ç¨‹è¢«ç§°ä¸º upsertã€‚</p>
<p>ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒKudu é€šè¿‡ Bloom filterã€Compaction ç­‰ç‰¹æ€§æ¥åŠ é€ŸæŸ¥è¯¢ã€‚</p>
<h4 id="references-22"><a class="header" href="#references-22">References:</a></h4>
<p>[1] <a href="https://docs.cloudera.com/runtime/7.2.8/kudu-overview/kudu-overview.pdf">Apache Kudu Overview</a></p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="a-hrefstorageassetspdfsfilesystemsunfitasdistributedstoragebackends-lessonsfromtenyearsofcephevolutionpdffile-systems-unfit-as-distributed-storage-backends-lessons-from-10-years-of-ceph-evolutiona"><a class="header" href="#a-hrefstorageassetspdfsfilesystemsunfitasdistributedstoragebackends-lessonsfromtenyearsofcephevolutionpdffile-systems-unfit-as-distributed-storage-backends-lessons-from-10-years-of-ceph-evolutiona"><a href="storage/../assets/pdfs/FileSystemsUnfitAsDistributedStorageBackends-lessonsFromTenYearsOfCephEvolution.pdf">File Systems Unfit as Distributed Storage Backends: Lessons from 10 Years of Ceph Evolution</a></a></h3>
<blockquote>
<p>SOSP 2019</p>
<p>https://doi.org/10.1145/3341301.3359656</p>
</blockquote>
<p>å¾ˆå¤šåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿé€‰æ‹©å°†å…¶å­˜å‚¨åç«¯æ„å»ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼Œå¦‚ ext4, XFSï¼ŒåŸå› åœ¨äº:</p>
<ul>
<li>å°†æŒä¹…åŒ–åŠç£ç›˜ç©ºé—´ç®¡ç†çš„å·¥ä½œäº¤ç»™äº†å¥å£®çš„å†…æ ¸ä»£ç </li>
<li>æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæä¾›äº† Posix æ¥å£åŠæ–‡ä»¶ç›®å½•æŠ½è±¡</li>
<li>å¯ä»¥ä½¿ç”¨æ ‡å‡†å·¥å…·ï¼ˆls, findï¼‰æ¥æŸ¥çœ‹æ•°æ®å†…å®¹</li>
</ul>
<p>Ceph ä¹Ÿä¸ä¾‹å¤–ï¼Œåœ¨å…¶æ¶æ„æ¼”è¿›çš„è¿›ç¨‹ä¸­å‰åä½¿ç”¨è¿‡ Btrfsï¼ŒXFS ç­‰æ–‡ä»¶ç³»ç»Ÿä½œä¸ºå…¶ FileStore çš„åç«¯å­˜å‚¨ï¼Œä½†åœ¨éµå¾ªè¿™ç§æƒ¯ä¾‹ 10 å¹´åï¼Œå‘ç°ä»¥æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä½œä¸ºå­˜å‚¨åç«¯æœ‰ç€æ˜‚è´µçš„ä»£ä»·:</p>
<ul>
<li>developing a zero-overhead transaction mechanism is challenging</li>
<li>metadata performance at the local level can significantly affect performance at the distributed level</li>
<li>supporting emerging storage hardware is painstakingly slow</li>
</ul>
<p>ç¬¬ä¸€ï¼Œåœ¨ç°æœ‰çš„æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šå®ç°é«˜æ•ˆçš„äº‹åŠ¡éå¸¸å›°éš¾ï¼ˆæ€§èƒ½å¼€é”€ã€åŠŸèƒ½é™åˆ¶ã€æ¥å£å¤æ‚åº¦æˆ–è€…å®ç°éš¾åº¦ï¼‰ï¼Œæœ‰ä¸‰ç§å¯åšå°è¯•çš„æ–¹æ³•ï¼š</p>
<ol>
<li>hooking into a file systemâ€™s internal (but limited) transaction mechanism</li>
<li>implementing a WAL in user space</li>
<li>using a key-value database with transactions as a WAL</li>
</ol>
<p>Ceph åœ¨å°è¯•ä¸Šè¿°ä¸‰ç§æ–¹å¼æ—¶éƒ½é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œå¦‚ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå†…ç½®çš„äº‹åŠ¡æœºåˆ¶ä¼šé€ æˆæ•°æ®éƒ¨åˆ†æäº¤ï¼›åœ¨ç”¨æˆ·æ€å®ç° WAL æœ‰ Read-Modify-Writeã€æ“ä½œéå¹‚ç­‰å¼•èµ·è¿›ç¨‹é‡å¯åæ•°æ®ä¸ä¸€è‡´ã€æ•°æ®åŒå†™ç­‰é—®é¢˜ï¼›ä½¿ç”¨ KVæ•°æ®åº“ä½œä¸º WAL çš„ NewStore è§£å†³äº†ç”¨æˆ·æ€ WAL çš„é—®é¢˜ï¼Œä½†ç”±äºæ¯ä¸ªäº‹åŠ¡éœ€è¦å…ˆå†™æ•°æ®å†å†™å…ƒæ•°æ®ï¼Œåˆ†åˆ«å¯¹åº”ä¸€æ¬¡ fsyncï¼Œè€Œå¯¹äº fsyncï¼Œæ–‡ä»¶ç³»ç»Ÿçš„è¡Œä¸ºæ˜¯å…ˆ flush æ•°æ®å† flush å…ƒæ•°æ®ï¼Œè¿™å°±é€ æˆäº†åœ¨ NewStore ä¸­å†™ä¸€ä¸ªå¯¹è±¡å¯¼è‡´äº†å››æ¬¡æ˜‚è´µçš„åˆ·ç›˜æ“ä½œï¼Œå…¸å‹çš„ <strong>journaling of journal</strong> é—®é¢˜ã€‚</p>
<p>ç¬¬äºŒï¼Œå…ƒæ•°æ®çš„æ€§èƒ½ä½æ•ˆä¼šæ‰©æ•£åˆ°æ•´ä¸ªé›†ç¾¤ã€‚Ceph å›¢é˜Ÿé‡åˆ°çš„ä¸€ä¸ªæŒ‘æˆ˜æ˜¯ Posix æ–‡ä»¶ç³»ç»Ÿçš„ readdir æ“ä½œè¿”å›ç»“æœæ˜¯ä¹±åºçš„ï¼Œä¸ºäº†ä¿è¯æ’åºçš„é«˜æ•ˆï¼Œéœ€è¦å¯¹ç›®å½•è¿›è¡Œåˆ†è£‚ï¼Œè¿™å°±ä¼šå½±å“å…¨å±€æ€§èƒ½ã€‚</p>
<p>ç¬¬ä¸‰ï¼Œç”±äºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿé€šå¸¸è¿è¡Œåœ¨å†…æ ¸æ€ï¼Œå½“ Ceph æƒ³è¦æ”¯æŒä¸€ä¸ªæ–°çš„ç¡¬ä»¶ï¼ˆå¦‚ SMRã€ZNSï¼‰çš„æ—¶å°±éœ€è¦ç­‰å¾…æ–‡ä»¶ç³»ç»Ÿç»´æŠ¤è€…çš„æ’æœŸã€‚</p>
<p>åœ¨ 2015 å¹´ï¼ŒCeph å¼€å§‹è®¾è®¡å¹¶å®ç° BlueStore â€”â€” ä¸€ä¸ªç”¨æˆ·æ€çš„å­˜å‚¨åç«¯ï¼Œæ•°æ®ç›´æ¥å­˜å‚¨åœ¨è£¸ç›˜ä¹‹ä¸Šï¼Œå…ƒæ•°æ®å­˜å‚¨åœ¨ kv ä¸­ã€‚å®ƒå®ç°äº†å¦‚ä¸‹ç›®æ ‡ï¼š</p>
<ul>
<li>Fast metadata operations</li>
<li>No consistency overhead for object writes</li>
<li>Copy-on-write clone operation</li>
<li>No journaling double-writes</li>
<li>Optimized I/O patterns for HDD and SSD</li>
</ul>
<p>ä¸ºäº†è¾¾åˆ°å¿«é€Ÿå…ƒæ•°æ®æ“ä½œï¼ŒBlueStore ä½¿ç”¨ RocksDB æ¥å­˜å–å…ƒæ•°æ®ã€‚ä¸ºäº†èƒ½è®©æ•°æ®å’Œå…ƒæ•°æ®å…±å­˜åº•å±‚è®¾å¤‡ï¼ŒBlueStore å®ç°äº†ä¸€ä¸ªèƒ½è¿è¡Œ RockesDB çš„æç®€æ–‡ä»¶ç³»ç»Ÿ BlueFSï¼ŒBlueFs å…·æœ‰ä¸€ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ä¸ºæ¯ä¸ªæ–‡ä»¶ç»´æŠ¤ä¸€ä¸ª inodeï¼Œinode è®°å½•äº†æ–‡ä»¶ä½¿ç”¨çš„ extent æ•°ç»„</li>
<li>ç›®å½•åªæœ‰ä¸€å±‚ï¼Œä¸å­˜åœ¨ç›®å½•åµŒå¥—</li>
<li>å…ƒæ•°æ®éƒ½åœ¨å†…å­˜(super blockã€dirmapã€filemap)</li>
<li>super block å­˜å‚¨åœ¨ offset = 4096 çš„ç£ç›˜ä½ç½®ï¼Œå…¶ä¸­ä¿å­˜äº† ino = 1 çš„ journal æ–‡ä»¶ inode</li>
<li>æ‰€æœ‰å¯¹æ–‡ä»¶ç³»ç»Ÿçš„æ›´æ”¹æ“ä½œï¼ˆå¦‚ mkdir, open, deleteï¼‰éƒ½ä¿å­˜åœ¨ ino = 1 çš„æ–‡ä»¶ä¸­</li>
<li>é€šè¿‡å›æ”¾æ¥è·å– Dir/File è§†å›¾ï¼Œç„¶åé€šè¿‡ fileMap æ¥é‡æ„ Allocator çš„å¯ç”¨å—</li>
</ul>
<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œjournal å’Œå…¶ä»–æ–‡ä»¶çš„ extent æ˜¯äº¤é”™å­˜æ”¾åœ¨æ•´ä¸ªç£ç›˜ä¸Šçš„ï¼Œè€Œç£ç›˜çš„åˆ†é…ç”± Space Allocator ç»Ÿä¸€ç®¡ç†ã€‚</p>
<p>å¯¹äºå¤§å—å†™å…¥ï¼ŒBlueStore é¦–å…ˆå°†æ•°æ®å†™å…¥æ–°åˆ†é…çš„ extent ä¸­ï¼Œä¸€æ—¦æ•°æ®è¢«æŒä¹…åŒ–ï¼Œç›¸åº”çš„å…ƒæ•°æ®è¢«æ’å…¥åˆ° RocksDBï¼Œå¦‚æ­¤å¯ä»¥é«˜æ•ˆåœ°æ”¯æŒå…‹éš†æ“ä½œå¹¶èƒ½é¿å…æ—¥å¿—åŒå†™ï¼›å¯¹äºå°äº allocation size çš„å†™å…¥ï¼Œæ•°æ®å’Œå…ƒæ•°æ®éƒ½è¢«æ’å…¥ RocksDBï¼Œç„¶åå†å¼‚æ­¥å†™å…¥ç£ç›˜ã€‚</p>
<p>BlueStore å®ç°ä¸ºç”¨æˆ·æ€å¹¶é€šè¿‡ DirectIO ç›´æ¥è®¿é—®è£¸ç›˜ï¼Œå› æ­¤ä¸å®ç”¨ kernel æä¾›çš„ page cacheã€‚ä¸ºäº†èƒ½æä¾›é«˜æ•ˆçš„è¯»å†™ï¼ŒBlueStore æ˜¯å®ç°äº†å®ƒè‡ªå·±çš„ write-through cacheï¼Œä½¿ç”¨ 2Q ç®—æ³•å¹¶å¯¹æ•°æ®è¿›è¡Œ shard æ¥æ”¯æŒå¹¶å‘ã€‚</p>
<p>ç”±äºæ§åˆ¶äº†æ‰€æœ‰çš„IOè·¯å¾„ï¼ŒCeph èƒ½æ›´çµæ´»é«˜æ•ˆåœ°æä¾›ç”¨æˆ·éœ€è¦çš„åŠŸèƒ½ç‰¹æ€§ã€‚</p>
<p>è®ºæ–‡ä¸­åœ¨å¼€å¤´éƒ¨åˆ†æåˆ°ï¼š</p>
<ul>
<li>Stonebraker: operating systems offer all things to all people at much higher overhead</li>
<li>exokernels demonstrated that customizing abstractions to applications results in significantly better performance</li>
</ul>
<p>Ceph åœ¨å…¶æ¼”è¿›è¿‡ç¨‹ä¸­ä½“ä¼šåˆ°äº†å®šåˆ¶æŠ½è±¡å±‚çš„é‡è¦æ€§ï¼Œå¯¹äºäº‘è®¡ç®—ï¼Œbyass kernel ä¹Ÿæ˜¯å¾ˆå¤šäº§å“çš„ç«äº‰é«˜åœ°ã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
