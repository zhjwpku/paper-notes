<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>raft - 论文阅读笔记</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
                <link rel="stylesheet" href="../../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Paper Notes</a></li><li class="chapter-item expanded "><a href="../../benchmarks/index.html"><strong aria-hidden="true">1.</strong> benchmarks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../benchmarks/ssb.html"><strong aria-hidden="true">1.1.</strong> ssb</a></li></ol></li><li class="chapter-item expanded "><a href="../../bigdata/index.html"><strong aria-hidden="true">2.</strong> bigdata</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../bigdata/mapreduce.html"><strong aria-hidden="true">2.1.</strong> mapreduce</a></li><li class="chapter-item expanded "><a href="../../bigdata/nephele.html"><strong aria-hidden="true">2.2.</strong> nephele</a></li><li class="chapter-item expanded "><a href="../../bigdata/dataflow-model.html"><strong aria-hidden="true">2.3.</strong> dataflow model</a></li><li class="chapter-item expanded "><a href="../../bigdata/flink.html"><strong aria-hidden="true">2.4.</strong> flink</a></li><li class="chapter-item expanded "><a href="../../bigdata/flink-state-management.html"><strong aria-hidden="true">2.5.</strong> flink state management</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/index.html"><strong aria-hidden="true">3.</strong> databases</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/column-stores-vs-row-stores.html"><strong aria-hidden="true">3.1.</strong> columnstores vs rowstores</a></li><li class="chapter-item expanded "><a href="../../databases/kv/index.html"><strong aria-hidden="true">3.2.</strong> kv</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/kv/optimizing-space-amplification-in-rocksdb.html"><strong aria-hidden="true">3.2.1.</strong> rocksdb cidr17</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/mmdb/index.html"><strong aria-hidden="true">3.3.</strong> mmdb</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/mmdb/overview.html"><strong aria-hidden="true">3.3.1.</strong> mmdb overview</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/oltp/index.html"><strong aria-hidden="true">3.4.</strong> oltp</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/oltp/oltp-through-the-looking-glass.html"><strong aria-hidden="true">3.4.1.</strong> through the looking glass</a></li><li class="chapter-item expanded "><a href="../../databases/oltp/staring-into-the-abyss.html"><strong aria-hidden="true">3.4.2.</strong> staring into the abyss</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/olap/index.html"><strong aria-hidden="true">3.5.</strong> olap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/olap/lakehouse.html"><strong aria-hidden="true">3.5.1.</strong> lakehouse</a></li><li class="chapter-item expanded "><a href="../../databases/olap/delta-lake.html"><strong aria-hidden="true">3.5.2.</strong> delta lake</a></li><li class="chapter-item expanded "><a href="../../databases/olap/vertica.html"><strong aria-hidden="true">3.5.3.</strong> vertica</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/htap/index.html"><strong aria-hidden="true">3.6.</strong> htap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/htap/greenplum-htap.html"><strong aria-hidden="true">3.6.1.</strong> greenplum</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/vectordb/index.html"><strong aria-hidden="true">3.7.</strong> vector db</a></li><li class="chapter-item expanded "><a href="../../databases/citus.html"><strong aria-hidden="true">3.8.</strong> citus</a></li><li class="chapter-item expanded "><a href="../../databases/optimizer/index.html"><strong aria-hidden="true">3.9.</strong> optimizer</a></li><li class="chapter-item expanded "><a href="../../databases/executor/index.html"><strong aria-hidden="true">3.10.</strong> executor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/executor/volcano.html"><strong aria-hidden="true">3.10.1.</strong> volcano</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/concurrencycontrol/index.html"><strong aria-hidden="true">3.11.</strong> concurrency control</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/concurrencycontrol/empirical-evaluation-of-mvcc.html"><strong aria-hidden="true">3.11.1.</strong> evaluation of in-memory mvcc</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/cdc/index.html"><strong aria-hidden="true">3.12.</strong> cdc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/cdc/dblog.html"><strong aria-hidden="true">3.12.1.</strong> dblog</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/rum.html"><strong aria-hidden="true">3.13.</strong> rum conjecture</a></li></ol></li><li class="chapter-item expanded "><a href="../../datalayout/index.html"><strong aria-hidden="true">4.</strong> datalayout</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../datalayout/c-store.html"><strong aria-hidden="true">4.1.</strong> cstore</a></li><li class="chapter-item expanded "><a href="../../datalayout/c-store-compression.html"><strong aria-hidden="true">4.2.</strong> cstore compression</a></li><li class="chapter-item expanded "><a href="../../datalayout/dremel.html"><strong aria-hidden="true">4.3.</strong> dremel</a></li><li class="chapter-item expanded "><a href="../../datalayout/rcfile.html"><strong aria-hidden="true">4.4.</strong> rcfile</a></li><li class="chapter-item expanded "><a href="../../datalayout/orc.html"><strong aria-hidden="true">4.5.</strong> orc</a></li><li class="chapter-item expanded "><a href="../../datalayout/table-placement-methods.html"><strong aria-hidden="true">4.6.</strong> table placement methods</a></li></ol></li><li class="chapter-item expanded "><a href="../../datastructure/index.html"><strong aria-hidden="true">5.</strong> data structures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../datastructure/btreefamily/index.html"><strong aria-hidden="true">5.1.</strong> btree family</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../datastructure/btreefamily/bw-tree.html"><strong aria-hidden="true">5.1.1.</strong> bw-tree</a></li></ol></li><li class="chapter-item expanded "><a href="../../datastructure/hash/index.html"><strong aria-hidden="true">5.2.</strong> hash table</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../datastructure/hash/linear-hashing.html"><strong aria-hidden="true">5.2.1.</strong> linear hashing</a></li></ol></li><li class="chapter-item expanded "><a href="../../datastructure/triefamily/index.html"><strong aria-hidden="true">5.3.</strong> trie family</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../datastructure/triefamily/art.html"><strong aria-hidden="true">5.3.1.</strong> art</a></li><li class="chapter-item expanded "><a href="../../datastructure/triefamily/hot.html"><strong aria-hidden="true">5.3.2.</strong> hot</a></li></ol></li><li class="chapter-item expanded "><a href="../../datastructure/bitmap/index.html"><strong aria-hidden="true">5.4.</strong> bitmaps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../datastructure/bitmap/roaring.html"><strong aria-hidden="true">5.4.1.</strong> roaring bitmaps</a></li></ol></li><li class="chapter-item expanded "><a href="../../datastructure/skiplist.html"><strong aria-hidden="true">5.5.</strong> skip list</a></li><li class="chapter-item expanded "><a href="../../datastructure/bloom-filter.html"><strong aria-hidden="true">5.6.</strong> bloom filter</a></li></ol></li><li class="chapter-item expanded "><a href="../../distributedsystem/index.html"><strong aria-hidden="true">6.</strong> distributed system</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/index.html"><strong aria-hidden="true">6.1.</strong> consensus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/flp.html"><strong aria-hidden="true">6.1.1.</strong> flp</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/paxos-made-simple.html"><strong aria-hidden="true">6.1.2.</strong> paxos made simple</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/paxos-made-live.html"><strong aria-hidden="true">6.1.3.</strong> paxos made live</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/vr.html"><strong aria-hidden="true">6.1.4.</strong> viewstamped replication</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/zab.html"><strong aria-hidden="true">6.1.5.</strong> zab</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/paxos-vs-vr-vs-zab.html"><strong aria-hidden="true">6.1.6.</strong> paxos vs. vr vs. zab</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/raft.html" class="active"><strong aria-hidden="true">6.1.7.</strong> raft</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/paxos-vs-raft.html"><strong aria-hidden="true">6.1.8.</strong> paxos vs raft</a></li></ol></li><li class="chapter-item expanded "><a href="../../distributedsystem/scheduler/index.html"><strong aria-hidden="true">6.2.</strong> scheduler</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../distributedsystem/scheduler/borg.html"><strong aria-hidden="true">6.2.1.</strong> borg</a></li></ol></li><li class="chapter-item expanded "><a href="../../distributedsystem/primary-backup.html"><strong aria-hidden="true">6.3.</strong> primary backup</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/chain-replication.html"><strong aria-hidden="true">6.4.</strong> chain replication</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/bolosky.html"><strong aria-hidden="true">6.5.</strong> bolosky</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/holygrail.html"><strong aria-hidden="true">6.6.</strong> holy grail</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/chandy.html"><strong aria-hidden="true">6.7.</strong> chandy lamport</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/abs.html"><strong aria-hidden="true">6.8.</strong> asynchronous barrier snapshotting</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/zookeeper.html"><strong aria-hidden="true">6.9.</strong> zookeeper</a></li></ol></li><li class="chapter-item expanded "><a href="../../fs/index.html"><strong aria-hidden="true">7.</strong> filesystem</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../fs/gfs.html"><strong aria-hidden="true">7.1.</strong> gfs</a></li><li class="chapter-item expanded "><a href="../../fs/polarfs.html"><strong aria-hidden="true">7.2.</strong> polarfs</a></li></ol></li><li class="chapter-item expanded "><a href="../../storage/index.html"><strong aria-hidden="true">8.</strong> storage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../storage/kv/index.html"><strong aria-hidden="true">8.1.</strong> kv store</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../storage/kv/dynamo.html"><strong aria-hidden="true">8.1.1.</strong> dynamo</a></li></ol></li><li class="chapter-item expanded "><a href="../../storage/kudu.html"><strong aria-hidden="true">8.2.</strong> kudu</a></li><li class="chapter-item expanded "><a href="../../storage/bluestore.html"><strong aria-hidden="true">8.3.</strong> bluestore</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">论文阅读笔记</h1>

                    <div class="right-buttons">
                                                <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/zhjwpku/paper-notes" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/zhjwpku/paper-notes/edit/master/src/distributedsystem/consensus/raft.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h3 id="a-hrefassetspdfsraftpdfin-search-of-an-understandable-consensus-algorithma"><a class="header" href="#a-hrefassetspdfsraftpdfin-search-of-an-understandable-consensus-algorithma"><a href="../../assets/pdfs/raft.pdf">In Search of an Understandable Consensus Algorithm</a></a></h3>
<blockquote>
<p>USENIX ATC'14</p>
<p>https://dl.acm.org/doi/10.5555/2643634.2643666</p>
</blockquote>
<p>共识算法通常伴随着复制状态机（replicated state machines），而复制状态机通常使用 <code>relicated log</code> 实现，每台服务器存储包含一系列命令的日志，状态机按序执行这些日志，如果各状态机以相同的状态开始并以相同的顺序执行相同的输入，它们将以相同的状态结束并产生相同的输出。</p>
<blockquote>
<p>Keeping the replicated log consistent is the job of the consensus algorithm.</p>
</blockquote>
<h4 id="whats-wrong-with-paxos"><a class="header" href="#whats-wrong-with-paxos">What's wrong with Paxos?</a></h4>
<ul>
<li>The first drawback is that Paxos is exceptionally difficult to understand.</li>
<li>The second problem with Paxos is that it does not provide a good foundation for building practical implementations.</li>
</ul>
<p>而 Raft 则将 <strong>易于理解</strong> 作为最重要的设计目标，算法设计出来应该能被大部分人轻松理解，能够让人产生直觉，进而可以被更多的开发者实现出来。</p>
<h4 id="raft-基本概念"><a class="header" href="#raft-基本概念">Raft 基本概念</a></h4>
<p>Raft 算法分为三个部分:</p>
<ul>
<li>Leader election</li>
<li>Log replication</li>
<li>Safty</li>
</ul>
<p>一个 Raft 集群包含多台服务器（通常为奇数），<code>2f + 1</code> 台机器能容忍 <code>f</code> 台机器出错（non-Byzantine fault），一台机器在任意时刻处于以下三种状态中的一种:</p>
<ul>
<li>leader</li>
<li>follower</li>
<li>candidate</li>
</ul>
<p>其状态转换过程:</p>
<p><img src="../../assets/images/raft-server-states.jpg" alt="raft server states" /></p>
<p>Raft 把时间分为多个 <code>term</code>，每个 <code>term</code> 的长度由集群的状态决定，当 <code>leader</code> 失效后，其中一个 <code>follower</code> 变为 <code>candidate</code> 并作出选举，相应的 <code>term</code> 进行加一，但一个 <code>term</code> 不一定有 <code>leader</code>，这是由于多个 <code>follower</code> 同时提出选举，可能会出现 <code>split vote</code>。</p>
<p><img src="../../assets/images/raft-terms.jpg" alt="raft terms" /></p>
<blockquote>
<p>Raft’s basic consensus algorithm depends on only two message (RPC) types: RequestVote and AppendEntries.</p>
</blockquote>
<h4 id="leader-election"><a class="header" href="#leader-election">Leader election</a></h4>
<p>Raft 使用心跳机制（<code>AppendEntries RPCs</code> that carry no log entries）来维护 <code>leader</code> 的权威性，一个 <code>follower</code> 只要收到心跳会一直保持在 follower 状态。如果 <code>follwer</code> 在 <strong>election timeout (150-300ms 之间的一个随机值)</strong> 之后未收到心跳，其状态变为 <code>candidate</code>，term + 1，投票给自己并使用 <code>RequestVote</code> RPC 向其它节点索要投票，该节点处于 <code>candidate</code> 状态直到以下三种情之一发生:</p>
<ol>
<li>得到多数投票赢得选举，状态变为 leader</li>
<li>另外一个节点赢得选举，状态变为 follower</li>
<li>一段时间过去了，没有 leader 被选出，此时该 term 内没有 leader，等待下一次选举</li>
</ol>
<p>如果 RPC 中返回的 term 大于 candidate 自身 term，更新 term 并将自身状态变为 follower，此种情况归类为如上 2。</p>
<p><em>Liveness propery</em></p>
<p>随机选举超时时间保证了短时间内有 <code>leader</code> 当选，i.e. something good eventually happens。</p>
<p><em>Safety property</em></p>
<p><code>votedFor</code> 和 <code>currentTerm</code> 持久化保证了同一 <code>term</code> 只能有一个 <code>leader</code> 当选，i.e. nothing bad happens。</p>
<h4 id="log-replication"><a class="header" href="#log-replication">Log replication</a></h4>
<p>当一个节点被选为 <code>leader</code> 后，它开始服务客户端请求，每个客户端请求都包含一个需要被 <code>relicated state machines</code> 执行的命令，leader 节点将该命令包装为 entry(leader 的 currentTerm + 命令本身) 追加写到自己的 log，然后将该 entry 并发使用 <code>AppendEntries</code> 发送给 <code>follower</code> 节点，当多数派收到该 entry 后，<code>leader</code> 将该 entry 提交给状态机执行，并返回客户端执行结果。</p>
<p>当 <code>leader</code> 节点出现问题时，可能会出现日志不一致的情况，Raft 通过强制 <code>follower</code> 复制 <code>leader</code> 的日志来解决一致性问题。</p>
<blockquote>
<p>To bring a follower’s log into consistency with its own, the leader must find the latest log entry where the two
logs agree, delete any entries in the follower’s log after that point, and send the follower all of the leader’s
entries after that point.</p>
</blockquote>
<p>通过在 Leader 节点为每个 <code>follower</code> 维护一个 <code>nextIndex</code> 值，当 <code>AppendEntries</code> 发送的日志与 <code>follower</code> 节点的日志不匹配时，<code>leader</code> 节点将对应 <code>follower</code> 的 <code>nextIndex</code> 值减一，直到找到匹配的位置重新发送。该过程保证了 <code>Log Matching Property</code>:</p>
<blockquote>
<p>If two entries in different logs have the same index and term, then they store the same command.
If two entries in different logs have the same index and term, then the logs are identical in all preceding entries.</p>
</blockquote>
<p>这种机制使得 <code>leader</code> 节点不需要做任何特殊处理就能够恢复日志的一致性，<code>leader</code> 节点从不覆盖写或删除已有的日志（Leader Append-Only Property）。但需要对选举的过程做一些额外限制来避免已经提交的日志被删除。</p>
<p><em>Election restriction</em></p>
<blockquote>
<p>A candidate must contact a majority of the cluster in order to be elected, which means that every
committed entry must be present in at least one of those servers. If the candidate’s log is at least
as up-to-date as any other log in that majority then it will hold all the committed entries.</p>
</blockquote>
<p><code>up-to-date</code> 定义为:</p>
<ul>
<li>If the logs have last entries with different terms, then the log with the later term is more up-to-date.</li>
<li>If the logs end with the same term, then whichever log is longer is more up-to-date.</li>
</ul>
<p><em>Commitment rules</em></p>
<ul>
<li>Raft never commits log entries from previous terms by counting replicas.</li>
<li>Only log entries from the leader’s current term are committed by counting replicas.</li>
<li>once an entry from the current term has been committed in this way, then all prior entries are committed indirectly because of the Log Matching Property.</li>
</ul>
<p>如上规则能避免下图中的问题:</p>
<p><img src="../../assets/images/raft-never-commit-previouse-term-by-counting-replicas.jpg" alt="a leader cannot determine commitment using log entries from older terms" /></p>
<h4 id="rafts-5-guarantees"><a class="header" href="#rafts-5-guarantees">Raft's 5 guarantees</a></h4>
<ol>
<li><strong>Election Safety:</strong> at most one leader can be elected in a given term.</li>
<li><strong>Leader Append-Only:</strong> a leader never overwrites or deletes entries in its log; it only appends new entries.</li>
<li><strong>Log Matching:</strong> if two logs contain an entry with the same index and term, then the logs are identical in all entries up through the given index.</li>
<li><strong>Leader Completeness:</strong> if a log entry is committed in a given term, then that entry will be present in the logs of the leaders for all higher-numbered terms.</li>
<li><strong>State Machine Safety:</strong> if a server has applied a log entry at a given index to its state machine, no other server will ever apply a different log entry for the same index.</li>
</ol>
<h4 id="optimizations"><a class="header" href="#optimizations">Optimizations</a></h4>
<ol>
<li>when rejecting an AppendEntries request, the followe rcan include the term of the conflicting entry and the first index it stores for that term. With this information, the leader can decrement nextIndex to bypass all of the conflicting entries in that term</li>
<li>Diego Ongaro's Ph.D. dissertation describes an optional <code>PreVote</code> phase in Raft that is designed to prevent a partitioned server from disrupting the cluster by forcing a re-election when it rejoins the cluster.</li>
</ol>
<h4 id="cluster-membership-changes"><a class="header" href="#cluster-membership-changes">Cluster Membership Changes</a></h4>
<p>Raft 使用 <code>joint consensus</code> 算法来保证配置切换期间不会出现双 <code>leader</code> 且能持续服务客户端。</p>
<h4 id="references"><a class="header" href="#references">References:</a></h4>
<p>[1] <a href="https://raft.github.io/">Raft Homepage</a><br>
[2] <a href="https://www.youtube.com/watch?v=YbZ3zDzDnrw">Raft lecture (Raft user study)</a> by by John Ousterhout<br>
[3] <a href="https://www.youtube.com/watch?v=vYp4LYbnnW8">Designing for Understandability: The Raft Consensus Algorithm</a> by John Ousterhout<br>
[4] <a href="../../assets/pdfs/raft-extended-version.pdf">In Search of an Understandable Consensus Algorithm (Extended Version)</a><br>
[5] <a href="https://github.com/ongardie/dissertation#readme">Diego Ongaro's Ph.D. dissertation</a><br>
[6] <a href="https://thesquareplanet.com/blog/students-guide-to-raft/">Students' Guide to Raft</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../distributedsystem/consensus/paxos-vs-vr-vs-zab.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../distributedsystem/consensus/paxos-vs-raft.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../distributedsystem/consensus/paxos-vs-vr-vs-zab.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../distributedsystem/consensus/paxos-vs-raft.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
