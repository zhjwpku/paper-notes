<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>viewstamped replication - 论文阅读笔记</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
                <link rel="stylesheet" href="../../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Paper Notes</a></li><li class="chapter-item expanded "><a href="../../benchmarks/index.html"><strong aria-hidden="true">1.</strong> benchmarks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../benchmarks/ssb.html"><strong aria-hidden="true">1.1.</strong> ssb</a></li></ol></li><li class="chapter-item expanded "><a href="../../bigdata/index.html"><strong aria-hidden="true">2.</strong> bigdata</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../bigdata/mapreduce.html"><strong aria-hidden="true">2.1.</strong> mapreduce</a></li><li class="chapter-item expanded "><a href="../../bigdata/nephele.html"><strong aria-hidden="true">2.2.</strong> nephele</a></li><li class="chapter-item expanded "><a href="../../bigdata/dataflow-model.html"><strong aria-hidden="true">2.3.</strong> dataflow model</a></li><li class="chapter-item expanded "><a href="../../bigdata/flink.html"><strong aria-hidden="true">2.4.</strong> flink</a></li><li class="chapter-item expanded "><a href="../../bigdata/flink-state-management.html"><strong aria-hidden="true">2.5.</strong> flink state management</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/index.html"><strong aria-hidden="true">3.</strong> databases</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/column-stores-vs-row-stores.html"><strong aria-hidden="true">3.1.</strong> columnstores vs rowstores</a></li><li class="chapter-item expanded "><a href="../../databases/kv/index.html"><strong aria-hidden="true">3.2.</strong> kv</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/kv/optimizing-space-amplification-in-rocksdb.html"><strong aria-hidden="true">3.2.1.</strong> rocksdb cidr17</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/mmdb/index.html"><strong aria-hidden="true">3.3.</strong> mmdb</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/mmdb/overview.html"><strong aria-hidden="true">3.3.1.</strong> mmdb overview</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/olap/index.html"><strong aria-hidden="true">3.4.</strong> olap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/olap/lakehouse.html"><strong aria-hidden="true">3.4.1.</strong> lakehouse</a></li><li class="chapter-item expanded "><a href="../../databases/olap/delta-lake.html"><strong aria-hidden="true">3.4.2.</strong> delta lake</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/htap/index.html"><strong aria-hidden="true">3.5.</strong> htap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/htap/greenplum-htap.html"><strong aria-hidden="true">3.5.1.</strong> greenplum</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/cdc/index.html"><strong aria-hidden="true">3.6.</strong> cdc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../databases/cdc/dblog.html"><strong aria-hidden="true">3.6.1.</strong> dblog</a></li></ol></li><li class="chapter-item expanded "><a href="../../databases/rum.html"><strong aria-hidden="true">3.7.</strong> rum conjecture</a></li></ol></li><li class="chapter-item expanded "><a href="../../datalayout/index.html"><strong aria-hidden="true">4.</strong> datalayout</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../datalayout/c-store.html"><strong aria-hidden="true">4.1.</strong> cstore</a></li><li class="chapter-item expanded "><a href="../../datalayout/dremel.html"><strong aria-hidden="true">4.2.</strong> dremel</a></li><li class="chapter-item expanded "><a href="../../datalayout/rcfile.html"><strong aria-hidden="true">4.3.</strong> rcfile</a></li><li class="chapter-item expanded "><a href="../../datalayout/orc.html"><strong aria-hidden="true">4.4.</strong> orc</a></li><li class="chapter-item expanded "><a href="../../datalayout/table-placement-methods.html"><strong aria-hidden="true">4.5.</strong> table placement methods</a></li></ol></li><li class="chapter-item expanded "><a href="../../datastructure/index.html"><strong aria-hidden="true">5.</strong> data structures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../datastructure/skiplist.html"><strong aria-hidden="true">5.1.</strong> skip list</a></li><li class="chapter-item expanded "><a href="../../datastructure/bloom-filter.html"><strong aria-hidden="true">5.2.</strong> bloom filter</a></li></ol></li><li class="chapter-item expanded "><a href="../../distributedsystem/index.html"><strong aria-hidden="true">6.</strong> distributed system</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/index.html"><strong aria-hidden="true">6.1.</strong> consensus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/flp.html"><strong aria-hidden="true">6.1.1.</strong> flp</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/paxos-made-simple.html"><strong aria-hidden="true">6.1.2.</strong> paxos made simple</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/paxos-made-live.html"><strong aria-hidden="true">6.1.3.</strong> paxos made live</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/vr.html" class="active"><strong aria-hidden="true">6.1.4.</strong> viewstamped replication</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/zab.html"><strong aria-hidden="true">6.1.5.</strong> zab</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/paxos-vs-vr-vs-zab.html"><strong aria-hidden="true">6.1.6.</strong> paxos vs. vr vs. zab</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/raft.html"><strong aria-hidden="true">6.1.7.</strong> raft</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/consensus/paxos-vs-raft.html"><strong aria-hidden="true">6.1.8.</strong> paxos vs raft</a></li></ol></li><li class="chapter-item expanded "><a href="../../distributedsystem/scheduler/index.html"><strong aria-hidden="true">6.2.</strong> scheduler</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../distributedsystem/scheduler/borg.html"><strong aria-hidden="true">6.2.1.</strong> borg</a></li></ol></li><li class="chapter-item expanded "><a href="../../distributedsystem/primary-backup.html"><strong aria-hidden="true">6.3.</strong> primary backup</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/chain-replication.html"><strong aria-hidden="true">6.4.</strong> chain replication</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/bolosky.html"><strong aria-hidden="true">6.5.</strong> bolosky</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/holygrail.html"><strong aria-hidden="true">6.6.</strong> holy grail</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/chandy.html"><strong aria-hidden="true">6.7.</strong> chandy lamport</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/abs.html"><strong aria-hidden="true">6.8.</strong> asynchronous barrier snapshotting</a></li><li class="chapter-item expanded "><a href="../../distributedsystem/zookeeper.html"><strong aria-hidden="true">6.9.</strong> zookeeper</a></li></ol></li><li class="chapter-item expanded "><a href="../../fs/index.html"><strong aria-hidden="true">7.</strong> filesystem</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../fs/gfs.html"><strong aria-hidden="true">7.1.</strong> gfs</a></li><li class="chapter-item expanded "><a href="../../fs/polarfs.html"><strong aria-hidden="true">7.2.</strong> polarfs</a></li></ol></li><li class="chapter-item expanded "><a href="../../storage/index.html"><strong aria-hidden="true">8.</strong> storage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../storage/kv/index.html"><strong aria-hidden="true">8.1.</strong> kv store</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../storage/kv/dynamo.html"><strong aria-hidden="true">8.1.1.</strong> dynamo</a></li></ol></li><li class="chapter-item expanded "><a href="../../storage/kudu.html"><strong aria-hidden="true">8.2.</strong> kudu</a></li><li class="chapter-item expanded "><a href="../../storage/bluestore.html"><strong aria-hidden="true">8.3.</strong> bluestore</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">论文阅读笔记</h1>

                    <div class="right-buttons">
                                                <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/zhjwpku/paper-notes" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/zhjwpku/paper-notes/edit/master/src/distributedsystem/consensus/vr.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h3 id="a-hrefassetspdfsvr-revisitedpdfviewstamped-replication-revisiteda"><a class="header" href="#a-hrefassetspdfsvr-revisitedpdfviewstamped-replication-revisiteda"><a href="../../assets/pdfs/vr-revisited.pdf">Viewstamped Replication Revisited</a></a></h3>
<blockquote>
<p>MIT technical report MIT-CSAIL-TR-2012-021, July 2012</p>
<p>https://pmg.csail.mit.edu/papers/vr-revisited.pdf</p>
</blockquote>
<p>Viewstamped Replication 最初在 1988 年发表的 <a href="../../assets/pdfs/viewstamped-replication.pdf">Viewstamped Replication: A New Primary Copy Method to Support Highly-available Distributed Systems</a> 中提出，其原始描述与分布式 Transactions 协议耦合在一起，理解起来较为困难。2012 年发表的 <strong>Viewstamped Replication Revisited</strong> 将其共识算法抽取出来，对协议的描述更为清晰。本文基于 vr-revisited 介绍 VR 协议。</p>
<blockquote>
<p>VR was originally developed in the 1980s, at about the same time as Paxos, 
but without knowledge of that work. It differs from Paxos in that it is a 
<strong>replication protocol</strong> rather than a consensus protocol: it <strong>uses consensus</strong>, 
with a protocol very similar to Paxos, as part of supporting a 
<strong>replicated state machine</strong>.</p>
</blockquote>
<p>虽然论文声称 VR 不是 consensus，而是使用了 consensus 的复制协议，但通常在提到 VR 协议时，认为它就是共识算法。</p>
<h4 id="failure-mode"><a class="header" href="#failure-mode">Failure Mode</a></h4>
<p>VR 假设集群中节点的失效模型为 <em>crash failures</em>，而非 <em>Byzantine failures</em>。VR 工作在异步网络模型（如 Internet），同时假设网络不会被恶意攻击者篡改。</p>
<blockquote>
<p>Messages might be lost, delivered late or out of order, and 
delivered more than once; however, we assume that if sent 
repeatedly a message will eventually be delivered.</p>
</blockquote>
<p>VR 是一个多数派的协议，一个 <strong>replica group</strong> 由 2f + 1 个节点组成，可以忍受 f 个节点同时失效，f + 1 个节点被称为 <strong>quorum</strong>，协议的正确性依赖 <strong>quorum intersection property</strong>:</p>
<blockquote>
<p>The quorum of replicas that processes a particular step of the protocol must
have a <strong>non-empty intersection</strong> with the group of replicas available to 
handle the next step, since this way we can ensure that at each next step 
at least one participant knows what happened in the previous step.</p>
</blockquote>
<h4 id="architecture"><a class="header" href="#architecture">Architecture</a></h4>
<p><img src="../../assets/images/vr_architecture.jpg" alt="VR Architecture" /></p>
<p>上图显示了 f = 1 的 VR 架构图，客户端通过 VR Proxy 和集群进行交互，每个 Replica 包含两部分代码:</p>
<ul>
<li>VR Code: 运行 VR 协议，当一个请求可以被执行的时候，产生一个 up-call 让 service code 执行该请求</li>
<li>Service Code: 执行请求，更新状态并将结果返回给 VR code，VR code 将结果消息发送给 client proxy</li>
</ul>
<h4 id="vr-protocol"><a class="header" href="#vr-protocol">VR Protocol</a></h4>
<p><strong>State machine replication</strong> 要求所有的 replica 以同样的初始状态开始，执行同样序列的操作，最终会得到一样的状态。</p>
<blockquote>
<p>The challenge for the replication protocol is to ensure that 
operations execute in the same order at all replicas in spite 
of concurrent requests from clients and in spite of failures.</p>
</blockquote>
<p>VR 协议使用一个 <strong>primary</strong> replica 对客户端请求进行排序，<strong>backup</strong> replica 接受 primary 选择的请求顺序。当 primary 失效，集群通过 <em>view change protocol</em> 选择一个新的 primary，如何保证新的 primary 能反应已经被执行过的请求是一个挑战。</p>
<blockquote>
<p>We support this requirement by having the primary wait until at least <strong>f + 1</strong> replicas 
(including itself) know about a client request before executing it, and by initializing 
the state of a new view by consulting at least <strong>f + 1</strong> replicas. Thus each request is 
known to a quorum and the new view starts from a quorum.</p>
</blockquote>
<p>VR 使用三个 sub-protocols 来保证协议的正确性：</p>
<ul>
<li>Normal case processing of user requests.</li>
<li>View changes to select a new primary.</li>
<li>Recovery of a failed replica so that it can rejoin the group.</li>
</ul>
<p>每个 replica 根据其 IP 地址被赋予一个 id，集群根据 replica id 循环（Round Robin）选择下一个 primary 角色。每个 replica 的 VR layer 维护了如下状态:</p>
<ul>
<li>configuration: 依据 2f + 1 个 relica 的 IP 地址排序的数组</li>
<li>replica number: 该 replica 在 configuration 中排序数组的 index</li>
<li>view-number: replica 当前的视图号，初始值为 0，递增</li>
<li>status: replica 当前状态，可能值为 normal、view-change 或 recovering</li>
<li>op-number: 赋予最新请求的操作id，初始值为 0，递增</li>
<li>log: replica 上维护的包含操作记录的数组</li>
<li>commit-number: 最新提交的请求操作的 op-number</li>
<li>client-table: 对于每个客户端维护的最新的请求，如果该请求已经被执行过，则该结构还会保存请求对应的响应结果</li>
</ul>
<p><strong>1. Normal Operation: request processing protocol</strong></p>
<p>在 primary 节点不出错的情况下，多个状态为 <em>normal</em> 且在同一 view 的 replicas 参与请求的处理。</p>
<blockquote>
<p>Replicas only process normal protocol messages containing a view-number that matches 
the view-number they know.</p>
</blockquote>
<p>该协议工作流程如下:</p>
<p><img src="../../assets/images/vr_normal_case.jpg" alt="normal case processing" /></p>
<ol>
<li>客户端发送 <code>&lt;Request op, c, s&gt;</code> 消息给 primary，其中 op 是客户端想要执行的请求（包含参数），c 是客户端 id，s 是指定给请求的 request-number;</li>
<li>primary 收到请求后，将 request-number 和 client-table 中记录的信息进行对比。如果 request-number 不大于 client-table 记录的 request-number，该 request 被丢弃，如果该 request 是 client-table 记录的最新 request，primary 会给客户端重新发送该请求对应的响应;</li>
<li>primary 增加 op-number 值，将请求追加到 log，更新 client-table 中对应该客户端的信息。向其它 replicas 发送 <code>&lt;Prepare v, m, n, k&gt;</code> 消息，v 是 primary 当前的 view-number，m 是客户端发送的消息（即 Step 1 中的 Request），n 是指定给请求的 op-number，k 是 commit-number;</li>
<li>backups 按照顺序处理 Prepare 消息，当 backup 收到 Prepare 消息时，它会等待所有更早的请求都存在于其 log 后，增加其 op-number 值，将该请求追加到 log，更新 client-table，然后向 primary 发送 <code>&lt;PrepareOk v, n, i&gt;</code> 消息，告诉 primay 该消息已经在本地日志就绪;</li>
<li>primary 在收到 f 个不同 backups 返回的 PrepareOk 消息后，认为该操作（及所有先前的操作）为 committed，在执行了所有更早的操作后，primary 通过 up-call 让 service code 执行该操作，并更新 commit-number。然后发送 <code>&lt;Reply v, s, x&gt;</code> 消息给客户端，v 是 primary 当前的 view-number，s 是客户端的 request-number，x 是 up-call 返回的结果。primary 同时会更新 client-table 中对应该请求的结果;</li>
<li>通常情况下，primary 通过下次 Prepare 消息通知 backups 当前的 commit-number，但是当在一定时间后未收到客户端发送的请求时，primary 会给 backups 返送 <code>&lt;Commit v, k&gt;</code> 消息，v 是 primary 当前的 view-number，k 是当前的 commit-number;</li>
<li>backup 在收到 commit-number 更新后，等待 log 中所有早于 commit-number 的请求被执行后，执行 up-call 让 service code 处理 commit-number 对应的操作，递增 commit-number 值，并更新 client-table，不过 backup 不需要给客户端回复结果。</li>
</ol>
<p>如果客户端在一定时间后未收到请求的响应，会将该消息发送给所有 replicas，这样能保证 replica group 进入下一个 view 后，请求可以发送给新的 primary。</p>
<p><strong>2. view change Protocol</strong></p>
<p>backup 通过 <code>Prepare</code> 和 <code>Commit</code> 消息对 primary 进行探活，如果在一定时间内未收到来自 primary 的消息，replicas 会通过 <strong>view change</strong> 切换新的 primary。</p>
<p>View Changes 保证正确性的前提是：每一个通过 up-call 被 service code 执行的请求，必须存活于下一个 view 且保证其在 log 中的顺序与执行顺序一致。</p>
<blockquote>
<p>The correctness condition for view changes is that every committed operation survives into 
all subsequent views in the same position in the serial order. This condition implies that 
any request that had been executed retains its place in the order.</p>
</blockquote>
<p>只有 committed 的操作会执行 up-call，这意味着旧的 primary 已经收到 f 个 backup 返回 PrepareOK 消息，进而意味着该操作已经在 f + 1 个 replica 的 log 中被记录。当 <strong>view change protocol</strong> 获取了 f + 1 个 replica 的日志信息后，依据 <strong>quorum intersection property</strong>，所有 committed 操作都能被新的 view 获取到。</p>
<p>该协议工作流程如下:</p>
<ol>
<li>replica i 根据其 timer 或在收到 <em>view-number</em> 大于该 replica 本身 <em>view-number</em> 的 StartViewChange 或 DoViewChange 消息后，执行 view change，将自己的状态置为 <em>view-change</em>，增加其 <em>view-number</em>，然后给其它 replicas 发送 <code>&lt;StartViewChange v, i&gt;</code> 消息，其中 v 为新视图的 <em>view-number</em>;</li>
<li>当 replica i 收到 f 个与其 <em>view-number</em> 相同的 StartViewChange 消息后，该 replica 发送 <code>&lt;DoViewChange v, l, v', n, k i&gt;</code> 消息给下一个视图的 primary（通过 Round Robin 指定）。其中 v 是该 replica 的 <em>view-number</em>，l 是它的 log，v' 是状态为 <em>normal</em> 的最近的视图的 <em>view-number</em>，n 为 <em>op-number</em>, k 为 <em>commit-number</em>;</li>
<li>当新的 primary 从不同 replicas（包括其自己）收到 f + 1 个 DoViewChange 消息后，它将自己的 <em>view-number</em> 及 log 设置为 v' 最大或多个具有最大 v' 中 n 最大的消息对应的 v 及 log，将其 <em>op-number</em> 设置为新 log 的最大 index，将其 <em>commit-number</em> 设置为所有 DoViewChange 中最大的 <em>commit-number</em>，然后将其状态设置为 normal，通过给各 replica 发送 <code>&lt;StartView v, l, l, n, k&gt;</code> 来通知其它 replica view change 过程结束，其中 l 为新的日志，n 为 <em>op-number</em>，k 为 <em>commit-number</em>;</li>
<li>新 replica 开始接收客户端请求，将之前未执行的 <code>committed</code> 操作执行一遍，更新 client-table，并给客户端发送响应;</li>
<li>当其它 replica 收到 StartView 消息后，它们更新本地的 log、op-number 及 view-number，将状态设置为 <em>normal</em>，并更新 client-table 中的信息。如果日志中有未提交的操作，replica 会给 primary 发送 <code>&lt;PrepareOk v, n, i&gt;</code>，然后执行之前未执行的 <code>committed</code> 操作，增加 <em>commit-number</em> 值，并更新 client-table 的信息。</li>
</ol>
<blockquote>
<p>VR as originally defined used a slightly different approach: it assigned each operation a 
viewstamp. A viewstamp is a pair &lt;view-number, op-number&gt;, with the natural order: the 
view-number is considered first, and then the op-number for two viewstamps with the same 
view-number.</p>
</blockquote>
<p>VR 在最初的论文中根据如上定义被命名为 <em>viewstamps</em>。</p>
<p>一个 View Change 过程可能由于新 primary 的失败而失败，这种情况下需要执行新一轮的 View Change。</p>
<p><strong>3. recovery protocol</strong></p>
<p>当一个 replica 从失败中恢复后，它不能参与集群的请求处理及 view changes 直到它获取到至少它失败时的状态。如果在磁盘上记录了状态，节点在读取磁盘重新初始化其状态后可以马上重新加入到系统中:</p>
<blockquote>
<p>The reason is that in this case a recovering node hasn’t forgotten anything 
it did before the crash (assuming the disk is intact). Instead it is the 
same as a node that has been unable to communicate for some period of time: 
its state is old but it hasn’t forgotten anything it did before.</p>
</blockquote>
<p>但 VR 为了提高其吞吐，并未在发送 Prepare 及 PrepareOk 消息之前写磁盘，其假设所有几点不会在同一时刻同时失败，及 replcas 具有 <code>failure independent</code> 的属性（依赖 UPS、non-volatime memory 或将 replica 放置在不同的地理位置）。</p>
<p>该协议工作流程如下:</p>
<ol>
<li>需要恢复的 replica i 给其它 replica 发送 <code>&lt;Recovery i, x&gt;</code>，其中 x 是一个递增的 nonce 值;</li>
<li>replica j 在状态为 <em>normal</em> 的前提下回复 <code>&lt;RecoveryResponse v, x, l, n, k, j&gt;</code> 消息给 replica i，v 是 <em>view-number</em>，x 是 Recovery 消息中的 nonce 值，如果 j 为当前视图的 primary，则 l 是其 log，n 为 <em>op-number</em>，k 为 <em>commit-number</em>，如果为 backup，则 l、n、k 的值都为 nil;</li>
<li>当 replica i 从不同节点收到 f + 1 个 RecoveryResponse 消息后（所有消息需包含与 Recovery 消息相同的 nonce，且至少有一个包含这些消息中含有最新视图的 primary 节点的消息），replica i 依据 primary 返回的信息更新其 log、<em>view-number</em>、<em>op-number</em> 及 <em>commit-number</em>，并将其状态改为 <em>normal</em>。</li>
</ol>
<p>当需要恢复的 replica i 同时为 view change 的 new primary 时，由于 replica i 不会回复 DoViewChange 消息，因此 view change 不能完成。这种情况下会进行新一轮的 view change。</p>
<p>nonce 的作用在于避免需要恢复的节点接收之前 Recovery 消息对应的 RecoveryResponse。</p>
<blockquote>
<p>When a replica recovers it doesn’t know what view it was in when it failed. 
However, when it receives <strong>f + 1</strong> responses to its RECOVERY message, it 
is certain to learn of a view at least as recent as the one that existed 
when it sent its last PREPAREOK, DOVIEWCHANGE, or RECOVERYRESPONSE message. 
Furthermore it gets its state from the primary of the latest view it hears 
about, which ensures it learns the latest state of that view.</p>
</blockquote>
<h4 id="efficient-log"><a class="header" href="#efficient-log">Efficient log</a></h4>
<p>如上协议中的 log 在长时间运行之后可能会非常巨大，依赖 application state 及 checkpoints 可以高效地管理日志，并可以将无用的 log 进行 gc。高效的日志管理对于提升 <strong>Recovery</strong>、<strong>State Transfer</strong>、<strong>View Changes</strong> 的性能都有很大的帮助，详细分析见论文。</p>
<h4 id="optimizations"><a class="header" href="#optimizations">Optimizations</a></h4>
<p>论文中提到了几个可以提高协议性能的优化点:</p>
<ul>
<li>Witnesses: 只执行 VR Code，不执行 Service Code。同时执行 VR Code 和 Service Code 的节点被称为 <code>active replica</code>，primary 总是 <code>active replica</code></li>
<li>Batching: primary 收集一堆请求同时运行 VR 协议，以提高 throughput</li>
<li>Fast Reads
<ul>
<li>Reads at the Primary: 依赖 lease 避免读取 old primary 中 stale 的数据，一个新 view 只会在 view change 算法的 f + 1 个参与者的 lease 结束后才开始，这样保证了新视图在旧 primary 停止回复读取操作后才开始</li>
<li>Reads at Backups: 客户端维护 <em>last-request-number</em>，当进行写操作时，replica 返回请求的 op-number；当进行读操作时，replica 返回当前的 commit-number。客户端将 replica 返回的值保存在 <em>last-request-number</em>，在进行读取操作时，将该值包含在读请求中，replica 只有在至少执行到 <em>last-request-number</em> 对应的操作时才会回复客户端。</li>
</ul>
</li>
</ul>
<h4 id="reconfiguration"><a class="header" href="#reconfiguration">Reconfiguration</a></h4>
<p>当有机器不可恢复、改变机器规格或者需要增大或缩小集群最大容错数 f 时，需要对集群进行 Reconfiguration。具体细节见 paper，本文略。</p>
<p>另外 VR 的 Reconfiguration 在进行中不能处理客户端请求，这点 Raft 更具优势 ?</p>
<br>
<p><a href="https://github.com/coilhq/tigerbeetle">TigerBeetle</a> 实现了 VR protocol。</p>
<h4 id="references"><a class="header" href="#references">References:</a></h4>
<p>[1] <a href="https://blog.acolyer.org/2015/03/02/viewstamped-replication-a-new-primary-copy-method-to-support-highly-available-distributed-systems/">Viewstamped replication</a>, a walk-through by Adrian Colyer<br>
[2] <a href="https://blog.acolyer.org/2015/03/06/viewstamped-replication-revisited/">Viewstamped Replication Revisited</a>, a walk-through by Adrian Colyer<br>
[3] <a href="https://www.youtube.com/watch?v=1EzNa-zAYS8">Bruno Bonacci on Viewstamped Replication @PWL London</a><br>
[4] <a href="https://www.youtube.com/watch?v=Wii1LX_ltIs">Paper #74. Viewstamped Replication Revisited</a> by Joran Dirk Greef<br></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../distributedsystem/consensus/paxos-made-live.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../distributedsystem/consensus/zab.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../distributedsystem/consensus/paxos-made-live.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../distributedsystem/consensus/zab.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
